<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Part III of Mathematical Structure of Mamba - S4D</title>
      <link href="/posts/10040.html"/>
      <url>/posts/10040.html</url>
      
        <content type="html"><![CDATA[<div class="note success flat"><p>æœ¬ç¯‡æ˜¯mambaç³»åˆ—blogçš„ç¬¬ä¸‰ç¯‡æ–‡ç« ï¼Œç³»åˆ—æ–‡ç« è§ï¼š</p><ul><li><p><a href="https://anti-entrophic.github.io/posts/10038.html" title="Part I of Mathematical Structure of Mamba - Hippo">Part I of Mathematical Structure of Mamba - Hippo</a></p></li><li><p><a href="https://anti-entrophic.github.io/posts/10039.html" title="Part II of Mathematical Structure of Mamba - S4">Part II of Mathematical Structure of Mamba - S4</a></p></li><li><p>Part III of Mathematical Structure of Mamba - S4D</p></li></ul><p>å‰©ä½™é¢„è®¡è¿˜æœ‰ä¸¤ç¯‡æ–‡ç« æ­£åœ¨ç”Ÿäº§ä¸­~</p></div><h1 id="NIPS-22-On-the-Parameterization-and-Initialization-of-Diagonal-State-Space-Models"><a href="#NIPS-22-On-the-Parameterization-and-Initialization-of-Diagonal-State-Space-Models" class="headerlink" title="[NIPS 22] On the Parameterization and Initialization of Diagonal State Space Models"></a>[NIPS 22] On the Parameterization and Initialization of Diagonal State Space Models</h1><h2 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h2><p>åœ¨mambaä¹‹å‰ï¼ŒHiPPOã€S4ã€DSSã€S4Déƒ½æ˜¯Albert Guçš„å·¥ä½œï¼Œå¯ä»¥è¯´æ˜¯ä¸€å·±ä¹‹åŠ›æ¨åŠ¨äº†SSMæ¨¡å‹çš„å‘å±•ã€‚åœ¨S4åˆ°mambaä¹‹é—´ï¼Œå…¶å®è¿˜ç»å†äº†å¾ˆå¤šç®€åŒ–ã€‚</p><p>æœ¬ç¯‡é€‰å–ä¸­é—´çš„ä¸€ç¯‡å·¥ä½œS4Dï¼Œæ¥ä¸€çª¥ç›®å‰çš„mambaä»“åº“ä»£ç çš„é›å½¢ã€‚ï¼ˆä¸»è¦æ˜¯æ¯”mambaæ¸…æ¥šå¤ªå¤šäº†ï¼Œmambaæ–‡ç« å’Œä»£ç ä»“åº“å®Œå…¨çœ‹ä¸æ‡‚ï¼Œåªèƒ½è¯´è¢«ICLR24æ‹’ç¨¿æ˜¯æœ‰åŸå› çš„ï¼‰</p><p>P.S. DSSå’ŒS4Déƒ½æ˜¯åŒä¸€å¹´çš„NIPSï¼Œçˆ½å‘å•Š</p><h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>S4çš„çªå‡ºè´¡çŒ®å°±åœ¨äºç»™å‡ºäº†HiPPOçŸ©é˜µåŠç›¸å…³å·ç§¯æ ¸é«˜é˜¶å¹‚çš„æ±‚è§£åŠæ³• <strong>DPLR</strong>ï¼Œä½†æ˜¯ä»æ¨å¯¼å°±å¯ä»¥çœ‹å‡ºï¼Œä»ç„¶æ˜¯è¿‡äºå¤æ‚äº†ã€‚</p><p>å‰ç½®å·¥ä½œ DSS å‘ç°ï¼Œå­˜åœ¨ä½¿ç”¨å¯¹è§’çº¿çŠ¶æ€çŸ©é˜µç®€åŒ–åŸæ¥çš„HiPPOçŸ©é˜µçš„å¯èƒ½æ€§ï¼Œä¸è¿‡è¿˜æ˜¯å¼•å…¥äº†ä¸€äº›æœ‰éš¾åº¦çš„æ“ä½œï¼ˆéœ€è¦å¤å€¼softmaxï¼Œå¹¶ä¸”æ²¡æœ‰è§£é‡Šä¸ºä»€ä¹ˆå¯¹è§’çº¿çŸ©é˜µå¯ä»¥workï¼‰</p><p>æœ¬ç¯‡æ–‡ç« å°±è¿›ä¸€æ­¥æ¢³ç†äº†SSMä½¿ç”¨å¯¹è§’çº¿çŠ¶æ€æ–¹ç¨‹çš„æœ€ä½³è¡¨è¾¾å½¢å¼</p><h2 id="é›¶é˜¶ä¿æŒç¦»æ•£åŒ–-ZOH"><a href="#é›¶é˜¶ä¿æŒç¦»æ•£åŒ–-ZOH" class="headerlink" title="é›¶é˜¶ä¿æŒç¦»æ•£åŒ–(ZOH)"></a>é›¶é˜¶ä¿æŒç¦»æ•£åŒ–(ZOH)</h2><p>æˆ‘ä»¬é¦–å…ˆæ¥ä»‹ç»ä¸€ä¸‹é›¶é˜¶ä¿æŒç¦»æ•£åŒ–æ–¹æ³•</p><h3 id="çŠ¶æ€æ–¹ç¨‹"><a href="#çŠ¶æ€æ–¹ç¨‹" class="headerlink" title="çŠ¶æ€æ–¹ç¨‹"></a>çŠ¶æ€æ–¹ç¨‹</h3><script type="math/tex; mode=display">\frac{dh(t)}{dt} = Ah(t) + Bx(t)</script><h3 id="æ±‚è§£"><a href="#æ±‚è§£" class="headerlink" title="æ±‚è§£"></a>æ±‚è§£</h3><p>ä½¿ç”¨<strong>ç§¯åˆ†å› å­æ³•</strong>ï¼Œé¦–å…ˆå°†æ–¹ç¨‹æ•´ç†ä¸ºæ ‡å‡†å½¢å¼ï¼š</p><script type="math/tex; mode=display">\frac{dh(t)}{dt} - Ah(t) = Bx(t)</script><p>æ¥ä¸‹æ¥è®¡ç®—ç§¯åˆ†å› å­ $\mu(t)$ï¼š</p><script type="math/tex; mode=display">\mu(t) = exp(\int -Adt) = e^{-At}</script><p>å°†ç§¯åˆ†å› å­ä¹˜ä»¥æ–¹ç¨‹ä¸¤è¾¹ï¼š</p><script type="math/tex; mode=display">e^{-At}\frac{dh(t)}{dt}-Ae^{-At}h(t) = Be^{-At}x(t)</script><p>å·¦è¾¹å˜ä¸ºï¼š</p><script type="math/tex; mode=display">\frac{d}{dt}(e^{-At}h(t)) = Be^{-At}x(t)</script><p>å¯¹ä¸¤è¾¹ç§¯åˆ†ï¼š</p><script type="math/tex; mode=display">\int_{t_0}^t \frac{d}{d\tau}(e^{-A\tau}h(\tau))d\tau=\int_{t_0}^{t}Be^{-A\tau}x(\tau)d\tau</script><p>ç§¯åˆ†åå¾—åˆ°ï¼š</p><script type="math/tex; mode=display">e^{-At}h(t) - e^{-At_0}h(t_0) = \int_{t_0}^{t}Be^{-A\tau}x(\tau)d\tau</script><p>è§£å‡º $h(t)$ï¼š</p><script type="math/tex; mode=display">h(t) = e^{A(t-t_0)}h(t_0) + \int_{t_0}^tBe^{A(t-\tau)}x(\tau)d\tau</script><h3 id="ç¦»æ•£åŒ–"><a href="#ç¦»æ•£åŒ–" class="headerlink" title="ç¦»æ•£åŒ–"></a>ç¦»æ•£åŒ–</h3><p>æˆ‘ä»¬è€ƒè™‘ $ t = t_0 + \Delta$ï¼Œåˆ™ $x(\tau)$ åœ¨è¿™æ®µæ—¶é—´å†…ä¿æŒæ’å®šï¼Œä¸å¦¨è®¾ä¸º $x_k$, åˆ™</p><script type="math/tex; mode=display">\begin{aligned}h(t+\Delta) &= e^{A\Delta}h(t) + \int_t^{t+\Delta}Be^{A(t-\tau)}x_kd\tau \\&= e^{A\Delta}h(t) + (\int_t^{t+\Delta}e^{A(t-\tau)}d\tau)Bx_k \\&= e^{A\Delta}h(t) + (\int_0^{\Delta}e^{A\tau}d\tau)Bx_k\end{aligned}</script><p>å…¶ä¸­ï¼Œ$\int_0^{\Delta}e^{A\tau}d\tau$ çš„ç»“æœå¯ä»¥å¦‚ä¸‹è®¡ç®—å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\frac{d}{dt}e^{At} = Ae^{At}</script><p>ä¸¤è¾¹ç§¯åˆ†å¾—ï¼š</p><script type="math/tex; mode=display">\int Ae^{At}dt = e^{At} + C</script><p>å·¦ä¹˜ $A^{-1}$ å¾—ï¼š</p><script type="math/tex; mode=display">\int e^{At}dt = A^{-1}e^{At} + C</script><p>å¯¹äºå®šç§¯åˆ† $[0ï¼Œ\Delta]$ï¼Œç»“æœæ˜¯ï¼š</p><script type="math/tex; mode=display">\int_0^{\Delta}e^{A\tau}d\tau = A^{-1}(e^{A\Delta}-I)</script><p>ç»¼ä¸Šï¼Œä»£å…¥ç§¯åˆ†ç»“æœï¼ŒåŸæ¥çš„ç¦»æ•£åŒ–æ–¹ç¨‹ä¸ºï¼š</p><script type="math/tex; mode=display">h(t+\Delta) = e^{A\Delta}h(t) + A^{-1}(e^{A\Delta}-I)</script><p>æ‰€ä»¥</p><script type="math/tex; mode=display">\begin{aligned}\bar{A} &= e^{A\Delta} \\\bar{B} &=  A^{-1}(e^{A\Delta}-I)\end{aligned}</script><p>è€Œ SSM ä¸­çš„ $C$ å’Œ $D$ æ˜¯ä¸éœ€è¦ç¦»æ•£åŒ–çš„ï¼Œå› ä¸ºå®ƒæœ¬æ¥å°±æ˜¯åœ¨ç¦»æ•£ç©ºé—´ä¸Šæ›´æ–°çš„ã€‚å…¶å®ä¹Ÿä¸ä¸€å®šéœ€è¦æ˜¯ $xâ€™ = Ch + Dx$ å§ï¼Œä¹Ÿå¯ä»¥æ˜¯ $y = Ch + Dx$ï¼ŒSSMæœ€é‡è¦çš„åªæ˜¯ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ç½¢äº†â€”â€”è¿™ä¸ªçŠ¶æ€æ˜¯å¯¹è®°å¿†ç©ºé—´æ­£äº¤åŸºçš„æŠ•å½±ã€‚</p><h3 id="çŸ©é˜µæŒ‡æ•°"><a href="#çŸ©é˜µæŒ‡æ•°" class="headerlink" title="çŸ©é˜µæŒ‡æ•°"></a>çŸ©é˜µæŒ‡æ•°</h3><p>çŸ©é˜µæŒ‡æ•°çš„å®šä¹‰å‚è€ƒæ ‡é‡æŒ‡æ•°å‡½æ•°çš„æ³°å‹’å±•å¼€ï¼š</p><script type="math/tex; mode=display">e^{At} = I + At + \frac{(At)^2}{2!}+...</script><p>ç³»ç»Ÿçš„ç¨³å®šæ€§ä¸»è¦ç”±çŸ©é˜µæŒ‡æ•° $e^{At}$ å†³å®šï¼Œåˆ†æ $e^{At}$ çš„æ•›æ•£æ€§æ¯”è¾ƒå¤æ‚ä¸”ç»å…¸ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºç»“è®º â€”â€” ç”±çŸ©é˜µ $A$ çš„ç‰¹å¾å€¼çš„å®éƒ¨çš„æ­£è´Ÿå†³å®š</p><ul><li>å½“çŸ©é˜µ $A$ çš„æ‰€æœ‰ç‰¹å¾å€¼çš„å®éƒ¨éƒ½å°äº0æ—¶ï¼ŒçŸ©é˜µæŒ‡æ•°å‡½æ•° $e^{At}$ åœ¨ $t \rightarrow \infty$ æ—¶æ”¶æ•›åˆ°é›¶çŸ©é˜µã€‚</li></ul><h4 id="è¯æ˜"><a href="#è¯æ˜" class="headerlink" title="è¯æ˜"></a>è¯æ˜</h4><div class="note warning flat"><p>æ„ä¼šä¸€ä¸‹ï¼Œä»¥åè¡¥ä¸Šå®Œæ•´è¯æ˜</p></div><p>ä»»ä½•çŸ©é˜µ $A$ éƒ½å¯ä»¥åˆ†è§£ä¸º Jordan æ ‡å‡†å‹ $A = PJP^{-1}$ï¼Œå…¶ä¸­ $J$ æ˜¯ Jordan çŸ©é˜µã€‚å› æ­¤ï¼Œ$e^{At}=Pe^{Jt}P^{-1}$</p><p>æ¯ä¸ª Jordan å—å¯¹åº”ä¸€ä¸ªç‰¹å¾å€¼ $\lambda$ï¼Œå…¶çŸ©é˜µæŒ‡æ•°åŒ…å«å½¢å¦‚ $t^ke^{\lambda t}$çš„é¡¹ï¼ˆå…¶ä¸­ $k$ æ˜¯å¤šé¡¹å¼é¡¹çš„é˜¶æ•°ï¼‰ã€‚å½“ $\lambda$ çš„å®éƒ¨å°äº0æ—¶ï¼ŒæŒ‡æ•°è¡°å‡ $e^{\lambda t}$ ä¼šå‹åˆ¶å¤šé¡¹å¼å¢é•¿ $t^k$ï¼Œä½¿å¾—æ¯ä¸€é¡¹åœ¨ $t \rightarrow \infty$ æ—¶è¶‹äº0</p><p>å› æ­¤æ•´ä¸ªJordan çŸ©é˜µçš„æŒ‡æ•° $e^{Jt}$ è¶‹å‘äºé›¶çŸ©é˜µï¼Œè¿›è€Œ $e^{At} = Pe^{Jt}P^{-1}$ ä¹Ÿè¶‹å‘äºé›¶çŸ©é˜µã€‚</p><h3 id="Left-half-plane-condition"><a href="#Left-half-plane-condition" class="headerlink" title="Left-half plane condition"></a>Left-half plane condition</h3><p>å› æ­¤ï¼Œä¸ºäº†é™åˆ¶ $A$ çš„å®éƒ¨å¤§å°ï¼Œä¸€ä¸ªå¸¸è§çš„æ–¹æ³•æ˜¯ç”¨æŒ‡æ•°å‡½æ•°æ¥åˆ›å»º $A$ çš„å®éƒ¨ï¼š$A = -e^{A_{Re}} + i \cdot A_{Im}$</p><p>è¿™æ ·å®éƒ¨å°±æ€»æ˜¯è´Ÿçš„ï¼Œå¤©æ‰ã€‚</p><p>Albert Gu åœ¨è¿™ç¯‡æ–‡ç« ä¸­æŒ‡å‡ºï¼Œä¸ä¸€å®šè¦ç”¨æŒ‡æ•°å‡½æ•°ï¼Œç”¨ä¸€èˆ¬çš„æ¿€æ´»å‡½æ•°æ¯”å¦‚è¯´ ReLU, softplusä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ç°åœ¨transformersåº“å¯¹mambaçš„å®ç°ä¸­å°±æ˜¯ç”¨çš„expçš„å½¢å¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># transformers/models/mamba2/modeling_mamba2.py</span></span><br><span class="line">A = -torch.exp(self.A_log.<span class="built_in">float</span>())</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Model Structure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mamba </tag>
            
            <tag> Model Structure </tag>
            
            <tag> HiPPO </tag>
            
            <tag> S4 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sparsemax</title>
      <link href="/posts/10035.html"/>
      <url>/posts/10035.html</url>
      
        <content type="html"><![CDATA[<p>ä»‹ç»ä¸€ç¯‡ä¿®æ”¹softmaxçš„æ–‡ç« ï¼Œé¢˜ç›®æ˜¯ï¼š</p><p><a href="https://arxiv.org/pdf/1602.02068" title="950å¼•">[ICML 2016] From Softmax to Sparsemax: A Sparse Model of Attention and Multi-Label Classification</a></p><p>å®ƒå…è®¸softmaxéå¹³æ»‘è¾“å‡ºï¼ŒæŸäº›ä½ç½®çš„probç›´æ¥ä¸º0</p><h1 id="method"><a href="#method" class="headerlink" title="method"></a>method</h1><p>åŸæ¥çš„softmaxå…¬å¼æ˜¯é€šè¿‡ä¸‹é¢çš„è®¡ç®—å¾—åˆ°æ¦‚ç‡åˆ†å¸ƒ</p><script type="math/tex; mode=display">\text{softmax}_i(z) = \frac{e^{z_i}}{\sum_j e^{z_j}}</script><p>ç°åœ¨ï¼Œä½œè€…è€ƒè™‘ç›´æ¥å°†éšçŠ¶æ€å‘ä¸€ä¸ª $K-1$ ç»´çš„å•çº¯å½¢æŠ•å½±ï¼Œæ±‚å¾—çš„ $p$ å³æ˜¯softmaxçš„ç»“æœ</p><script type="math/tex; mode=display">\begin{aligned}\Delta^{K-1} &:=\{p\in \mathbb{R}^K | 1^Tp=1, p \geq 0\} \\\text{sparsemax}(z) &:= \mathop{\arg\max}\limits_{p \in \Delta^{K-1}} ||p-z||^2\end{aligned}</script><h2 id="ä¸ºä»€ä¹ˆæ˜¯K-1ç»´"><a href="#ä¸ºä»€ä¹ˆæ˜¯K-1ç»´" class="headerlink" title="ä¸ºä»€ä¹ˆæ˜¯K-1ç»´"></a>ä¸ºä»€ä¹ˆæ˜¯K-1ç»´</h2><p>å› ä¸ºæœ‰ $1^Tp=1$ çš„é™åˆ¶ï¼Œå¯¼è‡´è‡ªç”±åº¦å‡1</p><p>å’Œ $x+y+z=1$ è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªå¹³é¢è€Œä¸æ˜¯ä¸‰ç»´ç©ºé—´æ˜¯ä¸€ä¸ªé“ç†</p><h2 id="å¦‚ä½•æ±‚è§£"><a href="#å¦‚ä½•æ±‚è§£" class="headerlink" title="å¦‚ä½•æ±‚è§£"></a>å¦‚ä½•æ±‚è§£</h2><p>å°†åŸé—®é¢˜è½¬åŒ–ä¸ºä¸€ä¸ªä¼˜åŒ–é—®é¢˜ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\text{min} \quad & ||p-z||^2 \\s.t. \quad & 1^Tp=1 \\& p \geq 0\end{aligned}</script><p>è€ƒè™‘æ±‚è§£å…¶æ‹‰æ ¼æœ—æ—¥å¯¹å¶é—®é¢˜ï¼š</p><script type="math/tex; mode=display">L(p, \lambda, \mu) = \frac{1}{2} ||p-z||^2 - \lambda^Tp + \mu(1^Tp-1)</script><p>è¿™é‡Œç³»æ•° $\frac{1}{2}$ æ˜¯ä¸ºäº†æ–¹ä¾¿æ±‚å¯¼åæ¶ˆå»ç³»æ•°</p><p>è€ƒè™‘KKTæ¡ä»¶ï¼š</p><script type="math/tex; mode=display">\left\{\begin{aligned}\nabla_p L(p^*, \lambda^*, \mu^*) &= p^*-z-\lambda^*+\mu^*1 \qquad&(1)\\ 1^Tp^* &= 1 &(2)\\ p^* &\geq 0   &(3)\\\lambda^* &\geq 0  &(4)\\\lambda^*p^* &= 0  &(5)\end{aligned}\right.</script><p>å¯¹äº $p_i^{\ast} &gt; 0$ï¼Œç”±äºå¼(5)ï¼Œæ­¤æ—¶å¿…æœ‰ $\lambda_i^{\ast}=0$ï¼Œæ‰€ä»¥ç”±å¼(1)ï¼Œå¾—ï¼š</p><script type="math/tex; mode=display">p_i^* = z_i - \mu, \quad s.t.\quad p_i^* > 0</script><p>ç”±å¼(2)ï¼Œå¾—ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\sum_{i \in K}p_i^* &= 0 + \sum_{i \in S(z)}p_i^* \\1 &= \sum_{i \in S(z)}(z_i - \mu) \\\mu &= \frac{\sum_{i \in S(z)}z_i - 1}{|S(z)|}\end{aligned}</script><p>å…¶ä¸­ï¼Œ$S(z) = \{j \in K \, | \,\, p_j^*&gt;0\}$</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•ä» $z$ å¾—åˆ° $p$ï¼Œå³ï¼š</p><script type="math/tex; mode=display">p = \text{sparsemax}(z) = [z - \mu]_+</script><p>æ±‚å‡º $\mu$ çš„å…³é”®ï¼Œæ˜¯æ±‚å‡ºå¤šå¤§ $|S(z)|$ æ‰èƒ½æ­£å¥½æ»¡è¶³ï¼š</p><ul><li><p>$z_j^* - \mu &gt; 0, \quad \forall j \in S(z)$</p></li><li><p>$z_j^* - \mu \leq 0, \quad \forall j \notin S(z)$</p></li></ul><p>æ³¨æ„ $\mu$ ä¸éšç€ $|S(z)|$ çš„å¢åŠ è€Œå•è°ƒï¼Œæ‰€ä»¥ä¸èƒ½<strong>äºŒåˆ†</strong>æ±‚è§£ï¼Œæœ´ç´ åœ°ç”¨ $O(K)$ çš„å¤æ‚åº¦éå†å¯»æ‰¾ $\mu$</p><div class="note success flat"><p>ä½†æ˜¯ $\Delta \mu$ æ˜¯å•è°ƒçš„ï¼Œæ‰€ä»¥ç†åº”æœ‰æ›´å¿«é€Ÿçš„æœç´¢æ–¹æ³•</p><p>å¦‚æœåªæ˜¯åœ¨ lm_head ä½ç½®å¯¹è¯è¡¨å¤§å° vocab_size åš softmaxï¼Œé‚£å¯èƒ½ç¡®å®é€Ÿåº¦ä¸è¦ç´§</p><p>ä½†æ˜¯å¦‚æœæ˜¯å¯¹attentionåšsoftmaxå°±å®Œè›‹äº†ï¼Œå› ä¸ºå®ƒè¦æ’åºï¼Œæ’åºçš„å¤æ‚åº¦æ˜¯ $O(N \log N)$ã€‚è¿™æ ·å¯¹äºé•¿åº¦ä¸º $N$ çš„ attentionï¼Œå¤æ‚åº¦ç›´æ¥åˆ° $O(KN\log N)$ äº†ï¼Œçˆ†äº†</p><p>æ‰€ä»¥å¦‚æœä¸åšä¿®æ”¹ï¼Œä¸å¯èƒ½ç”¨åˆ°attentioné‡Œ</p></div><h2 id="å…·ä½“ä¾‹å­"><a href="#å…·ä½“ä¾‹å­" class="headerlink" title="å…·ä½“ä¾‹å­"></a>å…·ä½“ä¾‹å­</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªéšçŠ¶æ€ $[1.5,2,0.5]^T$ï¼Œè®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>å¯¹æ‰€æœ‰å…ƒç´ å¤§å°æ’åº $2&gt;1.5&gt;0.5$</p><p>éå† $|S(z)|$ï¼Œä» $|S(z)|=1$ å¼€å§‹ï¼Œæ±‚å‡º $\mu = \frac{2-1}{1} = 1$</p><p>éªŒè¯æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼š</p><script type="math/tex; mode=display">\left\{\begin{aligned}2 - 1 > 0 \\1.5 - 1 < 0 \\0.5 - 1 < 0\end{aligned}\right.</script><p>ä¸æ»¡è¶³ï¼Œç»§ç»­æœï¼Œ$|S(z)|=2$ï¼Œ$\mu = \frac{2+1.5-1}{2} = 1.25$</p><p>éªŒè¯æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼š</p><script type="math/tex; mode=display">\left\{\begin{aligned}2 - 1.25 > 0 \\1.5 - 1.25 > 0 \\0.5 - 1.25 < 0\end{aligned}\right.</script><p>æ»¡è¶³äº†ï¼Œæ‰€ä»¥ $\text{sparsemax}(z) = [0.25, 0.75, 0]$</p>]]></content>
      
      
      <categories>
          
          <category> Model Structure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Model Structure </tag>
            
            <tag> softmax </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Continuous-time Model vs Discrete-time Model</title>
      <link href="/posts/10032.html"/>
      <url>/posts/10032.html</url>
      
        <content type="html"><![CDATA[<h1 id="è¿ç»­æ¨¡å‹"><a href="#è¿ç»­æ¨¡å‹" class="headerlink" title="è¿ç»­æ¨¡å‹"></a>è¿ç»­æ¨¡å‹</h1><h2 id="çŠ¶æ€æ–¹ç¨‹"><a href="#çŠ¶æ€æ–¹ç¨‹" class="headerlink" title="çŠ¶æ€æ–¹ç¨‹"></a>çŠ¶æ€æ–¹ç¨‹</h2><script type="math/tex; mode=display">\frac{dh(t)}{dt} = Ah(t) + Bx(t)</script><h2 id="æ±‚è§£"><a href="#æ±‚è§£" class="headerlink" title="æ±‚è§£"></a>æ±‚è§£</h2><p>ä½¿ç”¨<strong>ç§¯åˆ†å› å­æ³•</strong>ï¼Œé¦–å…ˆå°†æ–¹ç¨‹æ•´ç†ä¸ºæ ‡å‡†å½¢å¼ï¼š</p><script type="math/tex; mode=display">\frac{dh(t)}{dt} - Ah(t) = Bx(t)</script><p>æ¥ä¸‹æ¥è®¡ç®—ç§¯åˆ†å› å­ $\mu(t)$ï¼š</p><script type="math/tex; mode=display">\mu(t) = exp(\int -Adt) = e^{-At}</script><p>å°†ç§¯åˆ†å› å­ä¹˜ä»¥æ–¹ç¨‹ä¸¤è¾¹ï¼š</p><script type="math/tex; mode=display">e^{-At}\frac{dh(t)}{dt}-Ae^{-At}h(t) = Be^{-At}x(t)</script><p>å·¦è¾¹å˜ä¸ºï¼š</p><script type="math/tex; mode=display">\frac{d}{dt}(e^{-At}h(t)) = Be^{-At}x(t)</script><p>å¯¹ä¸¤è¾¹ç§¯åˆ†ï¼š</p><script type="math/tex; mode=display">\int_{t_0}^t \frac{d}{d\tau}(e^{-A\tau}h(\tau))d\tau=\int_{t_0}^{t}Be^{-A\tau}x(\tau)d\tau</script><p>ç§¯åˆ†åå¾—åˆ°ï¼š</p><script type="math/tex; mode=display">e^{-At}h(t) - e^{-At_0}h(t_0) = \int_{t_0}^{t}Be^{-A\tau}x(\tau)d\tau</script><p>è§£å‡º $h(t)$ï¼š</p><script type="math/tex; mode=display">h(t) = e^{A(t-t_0)}h(t_0) + \int_{t_0}^tBe^{A(t-\tau)}x(\tau)d\tau</script><h2 id="ç¦»æ•£åŒ–"><a href="#ç¦»æ•£åŒ–" class="headerlink" title="ç¦»æ•£åŒ–"></a>ç¦»æ•£åŒ–</h2><p>æˆ‘ä»¬è€ƒè™‘ $ t = t_0 + \Delta$ï¼Œåˆ™ $x(\tau)$ åœ¨è¿™æ®µæ—¶é—´å†…ä¿æŒæ’å®šï¼Œä¸å¦¨è®¾ä¸º $x_k$, åˆ™</p><script type="math/tex; mode=display">\begin{aligned}h(t+\Delta) &= e^{A\Delta}h(t) + \int_t^{t+\Delta}Be^{A(t-\tau)}x_kd\tau \\&= e^{A\Delta}h(t) + (\int_t^{t+\Delta}e^{A(t-\tau)}d\tau)Bx_k \\&= e^{A\Delta}h(t) + (\int_0^{\Delta}e^{A\tau}d\tau)Bx_k\end{aligned}</script><p>å…¶ä¸­ï¼Œ$\int_0^{\Delta}e^{A\tau}d\tau$ çš„ç»“æœå¯ä»¥å¦‚ä¸‹è®¡ç®—å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\frac{d}{dt}e^{At} = Ae^{At}</script><p>ä¸¤è¾¹ç§¯åˆ†å¾—ï¼š</p><script type="math/tex; mode=display">\int Ae^{At}dt = e^{At} + C</script><p>å·¦ä¹˜ $A^{-1}$ å¾—ï¼š</p><script type="math/tex; mode=display">\int e^{At}dt = A^{-1}e^{At} + C</script><p>å¯¹äºå®šç§¯åˆ† $[0ï¼Œ\Delta]$ï¼Œç»“æœæ˜¯ï¼š</p><script type="math/tex; mode=display">\int_0^{\Delta}e^{A\tau}d\tau = A^{-1}(e^{A\Delta}-I)</script><p>ç»¼ä¸Šï¼Œä»£å…¥ç§¯åˆ†ç»“æœï¼ŒåŸæ¥çš„ç¦»æ•£åŒ–æ–¹ç¨‹ä¸ºï¼š</p><script type="math/tex; mode=display">h(t+\Delta) = e^{A\Delta}h(t) + A^{-1}(e^{A\Delta}-I)</script><p>æ‰€ä»¥</p><script type="math/tex; mode=display">\begin{aligned}\bar{A} &= e^{A\Delta} \\\bar{B} &=  A^{-1}(e^{A\Delta}-I)\end{aligned}</script><p>è€ŒMambaä¸­çš„ $C$ å’Œ $D$ æ˜¯ä¸éœ€è¦ç¦»æ•£åŒ–çš„ï¼Œå› ä¸ºå®ƒæœ¬æ¥å°±æ˜¯åœ¨ç¦»æ•£ç©ºé—´ä¸Šæ›´æ–°çš„ã€‚å…¶å®ä¹Ÿä¸ä¸€å®šéœ€è¦æ˜¯ $xâ€™ = Ch + Dx$ å§ï¼Œä¹Ÿå¯ä»¥æ˜¯ $y = Ch + Dx$ï¼ŒSSMæœ€é‡è¦çš„åªæ˜¯ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ç½¢äº†â€”â€”è¿™ä¸ªçŠ¶æ€æ˜¯å¯¹è®°å¿†ç©ºé—´æ­£äº¤åŸºçš„æŠ•å½±ã€‚</p><h2 id="çŸ©é˜µæŒ‡æ•°"><a href="#çŸ©é˜µæŒ‡æ•°" class="headerlink" title="çŸ©é˜µæŒ‡æ•°"></a>çŸ©é˜µæŒ‡æ•°</h2><p>çŸ©é˜µæŒ‡æ•°çš„å®šä¹‰å‚è€ƒæ ‡é‡æŒ‡æ•°å‡½æ•°çš„æ³°å‹’å±•å¼€ï¼š</p><script type="math/tex; mode=display">e^{At} = I + At + \frac{(At)^2}{2!}+...</script><h2 id="ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶"><a href="#ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶" class="headerlink" title="ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶"></a>ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶</h2><p>ç³»ç»Ÿçš„ç¨³å®šæ€§ä¸»è¦ç”±çŸ©é˜µæŒ‡æ•° $e^{At}$ å†³å®šï¼Œåˆ†æ $e^{At}$ çš„æ•›æ•£æ€§æ¯”è¾ƒå¤æ‚ä¸”ç»å…¸ï¼Œè¿™é‡Œç›´æ¥ç»™å‡ºç»“è®º â€”â€” ç”±çŸ©é˜µ $A$ çš„ç‰¹å¾å€¼çš„å®éƒ¨çš„æ­£è´Ÿå†³å®š</p><ul><li>å½“çŸ©é˜µ $A$ çš„æ‰€æœ‰ç‰¹å¾å€¼çš„å®éƒ¨éƒ½å°äº0æ—¶ï¼ŒçŸ©é˜µæŒ‡æ•°å‡½æ•° $e^{At}$ åœ¨ $t \rightarrow \infty$ æ—¶æ”¶æ•›åˆ°é›¶çŸ©é˜µã€‚</li></ul><h3 id="è¯æ˜"><a href="#è¯æ˜" class="headerlink" title="è¯æ˜"></a>è¯æ˜</h3><div class="note warning flat"><p>æ„ä¼šä¸€ä¸‹ï¼Œä»¥åè¡¥ä¸Šå®Œæ•´è¯æ˜</p></div><p>ä»»ä½•çŸ©é˜µ $A$ éƒ½å¯ä»¥åˆ†è§£ä¸º Jordan æ ‡å‡†å‹ $A = PJP^{-1}$ï¼Œå…¶ä¸­ $J$ æ˜¯ Jordan çŸ©é˜µã€‚å› æ­¤ï¼Œ$e^{At}=Pe^{Jt}P^{-1}$</p><p>æ¯ä¸ª Jordan å—å¯¹åº”ä¸€ä¸ªç‰¹å¾å€¼ $\lambda$ï¼Œå…¶çŸ©é˜µæŒ‡æ•°åŒ…å«å½¢å¦‚ $t^ke^{\lambda t}$çš„é¡¹ï¼ˆå…¶ä¸­ $k$ æ˜¯å¤šé¡¹å¼é¡¹çš„é˜¶æ•°ï¼‰ã€‚å½“ $\lambda$ çš„å®éƒ¨å°äº0æ—¶ï¼ŒæŒ‡æ•°è¡°å‡ $e^{\lambda t}$ ä¼šå‹åˆ¶å¤šé¡¹å¼å¢é•¿ $t^k$ï¼Œä½¿å¾—æ¯ä¸€é¡¹åœ¨ $t \rightarrow \infty$ æ—¶è¶‹äº0</p><p>å› æ­¤æ•´ä¸ªJordan çŸ©é˜µçš„æŒ‡æ•° $e^{Jt}$ è¶‹å‘äºé›¶çŸ©é˜µï¼Œè¿›è€Œ $e^{At} = Pe^{Jt}P^{-1}$ ä¹Ÿè¶‹å‘äºé›¶çŸ©é˜µã€‚</p><h1 id="ç¦»æ•£æ¨¡å‹"><a href="#ç¦»æ•£æ¨¡å‹" class="headerlink" title="ç¦»æ•£æ¨¡å‹"></a>ç¦»æ•£æ¨¡å‹</h1><h2 id="çŠ¶æ€æ–¹ç¨‹-1"><a href="#çŠ¶æ€æ–¹ç¨‹-1" class="headerlink" title="çŠ¶æ€æ–¹ç¨‹"></a>çŠ¶æ€æ–¹ç¨‹</h2><script type="math/tex; mode=display">h_{t+1} = Ah_t</script><h2 id="æ±‚è§£-1"><a href="#æ±‚è§£-1" class="headerlink" title="æ±‚è§£"></a>æ±‚è§£</h2><script type="math/tex; mode=display">h_t = A^th_0</script><h2 id="ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶-1"><a href="#ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶-1" class="headerlink" title="ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶"></a>ç¨³å®šæ€§çš„æ•°å­¦æ¡ä»¶</h2><p>ç”±çŸ©é˜µ $A$ çš„è°±åŠå¾„å†³å®š</p>]]></content>
      
      
      <categories>
          
          <category> Model Structure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mamba </tag>
            
            <tag> Math </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part II of Mathematical Structure of Mamba - S4</title>
      <link href="/posts/10039.html"/>
      <url>/posts/10039.html</url>
      
        <content type="html"><![CDATA[<div class="note success flat"><p>æœ¬ç¯‡æ˜¯mambaç³»åˆ—blogçš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œç³»åˆ—æ–‡ç« è§ï¼š</p><ul><li><p><a href="https://anti-entrophic.github.io/posts/10038.html" title="Part I of Mathematical Structure of Mamba - Hippo">Part I of Mathematical Structure of Mamba - Hippo</a></p></li><li><p>Part II of Mathematical Structure of Mamba - S4</p></li><li><p><a href="https://anti-entrophic.github.io/posts/10040.html" title="Part III of Mathematical Structure of Mamba - S4D">Part III of Mathematical Structure of Mamba - S4D</a></p></li></ul><p>å‰©ä½™é¢„è®¡è¿˜æœ‰ä¸¤ç¯‡æ–‡ç« æ­£åœ¨ç”Ÿäº§ä¸­~</p></div><h1 id="ICLR22-S4-Efficiently-Modeling-Long-Sequences-with-Structured-State-Spaces"><a href="#ICLR22-S4-Efficiently-Modeling-Long-Sequences-with-Structured-State-Spaces" class="headerlink" title="[ICLR22] S4: Efficiently Modeling Long Sequences with Structured State Spaces"></a>[ICLR22] S4: Efficiently Modeling Long Sequences with Structured State Spaces</h1><h2 id="State-space-model"><a href="#State-space-model" class="headerlink" title="State space model"></a>State space model</h2><p>å‰ä¸€ç¯‡æ–‡ç« ä»‹ç»çš„HiPPOä¸ºæˆ‘ä»¬å¥ å®šäº†åœ¨ç¦»æ•£æ—¶é—´ç³»ç»Ÿä¸‹ç»´æŠ¤æ¨¡å‹çŠ¶æ€çš„æ–¹æ³•ã€‚è§† $c_k$ ä¸ºæ¨¡å‹å½“å‰çš„çŠ¶æ€ï¼Œ$f_k$ ä¸ºæ¨¡å‹å½“å‰çš„è¾“å…¥åºåˆ—ï¼Œå³å¯é€šè¿‡å…¬å¼æ›´æ–°å¾—åˆ°æ¨¡å‹åç»­çš„çŠ¶æ€ $c_{k+1}$ï¼Œè¿™æ˜¯ä¸€ä¸ªRNN-likeçš„ç»“æ„ã€‚æ— ç‹¬æœ‰å¶ï¼Œåœ¨å·¥ç¨‹å­¦ç§‘ä¸­çš„çŠ¶æ€ç©ºé—´æ¨¡å‹ï¼ˆState Space Modelï¼‰ä¹Ÿæœ‰ç±»ä¼¼çš„ç»“æ„ï¼š</p><script type="math/tex; mode=display">\begin{aligned}x'(t) &= Ax(t) + Bu(t) \\y(t)  &= Cx(t) + Du(t)\end{aligned}</script><p>ç›´è§‚ç†è§£ï¼Œ$A$ ä»£è¡¨äº†æ¨¡å‹å½“å‰çŠ¶æ€å¦‚ä½•å½±å“åç»­çŠ¶æ€ï¼Œ$B$ ä»£è¡¨äº†æ¨¡å‹å½“å‰è¾“å…¥å¦‚ä½•å½±å“åç»­çŠ¶æ€ï¼Œ$C$ ä»£è¡¨äº†æ¨¡å‹å½“å‰çŠ¶æ€å¦‚ä½•å½±å“æ¨¡å‹è¾“å‡ºï¼Œ$D$ ä»£è¡¨äº†æ¨¡å‹å½“å‰è¾“å…¥å¦‚ä½•å½±å“æ¨¡å‹è¾“å‡ºã€‚</p><p>æˆ‘ä»¬å¯ä»¥å¯¹è¿™å»ºç«‹åœ¨è¿ç»­ä¿¡å·ä¸Šçš„å…¬å¼ç¦»æ•£åŒ–ï¼Œå¾—åˆ°ç¦»æ•£æ•°æ®ä¸Šçš„å½¢å¼ï¼š</p><script type="math/tex; mode=display">\begin{aligned}x_k &= \bar{A}x_{k-1} + \bar{B}u_k \\y_k &= \bar{C}x_k + \bar{D}u_k\end{aligned}</script><p>$\bar{A}, \bar{B}, \bar{C}, \bar{D}$ çš„å…·ä½“å½¢å¼å¯ä»¥é€šè¿‡ä¸åŒçš„ç¦»æ•£åŒ–æ–¹æ³•ï¼ˆå‰å‘æ¬§æ‹‰ã€åå‘æ¬§æ‹‰ã€åŒçº¿æ€§ç­‰ï¼‰ä» $A,B,C,D$ å¾—åˆ°ã€‚è¿™ç§å½¢å¼çš„SSMå¯ä»¥åœ¨ç¦»æ•£æ•°æ®ä¸Šè®¡ç®—ï¼Œå¹¶ä¸”è®¡ç®—æ–¹å¼æ˜¯step-by-stepçš„ã€‚</p><p>ä¾‹å¦‚ï¼Œå¯¹äºåŒçº¿æ€§ç¦»æ•£åŒ–æ–¹æ³•æœ‰ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\bar{A}&=(I-\frac{\Delta}{2}A)^{-1}(I+\frac{\Delta}{2}A) \\\bar{B}&=(I-\frac{\Delta}{2}A)^{-1}\Delta B\end{aligned}</script><h3 id="å»ºæ¨¡"><a href="#å»ºæ¨¡" class="headerlink" title="å»ºæ¨¡"></a>å»ºæ¨¡</h3><p>æˆ‘ä»¬é¦–å…ˆå¿½ç•¥ $\bar{D}$ ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„æ®‹å·®è¿æ¥ã€‚</p><p>å¯¹äºç¦»æ•£å½¢å¼å…¬å¼åšç®€å•æ¨å¯¼ï¼š</p><script type="math/tex; mode=display">\begin{aligned}x_0 &= \bar{B}u_0 & x_1 &= \bar{A}\bar{B}u_0+\bar{u_1} & x_2 &= \bar{A}^2\bar{B}u_0+\bar{A}\bar{B}u_1 + \bar{B}u_2 \\y_0 &=  \bar{C}\bar{B}u_0 & y_1 &= \bar{C}\bar{A}\bar{B}u_0 + \bar{C}\bar{B}u_1 & y_2 &= \bar{C}\bar{A}^2\bar{B}u_0 + \bar{C}\bar{A}\bar{B}u_1 + \bar{C}{B}u_2\end{aligned}</script><p>å¯ä»¥çœ‹åˆ°ç¬¬ $k$ æ­¥çš„è¾“å‡ºå…·æœ‰é€šé¡¹å½¢å¼ï¼š</p><script type="math/tex; mode=display">\begin{aligned}x_k &= \sum_{i=0}^k\bar{A}^{k-i}\bar{B}u_i\\y_k &= \sum_{i=0}^k\bar{C}\bar{A}^{k-i}\bar{B}u_i\end{aligned}</script><p>è¿™æ˜¯ä¸€ä¸ªå·ç§¯æ ¸ä¸ºåºåˆ—é•¿åº¦çš„å·ç§¯ï¼Œå¯ä»¥è®°ä½œï¼š</p><script type="math/tex; mode=display">y = \bar{K} * u, \quad \bar{K}\in \mathbb{R}^{L}:=\mathcal{K}_L(\bar{A}, \bar{B}, \bar{C}):=(\bar{C}\bar{A}^{i}\bar{B})_{i\in[L]} = (\bar{C}\bar{B}, \bar{C}\bar{A}\bar{B}, ..., \bar{C}\bar{A}^{L-1}\bar{B})</script><p>å› æ­¤ï¼ŒState Space Modelæ—¢å¯ä»¥å»ºæ¨¡ä¸ºRNNï¼Œä¹Ÿå¯ä»¥å»ºæ¨¡ä¸ºCNNã€‚åœ¨æˆ‘çš„ç†è§£ä¸­ï¼Œprefillé˜¶æ®µå°±å¯ä»¥ä½¿ç”¨å·ç§¯å½¢å¼ï¼Œç»“åˆ<a href="https://oi-wiki.org/math/poly/fft/#%E7%A6%BB%E6%95%A3%E5%82%85%E9%87%8C%E5%8F%B6%E5%8F%98%E6%8D%A2" title="oi-wiki">ç¦»æ•£å‚…é‡Œå¶å˜æ¢DFT</a>ï¼Œåªéœ€è¦å…ˆå˜æ¢åˆ°é¢‘åŸŸä¸Šå†é€ç‚¹ç›¸ä¹˜å³å¯ï¼ˆ$\mathcal{F}\{f*g\} = F(f) \cdot F(G)$ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(L\log L)$ï¼›åç»­æ¨ç†ç»§ç»­ç”¨RNNå½¢å¼è‡ªå›å½’åœ°ç”Ÿæˆï¼Œå¤æ‚åº¦ä¸º $O(L)$ã€‚</p><div class="note warning flat"><p>è¿™é‡Œæˆ‘è€ƒè™‘å¾—éå¸¸ä¸ä¸¥è°¨ï¼Œå®é™…ä¸Šæˆ‘è‡ªå·±ä¹Ÿæ²¡æƒ³æ¸…æ¥šã€‚æ—¶é—´å¤æ‚åº¦ç“¶é¢ˆè¿˜å¯èƒ½å—åˆ°ï¼ŒçŸ©é˜µä¹˜æ³•çš„å¤æ‚åº¦ï¼Œå¯¹çŸ©é˜µè¿›è¡Œå‚…é‡Œå¶å˜æ¢çš„å¤æ‚åº¦ï¼Œç®—å­å®ç°ç­‰çš„å½±å“ã€‚å¦‚æœæƒ³è¦ä¸¥æ ¼è®¨è®ºæ—¶é—´å¤æ‚åº¦ï¼Œå¯èƒ½é…åˆä»£ç åˆ†ææ›´åŠ åˆé€‚ã€‚</p></div><h2 id="ç»“æ„åŒ–çŠ¶æ€ç©ºé—´"><a href="#ç»“æ„åŒ–çŠ¶æ€ç©ºé—´" class="headerlink" title="ç»“æ„åŒ–çŠ¶æ€ç©ºé—´"></a>ç»“æ„åŒ–çŠ¶æ€ç©ºé—´</h2><p>åœ¨S4çš„å‰ç½®å·¥ä½œä¸­ï¼Œä½œè€…å‘ç°éšæœºåˆå§‹åŒ–çš„SSMæ€§èƒ½éå¸¸å·®ï¼Œä½†ä½¿ç”¨HiPPO Matrixå¯¹ $A$ åˆå§‹åŒ–ï¼š</p><script type="math/tex; mode=display">(\text{HiPPO Matrix}) \quad A_{nk} = -\left\{\begin{matrix}(2n+1)^{\frac{1}{2}}(2k+1)^{\frac{1}{2}} & \text{if} \quad n>k \\n+1 & \text{if} \quad n=k \\0 & \text{if} \quad n<k\end{matrix}\right. \\</script><p>å°±å–å¾—äº†éå¸¸å¤§çš„æ€§èƒ½æå‡ã€‚ä¾‹å¦‚ï¼Œä»…ä»…å¯¹çŸ©é˜µ $A$ ä»éšæœºåˆå§‹åŒ–æ”¹æˆHiPPOåˆå§‹åŒ–å°±åœ¨sequential MNISTä¸ŠæŠŠæ€§èƒ½ä»60%æå‡åˆ°äº†98%ï¼Œè¿™æ­¥å¯ä»¥ç§°ä¸ºæ˜¯ç»“æ„åŒ–ã€‚</p><div class="note warning flat"><p>æ³¨æ„è¿™é‡ŒæŠŠä¹‹å‰å…¬å¼ä¸­ï¼Œå¤–é¢çš„è´Ÿå·æ”¾è¿›æ¥äº†ã€‚</p></div><h2 id="é«˜æ•ˆç®—æ³•"><a href="#é«˜æ•ˆç®—æ³•" class="headerlink" title="é«˜æ•ˆç®—æ³•"></a>é«˜æ•ˆç®—æ³•</h2><p>ä¸è¿‡ï¼Œå¯¹SSMè¿›è¡Œç›´æ¥è®¡ç®—å­˜åœ¨æ•ˆç‡ä¸Šçš„é—®é¢˜ï¼š</p><ul><li><p>å¯¹äºRecurrentå½¢å¼çš„SSMï¼Œç”±äºå‚æ•°å¯å­¦ä¹ ï¼Œå› æ­¤åœ¨æ¯ä¸€æ­¥ä¸Šéƒ½éœ€è¦é‡æ–°è®¡ç®— $\bar{A}=(I-\frac{\Delta}{2}A)^{-1}(I+\frac{\Delta}{2}A)$ ï¼Œéœ€è¦è¿›è¡ŒçŸ©é˜µ-çŸ©é˜µç›¸ä¹˜ã€‚å¦‚æœèƒ½æ‰¾åˆ°æŸç§åŸºäºçŸ©é˜µ-å‘é‡ä¹˜ç§¯çš„è®¡ç®—æ–¹æ³•ï¼Œè®¡ç®—é‡å°†å¤§å¹…é™ä½ã€‚</p></li><li><p>å¯¹äºConvolutionalå½¢å¼çš„SSMï¼Œé™¤äº† $DFT$ çš„åŠ é€Ÿï¼Œè®¡ç®—ç“¶é¢ˆè¿˜åœ¨å·ç§¯æ ¸çš„è®¡ç®—ä¸Šã€‚é•¿åº¦ä¸º $L$ çš„å·ç§¯æ ¸ $\bar{K}$ åŒ…å«çŸ©é˜µ $\bar{A}^{L-1}$ ï¼Œå³HiPPOçŸ©é˜µ $\bar{A}$ çš„ $L-1$ æ¬¡å¹‚ã€‚éœ€è¦æ‰¾åˆ°è¯¥é«˜é˜¶çŸ©é˜µå¹‚çš„å¿«é€Ÿç®—æ³•ã€‚</p></li></ul><p>å¯¹äºåŸå§‹çš„æ›´æ–°å…¬å¼ï¼š</p><script type="math/tex; mode=display">\begin{aligned}x_k &= \bar{A}x_{k-1} + \bar{B}u_k \\y_k &= \bar{C}x_k + \bar{D}u_k\end{aligned}</script><p>å¦‚æœä»¤ $(A,B,C)\sim (V^{-1}AV, V^{-1}B, CV)$ï¼Œè¿™å®é™…ä¸Šæ˜¯å¯¹stateè¿›è¡Œäº†ä¸€ä¸ªçº¿æ€§å˜æ¢ $x_k=V\bar{x}_k$</p><p>å¦‚æœæˆ‘ä»¬èƒ½æ‰¾åˆ°æ€§è´¨è‰¯å¥½çš„çŸ©é˜µ $V$ å¯¹HiPPOçŸ©é˜µ $A$ è¿›è¡Œè§„èŒƒåŒ–ï¼Œæ¯”å¦‚å°† $A$ å¯¹è§’åŒ–ï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“è®¡ç®— $V^{-1}AV$ çš„é«˜æ¬¡å¹‚</p><p>äº‹å®ä¸Šç¡®å®å­˜åœ¨è¿™æ ·çš„å¯¹è§’åŒ–æ–¹æ³•ã€‚S4çš„ä½œè€…è¯æ˜ï¼Œå¯¹äºæ‰€æœ‰çš„HiPPO Matrixï¼ˆHiPPO-LegSã€HiPPO-LegTã€HiPPO-LagTï¼‰ï¼Œéƒ½å¯ä»¥ç”¨çŸ©é˜µ $V_{ij} = \begin{pmatrix} i+j \\ i-j \end{pmatrix}$ è¿›è¡Œå¯¹è§’åŒ–ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯ç»„åˆæ•°ï¼‰ã€‚ç„¶è€Œç›´æ¥å¯¹ $A$ è¿›è¡Œè¿™æ ·çš„å¯¹è§’åŒ–ä¼šæœ‰æ•°å€¼ç¨³å®šæ€§ä¸Šçš„é—®é¢˜ï¼Œå› ä¸ºå¾ˆå®¹æ˜“å¾—åˆ°:</p><script type="math/tex; mode=display">\begin{aligned}V_{3i,i} =\begin{pmatrix} 4i \\ 2i \end{pmatrix} & = \frac{(4i)!}{(2i)!(2i)!}\\& \approx \frac{\sqrt{8\pi i}(\frac{4i}{e})^{4i}}{4\pi i (\frac{2i}{e})^{4i}}, \quad \text{æ ¹æ®stirlingå…¬å¼} \quad n! \approx \sqrt{2\pi n}(\frac{n}{e})^n \\ & = \frac{2^{4i}}{\sqrt{2\pi i}} \\& \approx 2^{4i}\end{aligned}</script><p>å³çŸ©é˜µ $V$ ä¸­æœ€å¤§å…ƒç´ çš„å€¼çš„å¤§å°å‡ ä¹æ˜¯æŒ‡æ•°å¢åŠ çš„ï¼Œåæ˜ åœ¨å®é™…è¿è¡Œæ—¶ï¼Œåºåˆ—é•¿åº¦ $L$ åªè¦ç¨å¾®å¤§ä¸€ç‚¹ï¼Œå·ç§¯æ ¸ä¸­å°±ä¼šå‡ºç° NaN</p><h3 id="Normal-Plus-Low-Rank"><a href="#Normal-Plus-Low-Rank" class="headerlink" title="Normal Plus Low-Rank"></a>Normal Plus Low-Rank</h3><p>ç›´æ¥ä½¿ç”¨ $V_{ij}=\begin{pmatrix} i+j \\ i-j \end{pmatrix}$ è™½ç„¶å¯ä»¥è¿›è¡Œå¯¹è§’åŒ–ï¼Œä½†ä¼šæœ‰ç¨³å®šæ€§é—®é¢˜ã€‚å¦‚æœçŸ©é˜µ $A$ ä¸ºæ­£è§„çŸ©é˜µï¼Œåˆ™å¯ä»¥ç”¨é…‰çŸ©é˜µå¯¹ $A$ è¿›è¡Œé…‰å¯¹è§’åŒ–ã€‚ä¸å¹¸çš„æ˜¯æ‰€æœ‰HiPPO matrixéƒ½ä¸æ˜¯æ­£è§„çŸ©é˜µã€‚</p><p>è™½ç„¶æ— æ³•ç›´æ¥å¯¹ $A$ è¿›è¡Œç¨³å®šçš„å¯¹è§’åŒ–ï¼Œä½†æˆ‘ä»¬è§‚å¯Ÿåˆ°ï¼Œæ‰€æœ‰çš„HiPPO matrixéƒ½èƒ½è¢«åˆ†è§£ä¸ºä¸€ä¸ªæ­£è§„çŸ©é˜µå’Œä¸€ä¸ªä½ç§©çŸ©é˜µçš„å’Œã€‚</p><script type="math/tex; mode=display">\quad A_{nk} = -\left\{\begin{matrix}(2n+1)^{\frac{1}{2}}(2k+1)^{\frac{1}{2}} & \text{if} \quad n>k \\n+1 & \text{if} \quad n=k \\0 & \text{if} \quad n<k\end{matrix}\right. \\</script><p>å¯¹çŸ©é˜µç›¸åŠ ä¸€ä¸ªæ¯ä¸ªå…ƒç´ å‡ä¸º $\frac{1}{2}(2n+1)^{\frac{1}{2}}(2k+1)^{\frac{1}{2}}$ çš„çŸ©é˜µï¼ˆä½ç§©ï¼Œç§©ä¸º1ï¼‰ï¼Œå¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">-\left\{\begin{matrix}\frac{1}{2}(2n+1)^{\frac{1}{2}}(2k+1)^{\frac{1}{2}} & \text{if} \quad n>k \\\frac{1}{2} & \text{if} \quad n=k \\-\frac{1}{2}(2n+1)^{\frac{1}{2}}(2k+1)^{\frac{1}{2}} & \text{if} \quad n<k\end{matrix}\right. \\</script><p>è¿™ä¸ªçŸ©é˜µç­‰äºä¸€ä¸ªå•ä½é˜µ $-\frac{1}{2}I$ åŠ ä¸€ä¸ªæ–œå¯¹ç§°çŸ©é˜µ $S$ ï¼Œæ–œå¯¹ç§°çŸ©é˜µæ˜¯æ­£è§„çŸ©é˜µçš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œå¯ä»¥ç”¨é…‰çŸ©é˜µè¿›è¡Œå¯¹è§’åŒ–ã€‚è™½ç„¶ $-\frac{1}{2}I+S$ ä¸å†æ˜¯æ–œå¯¹ç§°çŸ©é˜µï¼Œä½†å®ƒä»å¯ä»¥ä½¿ç”¨æŸäº›ä½¿ $S$ å¯¹è§’åŒ–çš„é…‰çŸ©é˜µè¿›è¡Œå¯¹è§’åŒ–ï¼Œå³ä»ä¸ºæ­£è§„çŸ©é˜µã€‚</p><p>æ­£å¼åœ°ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰HiPPO Matrixè¡¨ç¤ºä¸º<strong>NPLR</strong>ï¼ˆNormal Plus Low-Rankï¼‰:</p><script type="math/tex; mode=display">A = V \Lambda V^* - PQ^T</script><p>å…¶ä¸­ $PQ^T$ ä¸ºä½ç§©åˆ†è§£ï¼Œåƒä¸Šæ–‡HiPPO-LegSçš„ä½ç§©çŸ©é˜µç›´æ¥å°±æ˜¯ç§©ä¸º1ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ†è§£ä¸ºä¸¤ä¸ªå‘é‡çš„ä¹˜ç§¯ã€‚</p><p>ä¸ºäº†åç»­çš„é¢‘åŸŸè®¡ç®—ï¼Œæˆ‘ä»¬ä»è¿™é‡Œå¼€å§‹å°†çŸ©é˜µçš„å®šä¹‰æ‰©å±•åˆ°å¤æ•°ç©ºé—´ã€‚è¿›è¡Œä¸€äº›å˜æ¢æˆ‘ä»¬å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">A = V \Lambda V^* - PQ^T = V(\Lambda-(V^{*}P)(V^*Q)^*)V^*</script><p>å› æ­¤ï¼Œè®¡ç®— $A$ çš„é«˜æ¬¡å¹‚è½¬åŒ–ä¸ºå¯¹ $\Lambda - ({V^{\ast}} P)({V^{\ast}} Q)^{\ast} $ çš„è®¡ç®—ã€‚è¿™ä¸ªçŸ©é˜µå…·æœ‰æ›´è‰¯å¥½çš„å½¢å¼ï¼Œç§°ä¸º<strong>DPLR</strong> (Diagonal Plus Low-Rank)ã€‚ç„¶è€Œå³ä½¿æ˜¯DPLRï¼Œåˆ°è¿™ä¸€æ­¥ä»ç„¶ä¸å¥½è®¡ç®—ã€‚æ¥ä¸‹æ¥é’ˆå¯¹ä¸¤ç§æ¨¡å¼çš„SSMï¼Œå³RNN viewï¼ˆæ¨ç†ï¼‰å’ŒCNN viewï¼ˆè®­ç»ƒï¼‰ï¼Œåˆ†åˆ«ç”¨çŸ©é˜µç†è®ºè¿›è¡Œæ¨å¯¼ï¼Œæ‰¾åˆ°é«˜æ•ˆçš„è®¡ç®—æ–¹æ³•ã€‚</p><h3 id="RNN-view"><a href="#RNN-view" class="headerlink" title="RNN view"></a>RNN view</h3><p>æ ¹æ®å‰é¢çš„æ¨å¯¼ï¼Œæˆ‘ä»¬çŸ¥é“æ‰€æœ‰HiPPO Matriceséƒ½å¯ä»¥è¡¨ç¤ºä¸ºDPLRï¼Œä¸å¤±ä¸€èˆ¬æ€§ï¼Œæˆ‘ä»¬è®°ä¸º $A=\Lambda - PQ^{\ast}$ã€‚</p><p>åœ¨S4ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åŒçº¿æ€§ç¦»æ•£åŒ–æ–¹æ³•ï¼Œå‡è®¾æ­¥é•¿ä¸º $\Delta$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\bar{A}&=(I-\frac{\Delta}{2}A)^{-1}(I+\frac{\Delta}{2}A) \\\bar{B}&=(I-\frac{\Delta}{2}A)^{-1}\Delta B\end{aligned}</script><p>åˆ†åˆ«è®¡ç®—ä¸¤ä¸ªç›¸ä¹˜é¡¹ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><script type="math/tex; mode=display">\begin{aligned}I+\frac{\Delta}{2}A &= I + \frac{\Delta}{2}(\Lambda-PQ^*) \\&= \frac{\Delta}{2} [\frac{2}{\Delta}I + (\Lambda - PQ^*)] \\&= \frac{\Delta}{2} A_0\end{aligned}</script><script type="math/tex; mode=display">\begin{aligned}(I-\frac{\Delta}{2}A)^{-1} &= (I - \frac{\Delta}{2}(\Lambda-PQ^{\ast}))^{-1} \\&= \frac{2}{\Delta}[\frac{2}{\Delta} - \Lambda + PQ^{\ast}]\end{aligned}</script><p>ä½¿ç”¨<strong>Woodbury matrix identity</strong>: $(A+UCV)^{-1} = A^{-1} - A^{-1}U(C^{-1}+VA^{-1}U)^{-1}VA^{-1}$ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}(I-\frac{\Delta}{2}A)^{-1} &= \frac{2}{\Delta}[D-DP(I+Q^{\ast}DP)^{-1}Q^{\ast}D] \\ &= \frac{2}{\Delta} A_1\end{aligned}</script><p>å…¶ä¸­ $A_0 = \frac{2}{\Delta}I + (\Lambda - PQ^{\ast}), D = (\frac{2}{\Delta}-\Lambda)^{-1}, A_1 = D-DP(I + Q^{\ast}DP) ^{-1}Q^{\ast}D$</p><p>ä»£å…¥å¯å¾—ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\bar{A} &= A_1A_0 \\\bar{B} &= \frac{2}{\Delta} A_1 \Delta B = 2A_1 B \end{aligned}</script><p>å†å°†ä¸Šå¼ä»£å…¥ç¦»æ•£SSMï¼Œå¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}x_k &= \bar{A}x_{k-1} + \bar{B}u_k \\&= A_1A_0x_{k-1} + 2A_1B_{u_k} \\y_k &= Cx_k\end{aligned}</script><p>æ³¨æ„åˆ° $A_0, A_1$ çš„ç»„æˆå‡ä¸ºå•ä½é˜µã€å¯¹è§’é˜µå’Œä½ç§©çŸ©é˜µï¼Œå› æ­¤ $A_1, A_0$çš„è®¡ç®—ä»…åŒ…å«çŸ©é˜µ-å‘é‡ä¹˜æ³•ï¼ŒRNN viewè®¡ç®—ä¸€æ­¥çš„å¤æ‚åº¦ä¸º $O(N)$</p><h3 id="CNN-view"><a href="#CNN-view" class="headerlink" title="CNN view"></a>CNN view</h3><p>æˆ‘ä»¬ç¨å¾®å¯¹ç¬¦å·è¿›è¡Œä¸€ç‚¹ä¿®æ”¹ä¾¿äºåé¢çš„æ¨å¯¼ï¼ˆå°† $C$ è®°ä¸ºåˆ—å‘é‡ï¼‰ï¼š</p><script type="math/tex; mode=display">\begin{aligned}x'(t) &= Ax(t) + Bu(t) \\y(t) &= C^{\ast}x(t) + Du(t)\end{aligned}</script><p>æˆ‘ä»¬å¾—åˆ°çš„é•¿åº¦ä¸º $L$ çš„å·ç§¯æ ¸ä¸ºï¼š</p><script type="math/tex; mode=display">\mathcal{K}_L(\bar{A}, \bar{B}, \bar{C}) = (\bar{C}^{\ast}\bar{B}, \bar{C}^{\ast}\bar{A}\bar{B}, ..., \bar{C}^{\ast}\bar{A}^{L-1}\bar{B}) \in \mathbb{R}^L</script><p>æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå¯¹åº”äºå·ç§¯æ ¸çš„SSMç”Ÿæˆå‡½æ•°ï¼ˆä¸€ä¸ªå®šä¹‰åœ¨é¢‘åŸŸçš„å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡DFTå˜æ¢åˆ°æ—¶åŸŸçš„å·ç§¯æ ¸ï¼‰ï¼Œåœ¨èŠ‚ç‚¹ $z$ å…¶è¡¨è¾¾å¼ä¸ºï¼š</p><script type="math/tex; mode=display">\hat{\mathcal{K}}(z; \bar{A}, \bar{B}, \bar{C}) \in \mathbb{C} := \sum_{i=0}^{\infty} \bar{C}^{\ast} \bar{A}^i\bar{B}z^{i} = \bar{C}^{\ast}(I-\bar{A}z)^{-1}\bar{B}</script><p>ç‰¹åˆ«åœ°ï¼Œæˆªæ–­SSMç”Ÿæˆå‡½æ•°ä¸ºï¼š</p><script type="math/tex; mode=display">\hat{\mathcal{K}}_L(z; \bar{A}, \bar{B}, \bar{C})^{\ast} \in \mathbb{C} := \sum_{i=0}^{L-1} \bar{C}^{\ast}\bar{A}^i \bar{B}z^i = \bar{C}^{\ast}(I-\bar{A}^Lz^L)(I-\bar{A}z)^{-1}\bar{B}</script><p>å¯¹äº $M$ ä¸ªèŠ‚ç‚¹çš„å‘é‡ $\Omega \in \mathbb{C}^{M}$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><script type="math/tex; mode=display">\hat{\mathcal{K}}_L(\Omega; \bar{A}, \bar{B}, \bar{C}) \in \mathbb{C}^M := (\hat{\mathcal{K}}_L(\omega_k; \bar{A}, \bar{B}, \bar{C}))_{k \in [M]}</script><p>ä¸Šé¢éƒ½æ˜¯é’ˆå¯¹ç”Ÿæˆå·ç§¯æ ¸çš„å‡½æ•°çš„è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬è®°å·ç§¯æ ¸åŠå…¶é¢‘åŸŸå½¢å¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\bar{K} &= \mathcal{K}_L(\bar{A}, \bar{B}, \bar{C}) \\\hat{K} &= \hat{\mathcal{K}}_L(\Omega; \bar{A}, \bar{B}, \bar{C}) \\\hat{K}(z) &= \hat{\mathcal{K}}_L(z; \bar{A}, \bar{B}, \bar{C})\end{aligned}</script><p>æˆ‘ä»¬å–ä¸€ç»„å•ä½æ ¹ $\Omega = e^{-2\pi i \frac{k}{L}}, k\in[L]$ï¼Œå¯å¾—ï¼š</p><script type="math/tex; mode=display">\hat{K}_j = \sum_{k=0}^{L-1}\bar{K}_k e^{-2\pi i \frac{jk}{L}}</script><p>ä¸Šå¼å®é™…ä¸Šæ˜¯å¯¹å·ç§¯æ ¸è¿›è¡Œç¦»æ•£å‚…é‡Œå¶å˜æ¢ï¼ˆDFTï¼‰: $\hat{}K = \mathcal{F}_L{K}$ï¼Œä¸‹é¢æˆ‘ä»¬æ¨å¯¼ $\hat{K}$ çš„è®¡ç®—ã€‚</p><p>å±•å¼€æˆªæ–­SSMç”Ÿæˆå‡½æ•°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\mathcal{K}_L(z; \bar{A}, \bar{B}, \bar{C}) &= \bar{C}^{\ast}\bar{B} + \bar{C}^{\ast}\bar{A}\bar{B}z + ... + \bar{C}^{\ast}\bar{A}^{L-1}\bar{B}z^{L-1} \\&= \bar{C}W^{\ast}(I-\bar{A}^L)(I-\bar{A}z)^{-1}\bar{B} \\ &= \tilde{C}^{\ast}(I-\bar{A}z)^{-1}\bar{B} \\\end{aligned}</script><p>å…¶ä¸­ $\tilde{C}^{\ast} = C^{\ast}(I-\bar{A}^L)$ï¼Œç”±äº $C$ å¯å­¦ä¹ ï¼Œå®è·µä¸­å¯ä»¥ç›´æ¥å°† $\tilde{C}^{\ast}$ è®¾ä¸ºå¯å­¦ä¹ å‘é‡ã€‚å°†ä¸Šå¼å±•å¼€åˆ°å¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}C^{\ast}(I-\bar{A}z)^{-1}\bar{B} &= C^{\ast}[(I-\frac{\Delta}{2}A)^{-1}(I-\frac{\Delta}{2}A) - (I-\frac{\Delta}{2}A)^{-1}(I+\frac{\Delta}{2}A)z]^{-1}\bar{B} \\&= C^{\ast}[(I-\frac{\Delta}{2}A) - (I + \frac{\Delta}{2}A)z]^{-1}(I-\frac{\Delta}{2}A)\bar{B} \\&= C^{\ast}[I(1-z) - \frac{\Delta}{2}A(1+z)]^{-1} \Delta B \\&= \frac{\Delta}{1-z}C^{\ast} [I - \frac{\Delta A}{2 \frac{1-z}{1+z}}]^{-1}B \\&= \frac{2\Delta}{1+z}C^{\ast}[2\frac{1-z}{1+z}I - \Delta A]^{-1}B \\\end{aligned}</script><p>å³ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\mathcal{K}_L(z; \bar{A}, \bar{B}, \bar{C}) &= \frac{2}{1+z} \tilde{C}^{\ast}(\frac{2}{\Delta}\frac{1-z}{1+z}-A)^{-1}B \\&= \frac{2}{1+z}\tilde{C}^{\ast}(\frac{2}{\Delta}\frac{1-z}{1+z} - \Lambda + PQ^{\ast})^{-1}B\end{aligned}</script><p>ä½¿ç”¨<strong>Woodbury matrix identity</strong>: $(A+UCV)^{-1} = A^{-1} - A^{-1}U(C^{-1}+VA^{-1}U)^{-1}VA^{-1}$ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\mathcal{K}_L(z; \bar{A}, \bar{B}, \bar{C}) = \frac{2}{1+z} [\tilde{C}^{\ast}R(z)B - \tilde{C}^{\ast}R(z)P(1+Q^{\ast}R(z)P)^{-1}Q^{\ast}R(z)B]</script><p>å…¶ä¸­ $R(z) = (\frac{2}{\Delta}\frac{1-z}{1+z} - \Lambda)^{-1}$ã€‚åˆ°è¿™é‡Œï¼Œæˆªæ–­SSMç”Ÿæˆå‡½æ•°çš„è®¡ç®—å¯ä»¥è¢«æœ€ç»ˆå½’ç»“ä¸ºå¯¹ $R(z)$ åŠå…¶ä¸å…¶ä»–çŸ©é˜µçš„ä¹˜æ³•è®¡ç®—ï¼Œå…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›é«˜æ•ˆåœ°è®¡ç®— $Q^{\ast}R(\Omega; \Lambda)P$ï¼Œå°† $\frac{2}{\Delta}\frac{1-z}{1+z}$ è§†ä¸º $\omega \in \Omega$ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯è¦è®¡ç®— $\sum_j\frac{q_i^{\ast}p_j}{\omega-\lambda_j}$ï¼Œè€Œè¿™æ˜¯ä¸€ä¸ª Cauchy matrix-vector multiplicationï¼Œå·²æœ‰é«˜æ•ˆç®—æ³•ã€‚</p><p>å…·ä½“æ¥è¯´ï¼Œå¯¹äº Cauchy matrix $M$ï¼š</p><script type="math/tex; mode=display">M \in \mathbb{C}^{M \times N} = M(\Omega, \Lambda) = (M_{ij})_{i\in [M], j\in [N]}</script><script type="math/tex; mode=display">M_{ij} = \frac{1}{\omega_i - \lambda_j}</script><p>Cauchy matrix-vector productçš„è®¡ç®—å¤æ‚åº¦ä¸ºï¼š</p><script type="math/tex; mode=display">\mathcal{C}(M,N) = \left\{\begin{matrix}O(MN) & \text{naively} \\O((M+N)\log^2(M+N)) & \text{in exact arithmetic}\\O((M+N)\log(M+N)\log(\frac{1}{\epsilon})) & \text{numerically to precision} \,\,  \epsilon\end{matrix}\right. \\</script><p>å› æ­¤CNN view è®¡ç®—å¤æ‚åº¦ä¸º $O((L+N)\log(L+N)\log \frac{1}{\epsilon})$ï¼Œå¯ä»¥è®°ä¸ºæ¬¡çº¿æ€§å½¢å¼ï¼š$\tilde{O}(L+N)$</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>ç»„ä¼šå†…éƒ¨åˆ†äº«æŠ¥å‘Š ã€ŠA Gentle Introduction to HiPPOğŸ¦› and its Friendsã€‹</p><p><a href="https://arxiv.org/pdf/2111.00396" title="S4åŸæ–‡">Efficiently Modeling Long Sequences with Structured State Spaces</a></p>]]></content>
      
      
      <categories>
          
          <category> Model Structure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mamba </tag>
            
            <tag> Model Structure </tag>
            
            <tag> HiPPO </tag>
            
            <tag> S4 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part I of Mathematical Structure of Mamba - Hippo</title>
      <link href="/posts/10038.html"/>
      <url>/posts/10038.html</url>
      
        <content type="html"><![CDATA[<div class="note success flat"><p>æœ¬ç¯‡æ˜¯mambaç³»åˆ—blogçš„ç¬¬ä¸€ç¯‡æ–‡ç« </p><ul><li><p>Part I of Mathematical Structure of Mamba - Hippo</p></li><li><p><a href="https://anti-entrophic.github.io/posts/10039.html" title="Part II of Mathematical Structure of Mamba - S4">Part II of Mathematical Structure of Mamba - S4</a></p></li></ul><p>å‰©ä½™é¢„è®¡è¿˜æœ‰ä¸‰ç¯‡æ–‡ç« æ­£åœ¨ç”Ÿäº§ä¸­~</p></div><h1 id="NIPS20-HiPPO-Recurrent-Memory-with-Optimal-Polynomial-Projections"><a href="#NIPS20-HiPPO-Recurrent-Memory-with-Optimal-Polynomial-Projections" class="headerlink" title="[NIPS20] HiPPO: Recurrent Memory with Optimal Polynomial Projections"></a>[NIPS20] HiPPO: Recurrent Memory with Optimal Polynomial Projections</h1><h2 id="åºè¨€"><a href="#åºè¨€" class="headerlink" title="åºè¨€"></a>åºè¨€</h2><p>è€ƒè™‘ä¸€ä¸ªå¾ˆé•¿çš„ä¸€ç»´åºåˆ—ï¼Œå½“æˆ‘ä»¬å¸Œæœ›æ¨¡å‹å…·æœ‰â€œè®°å¿†â€èƒ½åŠ›çš„æ—¶å€™ï¼Œæˆ‘ä»¬å®é™…ä¸ŠæœŸæœ›æ¨¡å‹èƒ½åœ¨å½“å‰æ—¶é—´æ­¥å¯¹å¾ˆä¹…ä»¥å‰çš„æ—¶é—´æ­¥ä¸Šçš„æ•°æ®ç‚¹å…·æœ‰æ— æŸæ¢å¤çš„èƒ½åŠ›ã€‚ç„¶è€Œï¼Œæ¨¡å‹çš„å¤§å°æ˜¯ä¸å¯èƒ½éšåºåˆ—é•¿åº¦å¢é•¿çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦ä½¿ç”¨æœ‰é™çš„å‚æ•°æ¢å¤å‡ºæ— é™å¤šæ—¶é—´æ­¥çš„æ•°æ®ç‚¹ã€‚</p><p>å¾ˆæ˜¾ç„¶æ— æŸæ¢å¤æ˜¯ä¸å¯èƒ½çš„ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§å…·æœ‰æ¸è¿›æ”¶æ•›æ€§çš„æ–¹æ³•ï¼Œå°½å¯èƒ½å‡å°‘è¿™ç§æŸå¤±ã€‚æˆ‘ä»¬é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ€æ ·æè¿°è¿™ä¸ªæŸå¤±ï¼Ÿä¸€ä¸ªéå¸¸è‡ªç„¶çš„æƒ³æ³•æ˜¯ç›´æ¥æŠŠæˆ‘ä»¬æ¢å¤å‡ºæ¥çš„æ•°æ®ç‚¹å’ŒçœŸå®çš„æ•°æ®ç‚¹çš„è·ç¦»æ±‚ $L_2$ èŒƒæ•°ã€‚Naiveçš„ $L_2$ èŒƒæ•°å‡è®¾äº†æ‰€æœ‰å†å²æ•°æ®ç‚¹æ˜¯åŒç­‰é‡è¦çš„ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬èµ·ç æœ‰äº†ä¸€ç§æœ€ç®€å•çš„æ±‚æŸå¤±çš„æ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬æŠŠæ‰€æœ‰çœŸå®æ•°æ®ç‚¹çœ‹ä½œå¯¹æ—¶é—´æ­¥çš„å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸Šé¢æ±‚æŸå¤±çš„è¿‡ç¨‹æ­£æ˜¯<strong>å‡½æ•°é€¼è¿‘</strong>çš„è¿‡ç¨‹ï¼Œå³æˆ‘ä»¬ä¸çŸ¥é“çœŸå®å‡½æ•°çš„è¡¨è¾¾å¼ï¼Œä½†æˆ‘ä»¬è·å–äº†å®ƒçš„è‹¥å¹²é‡‡æ ·æ•°æ®ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ä¾èµ–è¿™äº›æ•°æ®ç‚¹ï¼Œé€‰å–ä¸€ä¸ªå·²çŸ¥è¡¨è¾¾å¼çš„å‡½æ•°æ¥é€¼è¿‘å®ƒã€‚è¿™ä¸ªç”¨äºé€¼è¿‘çš„å‡½æ•°åŒ…å«æœ‰é™å¤šçš„å¾…ä¼˜åŒ–çš„å‚æ•°ï¼Œè€Œå‚æ•°çš„æ•°é‡ä¸éšåºåˆ—é•¿åº¦å˜åŒ–ã€‚</p><p><strong>è®°å¿†é—®é¢˜è½¬åŒ–ä¸ºäº†å‡½æ•°é€¼è¿‘é—®é¢˜</strong></p><h2 id="æ•°å­¦æ¡†æ¶"><a href="#æ•°å­¦æ¡†æ¶" class="headerlink" title="æ•°å­¦æ¡†æ¶"></a>æ•°å­¦æ¡†æ¶</h2><p>è€ƒè™‘å®šä¹‰åœ¨ $t&gt;0$ ä¸Šçš„ä¸€ç»´è¿ç»­å‡½æ•° $f(t)\in \mathbb{R}$ï¼Œåˆ™ $t$ æ—¶åˆ»ä¹‹å‰çš„<strong>å†å²</strong>å¯ä»¥è¡¨è¿°ä¸º </p><script type="math/tex; mode=display">f_{\leq t} := f(x)|_{x \leq t}</script><p>å¯¹äºæ¯ä¸ª $t$ æ—¶åˆ»ï¼Œæˆ‘ä»¬å¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªå·²çŸ¥è¡¨è¾¾å¼çš„å‡½æ•° $g^{(t)}\in \text{span\{}\mathcal{G}\}$ æ¥é€¼è¿‘å†å² $f_{\leq t}$ï¼Œå…¶ä¸­ $\mathcal{G}$ æ˜¯æˆ‘ä»¬æ‰€æœ‰å¯é€‰æ‹©å‡½æ•°æ„æˆçš„å‡½æ•°æ—ã€‚</p><p>åœ¨ç»™å®šæ¦‚ç‡æµ‹åº¦ $M^{(t)}$ ï¼Œå¯¹åº”æ¦‚ç‡å¯†åº¦ $\mu$ æ»¡è¶³ $\int_{-\infty}^{t}\mu^{(t)}(x)\text{d}x = 1$ çš„æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªå‡½æ•°çš„å†…ç§¯å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p><script type="math/tex; mode=display">\langle f,g \rangle_{\mu^{(t)}} = \int_0^{\infty} f(x)g(x)\mu^{(t)}(x)\text{d}x</script><p>åŒæ—¶ï¼Œå¸¦æ¦‚ç‡æµ‹åº¦çš„ $L_2$ èŒƒæ•°å˜ä¸º </p><script type="math/tex; mode=display">||f||_{L_2(\mu^{(t)})} = \langle f, f \rangle_{\mu_{(t)}}^{\frac{1}{2}} = [\int_0^{\infty} f(x)^2\mu^{(t)}(x)\text{d}x]^{\frac{1}{2}}</script><p>è¦è¿›è¡Œå‡½æ•°é€¼è¿‘ï¼Œæˆ‘ä»¬é¦–å…ˆè¦é€‰å–ä¸€ç»„åŸºå‡½æ•°æ¥æ„å»ºå‡½æ•°æ—ã€‚æœ€å¸¸è§çš„é€‰æ‹©æ˜¯ä½¿ç”¨å¤šé¡¹å¼åŸºï¼Œæ¥å¯¹æ¦‚ç‡æµ‹åº¦ $M^{(t)}$ æ„å»ºä¸€ç»„ <strong>æ­£äº¤å¤šé¡¹å¼</strong> $\mathcal{G}=\{g_n\}_{n&lt;N}$ï¼Œæ»¡è¶³ $\forall i,j \in [N], \langle g_i, g_j \rangle _{\mu^{(t)}}=\int_0^{\infty}g_i(x)g_j(x)\mu^{(t)}(x)\text{d}x=0$ï¼Œæ¥æ‰¾åˆ°ä¸€ä¸ª $g^{(t)}=\sum_{k=0}^{N-1}c_k(t)g_k$ å»æœ€å°åŒ–åœ¨æµ‹åº¦ $M^{(t)}$ ä¸‹ä¸ f(t) ä¹‹é—´çš„æŸå¤±ï¼Œå³ï¼š</p><script type="math/tex; mode=display">\hat{g}^{(t)}:=\text{argmin}||f_{\leq t}-g^{(t)}||</script><p>å¯¹äºä¸Šå¼ï¼Œ $f_{\leq t}$ å¯ä»¥ç›´æ¥<strong>è§‚æµ‹</strong>å¾—åˆ°ï¼Œ$\mathcal{G}$ å¯ä»¥é€šè¿‡<strong>æ„é€ </strong>å¾—åˆ°ï¼ˆå‹’è®©å¾·å¤šé¡¹å¼ã€åˆ‡æ¯”é›ªå¤«å¤šé¡¹å¼ã€é›…å¯æ¯”å¤šé¡¹å¼ç­‰ç­‰ï¼‰ï¼Œ$\mu^{(t)}$å¯ä»¥ç›´æ¥<strong>è®¾å®š</strong>ï¼ˆä¾‹å¦‚è®¾å®šä¸ºæ‰€æœ‰å†å²åŒç­‰é‡è¦ï¼Œæˆ–åªå…³æ³¨æ­¤æ—¶åˆ»å¾€å‰å›ºå®šçª—å£å¤§å°çš„å†å²ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å”¯ä¸€è¦<strong>ä¼˜åŒ–</strong>çš„å°±æ˜¯ä¸€ç»„ç³»æ•° $[c_k(t)]_{k\in[N]} \in \mathbb{R}^{N}$ </p><div class="note success flat"><p>åæ–‡ä¸­ä»‹ç»äº†å¦‚ä½•åœ¨æµ‹åº¦åŠ æƒçš„æƒ…å†µä¸‹æ¨å¯¼å‡ºæ­£äº¤å¤šé¡¹å¼</p></div><p>åœ¨æŸä¸€æ—¶åˆ» $t$ çš„ä¸€ç»„å‚æ•° $c_k(t)$ ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•é€šè¿‡æœ€å°äºŒä¹˜æ³•æ±‚å¾—</p><script type="math/tex; mode=display">L = \int(f_{\leq t}(x)- \sum_{k=0}^{N-1}c_k(t)g_k^{(t)}(x))^2\mu^{(t)}(x)\text{d}x</script><p>å¯¹ $c_i$ æ±‚å¯¼ï¼Œä»¤å¯¼æ•°ä¸º0</p><script type="math/tex; mode=display">\begin{aligned}\frac{\partial L}{\partial c_k(t)}=-2\int (f_{\leq t}(x)-\sum_{k=0}^{N-1}c_k(t)g_k^{(t)}(x))g_i^{(t)}(x)\mu^{(t)}(x)\text{d}x =0 \\\int f_{\leq t}(x)g_i^{(t)}(x)\mu^{(t)}(x)\text{d}x = \sum_{k=0}^{N-1}c_k(t) \int g_k^{(t)}(x)g_i^{(t)}(x)\mu^{(t)}(x)\text{d}x\end{aligned}</script><p>ç”±äº $\int g_k^{(t)}(x)g_i^{(t)}(x)\mu^{(t)}(x)\text{d}x=1$ å½“ä¸”ä»…å½“ $k=i$ï¼Œæ‰€ä»¥</p><script type="math/tex; mode=display">\int f_{\leq t}(x)g_i^{(t)}(x)\mu^{(t)}(x)\text{d}x = c_i(t)</script><p>ä¹Ÿå³ $c_i(t)=\langle f_{\leq t}, g_i^{(t)} \rangle_M = \int f_{\leq t}(x)g_i^{(t)}(x)\mu^{(t)}(x)\text{d}x$</p><p>æ•°å­¦ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•è®¡ç®—å¾—åˆ°ã€‚ä½†è€ƒè™‘æ—¶é—´å¤æ‚åº¦ï¼Œæ¯æ¬¡è®¡ç®—éƒ½éœ€è¦éå†æ‰€æœ‰çš„å†å²æ±‚å‡º $f_{\leq t}$ï¼Œ$n$ æ¬¡æ“ä½œçš„æ€»å¤æ‚åº¦ä¾ç„¶æ˜¯ $O(n^2)$ ï¼Œæ— æ³•æ¥å—ã€‚</p><p>å¯ä»¥çœ‹åˆ° $c(t)$ æ˜¯å…³äºæ—¶é—´ $t$ çš„å‡½æ•°ï¼Œè€ƒè™‘åˆ°ç›¸æ¯”ä¸Šä¸ªæ—¶åˆ» $T-\delta$ ä»…æœ‰ä¸€ä¸ª<strong>å¢é‡</strong>æ•°æ®ç‚¹ $f(T)$ï¼Œè‡ªç„¶è€ƒè™‘ $c(t)$ çš„æ±‚è§£æ˜¯å¦å­˜åœ¨<strong>é€’æ¨</strong>å½¢å¼ï¼Œä¹Ÿå³å…³æ³¨ $c(t-\delta)$ï¼Œ$c(t)$ï¼Œ$f_{\leq t}$ ä¸‰è€…ä¹‹é—´çš„å…³ç³»ã€‚åœ¨è¿ç»­æƒ…å†µä¸‹å½“ $\delta \rightarrow 0$ æ—¶ï¼Œæˆ‘ä»¬å…³å¿ƒçš„æ˜¯ $\frac{d}{dt}c(t)$ï¼Œ$c(t)$ï¼Œ$f_{\leq t}$ ä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯æ±‚è§£ä¸€ä¸ªå…³äº $c(t)$ çš„<strong>å¸¸å¾®åˆ†æ–¹ç¨‹(ODE)</strong>ï¼š</p><script type="math/tex; mode=display">\frac{d}{dt}c(t)=u(t, c(t), f_{\leq t})</script><h2 id="æ•°å­¦æ¨å¯¼"><a href="#æ•°å­¦æ¨å¯¼" class="headerlink" title="æ•°å­¦æ¨å¯¼"></a>æ•°å­¦æ¨å¯¼</h2><p>æ ¹æ®å‰é¢çš„æ•°å­¦æ¡†æ¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ç»„æ­£äº¤å¤šé¡¹å¼ $\{g_n\}_{n&lt;N}$ å’Œæµ‹åº¦ $M^{(t)}$ï¼Œå¹¶æ±‚è§£å¸¸å¾®åˆ†æ–¹ç¨‹ $\frac{d}{dt}c(t)=u(t, c(t), f_{\leq t})$ã€‚é€‰å–ä¸åŒçš„å¤šé¡¹å¼å’Œæµ‹åº¦ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸åŒçš„ODEæ–¹ç¨‹å’Œè§£ï¼Œæ­¤å¤„ä»…ä»‹ç» HiPPO æ¡†æ¶ä¸­æœ€æˆåŠŸçš„ä¸€ç§å˜ä½“ï¼šHiPPO-LegSï¼ˆScaled Legendreï¼ŒLegSï¼‰ï¼Œå®ƒä½¿ç”¨å‹’è®©å¾·å¤šé¡¹å¼ä½œä¸ºæ­£äº¤å¤šé¡¹å¼ï¼Œå¹¶é€‰å–å‡åŒ€é‡è¦æ€§çš„æµ‹åº¦ã€‚</p><h3 id="æ¦‚ç‡æµ‹åº¦"><a href="#æ¦‚ç‡æµ‹åº¦" class="headerlink" title="æ¦‚ç‡æµ‹åº¦"></a>æ¦‚ç‡æµ‹åº¦</h3><center><img src="https://i.072333.xyz/file/AgACAgEAAyEGAASMaMWHAAJHDWff7yd7GUNqtkIh5zqyg-DCBX3SAAICsjEbTk4BRyA4qfV_1b8oAQADAgADdwADNgQ.png" width="1000px" /><p style="font-size: 10px;">HiPPOè®ºæ–‡ä¸­æå‡ºçš„ä¸‰ç§æ¦‚ç‡æµ‹åº¦ï¼Œä»å·¦å¾€å³åˆ†åˆ«ä¸ºï¼šLegTï¼ˆå°†æ»‘åŠ¨çª—å£å†…çš„å†å²è§†ä¸ºåŒç­‰é‡è¦ï¼‰ã€LagTï¼ˆå†å²çš„é‡è¦æ€§æŒ‡æ•°è¡°å‡ï¼‰ã€LegSï¼ˆå°†æ‰€æœ‰å†å²è§†ä¸ºåŒç­‰é‡è¦ï¼‰</p></center><p><br></p><p>åœ¨æŸä¸ªæ—¶åˆ» $t$ï¼Œå°†æ­¤å‰çš„æ‰€æœ‰å†å²è§†ä¸ºåŒç­‰é‡è¦ï¼Œæˆ‘ä»¬å¾—åˆ°HiPPO-LegSçš„æµ‹åº¦ï¼š</p><script type="math/tex; mode=display">\mu^{(t)}(x)=\frac{1_{[0,t]}}{t}</script><h3 id="æ­£äº¤å¤šé¡¹å¼"><a href="#æ­£äº¤å¤šé¡¹å¼" class="headerlink" title="æ­£äº¤å¤šé¡¹å¼"></a>æ­£äº¤å¤šé¡¹å¼</h3><p>ä¸ºäº†è·å¾—æ­£äº¤å¤šé¡¹å¼ï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯å¯¹ä¸€ç»„å‡½æ•°è¿›è¡ŒGram-Schmidtæ­£äº¤åŒ–ã€‚å½“æˆ‘ä»¬å¯¹ $1, x, x^2, \cdots$ è¿›è¡Œæ­£äº¤åŒ–åï¼Œå¾—åˆ°çš„å°±æ˜¯å‹’è®©å¾·å¤šé¡¹å¼ï¼š$P_0(x), P_1(x), P_2(x), \cdots$ã€‚</p><p>æ ‡å‡†å‹’è®©å¾·å¤šé¡¹å¼æœ‰ä¸€ä¸ªæ€§è´¨ï¼Œæˆ‘ä»¬ä¸åŠ è¯æ˜åœ°ç»™å‡ºï¼šåœ¨åŒºé—´ $[-1,1]$ ä¸Šï¼Œä¸¤ä¸ªå¤šé¡¹å¼ $P_n, P_m$ å…·æœ‰ä»¥ä¸‹å…³ç³»ï¼š</p><script type="math/tex; mode=display">\frac{2n+1}{2}\int_{-1}^{1}P_n(x)P_m(x)\text{d}x=\delta_{nm}</script><p>$\delta_{nm}$ è¡¨ç¤ºå½“ $n \neq m$ æ—¶ç­‰äº 0ï¼Œå› ä¸ºæ­£äº¤å˜›ï¼›å½“ $n=m$ æ—¶ç­‰äº1</p><p>ç”±äºè¯¥æ€§è´¨å®šä¹‰åœ¨åŒºé—´ $[-1,1]$ ä¸Šï¼Œæˆ‘ä»¬è¿›è¡Œå˜é‡ä»£æ¢ $x=\frac{2xâ€™}{t}-1$ æ”¾ç¼©åˆ°æˆ‘ä»¬å…³å¿ƒçš„ $[0,t]$ åŒºé—´ï¼Œä»£æ¢åçš„å…¬å¼ä¸ºï¼š</p><script type="math/tex; mode=display">(2n+1)\int_0^tP_n(\frac{2x}{t}-1)P_m(\frac{2x}{t}-1)\frac{1}{t}\text{d}x=\delta_{nm}</script><p>ä¸¤ä¸ªå¤šé¡¹å¼åœ¨åŒºé—´ $[0,t]$ ä¸Šç§¯åˆ†ç­‰ä»·äºåœ¨ç»™å®šæµ‹åº¦ $\mu^{(t)}(x)=\frac{1_{[0,t]}}{t}$ ä¸‹åœ¨æ•´ä¸ªæ•°è½´ä¸Šçš„ç§¯åˆ†ï¼Œä¸Šå¼å†™ä¸ºï¼š</p><script type="math/tex; mode=display">(2n+1)\int P_n(\frac{2x}{t}-1)P_m(\frac{2x}{t}-1)\frac{1_{[0,t]}}{t}\text{d}x=\delta_{nm}</script><p>æˆ‘ä»¬ä»…è€ƒè™‘ $n = m$ çš„æƒ…å†µï¼š</p><script type="math/tex; mode=display">\int((2n+1)^{\frac{1}{2}}P_n(\frac{2x}{t}-1))^2\mu^{(t)}(x)\text{d}x=1</script><p>ä»¤ $g_n^{(t)}(x)=(2n+1)^{\frac{1}{2}}P_n(\frac{2x}{t}-1)$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><script type="math/tex; mode=display">\int(g_n^{(t)}(x))^2\mu^{(t)}(x)\text{d}x = \langle g_n^{(t)}(x), g_n^{(t)}(x) \rangle_{\mu^{(t)}}=1</script><p>æ‰€ä»¥ï¼Œåœ¨æµ‹åº¦ $M^{(t)}$ ä¸‹å½’ä¸€åŒ–çš„å‹’è®©å¾·æ­£äº¤å¤šé¡¹å¼ä¸ºï¼š</p><script type="math/tex; mode=display">\{g_n^{(t)}(x)\}_{n<N}=\{(2n+1)^{\frac{1}{2}}P_n(\frac{2x}{t}-1)\}_{n<N}</script><div class="note warning flat"><p>æ€ä¹ˆè¯æ˜å½“ $n \neq m$ æ—¶æœ‰ $\int g_n^{(t)}(x) g_m^{(t)}(x) \mu^{(t)}(x) \text{d}x = 0$ ï¼Ÿ</p></div><h3 id="å¸¸å¾®åˆ†æ–¹ç¨‹"><a href="#å¸¸å¾®åˆ†æ–¹ç¨‹" class="headerlink" title="å¸¸å¾®åˆ†æ–¹ç¨‹"></a>å¸¸å¾®åˆ†æ–¹ç¨‹</h3><p>è¦è®¡ç®— $\frac{d}{dt}c(t)$ï¼Œ æˆ‘ä»¬éœ€è¦å¯¹ $c(t) \in \mathbb{R}^N$ çš„æ¯ä¸€ç»´ $c_n(t)$ æ±‚å¯¼ã€‚æ ¹æ® $c_n(t):=\langle f_{\leq t}, g_n^{(t)} \rangle_{\mu^{(t)}}$ï¼ŒåŒæ—¶æˆ‘ä»¬å¸Œæœ›é¿å…å¯¹ $f_{\leq t}$ è¿›è¡Œè®¡ç®—ï¼Œé‚£ä¹ˆå¯ä»¥å€ŸåŠ©è®¡ç®— $\frac{d}{dt}g_n^{(t)}$ å’Œ $\frac{d}{dt}\mu^{(t)}$ å¾—åˆ°ï¼ˆçœ‹äº†åé¢æ¨å¯¼å°±çŸ¥é“ä¸ºä»€ä¹ˆäº†ï¼‰ã€‚</p><p>åœ¨æ­¤å‰çš„æ¨å¯¼ä¸­ï¼Œæˆ‘ä»¬å°† $t$ è§†ä¸ºä¸€ä¸ªå›ºå®šçš„æ—¶åˆ»è€Œéå˜é‡ï¼Œå› æ­¤ $t$ ä½œä¸ºä¸Šæ ‡å‡ºç°ã€‚è€Œåœ¨æ¥ä¸‹æ¥çš„ODEæ¨å¯¼ä¸­ï¼Œæ—¶é—´ $t$ ä¹Ÿæ˜¯å˜é‡ï¼Œå› æ­¤ä¸‹é¢çš„è®°å·æ”¹ä¸ºç±»ä¼¼ $g(t, x)$ï¼Œ$\mu(t,x)$ çš„å½¢å¼ã€‚</p><div class="note warning flat"><p>$f_{\leq t}$ æ˜¯ä¸€ä¸ªå·²ç»ç¡®å®šçš„å‡½æ•°ï¼Œä»£è¡¨çš„æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„é‡‡æ ·ç‚¹èƒŒåçš„çœŸå®é€»è¾‘ï¼Œå¹¶ä¸æ˜¯ $t$ çš„å‡½æ•°ã€‚</p><p>å¯ä»¥ç†è§£ä¸ºï¼Œ$f_{\leq t}$ æ˜¯é€šè¿‡ $f(1), â€¦, f(t)$ æ‹Ÿåˆå‡ºæ¥çš„ä¸€ä¸ªå‡½æ•°ï¼Œæ±‚å‡ºè¿™ä¸ªå‡½æ•°çš„å¤æ‚åº¦æ˜¯ $O(t)$</p></div><p>è¡¥å……ä¸€ä¸‹å‹’è®©å¾·å¤šé¡¹å¼çš„é€’æ¨å…³ç³»å¼ $(2n+1)P_n=P_{n+1}â€™-P_{n-1}â€™$ï¼Œä»¥åŠæ¨è®º $(x+1)P_nâ€™(x)=nP_n(x) + (2n-1)P_{n-1}(x) + (2n-3)P_{n-2}(x) + \cdots$ï¼Œä¸‹é¢æ˜¯å‹’è®©å¾·å¤šé¡¹å¼çš„è¡¨ï¼Œå¯ä»¥è‡ªå·±éªŒè¯ä¸€ä¸‹ã€‚</p><center><img src="https://i.072333.xyz/file/AgACAgEAAyEGAASMaMWHAAJHJ2fgAnJTyuYYaqKiJHPqYNGyYqIcAAIcsjEbTk4BR5yYeSYijuKkAQADAgADeQADNgQ.png" width="600px" /><p style="font-size: 10px;"> æ ‡å‡†å‹’è®©å¾·å¤šé¡¹å¼ </p></center><p><br></p><p>å¯¹äº $\frac{\partial}{\partial t}\mu(t,x)$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\frac{\partial}{\partial t}\mu(t,x) &= \frac{\partial}{\partial t}(\frac{1_{[0,t]}}{t}) \\&= -t^{-2} 1_{[0,t]} + t^{-1}\delta_t \\&= t^{-1}(-\mu(t,x)+\delta_t) \end{aligned}</script><p>å¯¹äº $\frac{\partial}{\partial t}g_n(t,x)$ï¼Œæˆ‘ä»¬æœ‰ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\frac{\partial}{\partial t}g_n(t,x) &= \frac{\partial}{\partial t}((2n+1)^{\frac{1}{2}}P_n(\frac{2x}{t}-1)) \\&=-(2n+1)^{\frac{1}{2}}2xt^{-2}P_n'(\frac{2x}{t}-1) \\&=-(2n+1)^{\frac{1}{2}}t^{-1}(\frac{2x}{t}-1+1)P_n'(\frac{2x}{t}-1)\end{aligned}</script><p>è¿›è¡Œå˜é‡ä»£æ¢ $z=\frac{2x}{t}-1$ ç®€åŒ–å…¬å¼ï¼Œå¹¶ä½¿ç”¨å‹’è®©å¾·å¤šé¡¹å¼çš„æ¨è®ºå¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\frac{\partial}{\partial t}g_n(t,x) &= -(2n+1)^{\frac{1}{2}}t^{-1}(z+1)P_n'(z) \\&= -(2n+1)^{\frac{1}{2}}t^{-1}[nP_n(z)+(2n-1)P_{n-1}(z)+(2n-3)P_{n-2}(z)+\cdots] \\&= -t^{-1}(2n+1)^{\frac{1}{2}}[n(2n+1)^{-\frac{1}{2}}g_n(t,x)+(2n-1)^{\frac{1}{2}}g_{n-1}(t,x)+(2n-3)^{\frac{1}{2}}g_{n-2}(t,x)+\cdots]\end{aligned}</script><p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ¥è®¡ç®— $\frac{d}{dt}c_n(t)$</p><script type="math/tex; mode=display">\begin{aligned}\frac{d}{dt}c_n(t) &= \frac{\partial}{\partial t}(\int f(x)g_n(t,x)\mu(t,x)\text{d}x) \\&= \int f(x) (\frac{\partial}{\partial t}g_n(t,x))\mu(t,x)\text{d}x + \int f(x)g_n(t,x)(\frac{\partial}{\partial t}\mu(t,x))\text{d}x\end{aligned}</script><p>ä»£å…¥ $\frac{\partial}{\partial t}g_n(t,x)$ï¼Œ$\frac{d}{dt}\mu(t,x)$ çš„è®¡ç®—ç»“æœï¼Œå¯ä»¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\frac{d}{dt}c_n(t) &= -t^{-1}(2n+1)^{\frac{1}{2}}[n(2n+1)^{-\frac{1}{2}}c_n(t)+(2n-1)^{\frac{1}{2}}c_{n-1}(t)+(2n-3)^{\frac{1}{2}}c_{n-2}(t)+\cdots]-t^{-1}c_n(t) + t^{-1}f(t)g_n(t,t)\end{aligned}</script><p>å…¶ä¸­ $g_n(t,t) = (2n+1)^{\frac{1}{2}}P_n(1)=(2n+1)^{\frac{1}{2}}$ï¼Œä»£å…¥å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\frac{d}{dt}c_n(t) &= -t^{-1}(2n+1)^{\frac{1}{2}}[(n+1)(2n+1)^{-\frac{1}{2}}c_n(t)+(2n-1)^{\frac{1}{2}}c_{n-1}(t)+(2n-3)^{\frac{1}{2}}c_{n-2}(t)+\cdots] + t^{-1}(2n+1)^{\frac{1}{2}}f(t)\end{aligned}</script><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†æ¨å¯¼ï¼Œå¹¶å®ç°äº†åˆå§‹ç›®æ ‡ï¼Œå°† $\frac{d}{dt}c(t)$ è¡¨ç¤ºä¸ºäº† $c(t)$ ä¸ $f_{\leq t}$ çš„å‡½æ•°ï¼Œä¸”ä¸ä¾èµ–å¯¹è§‚æµ‹å‡½æ•° $f_{\leq t}$ çš„ç§¯åˆ†ï¼Œé¿å…äº†å¯¹æ‰€æœ‰å†å²çš„è®¡ç®—ã€‚æœ‰äº† $\frac{d}{dt}c_n(t)$ çš„è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†å‘é‡ $c(t)$ è¡¨ç¤ºä¸ºçŸ©é˜µè®¡ç®—å½¢å¼ï¼š</p><script type="math/tex; mode=display">\frac{d}{dt}c(t) = -\frac{1}{t}Ac(t) + \frac{1}{t}Bf(t)</script><script type="math/tex; mode=display">A_{nk} = \left\{\begin{matrix}(2n+1)^{\frac{1}{2}}(2k+1)^{\frac{1}{2}} & \text{if} \quad n>k \\n+1 & \text{if} \quad n=k \\0 & \text{if} \quad n<k\end{matrix}\right. \\</script><script type="math/tex; mode=display">B_n = (2n+1)^{\frac{1}{2}}</script><p>è¿™é‡Œçš„çŸ©é˜µ $A$ å°±æ˜¯å¤§åé¼é¼çš„<strong>HiPPO Matrix</strong>ï¼ŒS4ï¼ˆ<strong>S</strong>tructured <strong>S</strong>tate <strong>S</strong>pace<strong>S</strong>ï¼‰ä¸­â€œç»“æ„åŒ–â€æŒ‡çš„å°±æ˜¯ç”¨ç»“æ„åŒ–çš„çŸ©é˜µ $A$ æ¥å¯¹ SSM çš„å‚æ•°åˆå§‹åŒ–</p><h4 id="HiPPOçŸ©é˜µåˆå§‹åŒ–ä»£ç "><a href="#HiPPOçŸ©é˜µåˆå§‹åŒ–ä»£ç " class="headerlink" title="HiPPOçŸ©é˜µåˆå§‹åŒ–ä»£ç "></a>HiPPOçŸ©é˜µåˆå§‹åŒ–ä»£ç </h4><p>è¡¥å……ä¸€ä¸‹HiPPOçŸ©é˜µåˆå§‹åŒ–çš„ä»£ç ï¼ŒHiPPOçŸ©é˜µæ˜¯ä¸€ä¸ª $N \times N$ ç»´çš„ä¸‹ä¸‰è§’çŸ©é˜µï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_HiPPO</span>(<span class="params">N</span>):</span><br><span class="line">    P = np.sqrt(<span class="number">1</span> + <span class="number">2</span> * np.arange(N))</span><br><span class="line">    A = P[:, np.newaxis] * P[np.newaxis, :]</span><br><span class="line">    A = np.tril(A) - np.diag(np.arange(N))</span><br><span class="line">    <span class="keyword">return</span> -A</span><br></pre></td></tr></table></figure><p>è¿”å› $-A$ æ˜¯ä¸ºäº†å’Œåç»­çš„SSMçŠ¶æ€æ–¹ç¨‹å¯¹é½ï¼ŒæŠŠè´Ÿå·æ”¾åˆ°å‚æ•°å†…éƒ¨ã€‚</p><h3 id="HiPPO-ç¦»æ•£åŒ–"><a href="#HiPPO-ç¦»æ•£åŒ–" class="headerlink" title="HiPPO ç¦»æ•£åŒ–"></a>HiPPO ç¦»æ•£åŒ–</h3><p>ä»¥ä¸Šæ¨å¯¼éƒ½æ˜¯åœ¨å‡è®¾ $f(t)$ æ˜¯å…³äº $t$ çš„è¿ç»­å‡½æ•°çš„æƒ…å†µä¸‹è¿›è¡Œçš„ã€‚é€šè¿‡ç¦»æ•£åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—é’ˆå¯¹åºåˆ—æ•°æ®çš„ç¦»æ•£ODEã€‚è¿ç»­å‡½æ•°ç¦»æ•£åŒ–çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚å‰å‘æ¬§æ‹‰ã€åå‘æ¬§æ‹‰ã€åŒçº¿æ€§ç­‰ç­‰ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä»‹ç»å½¢å¼ç›¸å¯¹ç®€æ´çš„å‰å‘æ¬§æ‹‰æ–¹æ³•ä»¥åŠç¦»æ•£åŒ–åçš„HiPPO-LegSï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨HiPPOè®ºæ–‡çš„å®éªŒä»¥åŠS4ä¸­ä½¿ç”¨çš„éƒ½æ˜¯åŒçº¿æ€§ç¦»æ•£åŒ–æ–¹æ³•ï¼Œå› ä¸ºå…·æœ‰æ›´å¥½çš„æ•°å€¼ç¨³å®šæ€§ï¼Œè€Œmambaåˆ™æ˜¯é‡‡ç”¨çš„é›¶é˜¶ä¿æŒï¼ˆzero-order hold, ZOHï¼‰æ–¹æ³•ã€‚</p><p>å·²çŸ¥ $\frac{d}{dt}c(t) = -\frac{1}{t}Ac(t) + \frac{1}{t}Bf(t)$ ï¼Œå¯¹äºå‰å‘æ¬§æ‹‰ï¼Œå‡è®¾é‡‡æ ·é—´éš”ä¸º $\Delta t$ï¼Œæˆ‘ä»¬ä»æ—¶åˆ» $t$ å‘å‰èµ°ä¸€å°æ­¥å¾—åˆ° $t+\Delta t$ï¼Œå¯¹è¿™ä¸€å°æ®µåœ¨ç­‰å¼ä¸¤è¾¹ç§¯åˆ†å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">c(t+\Delta t)-c(t)=\int_t^{t+\Delta t} (-\frac{1}{s}Ac(s)+\frac{1}{s}Bf(s))\text{d}s</script><p>å¯¹äºç­‰å¼å³è¾¹æˆ‘ä»¬å°† $[t,t+\Delta t]$ å†… $\frac{d}{dt}c(t)$ çš„å€¼éƒ½ä¿æŒä¸º $t$ æ—¶åˆ»çš„å€¼æ¥è¿‘ä¼¼ï¼Œæœ‰ï¼š</p><script type="math/tex; mode=display">c(t+\Delta t)-c(t)=\Delta t (-\frac{1}{t}Ac(t)+\frac{1}{t}Bf(t))</script><p>ç§»é¡¹å¾—åˆ°ï¼š</p><script type="math/tex; mode=display">c(t+\Delta t)=(1-\frac{\Delta t}{t}A)c(t)+\frac{\Delta t}{t}Bf(t)</script><p>å°† $t_k$, $t_k+\Delta t$ æ—¶åˆ»åˆ†åˆ«å½“æˆç¦»æ•£çš„ $k$ï¼Œ$k+1$ æ—¶é—´æ­¥ï¼Œå³ $t_k=k \cdot \Delta t$ï¼Œæˆ‘ä»¬å¾—åˆ°å‰å‘æ¬§æ‹‰ç¦»æ•£åŒ–çš„HiPPO-LegSï¼š</p><script type="math/tex; mode=display">c_{k+1}=(1-\frac{A}{k})c_k+\frac{B}{k}f_k</script><p>åŒçº¿æ€§ç¦»æ•£åŒ–å°±æ˜¯ $c(t+\Delta t)-c(t)=\frac{\Delta t }{2}(\frac{dc(t)}{dt}+ \frac{dc(t+\Delta t)}{dt})$</p><p>åœ¨S4Déƒ¨åˆ†ä¼šä»‹ç»é›¶é˜¶ä¿æŒæ–¹æ³•ã€‚</p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>ç»„ä¼šå†…éƒ¨åˆ†äº«æŠ¥å‘Š ã€ŠA Gentle Introduction to HiPPOğŸ¦› and its Friendsã€‹</p>]]></content>
      
      
      <categories>
          
          <category> Model Structure </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mamba </tag>
            
            <tag> Model Structure </tag>
            
            <tag> HiPPO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Policy Gradient</title>
      <link href="/posts/10026.html"/>
      <url>/posts/10026.html</url>
      
        <content type="html"><![CDATA[<p>æˆ‘å»æ€ä¹ˆä¸èƒ½æ¸²æŸ“å…¬å¼äº†ã€‚ã€‚ã€‚çœ‹çœ‹æ€ä¹ˆè§£å†³ã€‚ã€‚ã€‚</p><p>ä»ç®€å•çš„å…¬å¼æ¨å¯¼ä»‹ç»å¤§è‡´æ€æƒ³ï¼Œç„¶åä»ä»£ç è§’åº¦ä»‹ç»å…·ä½“å®è·µã€‚</p><h1 id="Policy-Gradient"><a href="#Policy-Gradient" class="headerlink" title="Policy Gradient"></a>Policy Gradient</h1><p>å¯¹äºå½“å‰çš„çŠ¶æ€ $s$ï¼Œæˆ‘ä»¬éœ€è¦é‡‡å–ä¸€ä¸ªè¡ŒåŠ¨ $a$ï¼Œå‡è®¾æˆ‘ä»¬è¡ŒåŠ¨çš„ç­–ç•¥ç”±å‚æ•° $\theta$ å†³å®šï¼Œé‚£æˆ‘ä»¬é‡‡å–è¡ŒåŠ¨ $a$ çš„æ¦‚ç‡ä¸º $\pi_{\theta}(a|s) = P(a|s,\theta)$</p><p>ç›®æ ‡æ˜¯æ±‚å¾—èƒ½æœ€å¤§åŒ–å¥–åŠ±å‡½æ•° $J(\theta)$ çš„å‚æ•° $\theta$ï¼Œå³æ±‚</p><script type="math/tex; mode=display">\mathop{\arg\max}\limits_{\theta}J(\theta) = \mathop{\arg\max}\limits_{\theta}\mathbb{E}_{\tau \sim \pi_{\theta}}R(\tau)=\mathop{\arg\max}\limits_{\theta}\sum_{\tau}P(\tau;\theta)R(\tau)</script><p>æˆ‘ä»¬æŠŠ $J(\theta)$ çœ‹æˆæ˜¯è½¨è¿¹ $\tau$ çš„æœŸæœ›å¥–åŠ±ã€‚æ¯æ¡è½¨è¿¹çš„æ¦‚ç‡å¯ä»¥å±•å¼€è¡¨ç¤ºä¸ºï¼š</p><script type="math/tex; mode=display">P(\tau|\theta) = \prod_{t=0}^T P(s_{t+1}|s_t, a_t) \, \cdot \, \pi_{\theta}(a_t | s_t)</script><p>ä¸ºäº†æ±‚å¾— $\theta$ , æˆ‘ä»¬å¯¹ $\theta$ æ±‚å¯¼ï¼Œæ¨å¯¼å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">\begin{aligned}\nabla_{\theta}J(\theta) &= \sum_{\tau}\nabla_{\theta}P(\tau;\theta)R(\theta) \\&= \sum_{\tau} P(\tau;\theta) \frac{\nabla_{\theta}P(\tau;\theta)}{P(\tau;\theta)} R(\tau) \\&= \sum_{\tau} P(\tau;\theta) \nabla_{\theta}\text{log}P(\tau;\theta)R(\tau) \\&= \mathbb{E}_{\tau \sim \pi_{\theta}} \nabla_{\theta}\text{log}P(\tau;\theta)R(\tau)\end{aligned}</script><p>è¿™é‡Œæœ‰ä¸€æ­¥å·§å¦™çš„å˜æ¢ï¼Œå°† $\nabla_{\theta}P(\tau;\theta)$ å˜æˆäº† $P(\tau;\theta) \nabla_{\theta}\text{log}P(\tau;\theta)$ï¼Œlogå½¢å¼å…è®¸æˆ‘ä»¬å°†è¿ä¹˜å±•å¼€è¿›è¡Œè¿›ä¸€æ­¥æ¨å¯¼ã€‚</p><script type="math/tex; mode=display">\begin{aligned}\nabla_{\theta}\text{log}P(\tau;\theta) &= \nabla_{\theta}\sum_{t=0}^T\text{log}P(s_{t+1}|s_t, a_t) + \nabla_{\theta}\sum_{t=0}^T\text{log}\pi_{\theta}(a_t|s_t) \\&= \nabla_{\theta}\sum_{t=0}^T\text{log}\pi_{\theta}(a_t|s_t)\end{aligned}</script><p>å°†æ•°æ®å¸¦å›ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¥–åŠ±å‡½æ•°çš„æœ€ç»ˆå½¢å¼</p><script type="math/tex; mode=display">\begin{aligned}\nabla_{\theta}J(\theta) &= \mathbb{E}_{\tau \sim \pi_{\theta}} [\nabla_{\theta}\sum_{t=0}^T\text{log}\pi_{\theta}(a_t|s_t)R(\tau)] \\&= \mathbb{E}_{\tau \sim \pi_{\theta}} [\sum_{t=0}^T\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)R(\tau)]\end{aligned}</script><p>æœ€åï¼Œå¯¹äºæœ€å¤–å±‚çš„æœŸæœ›ï¼Œæˆ‘ä»¬ç”¨å¤šæ¬¡é‡‡æ ·æ¨¡æ‹Ÿã€‚å‡è®¾é‡‡äº† $m$ æ¬¡</p><script type="math/tex; mode=display">\begin{aligned}\nabla_{\theta}J(\theta) &\approx \frac{1}{m}\sum_{i=1}^mR(\tau^{(i)})[\sum_{t^{(i)}=0}^{T^{(i)}} \nabla_{\theta}\text{log}\pi_{\theta}(a_{t^{(i)}}|s_{t^{(i)}})]\end{aligned}</script><p>ä½†æ˜¯é‡‡æ ·éå¸¸æ˜‚è´µï¼Œæ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬å¯èƒ½åªç”¨Monte Carloé‡‡æ ·ä¸€æ¬¡ã€‚ç”šè‡³é‡‡æ ·å‡ºæ¥çš„æ ·æœ¬è¿˜è¦è¢«å¤šæ¬¡ä½¿ç”¨ã€‚</p><h2 id="Loss"><a href="#Loss" class="headerlink" title="Loss"></a>Loss</h2><p>å¯¹äºä¹‹å‰æ¨å¯¼çš„ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„ç§¯åˆ†å›å»:</p><script type="math/tex; mode=display">\nabla_{\theta}J(\theta) = \mathbb{E}_{\tau \sim \pi_{\theta}} [\sum_{t=0}^T\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)A(s_t, a_t)]</script><script type="math/tex; mode=display">J(\theta) = \mathbb{E}_{\tau \sim \pi_{\theta}} [\sum_{t=0}^T\text{log}\pi_{\theta}(a_t|s_t)A(s_t, a_t)]</script><p>å¸¸ç”¨çš„æ¢¯åº¦ä¸‹é™ç”¨çš„æ˜¯Lossï¼Œè€Œè¿™é‡Œæ˜¯rewardï¼Œæ‰€ä»¥ç»™rewardå–ä¸ªè´Ÿå·å°±æ˜¯lossäº†ã€‚</p><blockquote><p>ä¸Šå¼æ¯”è¾ƒå…·ä½“ï¼Œè®¨è®ºå…¬å¼æ—¶ä¹Ÿå¸¸ç”¨ç®€å•ç‰ˆï¼š$J(\theta)=\mathbb{E}_{\tau \sim \pi_{\theta}}\text{log}P(\tau;\theta)R(\tau)$</p><p>å¯¹äºLLMè€Œè¨€ï¼Œ$\pi_{\theta}(a_t|s_t)$ å°±ç­‰äº $P(t_i|t_{&lt;i},\theta)$</p><p>è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œä¸è¦è¿·ä¿¡Lossçš„ç»å¯¹å€¼å¤§å°ï¼Œå› ä¸ºç†è®ºä¸Šä½ å¯ä»¥ç»™LossåŠ ä¸Šä¸€ä¸ªä»»æ„å¸¸æ•° $c$ è€Œä¸å½±å“å®ƒçš„æ¢¯åº¦ã€‚åªéœ€è¦å…³æ³¨åˆç†çš„éƒ¨åˆ†çš„losså³å¯ã€‚</p></blockquote><h1 id="Advantage-amp-Reward"><a href="#Advantage-amp-Reward" class="headerlink" title="Advantage &amp; Reward"></a>Advantage &amp; Reward</h1><p>æ¯”èµ·æ•´æ¡è½¨è¿¹ $\tau$ è·å¾—ä¸€ä¸ªç¨€ç–çš„å¥–åŠ± $R(\tau)$ï¼Œé‡‡ç”¨ä¼˜åŠ¿å‡½æ•° $A(s,a)$ æ˜¯æ›´è¢«å¹¿æ³›é‡‡ç”¨çš„ç®—æ³•ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><script type="math/tex; mode=display">A(s,a)=Q(s,a) - V(s)</script><p>å…¶ä¸­ï¼Œ$Q(s,a)$ æ˜¯çŠ¶æ€åŠ¨ä½œå€¼å‡½æ•°ï¼Œè¡¨ç¤ºåœ¨å½“å‰çŠ¶æ€ $s$ ä¸‹é‡‡å–åŠ¨ä½œ $a$ çš„æœŸæœ›å¥–åŠ±ï¼›$V(s)$ æ˜¯çŠ¶æ€å€¼å‡½æ•°ï¼Œè¡¨ç¤ºå½“å‰çŠ¶æ€ $s$ åç»­çš„å¹³å‡æ”¶ç›Š</p><p>ç°åœ¨é‡‡ç”¨æœ€å¤šçš„ç­–ç•¥æ˜¯å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡ï¼ˆGeneralized Advantage Estimationï¼‰ã€‚</p><p>P.S. GRPOåˆå›åˆ°äº†ä½¿ç”¨ç¨€ç–å¥–åŠ±</p><h2 id="Baseline-Adjust"><a href="#Baseline-Adjust" class="headerlink" title="Baseline Adjust"></a>Baseline Adjust</h2><p>å…ˆæ¥ä¸¥è°¨ç†è§£ä¸€ä¸‹ä¼˜åŠ¿å‡½æ•°çš„é€‰æ‹©</p><p>ç›´æ¥ä½¿ç”¨å›æŠ¥ $Q$ å¯èƒ½å¯¼è‡´æ–¹å·®è¿‡å¤§ï¼Œå¯ä»¥è¯æ˜å‡å»ä¸€ä¸ªåŸºçº¿ $V(s_t)$ï¼Œå³åœ¨ $s_t$ çŠ¶æ€ä¸‹çš„å¹³å‡æ”¶ç›Šï¼Œå¯ä»¥ä¿è¯æ¢¯åº¦æ— åè€Œæ–¹å·®å‡å°ã€‚</p><script type="math/tex; mode=display">\mathbb{E}_{\tau}[\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)\cdot V(s_t)] = \mathbb{E}_{s_t}[\mathbb{E}_{a_t \sim \pi_{\theta}(\cdot|s_t)}[\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)\cdot V(s_t)| s_t]]</script><p>è§† $s_t$ ä¸ºä¸å˜æ•°ï¼Œåˆ™</p><script type="math/tex; mode=display">\mathbb{E}_{a_t \sim \pi_{\theta}(\cdot|s_t)}[\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)\cdot V(s_t)| s_t] = V(s_t) \cdot \mathbb{E}_{a_t}[\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)|s_t]</script><p>ä»…çœ‹ç¬¬äºŒé¡¹ï¼Œæœ‰</p><script type="math/tex; mode=display">\begin{aligned}\mathbb{E}_{a_t\sim \pi_{\theta}}[\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)|s_t] &= \int \pi_{\theta}(a_t|s_t)\cdot \frac{\nabla_{\theta}\pi_{\theta}(a_t|s_t)}{\pi_{\theta}(a_t|s_t)} da_t \\&= \nabla_{\theta} \int \pi_{\theta}(a_t|s_t)da_t \\&= \nabla_{\theta}1 \\&= 0\end{aligned}</script><p>æ‰€ä»¥æ˜¯æ— åçš„ã€‚æ¡ä»¶æ˜¯ï¼Œvalue functionä¸ $a_t$ æ— å…³ï¼Œæ‰å¯ä»¥åœ¨ç¬¬äºŒæ­¥åšä¸€ä¸ªåˆ†ç¦»ã€‚</p><p>$V(s_t)$ å–ä½œ $\mathbb{E}_{a_t}[Q(s_t, a_t)]$ æ˜¯ä¸€ä¸ªæ¯”è¾ƒè‡ªç„¶çš„æƒ³æ³•ï¼Œå› æ­¤å›æŠ¥åˆè¢«ç§°ä¸ºä¼˜åŠ¿å‡½æ•° $A(s_t, a_t) = Q(s_t, a_t) - V(s_t)$ã€‚æˆ–è€…è¿˜æœ‰åƒGAEä¸­é‡‡ç”¨TD error</p><h2 id="Generalized-Advantage-Estimation"><a href="#Generalized-Advantage-Estimation" class="headerlink" title="Generalized Advantage Estimation"></a>Generalized Advantage Estimation</h2><h3 id="çŠ¶æ€å€¼å‡½æ•°-V-s"><a href="#çŠ¶æ€å€¼å‡½æ•°-V-s" class="headerlink" title="çŠ¶æ€å€¼å‡½æ•° $V(s)$"></a>çŠ¶æ€å€¼å‡½æ•° $V(s)$</h3><p>å¯¹äºæ¯æ¡ $\tau$ï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨ critic model ç»™å‡ºä¸€ä¸ª valueï¼Œåœ¨LLMé‡Œå°±æ˜¯å¯¹rolloutå‡ºæ¥çš„æ•°æ®å†forwardä¸€æ¬¡å¾—åˆ°çš„logitsã€‚</p><h3 id="çŠ¶æ€åŠ¨ä½œå€¼å‡½æ•°-Q-s-a"><a href="#çŠ¶æ€åŠ¨ä½œå€¼å‡½æ•°-Q-s-a" class="headerlink" title="çŠ¶æ€åŠ¨ä½œå€¼å‡½æ•° $Q(s,a)$"></a>çŠ¶æ€åŠ¨ä½œå€¼å‡½æ•° $Q(s,a)$</h3><p>çŠ¶æ€åŠ¨ä½œå€¼çš„å–å€¼ä¸º $r_t+\gamma \cdot V(s_{t+1})$</p><p>ç›´è§‚ç†è§£å°±æ˜¯ï¼ŒåŠ¨ä½œ $a_t$ å¯¹æ˜¯å¦æ‹¿åˆ°reward $r_t$ æœ‰è´¡çŒ®ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜æœŸæœ›ä¸‹ä¸€æ­¥çš„valueè¦å°½é‡å¤§ã€‚</p><p>ç”±äº $V$ æ˜¯æˆ‘ä»¬ç”¨ critic model æ‰“åˆ†å¾—åˆ°çš„logitsï¼Œè¿™é‡Œçš„ $V(s_{t+1})$ å®é™…ä¸Šå·²ç»éšå«äº†ä¸Šä¸€æ­¥å–äº† $a_t$ çš„æ¡ä»¶ï¼Œç”šè‡³å¯ä»¥è¯´åœ¨LLMé‡Œ $s_{t+1}$ å°±æ˜¯ $a_t$ï¼Œå› æ­¤ $Q$ ç¡®å®å¯ä»¥çœ‹ä½œæ˜¯ $s$ ä¸ $a$ çš„å‡½æ•°ã€‚</p><h3 id="å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡-GAE"><a href="#å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡-GAE" class="headerlink" title="å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡ GAE"></a>å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡ GAE</h3><p>ä»¤ $\delta_t=r_t+\gamma \cdot V(s_{t+1}) - V(s_t)$ï¼Œè¿™ä¸€é¡¹è¢«ç§°ä¸ºTDè¯¯å·®</p><p>ç„¶åï¼Œ$A_t^\text{GAE}=\delta_t+\gamma\lambda\cdot A_{t+1}^\text{GAE}$</p><p>æœ€åè®¡ç®—å¾—åˆ°çš„å¥–åŠ±è®°ä¸º $R_t=A_t+V(s_t)$</p><ul><li><p>$\lambda$ çš„ä½œç”¨æ˜¯æ§åˆ¶ä¼˜åŠ¿ä¼°è®¡çš„æ­¥æ•°ã€‚å½“ $\lambda=0$ æ—¶ï¼Œé€€åŒ–ä¸ºä»…ç”¨å½“å‰ä¸€æ­¥çš„ advantageï¼›å½“ $\lambda=1$ æ—¶ï¼Œé€€åŒ–ä¸ºä½¿ç”¨æ— ç©·æ­¥çš„éšæ­¥é•¿è¡°å‡çš„ advantage ä¹‹å’Œã€‚</p></li><li><p>$\gamma$ å°±æ˜¯éšstepè¡°å‡ï¼Œè¢«ç§°ä¸º reward-to-go</p></li><li><p>æˆ‘è¿˜æœ‰ä¸€ä¸ªå¾ˆæœ´ç´ çš„ç–‘é—®æš‚æ—¶æ²¡æœ‰æƒ³æ˜ç™½ï¼ŒTD error ä¸ºä»€ä¹ˆåªå–ä¸€æ­¥ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½æ˜¯ $\delta_t = r_t + \gamma \cdot V(s_{t+1}) + \gamma^2 \cdot V(s_{t+2})- V(s_t)$ã€‚è™½ç„¶å¯èƒ½å¾ˆç®€å•ï¼Œæ¯”å¦‚è¯´ $V(s_{t+2})$ æ¶‰åŠå¦ä¸€æ¬¡ç¯å¢ƒäº¤äº’äº†ï¼Œä½†æˆ‘è¿˜æ˜¯å¸Œæœ›èƒ½å¾—åˆ°ä¸€ä¸ªæ•°å­¦ä¸Šçš„è§£é‡Šã€‚ç­‰æˆ‘ç†è§£è´å°”æ›¼ç®—å­çš„æ€§è´¨åä¼šå†æ¥è¡¥å……è¿™éƒ¨åˆ†ã€‚è‚¯å®šæœ‰ä¸€ä¸ªåŸå› æ˜¯è¦ä¿è¯ $A_t^{\text{GAE}}$ æ”¶æ•›ï¼Œä¸èƒ½éšç€ $n$ å‘æ•£</p></li><li><p>å¹¶ä¸”ï¼Œåœ¨LLMä¸­ï¼Œæˆ‘è§‰å¾— $\delta_t$ å¹¶ä¸é€‚åˆä»£è¡¨ $s_t$ çŠ¶æ€ä¸‹é€‰æ‹©åŠ¨ä½œï¼ˆtokenï¼‰ $a_t$ çš„ä»·å€¼ï¼Œå› ä¸º critic model çš„ token level çš„ value æ–¹å·®å¤ªå¤§ï¼Œ$V(s_{t+1})$ å¹¶ä¸èƒ½å‡†ç¡®åæ˜ çœŸæ­£çš„ä»·å€¼ã€‚æˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œâ€I love eat applâ€ï¼Œé‚£ä¸‹ä¸€ä¸ªè¯è¯´ â€œeâ€ çš„æ¦‚ç‡å¾ˆé«˜ï¼Œ$V(s_{t+1})$ éå¸¸å¤§ï¼Œä½†æ˜¯è¿™ä¸ªåˆé€‚å—ï¼Ÿå®ƒé€‚åˆä½œä¸ºåŸºçº¿å—ï¼Ÿä¸Šé¢çš„æ— åæ€§è¯æ˜æ˜¯åœ¨æœŸæœ›çš„æƒ…å†µä¸‹ã€‚å“ªæ€•PPO batch sizeå¼€çš„éå¸¸å¤§ï¼Œä¹Ÿæ²¡æ³•ä¼°è®¡è¿™ä¸ªä½ç½®å–ä¸åŒ $a_t$ çš„æœŸæœ›ï¼Œå› ä¸ºæ•´æ¡è½¨è¿¹éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯æœ‰åçš„ï¼ˆè€Œä¸”æˆ‘è§‰å¾—åçš„å¾ˆå¤§ï¼‰ã€‚</p></li></ul><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><p>åœ¨Verlä¸­è¿™éƒ¨åˆ†é€»è¾‘çš„ä»£ç å®ç°ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    lastgaelam = <span class="number">0</span></span><br><span class="line">    advantages_reversed = []</span><br><span class="line">    gen_len = token_level_rewards.shape[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(gen_len)):</span><br><span class="line">        nextvalues = values[:, t + <span class="number">1</span>] <span class="keyword">if</span> t &lt; gen_len - <span class="number">1</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">        delta = token_level_rewards[:, t] + gamma * nextvalues - values[:, t]</span><br><span class="line">        lastgaelam = delta + gamma * lam * lastgaelam</span><br><span class="line">        advantages_reversed.append(lastgaelam)</span><br><span class="line">    advantages = torch.stack(advantages_reversed[::-<span class="number">1</span>], dim=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    returns = advantages + values</span><br><span class="line">    advantages = verl_F.masked_whiten(advantages, eos_mask)</span><br><span class="line"><span class="keyword">return</span> advantages, returns</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å€’åºè®¡ç®—æ¥å¤„ç†TD errorçš„åå‘ä¾èµ–å…³ç³»ã€‚</p><h1 id="KL-Loss-Constraint"><a href="#KL-Loss-Constraint" class="headerlink" title="KL Loss Constraint"></a>KL Loss Constraint</h1><p>ç®€å•çš„ä½¿ç”¨ $\Delta\theta = \alpha\nabla_{\theta}J(\theta)$ï¼Œæ¨¡å‹å¯èƒ½ä¼šå´©æ‰ï¼Œéœ€è¦å¢åŠ é™åˆ¶ã€‚å¯¹äºè¯­è¨€æ¨¡å‹è€Œè¨€ï¼Œè¿™ä¸ªé™åˆ¶å°±æ˜¯è¾“å‡ºçš„KLæ•£åº¦ã€‚</p><script type="math/tex; mode=display">\mathcal{D}_{KL}(\pi_{\theta}||\pi_{\theta+\Delta\theta}) = \int_{x} \pi_{\theta}(x)\text{log}\frac{\pi_{\theta}(x)}{\pi_{\theta+\Delta\theta}(x)}dx</script><blockquote><p>ç‰¹åˆ«æ³¨æ„ï¼ŒKLæ•£åº¦æ˜¯éå¯¹ç§°çš„ï¼Œéœ€è¦åˆ†æä¸€ä¸‹ã€‚æˆ‘ä»¬å‡è®¾åˆ†å¸ƒ $P$ æ˜¯å·²çŸ¥çš„ï¼Œ$Q$ æ˜¯å¾…ä¼˜åŒ–çš„ \<br>1Â°) æ­£å‘KLæ•£åº¦ï¼š$\mathcal{D}_{KL}(P||Q) = \int_{x} P(x)\text{log}\frac{P(x)}{Q(x)}dx$ \<br>å½“ $P(x)$ åå¤§æ—¶ï¼ŒKLæ•£åº¦ä¼šæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥ä¼šæ›´å…³æ³¨åœ¨ $P(x)$ è¾ƒå¤§çš„åœ°æ–¹ï¼Œ$Q(x)$ä¹Ÿè¦å°½é‡å¤§ï¼Œè¿™æ ·æ‰èƒ½è®©KLæ•£åº¦åå°ã€‚å› æ­¤ï¼Œåˆ†å¸ƒä¼šå°½å¯èƒ½è¦†ç›–æ‰€æœ‰çš„æ¦‚ç‡å³°ã€‚\<br>2Â°) åå‘KLæ•£åº¦ï¼š$\mathcal{D}_{KL}(Q||P) = \int_{x} Q(x)\text{log}\frac{Q(x)}{P(x)}dx$ \<br>è¿™æ—¶æ°å¥½ç›¸åï¼Œå½“ $P(x)$ åå°çš„æ—¶å€™ï¼ŒKLæ•£åº¦ä¼šéå¸¸å¤§ï¼Œæ‰€ä»¥ä¼šæ›´å…³æ³¨åœ¨ $P(x)$ è¾ƒå°çš„åœ°æ–¹ï¼Œ$Q(x)$ ä¸€å®šè¦å¾ˆå°ï¼Œè¿™ä¼šå¯¼è‡´æœ€åçš„åˆ†å¸ƒé›†ä¸­åœ¨å•ä¸ªå³°ä¸Šï¼Œé¿å…è·¨è¶Šå³°ä¹‹é—´çš„ä½æ¦‚ç‡åŒºåŸŸã€‚\<br>æ€»ç»“ä¸€ä¸‹ï¼Œæ­£å‘KLæ•£åº¦èƒ½æ¯”è¾ƒå‡è¡¡åœ°è´´åˆåŸå§‹åˆ†å¸ƒã€‚è€Œåå‘KLæ•£åº¦æ¯”è¾ƒæç«¯ï¼Œä¼šåç¼©åˆ°å°‘æ•°åˆç†åˆ†å¸ƒã€‚\<br>å‚è€ƒï¼š<a href="https://blog.csdn.net/mch2869253130/article/details/108998463">https://blog.csdn.net/mch2869253130/article/details/108998463</a></p></blockquote><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦é€‰æ‹©ä¸€ä¸ªèƒ½æœ€å¤§åŒ– $J(\theta)$ çš„å˜åˆ† $\Delta\theta$ï¼ŒåŒæ—¶åˆè¦ä¿è¯è¾“å‡ºåˆ†å¸ƒä¸è¦æ¼‚ç§»å¤ªå¤šï¼Œå†™æˆæ•°å­¦å½¢å¼æ˜¯ï¼š</p><script type="math/tex; mode=display">\Delta\theta^* = \mathop{\arg\max}\limits_{\mathcal{D}_{KL}(\pi_{\theta}||\pi_{\theta+\Delta\theta}) \leq \epsilon}J(\theta+\Delta\theta)</script><p>åˆ©ç”¨å‡¸ä¼˜åŒ–ç†è®ºä¸­çš„æ‹‰æ ¼æœ—æ—¥æ¾å¼›ï¼ˆè™½ç„¶æˆ‘å·²ç»å¿˜äº†ï¼Œä¾ç¨€è®°å¾—è¿˜æœ‰ä»€ä¹ˆKKTæ¡ä»¶ï¼‰ï¼Œå¯ä»¥å°†çº¦æŸåŠ å…¥ä¼˜åŒ–ç›®æ ‡ä¸­ä½œä¸ºæƒ©ç½šé¡¹</p><script type="math/tex; mode=display">\Delta\theta^* = \mathop{\arg\max}\limits_{\Delta\theta}J(\theta+\Delta\theta)-\lambda (\mathcal{D}_{KL}(\pi_{\theta} || \pi_{\theta+\Delta\theta})-\epsilon)</script><p>$\lambda\epsilon$ è¿™ä¸€é¡¹å¯ä»¥å¿½ç•¥ï¼Œå®ƒä¸å½±å“æ¢¯åº¦çš„æ–¹å‘åªå½±å“æ¢¯åº¦çš„å¤§å°ï¼Œç­‰ä»·äºè°ƒèŠ‚å­¦ä¹ ç‡çš„å¤§å°ï¼Œå› ä¸º $\alpha \Delta \theta^{\ast} = \alphaâ€™ (\Delta \theta^{\ast} - \lambda \epsilon )$</p><h1 id="Importance-Sampling"><a href="#Importance-Sampling" class="headerlink" title="Importance Sampling"></a>Importance Sampling</h1><p>å‡è®¾æˆ‘ä»¬æƒ³ä¼°è®¡ $f(x)$ çš„æœŸæœ›ï¼Œ$x\sim p(x)$ï¼Œåˆ™ $E_{x\sim p}[f(x)] \approx \frac{1}{N}\sum_{i=1}^Nf(x^i)$</p><p>ä½†æ˜¯å¦‚æœ $p(x)$ ä¸å¯é‡‡æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦ä¸€ä¸ªå¯é‡‡æ ·çš„åˆ†å¸ƒ $q(x)$ æ¥è¿‘ä¼¼é‡‡æ ·ã€‚</p><script type="math/tex; mode=display">E_{x\sim p}[f(x)] = \int f(x)p(x)dx=\int f(x)\frac{p(x)}{q(x)}q(x)dx = E_{x \sim q} [f(x) \frac{p(x)}{q(x)}]</script><p>å…¶ä¸­ $\frac{p(x)}{q(x)}$ è¢«ç§°ä¸º importance weight</p><p>è™½ç„¶æœŸæœ› $E_{x\sim p}[f(x)]=E_{x\sim q}[f(x)\frac{p(x)}{q(x)}]$ æ„æˆäº†ä¸€ä¸ªæ— åä¼°è®¡ï¼Œä½†æ˜¯è€ƒè™‘å¯¹åº”çš„æ–¹å·®ï¼š</p><script type="math/tex; mode=display">\text{Var}_{x\sim p}[f(x)]=E_{x\sim p}[f(x)^2]-(E_{x\sim p}[f(x)])^2</script><script type="math/tex; mode=display">\begin{aligned}\text{Var}_{x\sim q}[f(x)\frac{p(x)}{q(x)}] &= E_{x\sim q}[(f(x)\frac{p(x)}{q(x)})^2]-(E_{x\sim q}[f(x)\frac{p(x)}{q(x)}])^2 \\&= E_{x\sim p}[f(x)^2\frac{p(x)}{q(x)}]-(E_{x\sim q}[f(x)])^2\end{aligned}</script><p>å¯ä»¥å‘ç°ï¼Œå½“ $q(x)$ å’Œ $p(x)$ ç›¸å·®å¾ˆå¤§çš„æ—¶å€™ï¼Œé‡è¦æ€§æƒé‡ $\frac{p(x)}{q(x)}$ å°±ä¼šåç¦»1ï¼Œè¿›è€Œå¯¼è‡´æ–¹å·®å·®å¼‚å˜å¤§ã€‚å› æ­¤ï¼Œé‡è¦æ€§é‡‡æ ·åœ¨é‡‡æ ·ä¸å……åˆ†çš„æ—¶å€™ä¼šé€æ¸å¤±çœŸã€‚</p><p>ä¹‹å‰ä¹Ÿè¯´è¿‡ï¼Œé‡‡æ ·å¾ˆæ˜‚è´µã€‚ä¸€æ¡æ•°æ®é‡‡å‡ºæ¥å¯èƒ½è¢«è®­ç»ƒå¤šæ¬¡ã€‚é‚£åœ¨è®­è¿‡ä¸€æ¬¡ä¹‹åï¼Œè¿™æ¡æ•°æ®å°±ä¸èƒ½çœ‹ä½œæ˜¯ç”±å½“å‰çš„åˆ†å¸ƒ $\pi_{\theta}$ é‡‡å‡ºæ¥çš„äº†ï¼Œè€Œæ˜¯è¿‡å»çš„åˆ†å¸ƒ $\pi_{\thetaâ€™}$ é‡‡æ ·çš„ç»“æœã€‚</p><p>æœ‰äº†é‡è¦æ€§é‡‡æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆoff-policyåœ°ç”¨ $\pi_{\thetaâ€™}$ é‡‡æ ·å¾ˆå¤šæ ·æœ¬ï¼Œç„¶åå†è¿›è¡Œè®­ç»ƒï¼š</p><script type="math/tex; mode=display">\begin{aligned}J(\theta) &=\mathbb{E}_{\tau \sim \pi_{\theta}}[\text{log}P(\tau;\theta)R(\tau)] \\&=\mathbb{E}_{\tau \sim \pi_{\theta'}}[\frac{\pi_{\theta}}{\pi_{\theta'}}\text{log}P(\tau;\theta)R(\tau)]\end{aligned}</script><p>ä½ å¯èƒ½ä¼šæƒ³é—® $\frac{\pi_{\theta}}{\pi_{\thetaâ€™}}$ æ€ä¹ˆç®—ï¼Œè®©æˆ‘ä»¬å±•å¼€æ¥ç†è§£ä¸€ä¸‹å…·ä½“çš„æ„æ€ã€‚</p><script type="math/tex; mode=display">\begin{aligned}J(\theta) &= \mathbb{E}_{\tau \sim \pi_{\theta}} [\sum_{t=0}^T\text{log}\pi_{\theta}(a_t|s_t)A(s_t, a_t)] \\&= \mathbb{E}_{\tau \sim \pi_{\theta'}} [\sum_{t=0}^T\frac{\pi_{\theta}(a_t|s_t)}{\pi_{\theta'}(a_t|s_t)}\text{log}\pi_{\theta}(a_t|s_t)A(s_t, a_t)]\end{aligned}</script><p>è¿™æ ·å°±æ¸…æ¥šå¤šäº†ï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¾ç„¶éƒ½æ˜¯å¯æ±‚çš„ã€‚å†è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬å›åˆ°æ¢¯åº¦å½¢å¼</p><script type="math/tex; mode=display">\begin{aligned}\nabla_{\theta}J(\theta) &= \mathbb{E}_{\tau \sim \pi_{\theta'}} [\sum_{t=0}^T\frac{\pi_{\theta}(a_t|s_t)}{\pi_{\theta'}(a_t|s_t)}\nabla_{\theta}\text{log}\pi_{\theta}(a_t|s_t)A(s_t, a_t)] \\&= \mathbb{E}_{\tau \sim \pi_{\theta'}} [\sum_{t=0}^T\frac{\pi_{\theta}(a_t|s_t)}{\pi_{\theta'}(a_t|s_t)}\frac{\nabla_{\theta}\pi_{\theta}(a_t|s_t)}{\pi_{\theta}(a_t|s_t)}A(s_t, a_t)] \\&= \mathbb{E}_{\tau \sim \pi_{\theta'}} [\sum_{t=0}^T\frac{\nabla_{\theta}\pi_{\theta}(a_t|s_t)}{\pi_{\theta'}(a_t|s_t)}A(s_t, a_t)] \\J(\theta) &= \mathbb{E}_{\tau \sim \pi_{\theta'}} [\sum_{t=0}^T\frac{\pi_{\theta}(a_t|s_t)}{\pi_{\theta'}(a_t|s_t)}A(s_t, a_t)]\end{aligned}</script><p>å¤ªAmazingäº†ã€‚æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ï¼ŒæŠŠé‡‡æ ·åˆ†è§£åˆ°æ¯ä¸ªæ—¶é—´æ­¥ï¼Œå¾—åˆ° </p><script type="math/tex; mode=display">J(\theta) = \mathbb{E}_{(s_t, a_t) \sim \pi_{\theta'}} [\frac{\pi_{\theta}(a_t|s_t)}{\pi_{\theta'}(a_t|s_t)}A(s_t, a_t)]</script><h1 id="PPO"><a href="#PPO" class="headerlink" title="PPO"></a>PPO</h1><p>TODO</p><h2 id="PPO-penalty"><a href="#PPO-penalty" class="headerlink" title="PPO penalty"></a>PPO penalty</h2><p>ç»™rewardæ·»åŠ ä¸€ä¸ª per token çš„KL controlï¼Œæˆ‘æ²¡ææ˜ç™½å®ƒæ•°å­¦ä¸Šçš„æ­£å½“æ€§æ˜¯å“ªé‡Œæ¥çš„ã€‚ä¸è¿‡ï¼Œå¯ä»¥ç®€å•å½“æˆå¯¹rewardçš„ä¸€ä¸ªä¿®æ­£ï¼Œåªåšäº†ä¸€ç‚¹ç‚¹æ”¹å˜å°±æ‹¿åˆ°rewardè‚¯å®šæ¯”åšäº†å¾ˆå¤šæ”¹å˜æ‰æ‹¿åˆ°rewardå¥½ï¼›åšäº†å¾ˆå¤šæ”¹å˜è¿˜æ‹¿ä¸åˆ°rewardçš„ç­–ç•¥æ›´æ˜¯è¦ç‹ ç‹ æƒ©ç½šã€‚</p><script type="math/tex; mode=display">r_t = r_t - \beta \text{log} \frac{\pi_{\theta}}{\pi_{\theta'}}</script><p>å‚è€ƒç­–ç•¥å¯ä»¥æ˜¯è‡ªå·±ï¼Œä¹Ÿå¯ä»¥æ˜¯sftå¯åŠ¨åçš„ref modelï¼Œä¸è¿‡ç°åœ¨éƒ½ä¸è¿™ä¹ˆåšäº†ã€‚è€Œä¸”ä»åè€…è§’åº¦ç†è§£çš„è¯å°±ä¼šè§‰å¾—æœ‰ç‚¹å¥‡æ€ªï¼Œè®©æ¨¡å‹å»å­¦ref modelï¼Œå¯èƒ½æ˜¯æ‰¾ä¸€æ¡æ›´å¹³æ»‘çš„æ¥è¿‘ï¼Ÿ</p><h2 id="PPO-Clip"><a href="#PPO-Clip" class="headerlink" title="PPO Clip"></a>PPO Clip</h2><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>ã€Proximal Policy Optimization (PPO) ç®—æ³•ç†è§£ï¼šä»ç­–ç•¥æ¢¯åº¦å¼€å§‹ã€‘<a href="https://zhuanlan.zhihu.com/p/614115887">https://zhuanlan.zhihu.com/p/614115887</a></p><p>ã€ä»Importance Samplingåˆ°PPOã€‘<a href="https://zhuanlan.zhihu.com/p/388707220">https://zhuanlan.zhihu.com/p/388707220</a></p><p>ã€Why does the â€œreward to goâ€ trick in policy gradient methods work?ã€‘<a href="https://ai.stackexchange.com/questions/9614/why-does-the-reward-to-go-trick-in-policy-gradient-methods-work">https://ai.stackexchange.com/questions/9614/why-does-the-reward-to-go-trick-in-policy-gradient-methods-work</a></p>]]></content>
      
      
      <categories>
          
          <category> Reinforcement Learning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Reinforcement Learning </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢å¤æ›´æ–°é€šçŸ¥ &amp; 2025plan</title>
      <link href="/posts/10021.html"/>
      <url>/posts/10021.html</url>
      
        <content type="html"><![CDATA[<p>æ¢å¤æ›´æ–°ï¼æ¢å¤æ›´æ–°ï¼</p><p>æœ‰ä¸€ä¸ªä¸ªäººåšå®¢å´ä¸å†™ç‚¹ä»€ä¹ˆå®åœ¨æ˜¯å¤ªå¯æƒœäº†ã€‚</p><p>è¿‡å»çš„ä¸€å¹´å‘ç”Ÿäº†å¾ˆå¤šäº‹æƒ…ï¼Œä¸è®ºæ˜¯äºæˆ‘è¿˜æ˜¯äºæˆ‘æ­£åœ¨æŠ•å…¥çš„é¢†åŸŸã€‚</p><p>ä½†æ˜¯æˆ‘å´æ²¡èƒ½ç•™ä¸‹ä»€ä¹ˆä¸œè¥¿ã€‚</p><p>è¿‡å»åŠå¹´åœ¨Shanghai AI Labå®ä¹ ï¼Œæ„Ÿè§‰è‡ªå·±Engineeringå’ŒResearchçš„èƒ½åŠ›éƒ½æœ‰æ‰€æé«˜äº†ã€‚</p><p>ç°åœ¨çš„è¯ï¼Œæ„Ÿè§‰èƒ½å†™ä¸‹ç‚¹æœ‰ç”¨çš„ä¸œè¥¿å§~</p>]]></content>
      
      
      <categories>
          
          <category> Other </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Other </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.824 Distributed System Lab2</title>
      <link href="/posts/10023.html"/>
      <url>/posts/10023.html</url>
      
        <content type="html"><![CDATA[<p>Lab Pageï¼š<a href="http://nil.csail.mit.edu/6.824/2022/labs/lab-raft.html">http://nil.csail.mit.edu/6.824/2022/labs/lab-raft.html</a></p><h1 id="Labæ¦‚è¿°"><a href="#Labæ¦‚è¿°" class="headerlink" title="Labæ¦‚è¿°"></a>Labæ¦‚è¿°</h1><p>æœ¬æ¬¡labéœ€è¦å®ç°å…±è¯†ç®—æ³•raftã€‚Lab2Aæˆ‘çœ‹åº”è¯¥æ˜¯åªéœ€è¦åšå‡ºelectionå°±å¯ä»¥ï¼Œä¸€æ­¥ä¸€æ­¥æ¥å§ã€‚</p><h1 id="RaftçŸ¥è¯†ç‚¹"><a href="#RaftçŸ¥è¯†ç‚¹" class="headerlink" title="RaftçŸ¥è¯†ç‚¹"></a>RaftçŸ¥è¯†ç‚¹</h1><p>ç½‘è¯¾è®²çš„æœ‰äº›æ…¢å“ˆå“ˆï¼Œæˆ‘ç›´æ¥çœ‹åšå®¢å­¦ä¹ äº†ï¼š<a href="https://zhuanlan.zhihu.com/p/404315977">https://zhuanlan.zhihu.com/p/404315977</a></p><p>åœ¨Raftä¸­ï¼ŒèŠ‚ç‚¹çš„çŠ¶æ€ä¸€å…±ä¸‰ç§ï¼Œfollowerï¼Œcandidateå’Œleaderï¼Œæ¯ä¸ªèŠ‚ç‚¹åœ¨åŠ å…¥æ—¶éƒ½ä¼šé»˜è®¤æˆä¸ºfollowerã€‚</p><p>followerå¹¶ä¸ä¸»åŠ¨å‘å‡ºæ¶ˆæ¯ï¼Œå®ƒæ‰€åšçš„æ“ä½œå¦‚ä¸‹ï¼š</p><ul><li><p>æ”¶åˆ°leaderçš„heartbeatï¼Œç»´æŒfollowerçŠ¶æ€ã€‚å¦‚æœä¹‹å‰æ²¡è¯†åˆ«åˆ°leaderæˆ–è¯†åˆ«äº†åˆ«çš„leaderï¼Œåˆ™æ›´æ–°ã€‚</p></li><li><p>å¦‚æœä¸€æ®µæ—¶é—´electionTimeå†…æ²¡æœ‰æ”¶åˆ°heartbeatï¼Œåˆ™è®¤ä¸ºleaderå·²ç»å˜äº†ï¼Œå°†è‡ªå·±çš„ä»»æœŸtermåŠ 1ï¼Œæˆä¸ºcandidateï¼Œå¹¶å‘å…¶å®ƒæˆå‘˜å‘èµ·æŠ•ç¥¨è¯·æ±‚ã€‚</p></li><li><p>æ¥æ”¶åˆ°åˆ«çš„candidateçš„æŠ•ç¥¨è¯·æ±‚ï¼Œä¾æ®å…ˆæ¥ååˆ°åŸåˆ™ï¼Œåªç»™ä¸€ä¸ªcandidateæŠ•ç¥¨ã€‚candidateçš„termä»¥åŠæ—¥å¿—indexå¿…é¡»å¤§äºè‡ªå·±ï¼Œå¦åˆ™ä¸ä¼šæŠ•ç¥¨ã€‚ï¼ˆè¿™è¾¹æˆ‘æš‚æ—¶ä¸æ˜¯å¾ˆç¡®å®šæ˜¯å¤§äºè¿˜æ˜¯å¤§äºç­‰äºï¼‰ï¼ˆä¼šä¸ä¼šæœ‰è‡ªå·±çš„ä»»æœŸæ˜¯3ï¼Œæœ‰ä¸€ä¸ªä»»æœŸä¸º4çš„candidateçš„requestè¿‡æ¥ä¹‹åï¼Œåˆæœ‰ä¸€ä¸ªä»»æœŸä¸º5çš„candidateçš„requestã€‚è¿™ä¸ªæ—¶å€™åº”è¯¥è¿˜æ˜¯è¦æŠ•ç¥¨å§ï¼Ÿæ‰€ä»¥ä¸€å¼ ç¥¨çš„é™åˆ¶åº”è¯¥æ˜¯ä»¥ä»»æœŸä¸ºå•ä½çš„ï¼Ÿï¼‰</p></li><li><p>æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚åï¼Œè½¬å‘ç»™leaderã€‚ï¼ˆè¿™è¾¹ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¯¹äºæ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼Œå®ƒè¿˜æ²¡è®¤è¯†åˆ°é›†ç¾¤ä¸­çš„leaderï¼Œè¿™é‡Œçš„è¯·æ±‚æ˜¯ç›´æ¥ä¸¢å¼ƒè¿˜æ˜¯æŒ‰ä¸‹ä¸è¡¨ï¼‰</p></li></ul><p>candidateæ˜¯ä¸€ç§ä¸´æ—¶çŠ¶æ€ï¼Œå®ƒæ‰€åšçš„æ“ä½œå¦‚ä¸‹ï¼š</p><ul><li><p>å‘å…¶å®ƒfollowerå‘èµ·è¯·æ±‚ï¼Œéœ€è¦ä¼ é€’è‡ªå·±çš„ä»»æœŸå·termå’Œæ—¥å¿—è¿›åº¦indexã€‚</p></li><li><p>å¦‚æœæ”¶åˆ°äº†å¤šæ•°æˆå‘˜çš„èµæˆç¥¨ï¼Œåˆ™è‡ªå·±æˆä¸ºleaderï¼ˆå› ä¸ºä¸€ä¸ªfolloweræœ€å¤šæŠ•ä¸€æ¬¡ç¥¨ï¼Œçœ‹ä¸Šå»å¤šæ•°èµæˆç¥¨åªèƒ½æœ‰ä¸€ä¸ªï¼Œä½†æ˜¯ä¸åŒèŠ‚ç‚¹ç»´æŠ¤çš„peerçŠ¶æ€å¯èƒ½äº§ç”Ÿåå·®ï¼Œå¯¼è‡´å¯¹â€œå¤šæ•°â€äº§ç”Ÿè¯¯è§£ï¼Œç”Ÿæˆä¸¤ä¸ªç”šè‡³å¤šä¸ªleaderã€‚raftå¯¹è¿™ä¸€é—®é¢˜çš„è¦æ±‚æ˜¯ï¼Œä¸€ä¸ªtermå†…åªèƒ½æœ‰leaderã€‚ï¼ˆæ‰€ä»¥å…·ä½“æ€ä¹ˆæ§åˆ¶çš„å‘¢ï¼Ÿï¼‰ï¼‰</p></li><li><p>å¦‚æœæ”¶åˆ°äº†åˆ«çš„leaderçš„heartbeatï¼Œåˆ™è½¬å˜å›followerçŠ¶æ€ã€‚ï¼ˆé‚£å¦‚æœåœ¨å¦ä¸€ä¸ªleaderçš„heartbeatåˆ°è¾¾å‰ï¼Œè‡ªå·±ä¹Ÿå˜æˆäº†leaderæ€ä¹ˆåŠï¼Ÿï¼ˆæœ‰æ—¶å€™å°±æ˜¯æœ‰è¿™ä¹ˆå·§åˆï¼‰ï¼‰</p></li><li><p>æ„Ÿè§‰æˆ‘å¯¹Termçš„ç†è§£ä¸å¤ªå¯¹å“ˆå“ˆã€‚é™¤äº†ä¸Šé¢çš„æƒ…å†µï¼Œå¦‚æœæ”¶åˆ°äº†ä¸€ä¸ªreplyè¯·æ±‚æºå¸¦çš„termæ¯”è‡ªå·±å¤§ã€‚è¯´æ˜é€‰ä¸¾å·²ç»è¿›è¡Œåˆ°ä¸‹ä¸€é˜¶æ®µï¼Œå·²ç»äº§ç”Ÿäº†ä¸‹ä¸€ä»£çš„å…±è¯†çš„leaderï¼Œè‡ªå·±å°±è¯¥è½¬å˜å›followerçŠ¶æ€ã€‚</p></li><li><p>candidateæœ‰ä¸€ä¸ªéšæœºçš„é€‰ä¸¾æ—¶é™ï¼Œè¶…è¿‡æ—¶é™è¿˜æ²¡èƒœå‡ºåˆ™å®£å¸ƒå¤±è´¥ï¼Œé‡æ–°å˜å›followerã€‚éšæœºæ˜¯ä¸ºäº†é¿å…é™·å…¥æŸç§é€‰ç¥¨ç“œåˆ†çš„æ­»å±€ã€‚ï¼ˆéšæœºå¤šå°‘ä¹Ÿè¦å…·ä½“è°ƒæ•´ï¼‰</p></li></ul><p>leaderæˆ‘ä»¬æš‚æ—¶ä¸è€ƒè™‘å®ƒå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„é—®é¢˜ï¼Œåªè€ƒè™‘å®ƒåœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­çš„æ“ä½œï¼š</p><ul><li>å®šæœŸå‘å…¶å®ƒèŠ‚ç‚¹å‘é€heartbeat</li></ul><p>ä»¥ä¸Šï¼Œå¯ä»¥çœ‹è§è¿˜æ˜¯æœ‰å¾ˆå¤šç–‘æƒ‘çš„ç‚¹çš„ï¼Œè¿˜æœ‰æ²¡å†™å‡ºæ¥çš„æ¯”å¦‚peeråˆ—è¡¨æ€ä¹ˆç»´æŠ¤ç­‰ç­‰ï¼Œå†™labçš„è¿‡ç¨‹ä¸­å°±ä¼šæ…¢æ…¢æƒ³æ˜ç™½çš„å§ã€‚</p><p>æ¥ä¸‹æ¥åº”è¯¥å°±æ˜¯çœ‹ä»£ç äº†ã€‚è¿™æ¬¡æˆ‘å¸Œæœ›èƒ½å¤Ÿçœ‹å¾—ä»”ç»†ä¸€ç‚¹å§ï¼Œå› ä¸ºåé¢è¿˜æœ‰2Bï¼Œ2Cï¼Œ2Dæ˜¯æ‰¿æ¥Lab2Aè¿›è¡Œä¸‹å»çš„ã€‚</p><h1 id="åŸºç¡€ä»£ç æ¡†æ¶"><a href="#åŸºç¡€ä»£ç æ¡†æ¶" class="headerlink" title="åŸºç¡€ä»£ç æ¡†æ¶"></a>åŸºç¡€ä»£ç æ¡†æ¶</h1><p>è¿˜æ˜¯ä¸Šæ¥ä¸€å¤´é›¾æ°´ï¼Œæ€»ä¹‹è¦å†™çš„ä»£ç åœ¨raft/raft.goé‡Œ</p><p>æœ€åŸºç¡€çš„ä¸€ä¸ªèŠ‚ç‚¹åº”è¯¥å°±æ˜¯è¿™ä¸ªraftç»“æ„ä½“ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Raft <span class="keyword">struct</span> &#123;</span><br><span class="line">mu        sync.Mutex          <span class="comment">// Lock to protect shared access to this peer&#x27;s state</span></span><br><span class="line">peers     []*labrpc.ClientEnd <span class="comment">// RPC end points of all peers</span></span><br><span class="line">persister *Persister          <span class="comment">// Object to hold this peer&#x27;s persisted state</span></span><br><span class="line">me        <span class="type">int</span>                 <span class="comment">// this peer&#x27;s index into peers[]</span></span><br><span class="line">dead      <span class="type">int32</span>               <span class="comment">// set by Kill()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå»çœ‹ä¸€ä¸‹ <code>*Persister</code> æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ã€‚</p><p>è¿˜æ˜¯ä¸å¤ªæ˜ç™½goè¯­è¨€çš„importé€»è¾‘ã€‚ <code>Persister</code>æ˜¯å®šä¹‰åœ¨åŒå±package raftä¸‹çš„ persister.go ä¸­çš„ç»“æ„ä½“ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Persister <span class="keyword">struct</span> &#123;</span><br><span class="line">mu        sync.Mutex</span><br><span class="line">raftstate []<span class="type">byte</span></span><br><span class="line">snapshot  []<span class="type">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½å§ï¼Œè®ºæ–‡é‡Œä»‹ç»äº†ä»€ä¹ˆæ˜¯persisterã€‚æ€»ä¹‹å°±æ˜¯ï¼Œpersisterè¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªèŠ‚ç‚¹è¦å­˜çš„æŒä¹…åŒ–çŠ¶æ€ã€‚è‡³äºæŒä¹…åŒ–çŠ¶æ€æœ‰ä»€ä¹ˆå‘¢ï¼Ÿåœ¨è®ºæ–‡çš„figure2é‡Œæœ‰ã€‚</p><p>æˆ‘ä¸æ˜¯å¾ˆæ‡‚ä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦åŠ ä¸€ä¸ªé”ï¼Ÿå˜›ï¼Œæš‚æ—¶æ²¡æƒ³åˆ°ä¼šå†²çªçš„æƒ…å†µã€‚ä»¥åæ“ä½œä¸€ä¸ªèŠ‚ç‚¹æ—¶å†…éƒ¨è¿˜ä¼šé‡åˆ°å†²çªå—ã€‚å“¦ï¼Œä¹Ÿåˆç†ï¼Œå› ä¸ºä»¥åå¯èƒ½ä¼šæœ‰å¾€æœ¬åœ°å­˜å‚¨å†™Persisterçš„æ—¶å€™ï¼Œä¸å¯èƒ½åŒæ—¶å…è®¸Raftè¿‡ç¨‹ä¿®æ”¹Persisterã€‚æ‰€ä»¥Persisterè¿™æ¬¡Lab2Aåº”è¯¥ç”¨ä¸åˆ°å§ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://i.072333.xyz/file/ff8a7f3f738c21a47a0b2.png" style="width:600px;"/></div></div><h2 id="rpcå‚æ•°ä¸Makeå‡½æ•°"><a href="#rpcå‚æ•°ä¸Makeå‡½æ•°" class="headerlink" title="rpcå‚æ•°ä¸Makeå‡½æ•°"></a>rpcå‚æ•°ä¸Makeå‡½æ•°</h2><p>æ ¹æ®Hint4ï¼Œæˆ‘ä»¬å…ˆæ¥è¡¥å…¨requestVoteï¼ŒæŒ‰ç…§å›¾ç¤ºçš„å†…å®¹ã€‚è®°å¾—RPCçš„å‚æ•°è¦æ˜¯å¤§å†™å­—æ¯å¼€å¤´ï¼ŒLab1é‡Œè¸©è¿‡å‘äº†ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://i.072333.xyz/file/1783f5b4bc63fd53158b4.png" style="width:600px;"/></div></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RequestVoteArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">Term         <span class="type">int</span>  <span class="comment">// candidateâ€™s term</span></span><br><span class="line">CandidateId  <span class="type">int</span>  <span class="comment">// candidate requesting vote</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> RequestVoteReply <span class="keyword">struct</span> &#123;</span><br><span class="line">Term         <span class="type">int</span>   </span><br><span class="line">VoteGranted  <span class="type">bool</span>  <span class="comment">// è¡¨ç¤ºæ˜¯å¦æ”¶åˆ°æŠ•ç¥¨ </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ <code>Make()</code> å‡½æ•°çš„ä½œç”¨æ˜¯åˆå§‹åŒ–ä¸€ä¸ªraftèŠ‚ç‚¹ï¼Œè¦ç†æ¸…éœ€è¦åšçš„äº‹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Make</span><span class="params">(peers []*labrpc.ClientEnd, me <span class="type">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">persister *Persister, applyCh <span class="keyword">chan</span> ApplyMsg)</span></span> *Raft &#123;</span><br><span class="line">rf := &amp;Raft&#123;&#125;  <span class="comment">// rfæ˜¯ä¸€ä¸ªæŒ‡é’ˆ</span></span><br><span class="line">rf.peers = peers  <span class="comment">// åœ¨goä¸­ï¼ŒæŒ‡é’ˆæŒ‡å‘æˆå‘˜å˜é‡ä¸éœ€è¦ä½¿ç”¨-&gt;</span></span><br><span class="line">rf.persister = persister</span><br><span class="line">rf.me = me</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your initialization code here (2A, 2B, 2C).</span></span><br><span class="line"></span><br><span class="line">rf.state = Follower</span><br><span class="line">rf.leaderId = <span class="number">-1</span>  <span class="comment">// è¡¨ç¤ºè¿˜æ²¡æœ‰leader</span></span><br><span class="line"><span class="keyword">go</span> rf.StartElection()</span><br><span class="line"></span><br><span class="line"><span class="comment">// initialize from state persisted before a crash</span></span><br><span class="line">rf.readPersist(persister.ReadRaftState())</span><br><span class="line"></span><br><span class="line"><span class="comment">// start ticker goroutine to start elections</span></span><br><span class="line"><span class="keyword">go</span> rf.ticker()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> rf</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯éœ€è¦å°†èŠ‚ç‚¹çš„çŠ¶æ€è®¾ä¸ºfollowerï¼Œä¸å¦¨ç»™raftèŠ‚ç‚¹åŠ ä¸Šä¸€ä¸ªstateå±æ€§ã€‚å¯ä»¥å®šä¹‰ä¸€ä¸ªconstæ˜ å°„ï¼Œæ¥å¢å¼ºä»£ç çš„å¯è¯»æ€§ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Follower = <span class="number">0</span></span><br><span class="line">    Candidate = <span class="number">1</span></span><br><span class="line">    Leader = <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>è¿™è¾¹ï¼Œåº”è¯¥æŠŠé€‰ä¸¾è¿‡ç¨‹é‡æ–°goä¸€ä¸ªè¿›ç¨‹ã€‚é€‰ä¸¾æ˜¯éœ€è¦å®šæœŸå‘èµ·çš„ï¼ˆé™¤éæ”¶åˆ°leaderçš„heartbeatï¼‰ï¼Œä¸å¦¨è®¾ç½®æˆæ— é™å¾ªç¯ï¼Œæ¯150mså‘èµ·ä¸€æ¬¡ï¼ˆä¹‹åä¼šè°ƒæ•´ï¼‰ã€‚</p><p>è®°å½•ä¸‹å¼€å§‹çš„æ—¶é—´startTimeï¼Œç­‰å¾…150msã€‚ä½¿ç”¨ä¸€ä¸ªlastReceiveTimeå±æ€§ï¼Œè®°å½•åœ¨è¿™150mså†…ï¼Œrfæ˜¯å¦æ”¶åˆ°äº†heartbeatï¼ˆå¯èƒ½è¿˜æœ‰åˆ«çš„æ“ä½œï¼Œåç»­è¡¥å……ï¼‰ã€‚å¦‚æœæ”¶åˆ°äº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå‘èµ·é€‰ä¸¾ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> StartElection() &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">electionTimeout := rand.Intn(<span class="number">150</span>)</span><br><span class="line">startTime := time.Now()</span><br><span class="line">        time.Sleep(time.Duration(electionTimeout) * time.Millisecond) <span class="comment">// æ¯150sä¸€æ¬¡</span></span><br><span class="line">        rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> atomic.LoadInt32(&amp;rf.dead) == Dead &#123;  <span class="comment">// åŠ ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æŒ‚äº†çš„åˆ¤æ–­ã€‚å¦‚æœKill()ä¸€ä¸ªèŠ‚ç‚¹ï¼Œrf.deadå°±ä¼šè¢«è®¾ä¸º1</span></span><br><span class="line">            rf.mu.Unlock()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">if</span> rf.lastReceiveTime &gt; startTime &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> rf.state != Leader &#123;</span><br><span class="line">rf.convertToCandidate()</span><br><span class="line">args := RequestVoteArgs&#123;</span><br><span class="line">Term:         rf.currentTerm,</span><br><span class="line">CandidateId:  rf.me,</span><br><span class="line">&#125;</span><br><span class="line">numVote := <span class="number">1</span>    <span class="comment">// æ”¶åˆ°çš„é€‰ç¥¨æ•°</span></span><br><span class="line"><span class="comment">// å¼€å§‹å‘æ¯ä¸ªèŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ã€‚</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(rf.peers); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> i == rf.me &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(peerId <span class="type">int</span>)</span></span> &#123;  <span class="comment">// è¿™é‡Œå¿…é¡»å•ç‹¬goä¸€ä¸ªè¿›ç¨‹ï¼Œå› ä¸ºrpcéœ€è¦æ—¶é—´</span></span><br><span class="line">replay := RequestVoteReply&#123;&#125;</span><br><span class="line">ok := sendRequestVote(i, args, reply)  </span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> replay.Term &gt; rf.currentTerm &#123;</span><br><span class="line">rf.convertToFollower(replay.Term)  <span class="comment">// åŒæ­¥åˆ°è¯¥èŠ‚ç‚¹çš„ä»»æœŸ</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> replay.VoteGranted &#123;</span><br><span class="line">numVote++</span><br><span class="line"><span class="keyword">if</span> numVote &gt; <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> &amp;&amp; rf.state == Candidate &#123;</span><br><span class="line">rf.convertToLeader()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">&#125; (i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€æ­¥è½¬å˜çŠ¶æ€å¯ä»¥åšä¸€å®šçš„å°è£…å¢å¼ºå¯è¯»æ€§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> convertFollower(newTerm <span class="type">int</span>) &#123;</span><br><span class="line">    rf.state = Follower</span><br><span class="line">rf.currentTerm = newTerm</span><br><span class="line">    rf.votedFor = <span class="number">-1</span></span><br><span class="line">rf.lastReceiveTime = time.Now()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> convertToCandidate() &#123;</span><br><span class="line">    rf.state = Candidate</span><br><span class="line">    rf.currentTerm++       <span class="comment">// å¢åŠ è‡ªå·±çš„ä»»æœŸ</span></span><br><span class="line">    rf.votedFor = rf.me    <span class="comment">// æŠ•ç¥¨ç»™è‡ªå·±</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> convertToLeader() &#123;</span><br><span class="line">    rf.state = Leader</span><br><span class="line">rf.leaderId = rf.me</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sendRequestVote"><a href="#sendRequestVote" class="headerlink" title="sendRequestVote()"></a>sendRequestVote()</h2><p>è¿™é‡Œï¼Œæˆ‘ä»¬çš„RPCè¯·æ±‚ç”± <code>sendRequestVote</code> å°è£…äº† <code>RequestVote</code>ï¼Œè¿˜è¦å®ç°ä¸€ä¸‹ã€‚</p><p>æ•´ç†å¥½argså’Œreplyçš„å‚æ•°å³å¯ã€‚å¼ºè°ƒä¸€ä¸‹ä»»æœŸè¿™ä¸€æ¦‚å¿µï¼Œæœ¬èº«å°±æ˜¯é€šè¿‡èŠ‚ç‚¹é—´çš„å…±è¯†æ¨è¿›çš„ï¼Œæ‰€ä»¥è½åå°±ä»£è¡¨ç€æŸä¸ªèŠ‚ç‚¹é”™è¿‡äº†ä¸€æ¬¡çš„leaderç»Ÿç­¹ï¼Œä½ä»»æœŸæ— æ¡ä»¶å‘é«˜ä»»æœŸçš„èŠ‚ç‚¹æŠ•é™ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> RequestVote(args *RequestVoteArgs, reply *RequestVoteReply) &#123;</span><br><span class="line"><span class="comment">// Your code here (2A, 2B).</span></span><br><span class="line">rf.mu.Lock()</span><br><span class="line">reply.Term = rf.currentTerm</span><br><span class="line"><span class="keyword">if</span> args.Term &lt; rf.currentTerm &#123;</span><br><span class="line">        reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> args.Term &gt; rf.currentTerm &#123;  <span class="comment">// å¦‚æœåˆ«äººçš„ä»»æœŸæ›´å¤§ï¼Œé‚£è‡ªå·±å¿…ä¸å¯èƒ½ç«äº‰è¿‡ï¼Œç›´æ¥æŠ•é™å˜ä¸ºfollower</span></span><br><span class="line">            rf.convertToFollower(args.Term)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> rf.votedFor == <span class="number">-1</span> &#123;</span><br><span class="line">            rf.votedFor = args.CandidateId</span><br><span class="line">            reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•æ¡†æ¶é€»è¾‘"><a href="#æµ‹è¯•æ¡†æ¶é€»è¾‘" class="headerlink" title="æµ‹è¯•æ¡†æ¶é€»è¾‘"></a>æµ‹è¯•æ¡†æ¶é€»è¾‘</h1><p>åªèƒ½è¯´goçš„è°ƒç”¨ç¡®å®æ¯”è¾ƒå¤æ‚ï¼Œè¿˜æ˜¯pythonç”¨å¤ªå¤šäº†ã€‚</p><p>å•Šé¦–å…ˆè¦è§£é‡Šä¸€ä¸‹ï¼Œæˆ‘ä»¬ç¼–è¯‘è¿è¡Œçš„æ˜¯ <code>go test -run 2A</code>ï¼Œè¿™æ˜¯goçš„testæ¡†æ¶çš„çº¦å®šï¼Œæ„æ€æ˜¯ï¼Œå®ƒä¼šæ‰§è¡Œå½“å‰æ–‡ä»¶å¤¹ä¸‹çš„ä¸€ä¸ªä»¥ â€œ_testâ€ ç»“å°¾çš„goæ–‡ä»¶ä¸­çš„æ‰€æœ‰ â€œä»¥Testå¼€å¤´ï¼Œä»¥2Aç»“å°¾â€ çš„å‡½æ•°ã€‚å¾ˆç¥å¥‡å§</p><p>æˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹ <code>test_test.go</code> ä¸­çš„ <code>TestInitialElection2A</code>å‡½æ•°</p><p>å®ƒä¼šè°ƒç”¨ <code>config.go</code> ä¸­çš„ <code>make_config</code> å‡½æ•°ï¼Œæ¥åˆå§‹åŒ–èŠ‚ç‚¹çŠ¶æ€ä¿å­˜åˆ°cfgå˜é‡ä¸­ã€‚</p><p>åœ¨ <code>make_config</code> ä¸­ï¼Œä¸»è¦ä¸€æ­¥æ˜¯ <code>start1</code> ï¼Œä½œç”¨æ˜¯åˆå§‹åŒ–ä¸€ä¸ªraftèŠ‚ç‚¹ï¼Œå…¶ä¸­å°±è°ƒç”¨äº†æˆ‘ä»¬åœ¨ <code>raft.go</code> ä¸­å†™çš„ <code>Make</code> å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rf := Make(ends, i, cfg.saved[i], applyCh)</span><br><span class="line">cfg.mu.Lock()</span><br><span class="line">cfg.rafts[i] = rf</span><br><span class="line">cfg.mu.Unlock()</span><br></pre></td></tr></table></figure><p>å—¯ï¼Œåé¢ç­‰ä¼šå†çœ‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Distributed System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Distributed System </tag>
            
            <tag> Lab </tag>
            
            <tag> Notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT 6.824 Distributed System Lab1</title>
      <link href="/posts/10022.html"/>
      <url>/posts/10022.html</url>
      
        <content type="html"><![CDATA[<p>Lab page: <a href="http://nil.csail.mit.edu/6.824/2022/labs/lab-mr.html">http://nil.csail.mit.edu/6.824/2022/labs/lab-mr.html</a></p><h1 id="Labæ¦‚è¿°"><a href="#Labæ¦‚è¿°" class="headerlink" title="Labæ¦‚è¿°"></a>Labæ¦‚è¿°</h1><p>æ­£å¥½è¿™å­¦æœŸæ­£å¥½å­¦æ ¡é‡Œè¦ä¸Šâ€å¹¶è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿâ€, ä¹Ÿæœ‰åŒå­¦æ¨èæˆ‘å»å­¦ä¹ è¿™é—¨MITçš„è¯¾ç¨‹ï¼Œé‚åšä¸€äº›å°è¯•ã€‚</p><p>æœ¬æ¬¡Lab1ä¸»è¦æ˜¯å®ç°ä¸€ä¸ªç®€å•çš„MapReduceæ¡†æ¶ï¼Œå®ŒæˆCoordinatorå’ŒWorkerçš„è®¾è®¡ï¼Œå®ç°ä¸€ä¸ªWord Countç¨‹åºã€‚</p><p>å…¨è¯¾ç¨‹Labä¸»è¦é‡‡ç”¨goè¯­è¨€æ¥å®ç°ï¼Œå­¦ä¹ goè¯­è¨€è¯­æ³•ä¹Ÿæ˜¯å¼€å§‹æœ¬æ¬¡Labçš„ç¬¬ä¸€æ­¥ã€‚</p><p>ä»¥ä¸‹æ‰€æœ‰å†…å®¹ä»…ä¸ºä¸ªäººè®°å½•æ‰€ç”¨ï¼Œè¯·ä¾ç…§è¯¾ç¨‹è¦æ±‚ç‹¬ç«‹å®ŒæˆLabå®éªŒã€‚</p><p>ä»¥ä¸Šã€‚è®°å½•ä¸€ä¸‹æœ¬æ¬¡çš„Lab1çš„å®ç°æ€è·¯ã€‚</p><h1 id="ä¸€ã€å®‰è£…goç¯å¢ƒ"><a href="#ä¸€ã€å®‰è£…goç¯å¢ƒ" class="headerlink" title="ä¸€ã€å®‰è£…goç¯å¢ƒ"></a>ä¸€ã€å®‰è£…goç¯å¢ƒ</h1><p>ä¸Šæ¥é¦–å…ˆå…ˆå®‰è£…ä¸€ä¸‹ä»¥å‰æ²¡ç”¨è¿‡çš„goç¯å¢ƒã€‚æˆ‘æ˜¯åœ¨å®éªŒå®¤linuxæœåŠ¡å™¨ä¸Šè¯•çš„ï¼Œwindowsç³»ç»Ÿå°±ä¸å¤ªæ¸…æ¥šäº†ã€‚ã€‚</p><p>é¦–å…ˆä¸‹è½½goçš„å®‰è£…åŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://go.dev/dl/go1.17.6.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå°†å…¶è§£å‹åˆ° $HOME/local ä¸‹</p><p>ä¹‹åéœ€è¦å°†goå‘½ä»¤åŠ åˆ°PATHä¸­</p><p>ä¸€ç§æ–¹æ³•æ˜¯ <code>export PATH=$PATH:$HOME/local/go/bin</code> ï¼Œä½†æ˜¯è¿™æ ·æ˜¯æš‚æ—¶çš„ï¼Œä¸‹æ¬¡å¯åŠ¨å°±æ²¡æœ‰äº†</p><p>è§£å†³åŠæ³•å°±æ˜¯æŠŠè¿™å¥è¯åŠ åˆ° .bashrc ä¸­çš„æœ€åå³å¯</p><p>é¡ºä¾¿ä½¿ç”¨ <code>echo -e $PATH | tr &quot;:&quot; &quot;\n&quot;</code> å¯ä»¥æŸ¥çœ‹å½“å‰çš„PATH</p><h1 id="äºŒã€ä¸‹è½½Labæ¡†æ¶"><a href="#äºŒã€ä¸‹è½½Labæ¡†æ¶" class="headerlink" title="äºŒã€ä¸‹è½½Labæ¡†æ¶"></a>äºŒã€ä¸‹è½½Labæ¡†æ¶</h1><p>ä¸‹è½½ä¸€ä¸‹Labçš„æ–‡ä»¶ï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆä¸œè¥¿</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git://g.csail.mit.edu/6.824-golabs-2022 6.824</span><br></pre></td></tr></table></figure><p>å®˜æ–¹æä¾›äº†ä¸€ä¸ªsequentialçš„MapReduceå®ç°ï¼ˆsrc/main/mrsequential.goï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆè¯•ç€è·‘èµ·æ¥è¿™ä¸ªã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd 6.824/src/main</span><br><span class="line">go build -race -buildmode=plugin ../mrapps/wc.go</span><br><span class="line">rm mr-out*</span><br><span class="line">go run -race mrsequential.go wc.so pg*.txt</span><br><span class="line">more mr-out-0</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡ç”¨goå¯èƒ½è¿˜æ˜¯æ¯”è¾ƒæ‡µçš„ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹å„æ­¥éƒ½åšäº†ä»€ä¹ˆã€‚</p><p>go buildå°±æ˜¯ç¼–è¯‘goæ–‡ä»¶ï¼Œä»¥*.soçš„å½¢å¼ä¿å­˜ï¼ˆæˆ‘ä¸çŸ¥é“è¯´ç¼–è¯‘æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶å‡†ä¸å‡†ç¡®ï¼‰</p><p><code>-race</code> è¡¨ç¤ºå¯ç”¨ç«äº‰æ£€æµ‹ï¼Œä»¥é¿å…å¯èƒ½çš„å†²çª</p><p><code>-buildmode=plugin</code> åˆ™è¡¨ç¤ºå°†å…¶ç¼–è¯‘ä¸ºpluginï¼Œåœ¨ <code>mrsequential.go</code> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸€æ’ä»¶çš„ç”¨æ³•ï¼ˆä¸‹é¢ä¼šä»‹ç»ï¼‰</p><p><code>rm mr-out*</code> åˆ™æ˜¯åˆ é™¤ä¹‹å‰å¯èƒ½çš„è¾“å‡ºæ–‡ä»¶ï¼Œä¿è¯æ–°ä¸€æ¬¡çš„è¾“å‡ºä¸ä¼šå—åˆ°å½±å“</p><p><code>go run -race mrsequential.go wc.so pg*.txt</code> go run å°±æ˜¯è¿è¡Œï¼ŒåŒæ ·å¼€å¯ç«äº‰æ£€æµ‹ã€‚è¿™æ¬¡æˆ‘ä»¬è¦ä¼ å…¥wc.soä¸­çš„å‡½æ•°ï¼Œä»¥åŠè¿è¡ŒWord Countéœ€è¦çš„æ‰€æœ‰æ–‡ä»¶å</p><p>æœ€åï¼Œè¾“å‡ºç»“æœ</p><p>æ³¨æ„åœ¨ <code>wc.so</code> ä¸­æ˜¯æœ‰ <code>import &quot;6.824/mr&quot;</code>ï¼ˆä¹Ÿå°±æ˜¯éœ€è¦æˆ‘ä»¬ç¼–å†™çš„éƒ¨åˆ†ï¼Œæ‰€ä»¥è®°å¾—æ¯æ¬¡å†™å®Œæµ‹è¯•æ—¶éƒ½è¦é‡æ–°ç¼–è¯‘wc.soï¼‰</p><h2 id="å¦‚ä½•ä½¿ç”¨plugin"><a href="#å¦‚ä½•ä½¿ç”¨plugin" class="headerlink" title="å¦‚ä½•ä½¿ç”¨plugin"></a>å¦‚ä½•ä½¿ç”¨plugin</h2><p>é¦–å…ˆéœ€è¦ <code>import &quot;plugin&quot;</code></p><p>ç„¶åæ‰“å¼€.soæ–‡ä»¶ï¼Œè¯»å–å…¶ä¸­çš„å‡½æ•° <code>p, err := plugin.Open(filename)</code> ï¼Œå…¶ä¸­filenameæ˜¯åœ¨å‘½ä»¤è¡Œä¸­ä¼ é€’çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯.soæ–‡ä»¶çš„åç§°</p><p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ <code>xmapf, err := p.Lookup(FuncName)</code> æ¥è°ƒç”¨å®šä¹‰åœ¨.soæ–‡ä»¶ä¸­çš„functionäº†ï¼Œæ¯”å¦‚è¯´è°ƒç”¨mapå‡½æ•°ï¼š <code>xmapf, err := p.Lookup(&quot;Map&quot;)</code></p><p>åˆæ¬¡è¯»è¿›æ¥çš„xmapfä¼¼ä¹æ˜¯ä¸€ç§ç‹¬ç‰¹çš„ç±»å‹ï¼Œè¿˜éœ€è¦è½¬æ¢è¯¥å‡½æ•°çš„å½¢å¼ï¼Œè®¾ç½®æ­£ç¡®çš„å½¢å‚å’Œè¿”å›å€¼ç±»å‹</p><p>ä¾‹ï¼š<code>mapf := xmapf.(func(string, string) []mr.KeyValue)</code> </p><h2 id="mrapps"><a href="#mrapps" class="headerlink" title="mrapps"></a>mrapps</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œmrappsæ–‡ä»¶å¤¹ä¸‹çš„å„ä¸ªæ–‡ä»¶éƒ½åŒ…å«ä¸€ä¸ªmapå‡½æ•°å’Œä¸€ä¸ªreduceå‡½æ•°ï¼Œä¸åŒçš„å‡½æ•°å®ç°å¯ä»¥è®©ç¨‹åºå®ç°ä¸åŒçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºWord Count</p><h1 id="ä¸‰ã€Start"><a href="#ä¸‰ã€Start" class="headerlink" title="ä¸‰ã€Start"></a>ä¸‰ã€Start</h1><p>ä¸€å¼€å§‹è‚¯å®šæ˜¯å¾ˆæ‡µçš„ï¼Œæ€»ä¹‹å…ˆè¯•ç€çœ‹æ‡‚æ–‡ä»¶çš„ç»“æ„ã€‚å¯ä»¥å‚ç…§ <code>mrsequential.go</code> çš„é€»è¾‘ï¼Œè¿™ä¸ªæ˜¯éå¸¸å®¹æ˜“ç†è§£çš„ã€‚</p><p>ç¬¬ä¸€æ­¥å°±æ˜¯ç”¨mapfå‡½æ•°æŠŠæ–‡ä»¶æ‹†æˆintermediateï¼Œç„¶åå°†å…¶æŒ‰ç…§é”®å€¼æ’åºï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸ªä½œä¸ºç¬¬ä¸€æ­¥ã€‚</p><p>å½“ç„¶åœ¨è¿™ä¹‹å‰ï¼Œworkerè¿˜éœ€è¦å‘coordinatorè¯·æ±‚ä¸€ä¸ªä»»åŠ¡ï¼Œå› æ­¤è¿˜éœ€è¦æˆ‘ä»¬å‘é€rpcè¯·æ±‚ï¼Œåœ¨<code>mr/worker.go</code>ä¸­ï¼Œç»™æˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•å‘é€rpcè¯·æ±‚ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚ç®€å•æ¥è¯´å°±æ˜¯è°ƒcallå‡½æ•°ï¼Œæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯æŒ‡å®šä½¿ç”¨coordinatorçš„å“ªä¸ªå‡½æ•°ï¼Œç¬¬äºŒä¸ªæ˜¯ä¼ è¿‡å»çš„å‚æ•°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å¸Œæœ›æ”¶åˆ°çš„å›å¤ã€‚</p><p>æš‚æ—¶è¿˜ä¸çŸ¥é“æ€ä¹ˆè®¾è®¡ï¼Œä¸€æ­¥ä¸€æ­¥æ…¢æ…¢æ¥ï¼Œå‡è®¾æˆ‘ä»¬coordinatoræœ‰ä¸€ä¸ªhandlerå‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦å‘å…¶è¯·æ±‚ä¸€ä¸ªmapä»»åŠ¡ã€‚</p><p>è¿™è¾¹æœ‰ä¸€ä¸ªæˆ‘ä¸æ˜¯å¾ˆæ¸…æ¥šçš„ç‚¹ï¼Œå› ä¸ºçœ‹è®ºæ–‡ï¼Œæ˜¯éœ€è¦å°†æ–‡ä»¶æ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªå—çš„ã€‚è¿™é‡Œæˆ‘ä»¬å°±ç›´æ¥æŠŠæ–‡ä»¶åè¿”å›ç»™workerï¼Œè®©workerå»åšè¯»å–è¿™ä»¶äº‹ã€‚</p><p>å‚è€ƒCallExample()<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// worker.go/func Worker</span></span><br><span class="line"><span class="comment">// ask for a job</span></span><br><span class="line">ok := call(<span class="string">&quot;Coordinator.Handler&quot;</span>, &amp;args, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">  <span class="comment">// reply.Y should be 100.</span></span><br><span class="line">  fmt.Printf(<span class="string">&quot;call success, Job name: %s\n&quot;</span>, reply.Filename)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  fmt.Printf(<span class="string">&quot;call failed!\n&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œè¦è€ƒè™‘çš„å°±æ˜¯æ€ä¹ˆè®¾è®¡replyã€‚å› ä¸ºWorkeræœ‰å¯èƒ½åšmapï¼Œæœ‰å¯èƒ½åšreduceï¼Œæ‰€ä»¥é¦–å…ˆéœ€è¦çš„å°±æ˜¯è¿”å›ä»»åŠ¡çš„ç±»å‹ï¼Œç„¶åè¿˜æœ‰éœ€è¦å¤„ç†çš„æ–‡ä»¶åç§°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rpc.go</span></span><br><span class="line"><span class="keyword">type</span> RPCReply <span class="keyword">struct</span> &#123;</span><br><span class="line">JobType <span class="type">string</span></span><br><span class="line">Filename <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè€ƒè™‘Coordinatorè¿™è¾¹ï¼ŒCoordinatoråº”è¯¥éœ€è¦çŸ¥é“ï¼Œè‡ªå·±è¦ç»™workeråˆ†é…ä»€ä¹ˆä»»åŠ¡ï¼ŒåŒ…æ‹¬ä»»åŠ¡ç±»å‹å’Œä»»åŠ¡å†…å®¹ã€‚è¿™å°±éœ€è¦Coordinatorç»´æŠ¤ä¸€ä¸ªä»»åŠ¡åˆ—è¡¨ï¼Œä»¥åŠä¸€ä¸ªä»»åŠ¡çŠ¶æ€ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Your definitions here.</span></span><br><span class="line">FilenameList []<span class="type">string</span></span><br><span class="line">JobType <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨Coordinatoråˆå§‹åŒ–çš„æ—¶å€™ï¼Œå®ƒå°±åº”è¯¥æ‹¥æœ‰ä¸€ä¸ªmapä»»åŠ¡åˆ—è¡¨ï¼Œä¸”å½“å‰çš„ä»»åŠ¡çŠ¶æ€æ˜¯â€mapâ€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeCoordinator</span><span class="params">(files []<span class="type">string</span>, nReduce <span class="type">int</span>)</span></span> *Coordinator &#123;</span><br><span class="line">c := Coordinator&#123;</span><br><span class="line">JobType: <span class="string">&quot;map&quot;</span>,  <span class="comment">// ä¸€å¼€å§‹åšmapæ“ä½œ</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your code here.</span></span><br><span class="line"><span class="keyword">for</span> _, filename := <span class="keyword">range</span> files &#123;</span><br><span class="line">c.FilenameList = <span class="built_in">append</span>(c.FilenameList, filename)</span><br><span class="line">fmt.Printf(<span class="string">&quot;æˆ‘è¯»å–äº†æ–‡ä»¶:%s\n&quot;</span>, filename)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.server()  <span class="comment">// æ³¨æ„è¿™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„go routineï¼Œå¯¼è‡´å¯èƒ½çš„race</span></span><br><span class="line"><span class="keyword">return</span> &amp;c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>raceé—®é¢˜ä¹‹åä¼šè¯´æ˜ï¼Œæ­¤å¤„æš‚æ—¶ç•¥è¿‡ã€‚ç„¶åå°±æ˜¯å…·ä½“çš„Handler()å‡½æ•°ï¼Œåœ¨æ¥æ”¶åˆ°è¯·æ±‚åå°†ä»»åŠ¡å‘è¿˜ç»™workerå³å¯ã€‚å¦‚æœmapä»»åŠ¡å‘å®Œäº†å°±å°†çŠ¶æ€æ”¹ä¸ºâ€reduceâ€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Handler(args *ExampleArgs, reply *RPCReply) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.JobType == <span class="string">&quot;map&quot;</span> &#123;</span><br><span class="line">reply.JobType = <span class="string">&quot;map&quot;</span></span><br><span class="line">reply.Filename = c.FilenameList[<span class="number">0</span>]</span><br><span class="line">c.FilenameList = c.FilenameList[<span class="number">1</span>:]  <span class="comment">// å…³äºè¿™ä¸€æ­¥çš„æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å‚è§ https://zhuanlan.zhihu.com/p/430888116</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(c.FilenameList) == <span class="number">0</span> &#123;</span><br><span class="line">c.JobType = <span class="string">&quot;reduce&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;not implemented yet\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨åªæ˜¯ç®€å•åœ°æµ‹è¯•ä¸€ä¸‹rpcæ˜¯å¦æ­£ç¡®ï¼Œå¯åŠ¨ä¸€ä¸‹çœ‹çœ‹ã€‚éœ€è¦å¼€ä¸¤ä¸ªterminal</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// ç¬¬ä¸€ä¸ªterminal</span><br><span class="line">go build -race -buildmode=plugin ../mrapps/wc.go</span><br><span class="line">rm mr-out*</span><br><span class="line">go run -race mrcoordinator.go pg-*.txt</span><br><span class="line"></span><br><span class="line">// ç¬¬äºŒä¸ªterminal</span><br><span class="line">go run -race mrworker.go wc.so</span><br></pre></td></tr></table></figure><p>å¦‚æœé¡ºåˆ©çš„è¯ï¼Œworkeråº”è¯¥æ­£ç¡®æ¥æ”¶åˆ°äº†ä¸€ä¸ªæ–‡ä»¶çš„mapä»»åŠ¡</p><p>ä¸è¿‡ï¼Œcoordinatorè¿™è¾¹ä¼šè¢«raceæ£€æµ‹å™¨æ£€æµ‹åˆ°é—®é¢˜ã€‚æ£€æŸ¥mrcoordinator.goæ–‡ä»¶ï¼Œå®ƒéœ€è¦ä¸æ–­åœ°æ£€æŸ¥ m.Done()æ¥åˆ¤æ–­Coordinatoræ˜¯å¦å®Œæˆäº†æ‰€æœ‰çš„mapreduceä»»åŠ¡ï¼›è€Œæˆ‘ä»¬åœ¨coordinator.goä¸­ï¼Œå› ä¸ºå¯åŠ¨äº†serverä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„go routineï¼Œè¿™å…¶ä¸­åˆåœ¨ä¸æ–­åœ°ä¿®æ”¹æˆ‘ä»¬çš„Coordinatorçš„çŠ¶æ€ï¼Œè¿™å…¶ä¸­å°±æœ‰å¯èƒ½äº§ç”Ÿå†²çªã€‚</p><p>ä¸€ä¸ªåŠæ³•å°±æ˜¯ç»™éœ€è¦è®¿é—®CoordinatorçŠ¶æ€çš„åœ°æ–¹åŠ ä¸Šé”ï¼Œé”çš„ç”¨æ³•åœ¨MIT Lecture2çš„Crawler.goä¸­æœ‰ä»‹ç»ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">mu      sync.Mutex  <span class="comment">// åŠ ä¸€ä¸ªé”æ¥ç»´æŠ¤</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Handler(args *ExampleArgs, reply *RPCReply) <span class="type">error</span> &#123;</span><br><span class="line">c.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> c.JobType == <span class="string">&quot;map&quot;</span> &#123;</span><br><span class="line">reply.JobType = <span class="string">&quot;map&quot;</span></span><br><span class="line">reply.Filename = c.FilenameList[<span class="number">0</span>]</span><br><span class="line">c.FilenameList = c.FilenameList[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(c.FilenameList) == <span class="number">0</span> &#123;</span><br><span class="line">c.JobType = <span class="string">&quot;reduce&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;not implemented yet\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">c.mu.Unlock()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Done() <span class="type">bool</span> &#123;</span><br><span class="line">ret := <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Your code here.</span></span><br><span class="line">c.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(c.FilenameList) == <span class="number">0</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;map completed\n&quot;</span>)</span><br><span class="line">ret = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">c.mu.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡å¯åŠ¨å¯ä»¥å‘ç°æ²¡æœ‰raceé—®é¢˜äº†ã€‚</p><p>å½“ç„¶ä»¥ä¸Šä»…æ˜¯æœ€ç®€å•çš„æƒ…å†µã€‚æˆ‘ä»¬å¯ä»¥ä»¥æ­¤ä¸ºåŸºç¡€ï¼Œæ•´ç†ä¸€ä¸‹æˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„äº‹ï¼š</p><ul><li><p>workeråœ¨æ”¶åˆ°mapä»»åŠ¡åçš„å¤„ç†é€»è¾‘ï¼Œéœ€è¦åº”ç”¨map functionï¼Œç„¶åæŒ‰é”®æ’åºï¼Œæœ€åå†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</p></li><li><p>å®Œæˆä»»åŠ¡ååº”å½“ç»™Coordinatorä¸€ä¸ªåé¦ˆï¼Œè¡¨ç¤ºå·²ç»å®Œæˆäº†ä»»åŠ¡ï¼Œè¿™æ ·Coordinatorå¯ä»¥å°†intermediateæ–‡ä»¶åŠ å…¥åˆ°å®ƒçš„reduceä»»åŠ¡åˆ—è¡¨ä¸­ã€‚è¿™è¦æ±‚Coordinatoråœ¨åˆ†é…ä»»åŠ¡çš„æ—¶å€™åˆ†é…ä¸€ä¸ªå·¥ä½œidï¼Œä»¥å”¯ä¸€æŒ‡ç¤ºã€‚</p></li><li><p>workerè¿˜éœ€è¦èƒ½å¤Ÿå¤„ç†reduceä»»åŠ¡ï¼Œé€»è¾‘åŒ <code>mrsequential.go</code></p></li></ul><p>è‡³æ­¤ï¼Œæ€è·¯å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œæ— éæ˜¯ä¸€è¾¹ç†Ÿæ‚‰goè¯­è¨€ä¸€è¾¹å®ŒæˆLabã€‚</p><h1 id="å››ã€mapä»»åŠ¡"><a href="#å››ã€mapä»»åŠ¡" class="headerlink" title="å››ã€mapä»»åŠ¡"></a>å››ã€mapä»»åŠ¡</h1><p>æŠŠé€»è¾‘ä¼˜åŒ–ä¸€ä¸‹ï¼Œæ•´ä¸€ä¸ªä¸“é—¨çš„WorkerMap()å‡½æ•°æ¥åšè¿™ä»¶äº‹ã€‚éœ€è¦ä¼ ä»€ä¹ˆå‚æ•°å†™ç€å†™ç€å°±çŸ¥é“äº†ï¼Œå¯¹åº”ä¿®æ”¹ç»“æ„ä½“å³å¯ã€‚</p><p>ä¸€ä¸ªç¥å¥‡çš„ç‚¹æ˜¯æˆ‘å‘ç°è‡ªå·±å‘é€çš„nReduceå­—æ®µæ— æ³•è¢«workeræ¥å—åˆ°ï¼Œæœ€åæ‰å‘ç°ï¼ŒåŸæ¥RPCåªå‘é€å­—æ®µåä»¥å¤§å†™å­—æ¯å¼€å¤´çš„ç»“æ„ä½“å­—æ®µï¼Œè¿™ä¸€ç‚¹Hintsé‡Œä¹Ÿæåˆ°äº†ã€‚æ ¹æ®chatgptè¯´å°å†™å­—æ¯å¼€å¤´çš„æ˜¯ç§æœ‰å­—æ®µï¼Œåœ¨å…¶ä»–åŒ…ä¸­æ˜¯æ— æ³•è®¿é—®çš„ã€‚</p><p>è¯»æ–‡ä»¶ï¼Œmapï¼Œsortï¼Œå’Œä¹‹å‰ä¸€æ ·</p><p>éšåï¼Œæ ¹æ®Labçš„Hintsï¼Œä¸ºäº†é¿å…ç¨‹åºå†™åˆ°ä¸€åŠä¸­æ–­ï¼Œå‡ºç°ä¸€ä¸ªæ–‡ä»¶é‡Œé¢å†…å®¹ä¸å…¨çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œå¾…å®Œå…¨å†™å…¥åå†å°†å…¶å‘½åä¸ºç›®æ ‡æ–‡ä»¶ã€‚è¿™æ ·èƒ½ä¿è¯ä¿å­˜ä¸‹æ¥çš„æ–‡ä»¶å†…å®¹æ˜¯å…¨çš„ã€‚åŒ…æ‹¬å†™å…¥æ–‡ä»¶ä¹Ÿéœ€è¦ä½¿ç”¨Hintsä¸­æåˆ°çš„ <code>encoding/json</code></p><p>æ‰€ä»¥æˆ‘ä»¬åˆ›å»ºnReduceä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œä»¥åŠå¯¹åº”çš„json encoder</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create temporary files and json encoder</span></span><br><span class="line"><span class="keyword">var</span> tempFiles []*os.File</span><br><span class="line"><span class="keyword">var</span> fileEncs []*json.Encoder</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; nReduce; i++&#123;</span><br><span class="line">  <span class="comment">// tmp files</span></span><br><span class="line">  tmpFile, err := ioutil.TempFile(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;temp-intermediate-*&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123; </span><br><span class="line">    fmt.Printf(<span class="string">&quot;Failed to create temporary file %d: %v\n&quot;</span>, i, err) </span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line">  &#125;</span><br><span class="line">  fmt.Printf(<span class="string">&quot;Create temporary file %d: %s\n&quot;</span>, i+<span class="number">1</span>, tmpFile.Name())</span><br><span class="line">  tempFiles = <span class="built_in">append</span>(tempFiles, tmpFile)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// json encoder</span></span><br><span class="line">  enc := json.NewEncoder(tmpFile)  <span class="comment">// å’Œå¯¹åº”æ–‡ä»¶è¾“å‡ºæµç»‘å®š</span></span><br><span class="line">  fileEncs = <span class="built_in">append</span>(fileEncs, enc)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä¸€å¼€å§‹å†™çš„æ˜¯ioutil.TempFile(â€œâ€, â€œtemp-intermediate-*â€)ï¼Œç»“æœæŠ¥é”™ï¼šinvalid cross-device linkï¼Œä¼°è®¡ç›´æ¥ä¿å­˜åˆ°æœåŠ¡å™¨çš„tmpç›®å½•ä¸‹å»äº†ï¼Ÿå¯èƒ½æ˜¯è·Ÿæˆ‘ä»¬å®éªŒå®¤æœåŠ¡å™¨çš„ç¡¬ç›˜é…ç½®æœ‰å…³ï¼ŒæŠŠä¸´æ—¶æ–‡ä»¶è®¾åˆ°å½“å‰ç›®å½•ä¸‹å°±å¯ä»¥è§£å†³äº†ã€‚</p><p>ç„¶ååœ¨ä¿å­˜çš„æ—¶å€™ï¼Œæ¯ä¸ªé”®å€¼å¯¹å…·ä½“ä¿å­˜åˆ°å“ªä¸ªæ–‡ä»¶ï¼Œéœ€è¦ä½¿ç”¨ç»™å‡ºçš„ihash()å‡½æ•°è¿›è¡Œæ˜ å°„ï¼Œè€Œä¸æ˜¯æŒ‰é¡ºåºå­˜å‚¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save the intermediate</span></span><br><span class="line">total_len := <span class="built_in">len</span>(intermediate)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; total_len; i++&#123;</span><br><span class="line">index := ihash(intermediate[i].Key) % nReduce</span><br><span class="line">enc := fileEncs[index]</span><br><span class="line">err := enc.Encode(&amp;intermediate[i])</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;json encode error\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼ŒæŠŠä¸´æ—¶æ–‡ä»¶é‡æ–°å‘½åä¿å­˜ä¸ºæ­£å¼æ–‡ä»¶ï¼Œä¿è¯åˆ é™¤ä¸´æ—¶æ–‡ä»¶ã€‚ä¿å­˜çš„ä¸­é—´intermediateæ–‡ä»¶åä¸ºâ€map-{JobId}-{i}â€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rename temporary files to formal files</span></span><br><span class="line"><span class="keyword">for</span> i, file := <span class="keyword">range</span> tempFiles &#123;</span><br><span class="line">oname := fmt.Sprintf(<span class="string">&quot;map-%d-%d&quot;</span>, JobId, i)</span><br><span class="line">err = os.Rename(file.Name(), oname)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">           fmt.Printf(<span class="string">&quot;Failed to rename temporary file %d: %v\n&quot;</span>, i, err)</span><br><span class="line">       &#125;</span><br><span class="line">file.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// delete temporary files</span></span><br><span class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> tempFiles &#123;</span><br><span class="line"><span class="keyword">defer</span> os.Remove(file.Name())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªèƒ½è¯´åœ¨å°è¯•åˆ›å»ºä¸´æ—¶æ–‡ä»¶çš„æ—¶å€™é‡åˆ°äº†å„ç§å„æ ·çš„é—®é¢˜ï¼Œï¼Œæœ€åè¿™æ˜¯ä¸€ä¸ªæˆ‘ä¸ªäººå¯è¡Œçš„æ–¹æ³•ã€‚</p><h1 id="äº”ã€è½®è¯¢-amp-ä¼˜åŒ–é€»è¾‘"><a href="#äº”ã€è½®è¯¢-amp-ä¼˜åŒ–é€»è¾‘" class="headerlink" title="äº”ã€è½®è¯¢ &amp; ä¼˜åŒ–é€»è¾‘"></a>äº”ã€è½®è¯¢ &amp; ä¼˜åŒ–é€»è¾‘</h1><p>æ­£ç¡®åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯åŠ¨coordinatorè¿›ç¨‹åï¼Œæ¯å¯åŠ¨ä¸€ä¸ªworkerè¿›ç¨‹ï¼Œå®ƒå°±ä¼šå‘coordinatorå‘é€ä¸€æ¬¡rpcè¯·æ±‚ï¼Œå¾—åˆ°ä¸€ä¸ªä»»åŠ¡ä»¥åŠå¯¹åº”çš„æ–‡ä»¶åï¼Œè¯»å–åå°†å…¶åˆ†è§£ä¸ºä¸­é—´æ–‡ä»¶å¹¶ä¿å­˜ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬å¸Œæœ›workerèƒ½å¤ŸæŒç»­çš„å·¥ä½œè€Œä¸æ˜¯åšä¸€æ¬¡ä¹‹åå°±åœæ­¢ï¼Œå› æ­¤åŠ ä¸€ä¸ªå¾ªç¯æ˜¯åˆç†çš„ã€‚</p><p>å†ç®€å•åœ°åŠ å®Œå¾ªç¯åï¼Œæˆ‘ä»¬ä¼šå‘ç°åœ¨coordinatorçš„è®¾è®¡ä¸Šè¿˜å­˜åœ¨è®¸å¤šé—®é¢˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠå–ä»»åŠ¡å’Œå®Œæˆä»»åŠ¡çš„é€»è¾‘å†™åœ¨åŒä¸€ä¸ªhandleræ¥å£é‡Œï¼Œè¿™æ˜¯ä¸å¯¹çš„ï¼Œè¿™æ ·ç›´åˆ°æ´¾å‡ºå»çš„ä»»åŠ¡å®Œæˆè¿”å›å‰ï¼Œcoordinatorçš„ä»»åŠ¡æ¸…å•éƒ½ä¸ä¼šæ›´æ–°ã€‚</p><p>æ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ€è·¯æ˜¯ï¼Œæ‹†æˆä¸¤ä¸ªåˆ†é…ä»»åŠ¡å’Œå®Œæˆä»»åŠ¡çš„æ¥å£å‡½æ•°ï¼Œå‰è€…å°†ä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»åŠ¡æå–åˆ°ä¸€ä¸ªä¸´æ—¶ä»»åŠ¡åˆ—è¡¨ä¸­ã€‚è€Œå®Œæˆä»»åŠ¡æ¥å£æ”¶åˆ°ä¿¡æ¯åï¼Œå°±å°†å…¶ä»ä¸´æ—¶ä»»åŠ¡åˆ—è¡¨åˆ é™¤ï¼Œå¦åˆ™ï¼Œè‹¥è¶…æ—¶ï¼ˆå³æœ‰å¯èƒ½æ´¾å‡ºå»çš„ä»»åŠ¡æ²¡èƒ½è¢«å®Œæˆï¼Œworkerä¸­æ–­äº†æˆ–æ˜¯æ€ä¹ˆï¼‰ï¼Œå°±å°†è¯¥ä»»åŠ¡å†æ”¾å›ä»»åŠ¡åˆ—è¡¨ï¼Œäº¤ç»™å…¶å®ƒworkerå·¥ä½œ</p><p>å¼€å†™ï¼Œç®€å•åœ°è´´ä¸€äº›ä»£ç å§ã€‚æ¯”å¦‚è¯´ç°åœ¨workerå‘coordinatorä¼ çš„argéœ€è¦åŒ…å«jobidå’Œå®Œæˆæƒ…å†µã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> JobDone(args *RPCArgs, reply *RPCReply) <span class="type">error</span> &#123;</span><br><span class="line">c.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> args.DoneSituation == <span class="number">0</span> &#123;</span><br><span class="line">c.FilenameList = <span class="built_in">append</span>(c.FilenameList, c.TempMissionMap[args.JobId])</span><br><span class="line"><span class="built_in">delete</span>(c.TempMissionMap, args.JobId)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> args.DoneSituation == <span class="number">1</span> &#123;</span><br><span class="line"><span class="built_in">delete</span>(c.TempMissionMap, args.JobId)</span><br><span class="line">c.ReduceList = <span class="built_in">append</span>(c.ReduceList, args.JobId)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(c.FilenameList) == <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(c.TempMissionMap) == <span class="number">0</span> &#123;</span><br><span class="line">c.JobType = <span class="string">&quot;reduce&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">c.mu.Unlock()</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åworkerè¿™è¾¹åŠ ä¸ªå¾ªç¯ï¼Œç®€å•åœ°è®¾äº†ä¸€ä¸ªè¶…æ—¶æ£€æµ‹ï¼ˆå¤„ç†workerå´©æºƒçš„æƒ…å†µï¼‰ï¼ˆå®é™…ä¸Šè¿™ä¸ªè¶…æ—¶æ£€æµ‹æ˜¯å®Œå…¨é”™è¯¯ï¼Œéå¸¸éš¾èšŒï¼Œä¹‹åæµ‹è¯•çš„æ—¶å€™æˆ‘æ‰ååº”è¿‡æ¥ï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">ok := call(<span class="string">&quot;Coordinator.JobAssign&quot;</span>, &amp;args, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;call success, Job name: %s, Job id: %d\n&quot;</span>, reply.Filename, reply.JobId)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;call failed!\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> reply.JobType == <span class="string">&quot;map&quot;</span> &#123;</span><br><span class="line">startTime := time.Now()</span><br><span class="line">WorkerMap(reply.Filename, reply.NReduce, reply.JobId, mapf)</span><br><span class="line">elapsedTime := time.Since(startTime)</span><br><span class="line"><span class="keyword">if</span> elapsedTime &gt;= <span class="number">5</span> * time.Second &#123;  <span class="comment">// è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º5s</span></span><br><span class="line">args.JobId = reply.JobId</span><br><span class="line">args.DoneSituation = <span class="number">0</span></span><br><span class="line">call(<span class="string">&quot;Coordinator.JobDone&quot;</span>, &amp;args, &amp;reply)  <span class="comment">// æ²¡æœ‰å¤„ç†è¿”å›å€¼</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">args.JobId = reply.JobId</span><br><span class="line">args.DoneSituation = <span class="number">1</span></span><br><span class="line">call(<span class="string">&quot;Coordinator.JobDone&quot;</span>, &amp;args, &amp;reply)</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> reply.JobType == <span class="string">&quot;reduce&quot;</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;map job has done\n&quot;</span>)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å…­ã€Reduce"><a href="#å…­ã€Reduce" class="headerlink" title="å…­ã€Reduce"></a>å…­ã€Reduce</h1><p>å‚è€ƒsequentialï¼Œä¸€æ ·å†™reduceçš„ä»£ç ã€‚</p><p>åˆ°è¿™è¾¹åº”è¯¥å·²ç»é©¾è½»å°±ç†Ÿäº†ï¼Œä¸»è¦å°±æ˜¯ä¼ ä»€ä¹ˆå‚æ•°è®©workerèƒ½å®šä½åˆ°æ–‡ä»¶ã€‚æ³¨æ„ä¸€æ¬¡reduceä»»åŠ¡å¤„ç†çš„æ˜¯æ‰€æœ‰åç§°ä¸ºmap-{0~filenums}-reduceidçš„ï¼Œæ‰€ä»¥é¦–å…ˆrpcå‚æ•°ä¸­éœ€è¦åŒ…å«filenums, ä»¥åŠæœ¬æ¬¡reduceä»»åŠ¡çš„id</p><p>è¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œé‡åˆ°äº†ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œå°±æ˜¯ç¬¬ä¸€æ¬¡reduceä»»åŠ¡çš„JobIdè·å–çš„ä¸å¯¹ï¼Œè®©æˆ‘debugä¸€ä¸‹ã€‚</p><p>ç»“æœå‘ç°coordinatoré‚£è¾¹ç»™çš„æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯workerè¿™è¾¹æ¥æ”¶çš„æ˜¯é”™çš„ï¼Œæˆ‘ç›´æ¥é—®å·ã€‚</p><p>æœ€åååº”è¿‡æ¥å»çœ‹labé¡µé¢ä¸­çš„hintsï¼ŒåŸæ¥è°ƒç”¨rpcè¯·æ±‚çš„æ—¶å€™ï¼Œæ¯æ¬¡ä¼ çš„replyéƒ½è¦æ¸…ç©ºï¼Œå¦åˆ™ä¼šæœ‰å¥‡æ€ªçš„é”™è¯¯ã€‚æ¸…ç©ºå®Œä»¥åå°±okäº†ã€‚</p><p>éšä¾¿è´´ä¸€äº›æˆ‘è§‰å¾—é‡è¦çš„ä»£ç å§ï¼Œè®°å¾—æŠŠnReduceä¸ªæ–‡ä»¶ä¸­çš„é”®å€¼å¯¹kvaæå–æ•´åˆåˆ°intermediateï¼Œè¦åšä¸€æ¬¡æ’åº</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WorkerReduce</span><span class="params">(ReduceId <span class="type">int</span>, nReduce <span class="type">int</span>, JobId <span class="type">int</span>, Filenums <span class="type">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">reducef <span class="keyword">func</span>(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span>) &#123;</span><br><span class="line"><span class="comment">// è¯»å–çš„æ–‡ä»¶æ ¼å¼ï¼š map-&#123;0~Filenums-1&#125;-&#123;ReduceId&#125;</span></span><br><span class="line"></span><br><span class="line">intermediate := []KeyValue&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> iter := <span class="number">0</span>; iter&lt;Filenums; iter++ &#123;</span><br><span class="line">fileName := fmt.Sprintf(<span class="string">&quot;map-%s-%s&quot;</span>, strconv.Itoa(iter), strconv.Itoa(ReduceId))</span><br><span class="line">file, err := os.Open(fileName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, fileName)</span><br><span class="line">&#125;</span><br><span class="line">kva := []KeyValue&#123;&#125;</span><br><span class="line"></span><br><span class="line">dec := json.NewDecoder(file)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">var</span> kv KeyValue</span><br><span class="line"><span class="keyword">if</span> err := dec.Decode(&amp;kv); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">kva = <span class="built_in">append</span>(kva, kv)  <span class="comment">// æå–å¾—åˆ°è¯¥æ–‡ä»¶ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹</span></span><br><span class="line">&#125;</span><br><span class="line">intermediate = <span class="built_in">append</span>(intermediate, kva...)</span><br><span class="line">file.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">oname := fmt.Sprintf(<span class="string">&quot;mr-out-%s&quot;</span>, strconv.Itoa(ReduceId))</span><br><span class="line">ofile, _ := os.Create(oname)</span><br><span class="line"></span><br><span class="line">sort.Sort(ByKey(intermediate))</span><br><span class="line"></span><br><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i &lt; <span class="built_in">len</span>(intermediate) &#123;</span><br><span class="line">j := i + <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> j &lt; <span class="built_in">len</span>(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key &#123;</span><br><span class="line">j++</span><br><span class="line">&#125;</span><br><span class="line">values := []<span class="type">string</span>&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> k := i; k &lt; j; k++ &#123;</span><br><span class="line">values = <span class="built_in">append</span>(values, intermediate[k].Value)</span><br><span class="line">&#125;</span><br><span class="line">output := reducef(intermediate[i].Key, values)</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is the correct format for each line of Reduce output.</span></span><br><span class="line">fmt.Fprintf(ofile, <span class="string">&quot;%v %v\n&quot;</span>, intermediate[i].Key, output)</span><br><span class="line"></span><br><span class="line">i = j</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ofile.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éšåæµ‹è¯•è¾“å‡ºï¼š<code>cat mr-out-* | sort | more</code></p><p>ä½†æ˜¯éå¸¸å¥‡æ€ªçš„æ˜¯ï¼Œå¥½åƒsortå¤±æ•ˆäº†ï¼Œæ²¡æœ‰æ­£ç¡®æŒ‰ç…§å­—å…¸åºæ’ï¼Ÿï¼Ÿï¼Ÿæ•°é‡æ˜¯å¯¹çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a 13382</span><br><span class="line">A 509</span><br><span class="line">Ab 3</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé—®é¢˜å¤ªå¥‡æ€ªäº†ï¼Œä¸€é€šè¯¢é—®GPTåï¼Œå®ƒå‘Šè¯‰æˆ‘å¯ä»¥æŒ‡å®š<code>export LC_COLLATE=C</code>ï¼Œç»“æœå±…ç„¶å°±å¯¹äº†ï¼Œï¼Œä¸çŸ¥é“åŸæ¥è¿™ä¸ªç¯å¢ƒå˜é‡å€¼æ˜¯ä»€ä¹ˆã€‚æˆ‘å¾ˆæ‹…å¿ƒä¸€ä¼šå„¿æµ‹è¯•çš„æ—¶å€™ç»“æœèƒ½ä¸èƒ½å¯¹ã€‚</p><p>ä¸ºäº†è®©ç¨‹åºæ­£å¸¸é€€å‡ºï¼Œå°±åœ¨æœ€åç»™workerå‘é€ä¸€ä¸ªâ€Doneâ€æ¶ˆæ¯ï¼Œç„¶åCoordinatorè¿™è¾¹æˆ‘å°±ç®€å•ç²—æš´åœ°ç­‰ä¸€ä¼šå„¿ï¼Œå†é€€å‡ºï¼ˆä»¥å…workeræœ€åä¸€æ¬¡è¯·æ±‚â€Doneâ€æ¶ˆæ¯å‰Coordinatorå·²ç»é€€å‡ºï¼‰ã€‚åªèƒ½è¯´ä¸å¤ªä¸¥è°¨ï¼Œå‡ºé—®é¢˜å†çœ‹å§ã€‚</p><h1 id="ä¸ƒã€æœ€åçš„Debug"><a href="#ä¸ƒã€æœ€åçš„Debug" class="headerlink" title="ä¸ƒã€æœ€åçš„Debug"></a>ä¸ƒã€æœ€åçš„Debug</h1><p>è¿è¡Œä¸€ä¸‹æµ‹è¯•çœ‹çœ‹ï¼Œç»“æœå¦‚ä¸‹ï¼š<code>bash test-mr.sh</code></p><div class="table-container"><table><thead><tr><th>æµ‹è¯•</th><th>ç»“æœ</th><th>æŠ¥é”™ä¿¡æ¯</th></tr></thead><tbody><tr><td>wc test</td><td>FAIL</td><td>sort: cannot read: â€˜mr-out*â€™</td></tr><tr><td>indexer test</td><td>PASS</td><td>/</td></tr><tr><td>map parallelism test</td><td>PASS</td><td>/</td></tr><tr><td>reduce parallelism test</td><td>PASS</td><td>BUTï¼šcall failed!dialing:dial unix /var/tmp/824-mr-3149: connect: connection refused</td></tr><tr><td>job count test</td><td>PASS</td><td>/</td></tr><tr><td>early exit test</td><td>FAIL</td><td>output changed after first worker exited</td></tr><tr><td>crash test</td><td>FAIL</td><td>crash output is not the same as mr-correct-crash.txt</td></tr></tbody></table></div><p>æ€»ä¹‹å°±æ˜¯éå¸¸æƒ¨çƒˆï¼Œåªèƒ½å†debugä¸€ä¸‹äº†ã€‚</p><h2 id="wc-test"><a href="#wc-test" class="headerlink" title="wc test"></a>wc test</h2><p>çœ‹äº†æŠ¥é”™ä¿¡æ¯æ˜¯å› ä¸ºmapé˜¶æ®µæŠ¥é”™äº†ï¼Œå–ä»»åŠ¡çš„æ—¶å€™å–äº†ç©ºåˆ—è¡¨ã€‚è¿™æ—¶æˆ‘æ‰ååº”è¿‡æ¥ï¼Œæˆ‘è¦ç­‰åˆ°å–äº†æœ€åä¸€ä¸ªä»»åŠ¡çš„workerè¿”å›æ‰ä¼šæ”¹å˜coordinatorçš„çŠ¶æ€ï¼Œä½†æ˜¯æ­¤æ—¶å…¶å®ƒworkerè¿˜ä¼šå–ä»»åŠ¡ï¼Œè¿™å°±ä¼šæŠ¥é”™äº†ã€‚</p><p>æ‰€ä»¥åœ¨workerå–ç©ºé›†çš„æƒ…å†µä¸‹ï¼Œæˆ‘å…ˆåŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå·²ç»ç©ºäº†ï¼Œå°±è¿”å›ä¸€ä¸ªsleepä¿¡æ¯ï¼Œè®©workerä¼‘æ¯1sï¼Œè¿™æ ·å°±èƒ½æ­£ç¡®ç­‰åˆ°CoordinatorçŠ¶æ€æ”¹å˜äº†ã€‚</p><p>ç„¶è€Œï¼Œåœ¨å¤šæ¬¡æµ‹è¯•çš„æ—¶å€™é‡åˆ°äº†æœ‰äº›mapä»»åŠ¡ä¸¢äº†çš„æƒ…å†µï¼Ÿå†debugä¸€ä¸‹ï¼Œæ„Ÿè§‰å¯èƒ½æ˜¯è¶…æ—¶æ—¶é—´çš„é—®é¢˜ï¼Œç¨‹åºæ˜¯ä¸ä¼šå‡ºé”™çš„ï¼Œåªä¸è¿‡æœ‰å¯èƒ½æœ‰çš„ä»»åŠ¡åšçš„æ…¢äº†ç‚¹ï¼Œè¶…æ—¶æ—¶é—´å¼€å¤§å°±å¯ä»¥äº†ã€‚</p><h2 id="early-exit-test"><a href="#early-exit-test" class="headerlink" title="early-exit test"></a>early-exit test</h2><p>çœ‹ä¸€ä¸‹bashæ–‡ä»¶èƒ½çŸ¥é“è¿™ä¸€é¡¹æµ‹è¯•çš„æµ‹è¯•é€»è¾‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a process has exited. this means that the output should be finalized</span></span><br><span class="line"><span class="comment"># otherwise, either a worker or the coordinator exited early</span></span><br><span class="line"><span class="built_in">sort</span> mr-out* | grep . &gt; mr-wc-all-initial</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait for remaining workers and coordinator to exit.</span></span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># compare initial and final outputs</span></span><br><span class="line"><span class="built_in">sort</span> mr-out* | grep . &gt; mr-wc-all-final</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´å°±æ˜¯åº”è¯¥æ˜¯ä¸€ä¸ªè¿›ç¨‹é€€å‡ºå°±åº”è¯¥è¯´æ˜æ•´ä¸ªä»»åŠ¡å®Œæˆäº†</p><p>ç»è¿‡debugï¼Œæˆ‘å‘ç°è‡ªå·±å‡ºäº†ä¸€ä¸ªå¾ˆé€†å¤©çš„bugï¼ŒCoordinatoråœ¨æ¯æ¬¡ç»™å®Œä»»åŠ¡åä¼šgoä¸€ä¸ªæ–°çš„åˆ¤æ–­å‡½æ•°ï¼Œå¦‚æœè¿‡äº†ä¸€å®šæ—¶é—´ï¼Œè¿™ä¸ªä»»åŠ¡è¿˜æ²¡å®Œæˆï¼Œå°±åˆ¤å®šworkerå‡ºé”™äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(jobID <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">c.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line"><span class="keyword">if</span> _, ok := c.TempMissionMap[jobID]; ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%d map job è¶…æ—¶\n&quot;</span>, jobID)</span><br><span class="line">c.FilenameList = <span class="built_in">append</span>(c.FilenameList, c.TempMissionMap[jobID])</span><br><span class="line"><span class="built_in">delete</span>(c.TempMissionMap, jobID)</span><br><span class="line">&#125;</span><br><span class="line">&#125;(reply.JobId)</span><br></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œæˆ‘å› ä¸ºå·æ‡’ï¼Œæ‰€ä»¥æŠŠmapä»»åŠ¡çš„ä¸´æ—¶åˆ—è¡¨å’Œreduceä»»åŠ¡çš„ä¸´æ—¶åˆ—è¡¨ç”¨çš„æ˜¯ä¸€ä¸ªã€‚ç»“æœï¼mapä»»åŠ¡æ—¶å‘èµ·çš„åˆ¤æ–­å‡½æ•°ï¼Œç«Ÿç„¶åœ¨reduceé˜¶æ®µé€ æˆäº†é—®é¢˜ï¼Œè¯¯åˆ äº†ä»»åŠ¡ã€‚ã€‚å¾ˆéš¾èšŒã€‚</p><p>é‡æ–°ç»™reduceä»»åŠ¡å•ç‹¬å¼€ä¸€ä¸ªåˆ—è¡¨å°±é€šè¿‡äº†ã€‚</p><h2 id="crash-test"><a href="#crash-test" class="headerlink" title="crash test"></a>crash test</h2><p>æˆ‘å‘ç°æ˜¯æˆ‘å¯¹è¶…æ—¶æ£€æµ‹çš„ç†è§£å‡ºäº†é—®é¢˜ã€‚è¶…æ—¶æ£€æµ‹åº”è¯¥æ˜¯åœ¨coordinatorç«¯è¿›è¡Œçš„ï¼Œå¦åˆ™workerç«¯crashäº†ï¼Œæ ¹æœ¬å°±ä¸ä¼šè§¦å‘é‚£è¾¹çš„è¶…æ—¶æ£€æµ‹ï¼Œä¼ ä¸€ä¸ªé”™è¯¯ä¿¡æ¯å›æ¥ä»€ä¹ˆçš„ã€‚æˆ‘é‚£ä¸ªè¶…æ—¶å°±å¾ˆå‘†ï¼Œå®Œå…¨æ²¡æœ‰ä¸€ç‚¹ä½œç”¨ï¼Œåº”è¯¥åˆ æ‰çš„ã€‚</p><p>åˆ©ç”¨æˆ‘ä»¬ä¹‹å‰çš„ä¸´æ—¶ä»»åŠ¡åˆ—è¡¨ï¼Œæˆ‘ä»¬éœ€è¦å†å†™ä¸€ä¸ªå‘¨æœŸæ‰§è¡Œçš„å‡½æ•°ï¼Œåˆ¤æ–­å®ƒä»¬è·ä»»åŠ¡å‘å¸ƒæ—¶é—´è¿‡å»å¤šä¹…äº†ã€‚</p><p>æˆ–è€…ï¼Œä¸€ä¸ªæ¯”è¾ƒå¥½çš„è®¾è®¡æ˜¯ï¼Œå‘é€ä¸€ä¸ªrpcè¯·æ±‚åï¼Œå®ƒä¼šå‘èµ·å¦ä¸€ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚è¯´10såæ˜¯å¦æ¥æ”¶åˆ°å›å¤ã€‚</p><p>æ˜¯å¦æ¥æ”¶åˆ°å›å¤æˆ‘ä»¬åªè¦çœ‹ä¸´æ—¶ä»»åŠ¡åˆ—è¡¨ä¸­å¯¹åº”çš„ä»»åŠ¡æœ‰æ²¡æœ‰è¢«åˆ å»å°±å¯ä»¥äº†ï¼Œå¤ç”¨ä¸€ä¸‹ç»“æ„</p><p>å°†ç±»ä¼¼ä»¥ä¸‹çš„å‡½æ•°æ’åœ¨coordinatorçš„rpcå›å¤ä¹‹åå°±å¯ä»¥äº†ã€‚å®ƒä¼šåœ¨10såæ£€æµ‹æœ‰æ²¡æœ‰è¢«æ­£ç¡®åˆ å»ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£å°±è¯´æ˜è¿™ä¸ªworkerçˆ†äº†ï¼ŒæŠŠä»»åŠ¡å†è¿”å›ä»»åŠ¡åˆ—è¡¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(jobID <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">c.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line"><span class="keyword">if</span> _, ok := c.TempMissionMap[jobID]; ok &#123;</span><br><span class="line">c.FilenameList = <span class="built_in">append</span>(c.FilenameList, c.TempMissionMap[jobID])</span><br><span class="line"><span class="built_in">delete</span>(c.TempMissionMap, jobID)</span><br><span class="line">&#125;</span><br><span class="line">&#125;(reply.JobId)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿˜æ˜¯ä¸å¯¹ï¼Œæˆ‘debugåå‘ç°æ˜¯æ–‡ä»¶å‘½åçš„é—®é¢˜ï¼Œï¼Œæˆ‘åœ¨mapé˜¶æ®µå¯¹ä¸­é—´æ–‡ä»¶çš„å‘½åæ˜¯ <code>map-&#123;JobId&#125;-&#123;0~nReduce-1&#125;</code> ï¼Œè€Œreduceçš„æ—¶å€™è¯»çš„æ–‡ä»¶åå´æ˜¯ <code>map-&#123;0~Filenums-1&#125;-&#123;ReduceId&#125;</code>ã€‚</p><p>æ„Ÿè§‰å°±è®°å½•ä¸€ä¸‹mapæˆåŠŸçš„jobidï¼Œç„¶åä¼ ç»™reduceï¼Ÿæˆ–è€…å…¶å®åº”è¯¥ä½¿ç”¨é€šé…ç¬¦ï¼Œç›´æ¥å»åŒ¹é… <code>map-*-&#123;ReduceId&#125;</code> ï¼Œè¿™æ ·è‚¯å®šæ›´å¥½ï¼Œé—®é—®gptæœ‰æ²¡æœ‰è¿™ç§æ–¹æ³•ã€‚</p><p>gptæä¾›äº†ä¸€ä¸ªåº“æ–¹æ³• <code>path/filepath</code> ï¼Œå¯ä»¥ä½¿ç”¨ <code>files, err := filepath.Glob(pattern)</code> å»åŒ¹é…ï¼Œä¿®æ”¹å®Œåé€šè¿‡æµ‹è¯•ã€‚</p><p>æœ€åè¿˜æœ‰ä¸¤ä¸ªå°å°çš„é—®é¢˜ï¼š</p><p>ä¸€ä¸ªæ˜¯æµ‹è¯•çš„bashè„šæœ¬ä¸­ï¼Œæ¯åšå®Œä¸€é¡¹ä»»åŠ¡å°±ä¼šæŠŠç”Ÿæˆçš„æ–‡ä»¶ mr-* åˆ äº†ï¼Œä½†æ˜¯æˆ‘çš„mapæ–‡ä»¶å‘½åçš„æ˜¯map-X-Yï¼Œå¯¼è‡´åˆ ä¸æ‰å°±ä¼šå½±å“ä¸‹æ¬¡çš„ç»“æœã€‚æŠŠä¸­é—´æ–‡ä»¶åæ¢äº†å°±å¯ä»¥äº†ã€‚</p><p>è¿˜æœ‰å°±æ˜¯crash-testï¼Œå¯ä»¥çœ‹åˆ°å®ƒä¼šè®©ç¨‹åºéšæœºdelayä¸€æ®µæ—¶é—´ï¼Œå¯èƒ½é•¿è¾¾10sï¼Œæ‰€ä»¥æˆ‘ä»¬çš„è¶…æ—¶æ£€æµ‹æ—¶é—´éœ€è¦å¼€çš„é•¿ä¸€ç‚¹ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> rr.Int64() &lt; <span class="number">660</span> &#123;</span><br><span class="line"><span class="comment">// delay for a while.</span></span><br><span class="line">maxms := big.NewInt(<span class="number">10</span> * <span class="number">1000</span>)</span><br><span class="line">ms, _ := crand.Int(crand.Reader, maxms)</span><br><span class="line">time.Sleep(time.Duration(ms.Int64()) * time.Millisecond)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å…«ã€å¤ç›˜"><a href="#å…«ã€å¤ç›˜" class="headerlink" title="å…«ã€å¤ç›˜"></a>å…«ã€å¤ç›˜</h1><p>æœ€åå±•ç¤ºä¸€ä¸‹é€šè¿‡æˆªå›¾å§ï¼š</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://i.072333.xyz/file/67b3d2132f8b5e49a1b68.png" style="width:400px;"/></div></div><p>è™½ç„¶æ˜¯å¾ˆä¸å®¹æ˜“åœ°åšå®Œäº†ï¼Œä½†æ˜¯æ„Ÿè§‰è¿˜æ˜¯æœ‰å¾ˆå¤šåšçš„ä¸å¤ªå¥½çš„åœ°æ–¹ã€‚</p><p>ç°åœ¨æƒ³æƒ³æ„Ÿè§‰åº”è¯¥ç»´æŠ¤ä¸€ä¸ªworkerçŠ¶æ€çš„ï¼Œæ¯ä¸ªworkerä¹Ÿåˆ†é…ä¸€ä¸ªworker IDï¼Œè¿™æ ·ä¾¿äºç®¡ç†ã€‚ä¹Ÿä¸ç”¨ä¸´æ—¶ä»»åŠ¡åˆ—è¡¨äº†ï¼Œç›´æ¥ç»´æŠ¤workeråˆ—è¡¨å°±å¯ä»¥äº†ï¼ˆåŒæ—¶è®°å½•æ¯ä¸ªworkeråˆ†é…çš„ä»»åŠ¡ï¼‰ã€‚å”‰ï¼Œåªèƒ½è¯´å¼€å§‹åšçš„æ—¶å€™è¿˜æ˜¯å¤ªä»“ä¿ƒäº†ã€‚</p><h1 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h1><p>è®ºæ–‡é“¾æ¥ï¼š<a href="http://research.google.com/archive/mapreduce-osdi04.pdf">http://research.google.com/archive/mapreduce-osdi04.pdf</a></p><p>ä»£ç é“¾æ¥ï¼šåç»­ä¼šæ”¾åˆ°æˆ‘çš„githubä¸Š</p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Distributed System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Distributed System </tag>
            
            <tag> Lab </tag>
            
            <tag> Notes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FDU Computer Graphics pj2</title>
      <link href="/posts/10020.html"/>
      <url>/posts/10020.html</url>
      
        <content type="html"><![CDATA[<div class="note success simple"><p>è–ªç«ç›¸ä¼ </p></div><p>è·ç¦»æœ‰ç‚¹ä¹…è¿œäº†ï¼Œå”‰å¯æƒœè‡ªå·±æ¯”è¾ƒæ‡’ï¼Œæ²¡èƒ½åœ¨åšå®Œä½œä¸šåç«‹é©¬è¡¥ä¸€ç¯‡åšå®¢ã€‚ç°åœ¨å·®ä¸å¤šéƒ½å¿˜å•¦ï¼Œç»“æœpj3è¿˜è¦ç”¨webglï¼Œåªå¥½å…ˆå¤ä¹ ä¸€ä¸‹pj2è‡ªå·±å­¦çš„ä¸œè¥¿ã€‚ä¹Ÿè®¸ä¼šç¨å¾®è®°å½•ä¸€ä¸‹é‡è¦æ­¥éª¤ã€‚ã€‚</p><p>æœ‰éœ€è¦çš„åŒå­¦å¯ä»¥æ‹‰åˆ°æœ€åç›´æ¥çœ‹å®Œæ•´jsä»£ç ã€‚</p><h1 id="é¡¹ç›®è¯´æ˜"><a href="#é¡¹ç›®è¯´æ˜" class="headerlink" title="é¡¹ç›®è¯´æ˜"></a>é¡¹ç›®è¯´æ˜</h1><p>ç”¨webglç”»ä¸€ä¸ªé¢œè‰²æ¸å˜å¤šè¾¹å½¢ï¼Œéœ€è¦å®ç°é¡¶ç‚¹æ‹–åŠ¨ï¼Œæ—‹è½¬åŠ¨ç”»ï¼Œç»˜åˆ¶ç½‘æ ¼ç­‰åŠŸèƒ½</p><h1 id="å®Œæ•´ä»£ç -javascript"><a href="#å®Œæ•´ä»£ç -javascript" class="headerlink" title="å®Œæ•´ä»£ç (javascript)"></a>å®Œæ•´ä»£ç (javascript)</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¡¶ç‚¹ç€è‰²å™¨</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">VSHADER_SOURCE</span> = </span><br><span class="line">    <span class="string">&#x27;attribute vec4 a_Position;\n&#x27;</span> + <span class="comment">// attribute å˜é‡</span></span><br><span class="line">    <span class="string">&#x27;uniform mat4 u_ModelMatrix;\n&#x27;</span> + <span class="comment">//å˜æ¢çŸ©é˜µ</span></span><br><span class="line">    <span class="string">&#x27;attribute vec4 a_Color;\n&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;varying vec4 v_Color;\n&#x27;</span> + <span class="comment">// varying å˜é‡</span></span><br><span class="line">    <span class="string">&#x27;uniform int u_RenderMode;\n&#x27;</span> + <span class="comment">// æ–°å¢ uniform å˜é‡ï¼Œç”¨äºåŒºåˆ†ç»˜åˆ¶æ¨¡å¼(å›¾å½¢orè¾¹æ¡†çº¿)</span></span><br><span class="line">    <span class="string">&#x27;void main() &#123;\n&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;    gl_Position = u_ModelMatrix * a_Position;\n&#x27;</span> + <span class="comment">// è®¾ç½®é¡¶ç‚¹åæ ‡</span></span><br><span class="line">    <span class="string">&#x27;    if(u_RenderMode == 0) &#123;\n&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;        v_Color = a_Color;\n&#x27;</span> +  <span class="comment">// ä¼ é€’ç»™ç‰‡å…ƒç€è‰²å™¨</span></span><br><span class="line">    <span class="string">&#x27;    &#125;\n&#x27;</span> + </span><br><span class="line">    <span class="string">&#x27;    else &#123;\n&#x27;</span>+</span><br><span class="line">    <span class="string">&#x27;        v_Color = vec4(1.0, 0.0, 0.0, 1.0);\n&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;    &#125;\n&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;&#125;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‰‡å…ƒç€è‰²å™¨</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">FSHADER_SOURCE</span> =</span><br><span class="line">    <span class="string">&#x27;precision mediump float;\n&#x27;</span> + <span class="comment">// ç²¾åº¦</span></span><br><span class="line">    <span class="string">&#x27;varying vec4 v_Color;\n&#x27;</span> +    <span class="comment">// æ¥æ”¶varyingå˜é‡</span></span><br><span class="line">    <span class="string">&#x27;void main() &#123;\n&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;  gl_FragColor = v_Color;\n&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;&#125;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—‹è½¬é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ANGLE_STEP</span> = <span class="number">45.0</span>;</span><br><span class="line"><span class="comment">// ç¼©æ”¾é€Ÿåº¦</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">SCALE_SPEED</span> = <span class="number">0.2</span>;</span><br><span class="line"><span class="comment">// ç¼©æ”¾æ–¹å‘ï¼ˆå˜å¤§orå˜å°ï¼‰</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">SCALE_DIRECTON</span> = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ˜¯å¦å¼€å¯åŠ¨ç”»</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">ANIMATION</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// é¿å…åŠ¨ç”»å¼€å§‹çš„ç¬ç§» </span></span><br><span class="line"><span class="keyword">var</span> init = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦æ­£æ‹–åŠ¨ç‚¹</span></span><br><span class="line"><span class="keyword">var</span> isDragging = <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// å½“å‰æ­£åœ¨æ‹–åŠ¨çš„ç‚¹</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">DraggingVertex</span> = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ˜¯å¦æ˜¾ç¤ºè¾¹æ¡†</span></span><br><span class="line"><span class="keyword">var</span> frame = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‰è§’å½¢å½“å‰çš„æ—‹è½¬è§’åº¦</span></span><br><span class="line"><span class="keyword">var</span> currentAngle = <span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">var</span> currentScale = <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;webgl&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!canvas) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Fail to load canvas&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®ç”»å¸ƒå¤§å°</span></span><br><span class="line">    canvas.<span class="title function_">setAttribute</span>(<span class="string">&quot;width&quot;</span>, canvasSize.<span class="property">maxX</span>);</span><br><span class="line">    canvas.<span class="title function_">setAttribute</span>(<span class="string">&quot;height&quot;</span>, canvasSize.<span class="property">maxY</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†canvasåæ ‡è½¬æ¢ä¸ºwebglåæ ‡</span></span><br><span class="line">    <span class="keyword">var</span> rect = canvas.<span class="title function_">getBoundingClientRect</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>, len = vertex_pos.<span class="property">length</span>; i&lt;len; i++) &#123;</span><br><span class="line">        vertex_pos[i][<span class="number">0</span>] = ((vertex_pos[i][<span class="number">0</span>] - rect.<span class="property">left</span>) - canvas.<span class="property">width</span> / <span class="number">2</span>) / (canvas.<span class="property">width</span> / <span class="number">2</span>);</span><br><span class="line">        vertex_pos[i][<span class="number">1</span>] = (canvas.<span class="property">height</span> / <span class="number">2</span> - (vertex_pos[i][<span class="number">1</span>] - rect.<span class="property">top</span>)) / (canvas.<span class="property">height</span> / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–webglå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> gl = <span class="title function_">getWebGLContext</span>(canvas);</span><br><span class="line">    <span class="keyword">if</span>(!gl) &#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Fail to get the rendering context for WebGL&quot;</span>); <span class="keyword">return</span> <span class="literal">false</span>;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç€è‰²å™¨</span></span><br><span class="line">    <span class="keyword">var</span> shader_main = <span class="title function_">initShaders</span>(gl, <span class="variable constant_">VSHADER_SOURCE</span>, <span class="variable constant_">FSHADER_SOURCE</span>);</span><br><span class="line">    <span class="keyword">if</span> (!shader_main) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to intialize shaders.&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºç¼“å†²åŒºå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> n = <span class="title function_">initVertexBuffers</span>(gl, canvas, rect);</span><br><span class="line">    <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to set the positions of the vertices&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®èƒŒæ™¯è‰²</span></span><br><span class="line">    gl.<span class="title function_">clearColor</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ¸²æŸ“æ¨¡å¼uniformå˜é‡</span></span><br><span class="line">    <span class="keyword">var</span> u_RenderMode = gl.<span class="title function_">getUniformLocation</span>(gl.<span class="property">program</span>, <span class="string">&#x27;u_RenderMode&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!u_RenderMode) &#123; </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to get the storage location of u_RenderMode&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æ—‹è½¬çŸ©é˜µuniformå˜é‡</span></span><br><span class="line">    <span class="keyword">var</span> u_ModelMatrix = gl.<span class="title function_">getUniformLocation</span>(gl.<span class="property">program</span>, <span class="string">&#x27;u_ModelMatrix&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!u_ModelMatrix) &#123; </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to get the storage location of u_ModelMatrix&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ—‹è½¬çŸ©é˜µ</span></span><br><span class="line">    <span class="keyword">var</span> modelMatrix = <span class="keyword">new</span> <span class="title class_">Matrix4</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ¨ç”»æ•ˆæœ</span></span><br><span class="line">    <span class="keyword">var</span> tick = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentStage = <span class="title function_">animate</span>(currentAngle, currentScale);</span><br><span class="line">        currentAngle = currentStage[<span class="number">0</span>];  <span class="comment">// æ›´æ–°æ—‹è½¬è§’åº¦</span></span><br><span class="line">        currentScale = currentStage[<span class="number">1</span>];  <span class="comment">// æ›´æ–°ç¼©æ”¾å¤§å°</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">draw</span>(gl, n, currentAngle, currentScale, modelMatrix, u_ModelMatrix, u_RenderMode);   <span class="comment">// æ¸²æŸ“å›¾å½¢</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable constant_">ANIMATION</span>)</span><br><span class="line">            <span class="title function_">requestAnimationFrame</span>(tick, canvas); <span class="comment">// è¯·æ±‚å†æ¬¡è°ƒç”¨tick</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_">draw</span>(gl, n, currentAngle, currentScale, modelMatrix, u_ModelMatrix, u_RenderMode);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œé”®ç›˜ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>, <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.<span class="property">key</span> === <span class="string">&quot;t&quot;</span> || event.<span class="property">key</span> === <span class="string">&quot;T&quot;</span>) &#123; <span class="comment">// å¼€å§‹/æš‚åœåŠ¨ç”»</span></span><br><span class="line">            <span class="variable constant_">ANIMATION</span> = !<span class="variable constant_">ANIMATION</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable constant_">ANIMATION</span>) &#123;</span><br><span class="line">                init = <span class="literal">true</span>;</span><br><span class="line">                <span class="title function_">tick</span>(); <span class="comment">// è°ƒç”¨ tick å‡½æ•°</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">key</span> === <span class="string">&quot;e&quot;</span> || event.<span class="property">key</span> === <span class="string">&quot;E&quot;</span>) &#123; <span class="comment">// å¤ä½</span></span><br><span class="line">            <span class="variable constant_">ANIMATION</span> = <span class="literal">false</span>;</span><br><span class="line">            currentAngle = <span class="number">0.0</span>;</span><br><span class="line">            currentScale = <span class="number">1.0</span>;</span><br><span class="line">            init = <span class="literal">true</span>;</span><br><span class="line">            <span class="title function_">tick</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="property">key</span> === <span class="string">&quot;b&quot;</span> || event.<span class="property">key</span> === <span class="string">&quot;B&quot;</span>) &#123; <span class="comment">// æ˜¾ç¤ºè¾¹æ¡†</span></span><br><span class="line">            frame = !frame;</span><br><span class="line">            init = <span class="literal">true</span>;</span><br><span class="line">            <span class="title function_">tick</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å†Œé¼ æ ‡ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">    canvas.<span class="property">onmousedown</span> = <span class="keyword">function</span>(<span class="params">ev</span>)&#123; </span><br><span class="line">        isDragging = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">click</span>(ev, gl, canvas, </span><br><span class="line">            currentAngle, currentScale,  <span class="comment">// å½“å‰çš„çŠ¶æ€ï¼Œä¸ºäº†ç¡®å®šå½“å‰çš„ç‚¹çš„ä½ç½®</span></span><br><span class="line">            modelMatrix, u_ModelMatrix,</span><br><span class="line">            rect); </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    canvas.<span class="property">onmousemove</span> = <span class="keyword">function</span>(<span class="params">ev</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isDragging) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">ANIMATION</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">var</span> x = <span class="title function_">toW</span>(ev.<span class="property">clientX</span>, <span class="number">0</span>, canvas, rect); <span class="comment">// é¼ æ ‡xåæ ‡</span></span><br><span class="line">        <span class="keyword">var</span> y = <span class="title function_">toW</span>(ev.<span class="property">clientY</span>, <span class="number">1</span>, canvas, rect); <span class="comment">// é¼ æ ‡yåæ ‡</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾—åˆ°æ—‹è½¬çŸ©é˜µ</span></span><br><span class="line">        modelMatrix.<span class="title function_">setRotate</span>(currentAngle, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        modelMatrix.<span class="title function_">scale</span>(currentScale, currentScale, currentScale);</span><br><span class="line">        <span class="comment">// æ±‚é€†</span></span><br><span class="line">        modelMatrix = modelMatrix.<span class="title function_">invert</span>();</span><br><span class="line">        <span class="comment">// æ›´æ–°ç‚¹ï¼ˆæ³¨æ„éœ€è¦æ›´æ–°æ—‹è½¬å‰çš„åæ ‡ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">DraggingVertex</span>!=-<span class="number">1</span>)&#123;</span><br><span class="line">            vertex_pos[<span class="title class_">DraggingVertex</span>][<span class="number">0</span>] = x * modelMatrix.<span class="property">elements</span>[<span class="number">0</span>] + y * modelMatrix.<span class="property">elements</span>[<span class="number">4</span>] + modelMatrix.<span class="property">elements</span>[<span class="number">12</span>];</span><br><span class="line">            vertex_pos[<span class="title class_">DraggingVertex</span>][<span class="number">1</span>] = x * modelMatrix.<span class="property">elements</span>[<span class="number">1</span>] + y * modelMatrix.<span class="property">elements</span>[<span class="number">5</span>] + modelMatrix.<span class="property">elements</span>[<span class="number">13</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡æ–°åˆ›å»ºç¼“å†²åŒºå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">var</span> n = <span class="title function_">initVertexBuffers</span>(gl, canvas, rect);</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to set the positions of the vertices&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">draw</span>(gl, n, currentAngle, currentScale, modelMatrix, u_ModelMatrix, u_RenderMode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    canvas.<span class="property">onmouseup</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        isDragging = <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initVertexBuffers</span>(<span class="params">gl, canvas, rect</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºç¼“å†²åŒºå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">var</span> vertexBuffer = gl.<span class="title function_">createBuffer</span>();</span><br><span class="line">    <span class="keyword">if</span>(!vertexBuffer) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to create the buffer object&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç¼“å†²åŒºå¯¹è±¡ç»‘å®šåˆ°ç›®æ ‡</span></span><br><span class="line">    gl.<span class="title function_">bindBuffer</span>(gl.<span class="property">ARRAY_BUFFER</span>, vertexBuffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ç¼“å†²åŒºå¯¹è±¡ä¸­å†™å…¥æ•°æ®</span></span><br><span class="line">    <span class="keyword">var</span> n = <span class="number">4</span> * polygon.<span class="property">length</span>; <span class="comment">// ç‚¹çš„ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">var</span> vertices = <span class="keyword">new</span> <span class="title class_">Float32Array</span>(n * <span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> offset = <span class="number">0</span>; <span class="comment">// åç§»ç”¨äºå°†æ¯ä¸ªå››è¾¹å½¢çš„é¡¶ç‚¹æ•°æ®å†™å…¥æ•°ç»„</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>, len = polygon.<span class="property">length</span>; i&lt;len; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>; j&lt;<span class="number">4</span>; j++) &#123;</span><br><span class="line">            vertices[offset++] = vertex_pos[polygon[i][j]][<span class="number">0</span>];</span><br><span class="line">            vertices[offset++] = vertex_pos[polygon[i][j]][<span class="number">1</span>];</span><br><span class="line">            vertices[offset++] = vertex_color[polygon[i][j]][<span class="number">0</span>]/<span class="number">255</span>;</span><br><span class="line">            vertices[offset++] = vertex_color[polygon[i][j]][<span class="number">1</span>]/<span class="number">255</span>;</span><br><span class="line">            vertices[offset++] = vertex_color[polygon[i][j]][<span class="number">2</span>]/<span class="number">255</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ç¼“å†²åŒºå†™å…¥æ•°æ®</span></span><br><span class="line">    gl.<span class="title function_">bufferData</span>(gl.<span class="property">ARRAY_BUFFER</span>, vertices, gl.<span class="property">STATIC_DRAW</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">FSIZE</span> = vertices.<span class="property">BYTES_PER_ELEMENT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–åæ ‡attributeå˜é‡</span></span><br><span class="line">    <span class="keyword">var</span> a_Position = gl.<span class="title function_">getAttribLocation</span>(gl.<span class="property">program</span>, <span class="string">&#x27;a_Position&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (a_Position &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to get the storage location of a_Position&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†ç¼“å†²åŒºå¯¹è±¡åˆ†é…ç»™a_positionå˜é‡</span></span><br><span class="line">    gl.<span class="title function_">vertexAttribPointer</span>(a_Position, <span class="number">2</span>, gl.<span class="property">FLOAT</span>, <span class="literal">false</span>, <span class="variable constant_">FSIZE</span> * <span class="number">5</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è¿æ¥a_Positionå˜é‡ä¸åˆ†é…ç»™å®ƒçš„ç¼“å†²åŒºå¯¹è±¡</span></span><br><span class="line">    gl.<span class="title function_">enableVertexAttribArray</span>(a_Position);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–é¢œè‰²attributeå˜é‡</span></span><br><span class="line">    <span class="keyword">var</span> a_Color = gl.<span class="title function_">getAttribLocation</span>(gl.<span class="property">program</span>, <span class="string">&#x27;a_Color&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(a_Color &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Failed to get the storage location of a_Color&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    gl.<span class="title function_">vertexAttribPointer</span>(a_Color, <span class="number">3</span>, gl.<span class="property">FLOAT</span>, <span class="literal">false</span>, <span class="variable constant_">FSIZE</span> * <span class="number">5</span>, <span class="variable constant_">FSIZE</span> * <span class="number">2</span>);</span><br><span class="line">    gl.<span class="title function_">enableVertexAttribArray</span>(a_Color); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£ç»‘ç¼“å†²åŒº</span></span><br><span class="line">    gl.<span class="title function_">bindBuffer</span>(gl.<span class="property">ARRAY_BUFFER</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">draw</span>(<span class="params">gl, n, currentAngle, currentScale, modelMatrix, u_ModelMatrix, u_RenderMode</span>) &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—æ—‹è½¬çŸ©é˜µ</span></span><br><span class="line">    modelMatrix.<span class="title function_">setRotate</span>(currentAngle, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    modelMatrix.<span class="title function_">scale</span>(currentScale, currentScale, currentScale);</span><br><span class="line">    <span class="comment">// æŠŠæ—‹è½¬çŸ©é˜µä¼ ç»™æ¸²æŸ“å™¨</span></span><br><span class="line">    gl.<span class="title function_">uniformMatrix4fv</span>(u_ModelMatrix, <span class="literal">false</span>, modelMatrix.<span class="property">elements</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// æ¸…é™¤canvas</span></span><br><span class="line">    gl.<span class="title function_">clear</span>(gl.<span class="property">COLOR_BUFFER_BIT</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç”»å‡ºå›¾å½¢</span></span><br><span class="line">    gl.<span class="title function_">uniform1i</span>(u_RenderMode, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">16</span>; i+=<span class="number">4</span>) &#123;</span><br><span class="line">        gl.<span class="title function_">drawArrays</span>(gl.<span class="property">TRIANGLE_FAN</span>, i, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(frame) &#123;</span><br><span class="line">        gl.<span class="title function_">uniform1i</span>(u_RenderMode, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">16</span>; i+=<span class="number">4</span>) &#123;</span><br><span class="line">            gl.<span class="title function_">drawArrays</span>(gl.<span class="property">LINE_LOOP</span>, i, <span class="number">3</span>);</span><br><span class="line">            gl.<span class="title function_">drawArrays</span>(gl.<span class="property">LINE_LOOP</span>, i, <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸Šæ¬¡è°ƒç”¨tickå‡½æ•°çš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">var</span> g_last = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">animate</span>(<span class="params">angle, scale</span>) &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—æ—¶é—´å·®è·</span></span><br><span class="line">    <span class="keyword">var</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">var</span> elapsed;</span><br><span class="line">    <span class="keyword">if</span>(!init) &#123;</span><br><span class="line">        elapsed = now - g_last;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        elapsed = <span class="number">0</span>;</span><br><span class="line">        init = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    g_last = now;</span><br><span class="line">    <span class="comment">// æ ¹æ®æ—¶é—´é—´éš”è°ƒæ•´æ–°è§’åº¦</span></span><br><span class="line">    <span class="keyword">var</span> newAngle = (angle + (<span class="variable constant_">ANGLE_STEP</span> * elapsed) / <span class="number">1000.0</span>) % <span class="number">360</span>;</span><br><span class="line">    <span class="comment">// æ ¹æ®æ—¶é—´é—´éš”è°ƒæ•´æ–°ç¼©æ”¾æ¯”ä¾‹</span></span><br><span class="line">    <span class="keyword">var</span> update = scale + <span class="variable constant_">SCALE_DIRECTON</span> * (<span class="variable constant_">SCALE_SPEED</span> * elapsed) / <span class="number">1000.0</span>;</span><br><span class="line">    <span class="keyword">var</span> newSize;</span><br><span class="line">    <span class="keyword">if</span>(update &lt; <span class="number">0.2</span>) &#123;</span><br><span class="line">        <span class="variable constant_">SCALE_DIRECTON</span> *= -<span class="number">1</span>;</span><br><span class="line">        newSize = <span class="number">0.4</span> - update;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(update &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="variable constant_">SCALE_DIRECTON</span> *= -<span class="number">1</span>;</span><br><span class="line">        newSize = <span class="number">2</span> - update;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        newSize = update;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [newAngle, newSize];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">click</span>(<span class="params">ev, gl, canvas, currentAngle, currentScale, modelMatrix, u_ModelMatrix, rect</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="title function_">toW</span>(ev.<span class="property">clientX</span>, <span class="number">0</span>, canvas, rect); <span class="comment">// é¼ æ ‡xåæ ‡</span></span><br><span class="line">    <span class="keyword">var</span> y = <span class="title function_">toW</span>(ev.<span class="property">clientY</span>, <span class="number">1</span>, canvas, rect); <span class="comment">// é¼ æ ‡yåæ ‡</span></span><br><span class="line">    <span class="comment">// è®¡ç®—æ—‹è½¬çŸ©é˜µ</span></span><br><span class="line">    modelMatrix.<span class="title function_">setRotate</span>(currentAngle, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    modelMatrix.<span class="title function_">scale</span>(currentScale, currentScale, currentScale);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> vertex_X;</span><br><span class="line">    <span class="keyword">var</span> vertex_Y;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> min_length = <span class="number">0.001</span>;</span><br><span class="line">    <span class="keyword">var</span> min_vertex = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>, len = vertex_pos.<span class="property">length</span>; i&lt;len; i++) &#123;</span><br><span class="line">        vertex_X = vertex_pos[i][<span class="number">0</span>] * modelMatrix.<span class="property">elements</span>[<span class="number">0</span>] + vertex_pos[i][<span class="number">1</span>] * modelMatrix.<span class="property">elements</span>[<span class="number">4</span>] + modelMatrix.<span class="property">elements</span>[<span class="number">12</span>];</span><br><span class="line">        vertex_Y = vertex_pos[i][<span class="number">0</span>] * modelMatrix.<span class="property">elements</span>[<span class="number">1</span>] + vertex_pos[i][<span class="number">1</span>] * modelMatrix.<span class="property">elements</span>[<span class="number">5</span>] + modelMatrix.<span class="property">elements</span>[<span class="number">13</span>];</span><br><span class="line">        <span class="keyword">if</span>((x - vertex_X)**<span class="number">2</span> + (y - vertex_Y)**<span class="number">2</span> &lt; min_length) &#123;</span><br><span class="line">            min_vertex = i;</span><br><span class="line">            min_length = (x - vertex_X)**<span class="number">2</span> + (y - vertex_Y)**<span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">DraggingVertex</span> = min_vertex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toW</span>(<span class="params">co, XorY, canvas, rect</span>)&#123; <span class="comment">// å˜æ¢è‡³Webglåæ ‡</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title class_">XorY</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((co - rect.<span class="property">left</span>) - canvas.<span class="property">width</span> / <span class="number">2</span>) / (canvas.<span class="property">width</span> / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (canvas.<span class="property">height</span> / <span class="number">2</span> - (co - rect.<span class="property">top</span>)) / (canvas.<span class="property">height</span> / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Computer Graphics </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Computer Graphics </tag>
            
            <tag> Study </tag>
            
            <tag> Homework </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mininetå®‰è£…å…¨æŒ‡å—</title>
      <link href="/posts/10019.html"/>
      <url>/posts/10019.html</url>
      
        <content type="html"><![CDATA[<p>è¯¥è¯´ä¸è¯´ï¼Œå¯¹æˆ‘ä»¬å­¦æ ¡å¤§éƒ¨åˆ†è¯¾ç¨‹çš„Labéƒ½éå¸¸å¤±æœ›ï¼Œè¿ç®€å•çš„å®éªŒæ–‡æ¡£éƒ½å†™ä¸å¥½ï¼Œè¿˜éœ€è¦å­¦ç”Ÿè‡ªå·±æ‘¸ç´¢æ€ä¹ˆåšï¼Œæµªè´¹æˆ‘é‚£ä¹ˆå¤šæ—¶é—´ã€‚</p><p>è®°å½•ä¸€ä¸‹è‡ªå·±åœ¨å®‰è£…mininetè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œéå¸¸éå¸¸å¤šï¼Œå¸Œæœ›èƒ½å¸®åˆ°åæ¥çš„åŒå­¦ã€‚</p><p>åº”è¯¥ä¼šæœ‰å¾ˆå¤šå›¾ï¼Œå¸Œæœ›éƒ½èƒ½åŠ è½½å‡ºæ¥ã€‚</p><h1 id="å®‰è£…è™šæ‹Ÿæœº"><a href="#å®‰è£…è™šæ‹Ÿæœº" class="headerlink" title="å®‰è£…è™šæ‹Ÿæœº"></a>å®‰è£…è™šæ‹Ÿæœº</h1><p>æœ¬æ¬¡mininetéœ€è¦ç”¨åˆ°å›¾å½¢ç•Œé¢ï¼ŒWSLæœ¬äººè¯•è¿‡äº†å¹¶ä¸æ”¯æŒï¼Œæ— å¥ˆåªèƒ½è½¬å‘VirtualBoxè¿›è¡Œå®éªŒã€‚</p><p>å»VirtualBoxå®˜ç½‘ä¸‹è½½å³å¯ï¼š<a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></p><p>æˆ‘æ˜¯windowsç³»ç»Ÿï¼Œç›´æ¥ç‚¹windows hostä¸‹è½½å³å¯ã€‚ä¸‹è½½å®Œåå®‰è£…ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picss.sunbangyan.cn/2023/11/22/d847fbc3124ed53e25aed79901f8ed26.jpeg" style="width:400px;"/></div></div><p>ä¸‹è½½å®Œåæ‰“å¼€åº”è¯¥æ˜¯è¿™æ ·ï¼šï¼ˆæˆ‘å› ä¸ºå·²ç»å»ºå¥½äº†æ‰€ä»¥åˆ—è¡¨é‡Œä¼šæœ‰ä¸€ä¸ªUbuntuï¼ŒåŸå§‹çŠ¶æ€åº”è¯¥æ˜¯ç©ºçš„ï¼‰</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picst.sunbangyan.cn/2023/11/22/d3b4657d59d70bc5d2ca1999fae0005f.jpeg" style="width:800px;"/></div></div><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å…ˆå»ä¸‹è½½ä¸€ä¸ªUbuntué•œåƒï¼Œåœ¨ <a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/20.04/">https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/20.04/</a> è¿™é‡Œå³å¯ä¸‹è½½ï¼Œé€‰æ‹© ubuntu-20.04.6-desktop-amd64.iso</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picss.sunbangyan.cn/2023/11/22/a259e2bfd08beb71fad51b4c18bc3768.jpeg" style="width:400px;"/></div></div><p>ä¸‹è½½å®Œåæˆ‘ä»¬å›åˆ°VirtualBoxï¼Œç‚¹å‡»å³ä¸Šæ–¹è“è‰²çš„æ–°å»º</p><p>è¿›å»ä»¥åç•Œé¢å¦‚ä¸‹ï¼Œè®¾ç½®ä¸€ä¸ªåç§°ï¼ˆUbuntuå°±å¯ä»¥ï¼‰ï¼Œæ–‡ä»¶å¤¹åœ¨æƒ³è¦çš„ä½ç½®è‡ªå·±å»ºä¸€ä¸ªï¼Œç„¶åè™šæ‹Ÿå…‰ç›˜é€‰æ‹©æˆ‘ä»¬åˆšæ‰ä¸‹è½½çš„æ–‡ä»¶ã€‚ä¸‹ä¸€æ­¥</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picss.sunbangyan.cn/2023/11/22/415d13eb9426abb55c23cdbbd4bf05f6.jpeg" style="width:800px;"/></div></div><p>ä¸‹ä¸€æ­¥è‡ªå·±è®¾ç½®ç”¨æˆ·åå’Œå¯†ç ï¼ˆè¯·è®°ä½ï¼‰ã€‚ç„¶åä¸‹é¢è¿™ä¸ªå¢å¼ºåŠŸèƒ½è¦å‹¾é€‰ï¼ï¼ˆæˆªå›¾ä¸­æ²¡æœ‰é€‰ä¸Šï¼‰</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picdl.sunbangyan.cn/2023/11/22/04cb6d27ce0073cd853d42217eab62fd.jpeg" style="width:800px;"/></div></div><p>ä¹‹åæ˜¯åˆ†é…å†…å­˜å’Œç©ºé—´ï¼Œé»˜è®¤å³å¯ï¼ˆæ„Ÿè§‰ç©ºé—´ä¸ç”¨é‚£ä¹ˆå¤šï¼‰</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picdl.sunbangyan.cn/2023/11/22/0b60d8486932d0d87d22fadfcdd0de05.jpeg" style="width:400px;"/></div></div><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picdl.sunbangyan.cn/2023/11/22/0b8f435b83c5e52744ddcb9eabe106a5.jpeg" style="width:400px;"/></div></div><p>ç„¶åå®ƒå°±ä¼šå¼€å§‹åˆå§‹åŒ–ç³»ç»Ÿï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å³å¯ã€‚</p><h1 id="é…ç½®Ubuntu"><a href="#é…ç½®Ubuntu" class="headerlink" title="é…ç½®Ubuntu"></a>é…ç½®Ubuntu</h1><h2 id="å‘¼å‡ºå‘½ä»¤è¡Œ"><a href="#å‘¼å‡ºå‘½ä»¤è¡Œ" class="headerlink" title="å‘¼å‡ºå‘½ä»¤è¡Œ"></a>å‘¼å‡ºå‘½ä»¤è¡Œ</h2><p>éšåå°±å¯ä»¥è¿›å…¥Ubuntuç•Œé¢ï¼Œé‚£ä¹ˆï¼Œè¯¥å¦‚ä½•å‘¼å‡ºå‘½ä»¤è¡Œå‘¢ï¼Ÿ</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picdl.sunbangyan.cn/2023/11/22/146af73c4b003f2be0f83e70a8ae9032.jpeg" style="width:400px;"/></div></div><p>æŒ‰ä¸‹é”®ç›˜ä¸Šçš„windowsé”®ï¼Œè¾“å…¥terminalå³å¯ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picdm.sunbangyan.cn/2023/11/22/a4718c0bb76ea6a428a0bb204e805c9e.jpeg" style="width:400px;"/></div></div><p>ä½†æ˜¯ä½ ä¼šå‘ç°åªæœ‰ä¸€è¡Œterminalçš„æ–‡å­—å‡ºç°åœ¨å·¦ä¸Šè§’ï¼Œéšåæ— äº‹å‘ç”Ÿã€‚è¿™é‡Œå°±æ˜¯æˆ‘é‡åˆ°çš„ç¬¬ä¸€ä¸ªå‘äº†ã€‚è§£å†³æ–¹æ³•å‚è€ƒï¼š<a href="https://www.cnblogs.com/lifuqiang/articles/17167367.html">https://www.cnblogs.com/lifuqiang/articles/17167367.html</a></p><p>æˆ‘ä»¬é¦–å…ˆè¾“å…¥CTRL + ALT + F3ï¼Œç„¶åä¼šè¦æ±‚æˆ‘ä»¬ç™»å½•ï¼Œç”¨æˆ·åè¾“å…¥rootï¼Œå¯†ç è¾“å…¥è‡ªå·±ä¹‹å‰è®¾çš„é‚£ä¸ª</p><p>éšåï¼Œä¾æ¬¡è¾“å…¥å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/default</span><br><span class="line">sudo nano locale</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå°†ç¬¬ä¸€è¡Œæ”¹ä¸º <code>LANG=en_US.UTF-8</code></p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picst.sunbangyan.cn/2023/11/22/37e17dd85531240de5b51dc37f3c1a6c.jpeg" style="width:800px;"/></div></div><p>æŒ‰ CTRL+Xï¼Œç„¶å Yï¼Œå›è½¦ï¼Œç„¶åå†enteré€€å‡ºç¼–è¾‘</p><p>éšåï¼Œå†è¾“å…¥å‘½ä»¤ <code>sudo locale-gen --purge</code>ï¼Œ é…ç½®æˆ‘ä»¬åˆšåˆšä¿®æ”¹çš„è®¾ç½®</p><p>ç„¶åè¾“å…¥å‘½ä»¤ <code>reboot</code> é‡å¯è™šæ‹Ÿæœºï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥windowsé”®æ‰“å¼€æœç´¢ï¼Œè¾“å…¥terminalç„¶åå¯åŠ¨äº†ã€‚ï¼ˆåŸæ¥ä¹±ç çš„æ—¥æœŸä¹Ÿæ¢å¤äº†ï¼‰</p><h2 id="ç»™ç”¨æˆ·sudoæƒé™"><a href="#ç»™ç”¨æˆ·sudoæƒé™" class="headerlink" title="ç»™ç”¨æˆ·sudoæƒé™"></a>ç»™ç”¨æˆ·sudoæƒé™</h2><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/Moelimoe/article/details/105292219">https://blog.csdn.net/Moelimoe/article/details/105292219</a></p><p>ç›®å‰ä½ åˆ›å»ºçš„ç”¨æˆ·æ˜¯æ²¡æœ‰è¶…çº§æƒé™çš„ï¼Œè€Œmininetçš„ä½¿ç”¨åˆå¿…é¡»è¦è¶…çº§æƒé™ï¼Œä¹‹åä¼šé‡åˆ°å„ç§é—®é¢˜ã€‚å¹²è„†ç›´æ¥ç»™ç”¨æˆ·è¶…çº§æƒé™å¥½äº†ã€‚</p><p>é¦–å…ˆæ‰“å¼€å‘½ä»¤è¡Œï¼Œ<code>su root</code> è¿›å…¥rootç”¨æˆ·ï¼Œç„¶åè¾“å…¥å‘½ä»¤ <code>sudo adduser &lt;user_id&gt; sudo</code> ï¼Œå¡«å…¥è‡ªå·±çš„ç”¨æˆ·åå³å¯ï¼Œä¹‹åä½ çš„è´¦å·å°±æœ‰sudoæƒé™äº†ï¼Œæ“ä½œä¹Ÿä¸ç”¨è¿›rootã€‚</p><h1 id="é…ç½®mininet"><a href="#é…ç½®mininet" class="headerlink" title="é…ç½®mininet"></a>é…ç½®mininet</h1><h2 id="å®‰è£…git"><a href="#å®‰è£…git" class="headerlink" title="å®‰è£…git"></a>å®‰è£…git</h2><p>åˆšé…å¥½çš„ç¯å¢ƒä»€ä¹ˆä¹Ÿæ²¡æœ‰ï¼Œgitä¹Ÿéœ€è¦å®‰è£…ï¼Œå‘½ä»¤è¡Œè¾“å…¥ <code>sudo apt install git</code></p><p>ç„¶å <code>git clone https://gitee.com/derekwin/mininet.git</code> ï¼ŒåŸä»“åº“ä¸‹è½½ä¼šå¡ä½ï¼Œå¹¶ä¸”æœ‰ä¸€äº›æ€ªé—®é¢˜ï¼Œè¿™è¾¹æˆ‘ä»¬åˆ©ç”¨åˆ«äººçš„é•œåƒæºï¼ˆå‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/576832894ï¼‰">https://zhuanlan.zhihu.com/p/576832894ï¼‰</a></p><h2 id="å®‰è£…pip"><a href="#å®‰è£…pip" class="headerlink" title="å®‰è£…pip"></a>å®‰è£…pip</h2><p>æƒ³ä¸åˆ°å§ï¼Œpipä¹Ÿæ²¡æœ‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å…ˆå®‰è£…pipï¼Œå¦åˆ™ä¹‹åä¼šæŠ¥é”™ã€‚</p><p>å‘½ä»¤ï¼š <code>sudo apt-get install python3-pip</code></p><h2 id="å®‰è£…mininet"><a href="#å®‰è£…mininet" class="headerlink" title="å®‰è£…mininet"></a>å®‰è£…mininet</h2><p>éšåï¼Œæˆ‘ä»¬éœ€è¦è¾“å…¥å‘½ä»¤ <code>PYTHON=python3 mininet/util/install.sh -a</code>ï¼ŒæŒ‡å®špython3æ˜¯å› ä¸ºè¾ƒæ–°ç‰ˆæœ¬çš„ubuntué»˜è®¤åªæœ‰python3ç¯å¢ƒï¼Œä¸”æ²¡æœ‰/usr/bin/pythonï¼Œä¹‹åå®‰è£…æ—¶ä¼šæŠ¥é”™ã€‚</p><p>è¿™æ­¥æœ‰å¯èƒ½å› ä¸ºç½‘ç»œé—®é¢˜å¡ä½è€Œè·å–å¤±è´¥ï¼Œæˆ‘çš„å»ºè®®æ˜¯å¤šè¯•å‡ æ¬¡ã€‚æ²¡ä»€ä¹ˆåŠæ³•ã€‚</p><p>å®‰è£…è¿‡ç¨‹æ¯”è¾ƒé•¿ï¼Œéœ€è¦ç­‰å¾…</p><p>å‡ºç°Enjoy Mininet!å°±æ˜¯æˆåŠŸäº†</p><p>ä¹‹åå†è¾“å…¥ä¸€è¡Œå‘½ä»¤ <code>sudo apt-get install mininet</code>ï¼Œä¸€åˆ‡å¤§åŠŸå‘Šæˆã€‚</p><h2 id="ä¸‹è½½iperf3"><a href="#ä¸‹è½½iperf3" class="headerlink" title="ä¸‹è½½iperf3"></a>ä¸‹è½½iperf3</h2><p>åç»­å®éªŒè¿˜éœ€è¦ä¸¤ä¸ªå°æ’ä»¶ï¼Œæˆ‘ä»¬è¾“å…¥ <code>sudo apt-get install iperf3</code> å®‰è£…</p><p>è¿˜æœ‰ä¸€ä¸ªiperf3-plotterï¼Œä½†æ˜¯åŠ©æ•™ç»™çš„gitæ ¹æœ¬downloadä¸ä¸‹æ¥ï¼ˆ<code>git clone git://github.com/ekfoury/iperf3_plotter.git</code>ï¼‰ï¼Œå¾ˆéš¾èšŒã€‚</p><p>å¯ä»¥ç›´æ¥å» <a href="https://github.com/ekfoury/iperf3_plotter.git">https://github.com/ekfoury/iperf3_plotter.git</a> ä¸‹è½½å‹ç¼©åŒ…ï¼Œè§£å‹</p><p>éšåæˆ‘ä»¬å›åˆ°VirtualBoxçš„ç®¡ç†é¡µé¢ï¼Œåœ¨æˆ‘ä»¬é…ç½®çš„Ubuntuç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ä¿®æ”¹ä¸€ä¸‹è®¾ç½®ã€‚ä¿®æ”¹è®¾ç½®éœ€è¦åœ¨å…³é—­è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹å¯åŠ¨</p><p>åœ¨â€è®¾ç½®-&gt;å­˜å‚¨â€ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç©ºçš„â€æ§åˆ¶å™¨:IDEâ€ä¸‹æ·»åŠ ä¸€ä¸ªç›˜ï¼Œç‚¹å‡»å³ä¾§çš„â€å±æ€§-&gt;åˆ†é…å…‰é©±â€å³è¾¹çš„é‚£ä¸ªå°å›¾æ ‡ï¼Œé€‰æ‹©â€é€‰æ‹©è™šæ‹Ÿç›˜â€ï¼Œæ‰¾åˆ°VirtualBoxå®‰è£…æ—¶è‡ªå¸¦çš„ä¸€ä¸ªè™šæ‹Ÿç›˜å³å¯</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picss.sunbangyan.cn/2023/11/22/e57a184a662d19a18808481cca0bc9f3.jpeg" style="width:800px;"/></div></div><p>ä¹‹åé€€å›ç®¡ç†é¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯åŠ¨è™šæ‹Ÿæœºã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨å³ä¸‹è§’è¾“å…¥ç”¨æˆ·åå¯†ç ç™»å½•ï¼Œå¹¶ä¸”ä¼ æ–‡ä»¶ã€‚å·¦è¾¹æ˜¯windowsä¸‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå³è¾¹æ˜¯ubuntuä¸­çš„ã€‚æˆ‘ä»¬é€‰æ‹©éœ€è¦çš„æ–‡ä»¶ï¼Œç‚¹å‡»ä¸­é—´çš„å›¾æ ‡ä¸­ä¸‹é¢é‚£ä¸ªï¼Œå°±å¯ä»¥æŠŠæ–‡ä»¶ä¼ åˆ°è™šæ‹Ÿæœºä¸­äº†ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picss.sunbangyan.cn/2023/11/22/99c0d3389c8071cdf4d9ab1cee89cd2a.jpeg" style="width:800px;"/></div></div><p>éšååœ¨è™šæ‹Ÿç³»ç»Ÿä¸­å‘½ä»¤è¡Œè¿›å…¥æ–‡ä»¶å¤¹iperf3_plotter-masterï¼Œç„¶å <code>sudo make</code>ï¼Œå°±å¯ä»¥äº†</p><h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1><p>ä¹‹åçš„å®éªŒéƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å¦å¤–è®°å½•äº†ï¼Œå¼•å¯¼ä¹Ÿè¿˜å¯ä»¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Computer Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Study </tag>
            
            <tag> Notes </tag>
            
            <tag> Computer Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FDU Operating System Lab4</title>
      <link href="/posts/10018.html"/>
      <url>/posts/10018.html</url>
      
        <content type="html"><![CDATA[<h1 id="RISC-V-å®éªŒ"><a href="#RISC-V-å®éªŒ" class="headerlink" title="RISC-V å®éªŒ:"></a>RISC-V å®éªŒ:</h1><h3 id="1-Which-registers-contain-arguments-to-functions-For-example-which-register-holds-13-in-mainâ€™s-call-to-printf"><a href="#1-Which-registers-contain-arguments-to-functions-For-example-which-register-holds-13-in-mainâ€™s-call-to-printf" class="headerlink" title="1. Which registers contain arguments to functions? For example, which register holds 13 in mainâ€™s call to printf?"></a>1. Which registers contain arguments to functions? For example, which register holds 13 in mainâ€™s call to printf?</h3><p>åœ¨æ¨èé˜…è¯»ææ–™ã€ŠCalling Conventionã€‹ä¸­ï¼Œæœ‰æåˆ°ï¼š</p><p>â€œThe RISC-V calling convention passes arguments in registers when possible. Up to eight integer registers, a0â€“a7, and up to eight floating-point registers, fa0â€“fa7, are used for this purpose.â€ </p><p>æ‰€ä»¥ï¼Œå‘å‡½æ•°ä¼ é€’å‚æ•°çš„å¯„å­˜å™¨æ˜¯ <code>a0-a7</code> å’Œ <code>fa0-fa7</code>. åœ¨è°ƒç”¨ printf çš„æ—¶å€™ï¼Œ13 è¢«æ”¾åœ¨äº†å¯„å­˜å™¨ a2 ä¸­ <code>(24: 4635 li a2,13)</code></p><h3 id="2-Where-is-the-call-to-function-f-in-the-assembly-code-for-main-Where-is-the-call-to-g-Hint-the-compiler-may-inline-functions"><a href="#2-Where-is-the-call-to-function-f-in-the-assembly-code-for-main-Where-is-the-call-to-g-Hint-the-compiler-may-inline-functions" class="headerlink" title="2. Where is the call to function f in the assembly code for main? Where is the call to g? (Hint: the compiler may inline functions.)"></a>2. Where is the call to function f in the assembly code for main? Where is the call to g? (Hint: the compiler may inline functions.)</h3><p><code>main</code> å‡½æ•°åº”è¯¥æ˜¯åœ¨ <code>printf</code> ä¸­è°ƒç”¨äº†å‡½æ•° <code>f</code>ï¼Œä½†æ˜¯é€šè¿‡æŸ¥çœ‹æ±‡ç¼–ä»£ç ï¼Œæˆ‘ä»¬å‘ç°æœ¬åº”è°ƒç”¨å‡½æ•° <code>f</code> çš„åœ°æ–¹ï¼Œ<code>main</code> å‡½æ•°ç›´æ¥è¯»å–äº†å‚æ•° 12 <code>(24: 45b1 li a1,12)</code>ï¼Œå¯ä»¥æƒ³åˆ°æ˜¯å‡½æ•° f å’Œå‡½æ•° g å¤ªç®€å•äº†ï¼Œç›´æ¥è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰äº†ã€‚</p><h3 id="3-At-what-address-is-the-function-printf-located"><a href="#3-At-what-address-is-the-function-printf-located" class="headerlink" title="3. At what address is the function printf located?"></a>3. At what address is the function printf located?</h3><p>ç”±<code>(34:61a080e7 jalr 1562(ra) # 64a &lt;printf&gt;)</code>è¿™å¥ï¼Œåº”è¯¥æ˜¯åœ¨ <code>0x64a</code> çš„ä½ç½®ï¼Œå…¶ä¸­ <code>ra</code> æ˜¯ä¸Šä¸€è¡Œä½¿ç”¨ <code>(30: 00000097 auipc ra,0x0)</code> è·å–çš„è¿™è¡Œä»£ç çš„åœ°å€ <code>0x30</code>ï¼Œç„¶å <code>jalr</code> çš„ç›®æ ‡åœ°å€å°±æ˜¯ 1562(åè¿›åˆ¶) + 0x30 = 0x64aï¼Œæˆ‘ä»¬æŠŠä»£ç å¾€ä¸‹ç¿»åˆ° <code>0x64a</code> çš„åœ°æ–¹ï¼Œä¹Ÿç¡®å®æ˜¯ <code>printf</code> å‡½æ•°çš„èµ·å§‹åœ°å€ã€‚</p><h3 id="4-What-value-is-in-the-register-ra-just-after-the-jalr-to-printf-in-main"><a href="#4-What-value-is-in-the-register-ra-just-after-the-jalr-to-printf-in-main" class="headerlink" title="4. What value is in the register ra just after the jalr to printf in main?"></a>4. What value is in the register ra just after the jalr to printf in main?</h3><p>å‚è€ƒé˜…è¯»ææ–™ï¼š</p><p>â€œThe indirect jump instruction JALR (jump and link register) uses the I-type encoding. The target address is obtained by adding the sign-extended 12-bit I-immediate to the register rs1, then setting the least-significant bit of the result to zero. The address of the instruction following the jump (pc+4) is written to register rd.Register x0 can be used as the destination if the result is not required.â€ </p><p>æ‰€ä»¥ï¼Œåº”è¯¥ ra é‡Œå­˜çš„æ˜¯ pc+4ï¼Œä¹Ÿå°±æ˜¯ <code>0x38</code></p><h3 id="5-Run-the-following-code-unsigned-int-i-0x00646c72-printf-â€œH-x-Wo-sâ€-57616-amp-i"><a href="#5-Run-the-following-code-unsigned-int-i-0x00646c72-printf-â€œH-x-Wo-sâ€-57616-amp-i" class="headerlink" title="5. Run the following code. unsigned int i = 0x00646c72; printf(â€œH%x Wo%sâ€, 57616, &amp;i)"></a>5. Run the following code. unsigned int i = 0x00646c72; printf(â€œH%x Wo%sâ€, 57616, &amp;i)</h3><p>è¾“å‡ºï¼šHE110 World</p><p>å‰é¢è¿™ä¸ª%x æ˜¯ä»¥ 16 è¿›åˆ¶è¾“å‡º 57616(åè¿›åˆ¶)ï¼Œå°±æ˜¯ E110ï¼›åé¢å› ä¸º risc-v é‡‡ç”¨ little-endian å­˜<br>å‚¨æ•°æ®ï¼Œæ‰€ä»¥è¾“å‡ºçš„æ—¶å€™æ˜¯ <code>72, 6c, 64, 00</code>ï¼Œå¯¹åº”çš„å­—ç¬¦å°±æ˜¯ <code>r l d \0</code>ï¼Œå¦‚æœæ˜¯ big-endian, i å°±åº”è¯¥<br>æ˜¯ <code>0x726c6400</code>ï¼Œ<code>57616</code> ä¸ç”¨å˜ã€‚</p><h3 id="6-In-the-following-code-what-is-going-to-be-printed-after-â€˜y-â€™-note-the-answer-is-not-a-specific-value-Why-does-this-happen-printf-â€œx-d-y-dâ€-3"><a href="#6-In-the-following-code-what-is-going-to-be-printed-after-â€˜y-â€™-note-the-answer-is-not-a-specific-value-Why-does-this-happen-printf-â€œx-d-y-dâ€-3" class="headerlink" title="6. In the following code, what is going to be printed after â€˜y=â€™? (note: the answer is not a specific value.) Why does this happen?  printf(â€œx=%d y=%dâ€, 3);"></a>6. In the following code, what is going to be printed after â€˜y=â€™? (note: the answer is not a specific value.) Why does this happen?  printf(â€œx=%d y=%dâ€, 3);</h3><p>è¾“å‡ºï¼šx=3 y=8229</p><p>å‰é¢ä¸€ä¸ªæ­£å¸¸è¾“å‡º 3ï¼Œy è¿™ä¸ªæ²¡ä¼ å‚æ•°ï¼Œä¼šè¾“å‡ºä¸€ä¸ªå¥‡æ€ªçš„å€¼ã€‚çœ‹æ±‡ç¼–ç çš„è¯ï¼Œprintf(â€œx=%d y=%dâ€, 3) ä¼šæ¯” printf(â€œx=%d y=%dâ€, 3, 4) å°‘ä¸€å¥ <code>li a2,4</code>ï¼Œå…¶ä½™æ±‡ç¼–ç éƒ½æ˜¯ä¸€æ ·çš„ã€‚æˆ‘çŒœå°±æ˜¯æ²¡ä¼ å‚æ•°çš„è¯ï¼Œy ä¹Ÿä¼šè¾“å‡º a2 å¯„å­˜å™¨é‡Œçš„å†…å®¹ï¼Œåªä¸è¿‡å¯„å­˜å™¨é‡Œå°±æ˜¯ä¸€ä¸ªä¸ç¡®å®šçš„å€¼äº†ã€‚</p><h1 id="BACKTRACEå®éªŒ"><a href="#BACKTRACEå®éªŒ" class="headerlink" title="BACKTRACEå®éªŒ"></a>BACKTRACEå®éªŒ</h1><p>backtraceå‡½æ•°çš„ç›®çš„æ˜¯é€’å½’è¯»å–æ¯ä¸ªå‡½æ•°è°ƒç”¨æ ˆï¼Œä¾æ¬¡æ‰“å°è¿”å›åœ°å€</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æœ¬æ¬¡çš„æµ‹è¯•ç¨‹åº <code>/user/bttest</code> ï¼Œæ¯”è¾ƒæœ´ç´ ï¼Œå°±è°ƒç”¨äº†ä¸€ä¸ªsleep()çš„system call</p><p>æ‰€ä»¥æˆ‘ä»¬è¦åœ¨ <code>kernel/defs.h</code> å¤´æ–‡ä»¶ä¸­æ³¨å†Œbacktraceå‡½æ•°çš„åŸå‹ï¼Œä»¥ä¾¿sys_sleepå‡½æ•°å¯ä»¥è°ƒç”¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// printf.c</span></span><br><span class="line"><span class="type">void</span>            <span class="title function_">printf</span><span class="params">(<span class="type">char</span>*, ...)</span>;</span><br><span class="line"><span class="type">void</span>            <span class="title function_">panic</span><span class="params">(<span class="type">char</span>*)</span> __<span class="title function_">attribute__</span><span class="params">((<span class="keyword">noreturn</span>))</span>;</span><br><span class="line"><span class="type">void</span>            <span class="title function_">printfinit</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span>            <span class="title function_">backtrace</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>è¿›ä¸€æ­¥æŒ‰ç…§æç¤ºï¼Œåœ¨ <code>kernel/riscv.h</code> æ·»åŠ å¦‚ä¸‹å‡½æ•°è·å–s0å¯„å­˜å™¨ä¸­ä¿å­˜çš„fpçš„å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> uint64 <span class="title function_">r_fp</span><span class="params">()</span> &#123;</span><br><span class="line">  uint64 x;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mv %0, s0&quot;</span> : <span class="string">&quot;=r&quot;</span> (x) )</span>;</span><br><span class="line">  <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>kernel/sysproc.c</code> çš„sys_sleep()ä¸­è°ƒç”¨backtrace()</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_sleep</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  uint ticks0;</span><br><span class="line"></span><br><span class="line">  backtrace();</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>, &amp;n);</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="backtraceå‡½æ•°å®ç°"><a href="#backtraceå‡½æ•°å®ç°" class="headerlink" title="backtraceå‡½æ•°å®ç°"></a>backtraceå‡½æ•°å®ç°</h2><p>æˆ‘ä»¬å¯ä»¥å…ˆçœ‹ <a href="https://pdos.csail.mit.edu/6.1810/2022/lec/l-riscv.txt">https://pdos.csail.mit.edu/6.1810/2022/lec/l-riscv.txt</a> ä¸­å¯¹å‡½æ•°è°ƒç”¨æ ˆçš„ç»“æ„çš„ä»‹ç»</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Stack</span><br><span class="line">                   .</span><br><span class="line">                   .</span><br><span class="line">      +-&gt;          .</span><br><span class="line">      |   +-----------------+   |</span><br><span class="line">      |   | return address  |   |</span><br><span class="line">      |   |   previous fp ------+</span><br><span class="line">      |   | saved registers |</span><br><span class="line">      |   | local variables |</span><br><span class="line">      |   |       ...       | &lt;-+</span><br><span class="line">      |   +-----------------+   |</span><br><span class="line">      |   | return address  |   |</span><br><span class="line">      +------ previous fp   |   |</span><br><span class="line">          | saved registers |   |</span><br><span class="line">          | local variables |   |</span><br><span class="line">      +-&gt; |       ...       |   |</span><br><span class="line">      |   +-----------------+   |</span><br><span class="line">      |   | return address  |   |</span><br><span class="line">      |   |   previous fp ------+</span><br><span class="line">      |   | saved registers |</span><br><span class="line">      |   | local variables |</span><br><span class="line">      |   |       ...       | &lt;-+</span><br><span class="line">      |   +-----------------+   |</span><br><span class="line">      |   | return address  |   |</span><br><span class="line">      +------ previous fp   |   |</span><br><span class="line">          | saved registers |   |</span><br><span class="line">          | local variables |   |</span><br><span class="line">  $fp --&gt; |       ...       |   |</span><br><span class="line">          +-----------------+   |</span><br><span class="line">          | return address  |   |</span><br><span class="line">          |   previous fp ------+</span><br><span class="line">          | saved registers |</span><br><span class="line">  $sp --&gt; | local variables |</span><br><span class="line">          +-----------------+</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªå‡½æ•°ä½¿ç”¨ä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆä»é«˜åœ°å€å‘ä½åœ°å€ç”Ÿé•¿ã€‚ç”±å›¾ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½ï¼Œæ¯ä¸ªæ ˆå¸§çš„èµ·å§‹åœ°å€ç”±fpç»™å‡ºï¼ˆé€šè¿‡ <code>r_fp()</code> è·å–ï¼‰ï¼Œfp-8 å°±æ˜¯è¿”å›åœ°å€ï¼Œfp-16 å°±æ˜¯å‰ä¸€ä¸ªå‡½æ•°çš„æ ˆå¸§çš„fpã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åªè¦é€’å½’åœ°æ‰“å°ä¿¡æ¯å°±å¯ä»¥äº†ï¼Œè‡³äºç»ˆæ­¢æ¡ä»¶ï¼Œæ ¹æ®æç¤ºæˆ‘ä»¬å¯ä»¥å‚çœ‹ <code>kernel/riscv.h</code> ä¸­çš„PGROUNDUP(fp)æˆ–PGROUNDDOWN(fp)å‡½æ•°</p><p>å¤šä¸ªå‡½æ•°çš„æ ˆå¸§éƒ½åœ¨åŒä¸€ä¸ªé¡µé¢ä¸­ï¼Œæ— è®ºfpæŒ‡é’ˆæŒ‡å‘å“ªä¸ªå‡½æ•°çš„æ ˆå¸§ï¼ŒPGROUNDUP(fp) å’Œ PGROUNDDOWN(fp)éƒ½æ˜¯å›ºå®šä¸å˜çš„ï¼Œä¸”æœ‰PGROUNDUP(fp) - PGROUNDDOWN(fp) = PGSIZEã€‚è€Œå½“ fp æŒ‡å‘å½“å‰é¡µçš„èµ·å§‹åœ°å€æ—¶ï¼Œä¼šæœ‰PGROUNDUP(fp) = PGROUNDDOWN(fp)ï¼Œæ­¤æ—¶å¾ªç¯ç»ˆæ­¢ã€‚</p><p>åœ¨ <code>kernel/printf.c</code> ä¸­<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> </span><br><span class="line"><span class="title function_">backtrace</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;barcktrace:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  uint64 ra, fp = r_fp();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span>(PGROUNDUP(fp) - PGROUNDDOWN(fp) == PGSIZE)</span><br><span class="line">  &#123;</span><br><span class="line">    ra = *((uint64*)(fp - <span class="number">8</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, ra);</span><br><span class="line">    fp = *((uint64*)(fp - <span class="number">16</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨è°ƒç”¨å®Œbtteståé€€å‡ºqemuï¼Œæ‰§è¡Œaddr2line -e kernel/kernelï¼ŒæŸ¥çœ‹è¿”å›åœ°å€åœ¨ä»£ç ä¸­çš„ä½ç½®</p><p>æ‰§è¡Œå‘½ä»¤ï¼š<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">addr2line -e kernel/kernel</span><br><span class="line"><span class="number">0</span>x000000008000212c</span><br><span class="line"><span class="number">0</span>x000000008000201e</span><br><span class="line"><span class="number">0</span>x0000000080001d14</span><br></pre></td></tr></table></figure></p><p>å¾—åˆ°ç»“æœï¼š<br><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/root/Desktop/xv6-labs-<span class="number">2022</span>/kernel/sysproc.c:<span class="number">59</span></span><br><span class="line">/root/Desktop/xv6-labs-<span class="number">2022</span>/kernel/syscall.c:<span class="number">141</span></span><br><span class="line">/root/Desktop/xv6-labs-<span class="number">2022</span>/kernel/trap.c:<span class="number">76</span></span><br></pre></td></tr></table></figure></p><h1 id="Alarmå®éªŒ"><a href="#Alarmå®éªŒ" class="headerlink" title="Alarmå®éªŒ"></a>Alarmå®éªŒ</h1><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ·»åŠ ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ <code>sys_sigalarm</code> å’Œ <code>sys_sigreturn</code> ï¼Œå¯ä»¥å‚çœ‹Lab2çš„æ“ä½œ</p><p>ä¿®æ”¹ä¸€ä¸‹Makefileæ–‡ä»¶æ¥ç¼–è¯‘alarmtest.c</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UPROGS=\</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">$U/_zombie\</span><br><span class="line">    $U/_alarmtest\</span><br></pre></td></tr></table></figure><p>åœ¨ <code>user/user.h</code> ä¸­æ·»åŠ ç³»ç»Ÿè°ƒç”¨å£°æ˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system calls</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigalarm</span><span class="params">(<span class="type">int</span> ticks, <span class="type">void</span> (*handler)())</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigreturn</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>kernel/syscall.h</code> ä¸­ï¼Œæ·»åŠ ä¸¤ä¸ªå®å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_sigalarm 22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_sigreturn 23</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>kernel/syscall.c</code> æŒ‡å®šç³»ç»Ÿè°ƒç”¨çš„ä¸»ä½“å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">[SYS_sigalarm] sys_sigalarm,</span><br><span class="line">[SYS_sigreturn] sys_sigreturn,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>user/usys.pl</code> ä¸­æ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„å­˜æ ¹</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry(<span class="string">&quot;sigalarm&quot;</span>);</span><br><span class="line">entry(<span class="string">&quot;sigreturn&quot;</span>);</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå°±åšå®Œå‡½æ•°è°ƒç”¨çš„å‡†å¤‡äº†ï¼Œæ¥ä¸‹æ¥ï¼Œå…ˆå®ç° <code>sys_sigalarm()</code> å‡½æ•°</p><p>ä¿®æ”¹ <code>kernel/proc.h</code> ä¸­çš„procç»“æ„ä½“ï¼Œæ·»åŠ sigalarmçš„ä¸¤ä¸ªå‚æ•°(æ—¶é—´é—´éš”nã€è°ƒç”¨å‡½æ•°fn)ï¼Œè¿˜éœ€è¦è®°å½•ä»ä¸Šæ¬¡è°ƒç”¨sigalarmåç»è¿‡çš„æ—¶é—´é—´éš”ticks</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> n; <span class="comment">// the alarm interval</span></span><br><span class="line"><span class="type">int</span> ticks;</span><br><span class="line">uint64 fn; <span class="comment">// the pointer to the handler function</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>kernel/proc.c</code> ä¸­çš„allocproc()å‡½æ•°ä¸­åˆå§‹åŒ–æ–°åŠ çš„å‚æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">found:</span><br><span class="line">  p-&gt;pid = allocpid();</span><br><span class="line">  p-&gt;state = USED;</span><br><span class="line">  p-&gt;n = <span class="number">0</span>;</span><br><span class="line">  p-&gt;ticks = <span class="number">0</span>;</span><br><span class="line">  p-&gt;fn = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>kernel/sysproc.c</code> ä¸­å®ç° <code>sys_sigalarm()</code> å‡½æ•°(æš‚æ—¶ <code>sys_sigreturn</code> åªè¿”å›0)ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  uint64 fn;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  argint(<span class="number">0</span>,&amp;n);</span><br><span class="line">  argaddr(<span class="number">1</span>,&amp;fn);</span><br><span class="line"></span><br><span class="line">  p-&gt;n = n;</span><br><span class="line">  p-&gt;fn = fn;</span><br><span class="line">  p-&gt;ticks = <span class="number">0</span>;  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ <code>kernel/trap.c</code> å¯¹æ—¶é—´ä¸­æ–­çš„å¤„ç†ï¼Œå¦‚æœæ˜¯æ—¶é’Ÿä¸­æ–­ï¼ˆwhich_dev==2ï¼‰ï¼Œå°±å¢åŠ è®°å½•çš„ä¸­æ–­æ•°ã€‚å¦‚æœä¸­æ–­æ•°åˆ°è¾¾æŒ‡å®šé—´éš”ï¼Œå°±å°†å¤„ç†å‡½æ•°fnçš„æŒ‡é’ˆä¼ ç»™epcï¼Œä»¥æ‰§è¡Œå¤„ç†å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(which_dev == <span class="number">2</span>) </span><br><span class="line">&#123;</span><br><span class="line">  p-&gt;ticks++;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;ticks == p-&gt;n) &#123;</span><br><span class="line">    p-&gt;trapframe-&gt;epc = p-&gt;fn; </span><br><span class="line">    p-&gt;ticks = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®ç°sys-sigreturn"><a href="#å®ç°sys-sigreturn" class="headerlink" title="å®ç°sys_sigreturn"></a>å®ç°sys_sigreturn</h2><p>è¿™ä¸ªå‡½æ•°è°ƒç”¨è¦æ±‚æˆ‘ä»¬åœ¨æ—¶é’Ÿä¸­æ–­è¿”å›åï¼Œèƒ½å¤Ÿå›åˆ°åŸæ¥çš„çŠ¶æ€ã€‚</p><p>æ ¹æ®hintï¼Œæˆ‘ä»¬éœ€è¦åœ¨sys_sigalarm()ä¸­ä¿å­˜ä¸­æ–­æ—¶çš„å¯„å­˜å™¨å€¼</p><p>æ‰€ä»¥ï¼Œåœ¨ <code>kernel/proc.h</code> ä¸­çš„procç»“æ„ä½“åŠ ä¸Šç›¸å…³ä¿¡æ¯ï¼Œä¸å¦¨ç›´æ¥è®¾ç½®ä¸€ä¸ªå¤‡ä»½çš„trapframeï¼ˆåŒ…å«æ‰€æœ‰å¯„å­˜å™¨çš„å€¼ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> *<span class="title">backup</span>;</span>    <span class="comment">// Save registers</span></span><br><span class="line"><span class="type">int</span> cur_fn;                  <span class="comment">// Prevent repetitive calls to the handler function(test2 è¦ç”¨)</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œåœ¨è°ƒç”¨sigreturnæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠbackupå¤åˆ¶å›åŸæ¥çš„trapframeå³å¯ï¼ŒåŒæ—¶è®¾cur_fnä¸º0è¡¨ç¤ºæ—¶é’Ÿä¸­æ–­å¤„ç†å‡½æ•°ç»“æŸï¼›hint4ä¹Ÿæé†’æˆ‘ä»¬è¦æŠŠè¿”å›å€¼è®¾ä¸ºa0çš„å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">uint64 </span><br><span class="line"><span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span>* <span class="title">p</span> =</span> myproc();</span><br><span class="line">  *p-&gt;trapframe = *p-&gt;backup;</span><br><span class="line">  p-&gt;cur_fn = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> p-&gt;backup-&gt;a0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå¯¹åº”çš„æ—¶é’Ÿä¸­æ–­å¤„ç†å‡½æ•°ï¼ŒåŠ ä¸€ä¸ª <code>if(p-&gt;cur_fn == 0)</code> åˆ¤æ–­ä¸ä¼šé‡å¤è°ƒç”¨ï¼Œè¿˜æœ‰å°±æ˜¯å¤åˆ¶åŸæ¥çš„trapframeã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(which_dev == <span class="number">2</span>) </span><br><span class="line">&#123;</span><br><span class="line">  p-&gt;ticks++;</span><br><span class="line">  <span class="keyword">if</span>(p-&gt;ticks == p-&gt;n &amp;&amp; p-&gt;cur_fn == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    *p-&gt;backup = *p-&gt;trapframe;</span><br><span class="line">    p-&gt;trapframe-&gt;epc = p-&gt;fn;</span><br><span class="line">    p-&gt;ticks = <span class="number">0</span>;</span><br><span class="line">    p-&gt;cur_fn = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ƒè¿˜æœ‰ä¸€äº›ç»†èŠ‚éƒ¨åˆ†ï¼Œè¯¥åˆ†é…å†…å­˜å’Œé‡Šæ”¾å†…å­˜çš„åœ°æ–¹ï¼Œå‚è€ƒåŸæœ¬æœ‰çš„éƒ¨åˆ†</p><p>åœ¨ <code>kernel/proc.c</code> çš„ <code>allocproc</code> ä¸­ï¼Œç»™æ–°åŠ çš„ä¸¤ä¸ªå˜é‡åˆ†é…å†…å­˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p-&gt;cur_fn = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((p-&gt;backup = (<span class="keyword">struct</span> trapframe *)kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">  freeproc(p);</span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>freeproc</code> ä¸­é‡Šæ”¾å†…å­˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(p-&gt;backup) </span><br><span class="line">  kfree((<span class="type">void</span>*) p-&gt;backup);</span><br><span class="line">p-&gt;backup = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">p-&gt;n = <span class="number">0</span>;</span><br><span class="line">p-&gt;ticks = <span class="number">0</span>;</span><br><span class="line">p-&gt;fn = <span class="number">0</span>;</span><br><span class="line">p-&gt;cur_fn = <span class="number">0</span>;</span><br><span class="line">p-&gt;state = UNUSED;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Operating System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Study </tag>
            
            <tag> Notes </tag>
            
            <tag> Operating System </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyTorchå­¦ä¹ ç¬”è®°ï¼ˆä¸‰ï¼‰ LSTM</title>
      <link href="/posts/10012.html"/>
      <url>/posts/10012.html</url>
      
        <content type="html"><![CDATA[<p>å‚è€ƒï¼š<a href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">https://colah.github.io/posts/2015-08-Understanding-LSTMs/</a> ï¼Œå†™å¾—éå¸¸è¯¦ç»†ï¼Œæœ‰ç²¾è‡´çš„å›¾ä¾‹å’Œæ¸…æ¥šçš„å…¬å¼ï¼Œå»ºè®®å…ˆé˜…è¯»è¯¥ç¯‡æ–‡ç« </p><p class='p left logo large'>åŸºæœ¬æ¦‚å¿µ</p><p>LSTMï¼Œé•¿çŸ­æœŸè®°å¿†ç¥ç»ç½‘ç»œï¼Œå®ƒå…‹æœäº†RNNéš¾ä»¥è®°å½•é•¿æœŸä¿¡æ¯çš„ç‰¹ç‚¹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œâ€œå¤©ä¸Šçº¢è‰²çš„æ˜¯__â€ï¼ŒRNNå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šåˆ©ç”¨â€œå¤©ä¸Šâ€ã€â€œçº¢è‰²â€ç­‰ä¿¡æ¯æ¥é¢„æµ‹å½“å‰åº”å¡«çš„å•è¯ï¼Œå¯èƒ½æ˜¯â€œå¤ªé˜³â€ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœæœ‰æ•ˆä¿¡æ¯ç›¸éš”éå¸¸è¿œï¼Œä¾‹å¦‚ï¼šâ€œæˆ‘æ˜¯ä¸€ä¸ªä¸­å›½äººï¼Œâ€¦â€¦ï¼Œæˆ‘ä¼šè¯´___ï¼Œè‹±è¯­å’Œæ—¥è¯­â€ï¼Œè¿™äº›ä¹…è¿œçš„ä¿¡æ¯å¾ˆéš¾ç•™å­˜åœ¨RNNçš„hidden stateä¸­ã€‚</p><p>LSTMåœ¨ç»“æ„ä¸Šåšå‡ºäº†æ”¹è¿›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å®ƒåŒ…å«ä¸¤ç§hidden stateï¼Œä¸€ä¸ªæ˜¯ä¸Šæ–¹çš„$C_t$ï¼Œå®ƒä»£è¡¨ç€æ¨¡å‹çš„è®°å¿†ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ”¹åŠ¨è¾ƒå°‘ï¼Œä¸€ä¸ªæ˜¯ä¸‹æ–¹çš„$h_t$ï¼Œä»£è¡¨ç€è¾“å…¥å†…å®¹çš„æŠ½è±¡ä¿¡æ¯ï¼ˆï¼Ÿä¹Ÿè®¸ï¼Œå…¶å®æ²¡æœ‰è¿™ä¹ˆæ˜ç¡®çš„ç‰©ç†æ„ä¹‰ï¼Œåªæ˜¯æˆ‘æœŸæœ›å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼‰ã€‚å®ƒä»¬é€šè¿‡ä¸€äº›æ–¹å¼äº’ç›¸å½±å“å¹¶æ›´æ–°ï¼Œä¸‹é¢ä¸€ä¸€ä»‹ç»ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picss.sunbangyan.cn/2023/10/18/a1e155b0ed13694af1700b3c732024b9.png" style="width:800px;"/></div></div><p class='p left logo large'>ç½‘ç»œç»“æ„</p><h1 id="é—å¿˜é—¨"><a href="#é—å¿˜é—¨" class="headerlink" title="é—å¿˜é—¨"></a>é—å¿˜é—¨</h1><p>LSTMçš„ç¬¬ä¸€æ­¥æ˜¯å†³å®šè¦è®©é•¿æœŸè®°å¿†$C_{t-1}$å»é—å¿˜ä»€ä¹ˆã€‚å®ƒæ‹¼æ¥å½“å‰è¾“å…¥$x_t$å’Œä¸Šä¸€æ—¶åˆ»çš„çŠ¶æ€$h_{t-1}$ï¼Œå¹¶é€å…¥sigmoidå±‚ï¼Œå¾—åˆ°ä¸€ä¸ªä»‹äº0ä¸1ä¹‹é—´çš„è¾“å‡ºå‘é‡ã€‚éšåï¼Œå’Œ$C_{t-1}$åšHadamardç§¯ã€‚å¦‚æœsigmoidå±‚å¯¹åº”è¾“å‡ºè¶Šæ¥è¿‘0ï¼Œåˆ™å¯¹åº”ä¿¡æ¯é—å¿˜å¾—è¶Šå¤šï¼Œåä¹‹åˆ™ç»§ç»­è®°å¿†ã€‚</p><p>å½¢è±¡åŒ–çš„ç†è§£å¯èƒ½å°±æ˜¯ï¼Œç”¨å½“å‰çŠ¶æ€å»åˆ¤æ–­å“ªäº›è®°å¿†ä¸å†é€‚ç”¨äº†ï¼Œæ¯”å¦‚è¯´ä¹‹å‰è¿˜ä¸€ç›´åœ¨è°ˆè®ºAï¼Œç°åœ¨çªç„¶è½¬åˆ°è°ˆè®ºBäº†ï¼Œä¸€äº›æœ‰å…³Açš„ä¿¡æ¯å°±ä¸å†éœ€è¦äº†ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picdm.sunbangyan.cn/2023/10/19/9e11a5f3e9ea43fa9bb0538dbcc869e5.png" style="width:800px;"/></div></div><h1 id="è¾“å…¥é—¨"><a href="#è¾“å…¥é—¨" class="headerlink" title="è¾“å…¥é—¨"></a>è¾“å…¥é—¨</h1><p>ç¬¬äºŒæ­¥æ˜¯å†³å®šè¦è®©$C_{t-1}$è®°ä½ä»€ä¹ˆã€‚å½“å‰è¾“å…¥é¦–å…ˆä¼šç»è¿‡ä¸€ä¸ªsigmoidå±‚å¾—åˆ°$i_t$ï¼Œè¿™å†³å®šäº†æ¥ä¸‹æ¥å“ªäº›ä¿¡æ¯æ˜¯æœ‰å¿…è¦è¢«è®°ä½çš„ã€‚å®é™…ä¸Šçš„æ›´æ–°å‘é‡$\tilde{C_t}$æ˜¯é€šè¿‡tanhæ¿€æ´»å‡½æ•°å¾—åˆ°çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆé€‰tanhï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€äº›è¯´æ³•ï¼šï¼ˆæ¥è‡ªï¼š<a href="https://stackoverflow.com/questions/40761185/what-is-the-intuition-of-using-tanh-in-lstmï¼‰">https://stackoverflow.com/questions/40761185/what-is-the-intuition-of-using-tanh-in-lstmï¼‰</a></p><ul><li><p>ä¸ºäº†é˜²æ­¢æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªäºŒæ¬¡å¯¼æ•°åœ¨å¤§èŒƒå›´å†…ä¸ä¸º0çš„å‡½æ•°ï¼Œè€Œtanhå‡½æ•°å¯ä»¥æ»¡è¶³è¿™ä¸€ç‚¹</p></li><li><p>ä¸ºäº†ä¾¿äºå‡¸ä¼˜åŒ–ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•è°ƒå‡½æ•°</p></li><li><p>tanhå‡½æ•°ä¸€èˆ¬æ”¶æ•›çš„æ›´å¿«</p></li><li><p>tanhå‡½æ•°çš„æ±‚å¯¼å ç”¨ç³»ç»Ÿçš„èµ„æºæ›´å°‘</p></li></ul><p>éšåï¼Œ$i_t$ä¸$\tilde{C_t}$ç›¸ä¹˜ï¼Œå¾—åˆ°æ­£å¼çš„updateå†…å®¹ã€‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picdm.sunbangyan.cn/2023/10/19/59ab5d4957ad6e60f3984257d96245f5.png" style="width:800px;"/></div></div><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picst.sunbangyan.cn/2023/10/19/65e1a37f0d9e047776f1a0b0f6e228c7.png" style="width:800px;"/></div></div><h1 id="è¾“å‡ºé—¨"><a href="#è¾“å‡ºé—¨" class="headerlink" title="è¾“å‡ºé—¨"></a>è¾“å‡ºé—¨</h1><p>æˆ‘ä»¬è¦å†³å®šè¾“å‡ºä»€ä¹ˆå†…å®¹ã€‚æ€»ä¹‹å°±æ˜¯è¾“å…¥ç»è¿‡ä¸€ä¸ªsigmoidå±‚ï¼ŒåŠ ä¸Šè®°å¿†$C_{t}$çš„å½±å“ï¼ˆç»è¿‡tanhï¼‰ï¼Œ</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picss.sunbangyan.cn/2023/10/19/a3243ac1c491e8b184bc8912621828af.png" style="width:800px;"/></div></div><p class='p left logo large'>ä»£ç </p><h1 id="è‡ªå·±å®ç°"><a href="#è‡ªå·±å®ç°" class="headerlink" title="è‡ªå·±å®ç°"></a>è‡ªå·±å®ç°</h1><p>å…ˆä¸ç”¨PyTorchå®šä¹‰å¥½çš„LSTMï¼Œç›´æ¥æ ¹æ®ç½‘ç»œç»“æ„ä¸€æ­¥æ­¥ä»å¤´æ­å»ºä¸€ä¸ª</p><p>æ³¨æ„åˆ°åŸæ¥å…¬å¼ä¸­æœ‰ä¸€æ­¥æ‹¼æ¥$h_{t-1}$å’Œ$x_t$çš„æ“ä½œï¼Œç„¶åå’Œæƒé‡çŸ©é˜µ$W$ç›¸ä¹˜ã€‚ç”±çº¿æ€§ä»£æ•°çŸ¥è¯†ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠ$W \cdot [h_{t-1},x_t]$ å˜æˆ $U \cdot x_t + V \cdot h_{t-1}$</p><p>è¿™æ ·ï¼ŒåŸæ¥LSTMä¸­çš„ä¸‰ä¸ªsigmoidå±‚ï¼Œä¸€ä¸ªtanhå±‚çš„å…¬å¼å°±åº”è¯¥æ˜¯ï¼š</p><script type="math/tex; mode=display">\begin{equation}\left\{    \begin{array}{ll}      f_t &= \sigma(U_f \cdot x_t + V_f \cdot h_{t-1} + b_f) \\          i_t &= \sigma(U_i \cdot x_t + V_i \cdot h_{t-1} + b_i) \\      \tilde{C_t} &= \sigma(U_c \cdot x_t + V_c \cdot h_{t-1} + b_c) \\      o_t &= \sigma(U_o \cdot x_t + V_o \cdot h_{t-1} + b_o)    \end{array}\right. \notag\end{equation}</script><p>ç°åœ¨éœ€è¦ç†æ¸…æ¥šä¸€ä¸‹ç»´åº¦ï¼š</p><p>è¾“å…¥ $x$ åº”è¯¥æ˜¯ [batch_size, sequence_len(æ—¶é—´åºåˆ—é•¿åº¦), feature_size]</p><p>è¿™æ · $x_t$ å°±æ˜¯ [feature_size]ï¼Œ åŒç† $h_t$ æ˜¯ [hidden_size]</p><p>æ‰€ä»¥éœ€è¦è®­ç»ƒçš„å‚æ•°ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">myLstm</span>(nn.Module):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_sz, hidden_sz</span>):</span><br><span class="line">    <span class="built_in">super</span>().__init__()</span><br><span class="line">    self.input_size = input_sz</span><br><span class="line">    self.hidden_size = hidden_sz</span><br><span class="line"></span><br><span class="line">    <span class="comment">#f_t</span></span><br><span class="line">    self.U_f = nn.Parameter(torch.Tensor(input_sz, hidden_sz))</span><br><span class="line">    self.V_f = nn.Parameter(torch.Tensor(hidden_sz, hidden_sz))</span><br><span class="line">    self.b_f = nn.Parameter(torch.Tensor(hidden_sz))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#i_t</span></span><br><span class="line">    self.U_i = nn.Parameter(torch.Tensor(input_sz,hidden_sz))</span><br><span class="line">    self.V_i = nn.Parameter(torch.Tensor(hidden_sz,hidden_sz))</span><br><span class="line">    self.b_i = nn.parameter(torch.Tensor(hidden_sz))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#c_t</span></span><br><span class="line">    self.U_c = nn.Parameter(torch.Tensor(input_sz, hidden_sz))</span><br><span class="line">    self.V_c = nn.Parameter(torch.Tensor(hidden_sz, hidden_sz))</span><br><span class="line">    self.b_c = nn.Parameter(torch.Tensor(hidden_sz))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#o_t</span></span><br><span class="line">    self.U_o = nn.Parameter(torch.Tensor(input_sz, hidden_sz))</span><br><span class="line">    self.V_o = nn.Parameter(torch.Tensor(hidden_sz, hidden_sz))</span><br><span class="line">    self.b_o = nn.Parameter(torch.Tensor(hidden_sz))</span><br></pre></td></tr></table></figure><p>å‰å‘ä¼ æ’­å®šä¹‰å¦‚ä¸‹ï¼š</p><p>åœ¨è®­ç»ƒæ—¶ï¼ŒæŸäº›æ ·æœ¬åœ¨æ—¶é—´ä¸Šå¯èƒ½æ˜¯è¿ç»­çš„ï¼Œè€Œæœ‰äº›æ˜¯ä¸ç›¸å¹²çš„ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦æƒé‡è¿›è¡Œé¢„æµ‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°init_statesæ¥å†³å®šæ˜¯å¦è¦ç»§æ‰¿ä¸Šæ¬¡çš„æœ€ç»ˆè¾“å‡º$h_t$å’Œ$c_t$ï¼Œè¿˜æ˜¯ç›´æ¥é‡æ–°åˆå§‹åŒ–ã€‚</p><p>éšåï¼Œéå†æ—¶é—´æ­¥ï¼Œåœ¨æ•´ä¸ªæ—¶é—´åºåˆ—éå†å®Œåå†æ›´æ–°æƒé‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, init_states=<span class="literal">None</span></span>):</span><br><span class="line">    batch_size,seq_sz,_=x.size()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> init_states <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">      h_t,c_t=(</span><br><span class="line">          torch.zeros(batch_size, self.hidden_size).to(x.device),</span><br><span class="line">          torch.zeros(batch_size, self.hidden_size).to(x.device)</span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      h_t, c_t = init_states</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(seq_sz):</span><br><span class="line">      x_t = x[:, t, :]</span><br><span class="line"></span><br><span class="line">      <span class="comment"># å’Œnn.parameterè®¡ç®—æ—¶ï¼Œè‡ªåŠ¨å¤„ç†xçš„batchè¿™ä¸€ç»´åº¦</span></span><br><span class="line">      i_t = torch.sigmoid(x_t @ self.U_i + h_t @ self.V_i + self.b_i)</span><br><span class="line">      f_t = torch.sigmoid(x_t @ self.U_f + h_t @ self.V_f + self.b_f)</span><br><span class="line">      g_t = torch.tanh(x_t @ self.U_c + h_t @ self.V_c + self.b_c)</span><br><span class="line">      o_t = torch.sigmoid(x_t @ self.U_o + h_t @ self.V_o + self.b_o)</span><br><span class="line">      c_t = f_t * c_t + i_t * g_t</span><br><span class="line">      h_t = o_t * torch.tanh(c_t)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h_t, c_t</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°æœ€åä¸€æ¬¡è¾“å‡ºçš„æƒé‡ã€‚æ¯”å¦‚è¯´è¦é¢„æµ‹æ¥ä¸‹æ¥16ä¸ªæ—¶é—´æ­¥çš„å†…å®¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™äº›æ•°æ®ï¼Œè¿›ä¸€æ­¥åœ¨æ¨¡å‹ä¸­forwardï¼Œå¾—åˆ°æ–°çš„è¾“å‡º $y_{pred}$ï¼Œå’ŒçœŸå®çš„ $y$ è®¡ç®—è¯¯å·®ã€‚</p><h1 id="è¿›ä¸€æ­¥ä¼˜åŒ–"><a href="#è¿›ä¸€æ­¥ä¼˜åŒ–" class="headerlink" title="è¿›ä¸€æ­¥ä¼˜åŒ–"></a>è¿›ä¸€æ­¥ä¼˜åŒ–</h1><p>æ³¨æ„åˆ°å››ä¸ªé—¨çš„è®¡ç®—éƒ½æ˜¯äº’ç›¸å¹¶è¡Œçš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€æ¬¡çŸ©é˜µè¿ç®—æ¥åŠ é€Ÿæ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomLSTM</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_sz, hidden_sz</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.input_sz = input_sz</span><br><span class="line">        self.hidden_size = hidden_sz</span><br><span class="line">        self.W = nn.Parameter(torch.Tensor(input_sz, hidden_sz * <span class="number">4</span>))</span><br><span class="line">        self.U = nn.Parameter(torch.Tensor(hidden_sz, hidden_sz * <span class="number">4</span>))</span><br><span class="line">        self.bias = nn.Parameter(torch.Tensor(hidden_sz * <span class="number">4</span>))</span><br><span class="line">        self.init_weights()</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># åˆå§‹åŒ–æ¨¡å‹æƒé‡</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">init_weights</span>(<span class="params">self</span>):</span><br><span class="line">        stdv = <span class="number">1.0</span> / math.sqrt(self.hidden_size)</span><br><span class="line">        <span class="keyword">for</span> weight <span class="keyword">in</span> self.parameters():</span><br><span class="line">            weight.data.uniform_(-stdv, stdv)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, </span></span><br><span class="line"><span class="params">                init_states=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Assumes x is of shape (batch, sequence, feature)&quot;&quot;&quot;</span></span><br><span class="line">        bs, seq_sz, _ = x.size()</span><br><span class="line">        hidden_seq = []</span><br><span class="line">        <span class="keyword">if</span> init_states <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            h_t, c_t = (torch.zeros(bs, self.hidden_size).to(x.device), </span><br><span class="line">                        torch.zeros(bs, self.hidden_size).to(x.device))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            h_t, c_t = init_states</span><br><span class="line"> </span><br><span class="line">        HS = self.hidden_size</span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(seq_sz):</span><br><span class="line">            x_t = x[:, t, :]</span><br><span class="line">            <span class="comment"># batch the computations into a single matrix multiplication</span></span><br><span class="line">            gates = x_t @ self.W + h_t @ self.U + self.bias</span><br><span class="line">            i_t, f_t, g_t, o_t = (</span><br><span class="line">                torch.sigmoid(gates[:, :HS]), <span class="comment"># input</span></span><br><span class="line">                torch.sigmoid(gates[:, HS:HS*<span class="number">2</span>]), <span class="comment"># forget</span></span><br><span class="line">                torch.tanh(gates[:, HS*<span class="number">2</span>:HS*<span class="number">3</span>]),</span><br><span class="line">                torch.sigmoid(gates[:, HS*<span class="number">3</span>:]), <span class="comment"># output</span></span><br><span class="line">            )</span><br><span class="line">            c_t = f_t * c_t + i_t * g_t</span><br><span class="line">            h_t = o_t * torch.tanh(c_t)</span><br><span class="line">            hidden_seq.append(h_t.unsqueeze(<span class="number">0</span>))</span><br><span class="line">        hidden_seq = torch.cat(hidden_seq, dim=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># reshape from shape (sequence, batch, feature) to (batch, sequence, feature)</span></span><br><span class="line">        hidden_seq = hidden_seq.transpose(<span class="number">0</span>, <span class="number">1</span>).contiguous()</span><br><span class="line">        <span class="keyword">return</span> hidden_seq, (h_t, c_t)</span><br></pre></td></tr></table></figure><p>æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šç®—å‡ºæ¯ä¸€æ­¥çš„ hidden_seq æœ‰ä»€ä¹ˆç”¨ï¼Œä¸ºä»€ä¹ˆåªå­˜ $h_t$ è€Œä¸å­˜ $C_t$ ï¼Ÿ</p><p>é—®äº† ChatGPTï¼Œå®ƒæ˜¯è¿™ä¹ˆå›ç­” hidden_seq çš„ä½œç”¨çš„ï¼š</p><ul><li><p>åºåˆ—åˆ†ç±»ï¼šå¦‚æœä½ çš„ä»»åŠ¡æ˜¯å¯¹æ•´ä¸ªåºåˆ—è¿›è¡Œåˆ†ç±»ï¼Œä½ å¯ä»¥ä½¿ç”¨ hidden_seq ä¸­çš„æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€ h_t æˆ–è€…å¯¹æ•´ä¸ªåºåˆ—çš„éšè—çŠ¶æ€è¿›è¡Œæ± åŒ–æ“ä½œï¼ˆä¾‹å¦‚å¹³å‡æ± åŒ–æˆ–æœ€å¤§æ± åŒ–ï¼‰ï¼Œç„¶åå°†å…¶ä¼ é€’ç»™åˆ†ç±»å™¨è¿›è¡Œåˆ†ç±»é¢„æµ‹ã€‚</p></li><li><p>åºåˆ—æ ‡æ³¨ï¼šåœ¨è‡ªç„¶è¯­è¨€å¤„ç†ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ hidden_seq æ¥ç”Ÿæˆæ¯ä¸ªæ—¶é—´æ­¥çš„æ ‡æ³¨ç»“æœï¼Œä¾‹å¦‚è¯æ€§æ ‡æ³¨æˆ–å‘½åå®ä½“è¯†åˆ«ã€‚</p></li><li><p>åºåˆ—ç”Ÿæˆï¼šå¦‚æœä½ çš„ä»»åŠ¡æ˜¯ç”Ÿæˆæ–°çš„åºåˆ—ï¼Œå¦‚æ–‡æœ¬ç”Ÿæˆï¼Œä½ å¯ä»¥ä½¿ç”¨ hidden_seq ä½œä¸ºç”Ÿæˆå™¨çš„è¾“å…¥ï¼Œä»¥ç”Ÿæˆæ¥ä¸‹æ¥çš„åºåˆ—å†…å®¹ã€‚</p></li><li><p>æ³¨æ„åŠ›æœºåˆ¶ï¼šhidden_seq å¯ç”¨äºè®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼Œä»¥ç¡®å®šåºåˆ—ä¸­ä¸åŒæ—¶é—´æ­¥çš„é‡è¦æ€§ï¼Œç„¶åå¯¹åºåˆ—çš„ä¸åŒéƒ¨åˆ†è¿›è¡ŒåŠ æƒæ±‡æ€»ã€‚</p></li><li><p>å¯è§†åŒ–å’Œåˆ†æï¼šhidden_seq å¯ä»¥ç”¨äºå¯è§†åŒ–å’Œåˆ†ææ¨¡å‹åœ¨è¾“å…¥åºåˆ—ä¸Šçš„å­¦ä¹ è¿‡ç¨‹ã€‚ä½ å¯ä»¥æŸ¥çœ‹éšè—çŠ¶æ€çš„å˜åŒ–ï¼Œäº†è§£æ¨¡å‹å¦‚ä½•å¤„ç†ä¸åŒæ—¶é—´æ­¥çš„ä¿¡æ¯ã€‚</p></li></ul><p>å—¯ï¼Œæš‚æ—¶è¿˜ä¸ç†è§£ã€‚</p><h1 id="PyTorch-API"><a href="#PyTorch-API" class="headerlink" title="PyTorch API"></a>PyTorch API</h1><p>ä¹Ÿå¯ä»¥ç›´æ¥è°ƒPyTorchçš„APIï¼Œä¼šæ–¹ä¾¿å¾ˆå¤š</p><p>æˆ‘ä»¬ç”¨ <a href="https://github.com/L1aoXingyu/code-of-learn-deep-learning-with-pytorch/blob/master/chapter5_RNN/time-series/lstm-time-series.ipynb">https://github.com/L1aoXingyu/code-of-learn-deep-learning-with-pytorch/blob/master/chapter5_RNN/time-series/lstm-time-series.ipynb</a> ä¸­çš„ä¾‹å­æ¥å®è·µä¸€ä¸‹</p><p>åå¹´é£æœºå®¢æµé‡æ•°æ®ï¼š<a href="https://github.com/L1aoXingyu/code-of-learn-deep-learning-with-pytorch/blob/master/chapter5_RNN/time-series/data.csv">https://github.com/L1aoXingyu/code-of-learn-deep-learning-with-pytorch/blob/master/chapter5_RNN/time-series/data.csv</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line">data_csv = pd.read_csv(<span class="string">&#x27;./data.csv&#x27;</span>, usecols=[<span class="number">1</span>])</span><br><span class="line">plt.plot(data_csv)</span><br></pre></td></tr></table></figure><p>æ•°æ®å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picst.sunbangyan.cn/2023/10/19/ad2d62c0b67d9370b1e9fb4571081b17.png" style="width:800px;"/></div></div><p>æˆ‘ä»¬çš„ä»»åŠ¡ç›®æ ‡æ˜¯é€šè¿‡å‰å‡ ä¸ªæœˆçš„å®¢æµé‡æ•°æ®å»é¢„æµ‹åå‡ ä¸ªæœˆçš„å®¢æµé‡æ•°æ®ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬è¦ç”¨å‰ä¸¤ä¸ªæœˆçš„æ•°æ®å»é¢„æµ‹åä¸€ä¸ªæœˆçš„æ•°æ®ã€‚</p><p>é¦–å…ˆè¿›è¡Œæ•°æ®å¤„ç†ï¼Œé™¤æ‰ç©ºæ•°æ®ï¼ˆè™½ç„¶è¿™ä¸ªæ•°æ®é›†é‡Œå¥½åƒæ²¡æœ‰ï¼‰ï¼Œç„¶åæ‰§è¡Œå½’ä¸€åŒ–ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ•°æ®é¢„å¤„ç†</span></span><br><span class="line">data_csv = data_csv.dropna()</span><br><span class="line">dataset = data_csv.values</span><br><span class="line">dataset = dataset.astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">max_value = np.<span class="built_in">max</span>(dataset)</span><br><span class="line">min_value = np.<span class="built_in">min</span>(dataset)</span><br><span class="line">scalar = max_value - min_value</span><br><span class="line">dataset = <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x / scalar, dataset))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_dataset</span>(<span class="params">dataset, look_back=<span class="number">2</span></span>):</span><br><span class="line">    dataX, dataY = [], []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dataset) - look_back):</span><br><span class="line">        a = dataset[i:(i + look_back)]</span><br><span class="line">        dataX.append(a)</span><br><span class="line">        dataY.append(dataset[i + look_back])</span><br><span class="line">    <span class="keyword">return</span> np.array(dataX), np.array(dataY)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¥½è¾“å…¥è¾“å‡º</span></span><br><span class="line">data_X, data_Y = create_dataset(dataset)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ’åˆ†è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œ70% ä½œä¸ºè®­ç»ƒé›†</span></span><br><span class="line">train_size = <span class="built_in">int</span>(<span class="built_in">len</span>(data_X) * <span class="number">0.7</span>)</span><br><span class="line">test_size = <span class="built_in">len</span>(data_X) - train_size</span><br><span class="line">train_X = data_X[:train_size]</span><br><span class="line">train_Y = data_Y[:train_size]</span><br><span class="line">test_X = data_X[train_size:]</span><br><span class="line">test_Y = data_Y[train_size:]</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹ç½‘ç»œçš„å®šä¹‰ï¼Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹ <code>nn.LSTM</code> çš„å‚æ•°ï¼š</p><ul><li>input_size â€“ è¾“å…¥çš„ç‰¹å¾ç»´åº¦</li><li>hidden_size â€“ éšçŠ¶æ€çš„ç‰¹å¾ç»´åº¦</li><li>num_layers â€“ å †å LSTMçš„å±‚æ•°</li><li>batch_first â€“ å¦‚æœä¸ºTrueï¼Œé‚£ä¹ˆè¾“å…¥å’Œè¾“å‡ºTensorçš„å½¢çŠ¶ä¸º(batch, seq, feature)ï¼Œé»˜è®¤ä¸ºfalseï¼Œæ˜¯(seq, batch, feature)</li><li>bidirectional â€“ æ˜¯å¦åŒå‘ä¼ æ’­ï¼Œé»˜è®¤ä¸ºFalse</li></ul><p>LSTMè¾“å‡º: output, (h_n, c_n)</p><p>output (seq_len, batch, hidden_size <em> num_directions):LSTMçš„è¾“å‡ºåºåˆ—ï¼Œå¯¹äºæ¯ä¸ªæ—¶é—´æ­¥ï¼Œå®ƒåŒ…å«äº†æ¯ä¸ªæ ·æœ¬çš„éšè—çŠ¶æ€ã€‚<br>h_n (num_layers </em> num_directions, batch, hidden_size):ä¿å­˜ç€LSTMæœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„éšçŠ¶æ€<br>c_n (num_layers * num_directions, batch, hidden_size):ä¿å­˜ç€LSTMæœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„ç»†èƒçŠ¶æ€</p><p>å…¶ä¸­ h_n åº”è¯¥å°±æ˜¯ output[-1] ï¼ˆæœ€åä¸€é¡¹ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¾‹</span></span><br><span class="line">lstm = nn.LSTM(<span class="number">10</span>, <span class="number">512</span>, <span class="number">2</span>, bidirectional=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦æŠŠè¾“å…¥çš„æ•°æ®å…ˆåšä¸€ä¸‹ç»´åº¦å˜æ¢ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line">train_X = train_X.reshape(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">train_Y = train_Y.reshape(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">test_X = test_X.reshape(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">train_x = torch.from_numpy(train_X)</span><br><span class="line">train_y = torch.from_numpy(train_Y)</span><br><span class="line">test_x = torch.from_numpy(test_X)</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å®šä¹‰æ¨¡å‹ï¼Œå¼€å§‹è®­ç»ƒã€‚</p><p>æ³¨æ„æœ€åä¸€å±‚çº¿æ€§å±‚ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå½“å‰çš„è¾“å‡ºhidden_sizeè½¬åŒ–æˆæˆ‘ä»¬éœ€è¦çš„output_sizeã€‚</p><p>çº¿æ€§å±‚ä¸€èˆ¬æ¥æ”¶ä¸€ä¸ªäºŒç»´è¾“å…¥ï¼Œå¿½ç•¥ç¬¬ä¸€ç»´çš„batch_sizeï¼Œè½¬æ¢hidden_sizeï¼Œä¸è¿‡å› ä¸ºå‰é¢ä¸€å±‚æ˜¯LSTMçš„è¾“å‡ºï¼Œæ‰€ä»¥æ˜¯ä¸‰ç»´çš„ï¼Œæˆ‘ä»¬ä¸å¦¨æŠŠbatch_sizeå’Œseq_lenå…ˆâ€œæ‹¼èµ·æ¥â€ï¼Œæ¯•ç«Ÿæˆ‘ä»¬çš„ç›®çš„åªæ˜¯æƒ³æŠŠéšè—å±‚è¾“å‡ºè½¬åŒ–ä¸ºç›®æ ‡è¾“å‡ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> torch <span class="keyword">import</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.autograd <span class="keyword">import</span> Variable</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ¨¡å‹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">lstm_reg</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_size, hidden_size, output_size=<span class="number">1</span>, num_layers=<span class="number">2</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        </span><br><span class="line">        self.lstm = nn.LSTM(input_size, hidden_size, num_layers) <span class="comment"># lstm</span></span><br><span class="line">        self.reg = nn.Linear(hidden_size, output_size) <span class="comment"># å›å½’</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x, _ = self.lstm(x) <span class="comment"># (seq, batch, hidden)</span></span><br><span class="line">        s, b, h = x.shape</span><br><span class="line">        x = x.view(s*b, h) <span class="comment"># è½¬æ¢æˆçº¿æ€§å±‚çš„è¾“å…¥æ ¼å¼</span></span><br><span class="line">        x = self.reg(x)</span><br><span class="line">        x = x.view(s, b, -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line">model = lstm_reg(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">criterion = nn.MSELoss()</span><br><span class="line">optimizer = torch.optim.Adam(model.parameters(), lr=<span class="number">1e-2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹è®­ç»ƒ</span></span><br><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    var_x = Variable(train_x)</span><br><span class="line">    var_y = Variable(train_y)</span><br><span class="line">    <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">    out = model(var_x)</span><br><span class="line">    loss = criterion(out, var_y)</span><br><span class="line">    <span class="comment"># åå‘ä¼ æ’­</span></span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    if (e + 1) % 100 == 0: # æ¯ 100 æ¬¡è¾“å‡ºç»“æœ</span></span><br><span class="line"><span class="string">        print(&#x27;Epoch: &#123;&#125;, Loss: &#123;:.5f&#125;&#x27;.format(e + 1, loss.data[0]))</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (step + <span class="number">1</span>) % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Step:&#x27;</span>, <span class="string">&#x27;%04d&#x27;</span> % (step + <span class="number">1</span>), <span class="string">&#x27;cost =&#x27;</span>, <span class="string">&#x27;&#123;:.6f&#125;&#x27;</span>.<span class="built_in">format</span>(loss))</span><br></pre></td></tr></table></figure><p>è®­ç»ƒå¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å»åšé¢„æµ‹äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">net = net.<span class="built_in">eval</span>() <span class="comment"># è½¬æ¢æˆæµ‹è¯•æ¨¡å¼</span></span><br><span class="line"></span><br><span class="line">data_X = data_X.reshape(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">data_X = torch.from_numpy(data_X)</span><br><span class="line">var_data = Variable(data_X)</span><br><span class="line">pred_test = net(var_data) <span class="comment"># æµ‹è¯•é›†çš„é¢„æµ‹ç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¹å˜è¾“å‡ºçš„æ ¼å¼</span></span><br><span class="line">pred_test = pred_test.view(-<span class="number">1</span>).data.numpy()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”»å‡ºå®é™…ç»“æœå’Œé¢„æµ‹çš„ç»“æœ</span></span><br><span class="line">plt.plot(pred_test, <span class="string">&#x27;r&#x27;</span>, label=<span class="string">&#x27;prediction&#x27;</span>)</span><br><span class="line">plt.plot(dataset, <span class="string">&#x27;b&#x27;</span>, label=<span class="string">&#x27;real&#x27;</span>)</span><br><span class="line">plt.legend(loc=<span class="string">&#x27;best&#x27;</span>)</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://picst.sunbangyan.cn/2023/10/19/04bdfe4d9588f5405fd426ac51d32979.png" style="width:800px;"/></div></div><p class='p left logo large'>å‚è€ƒé“¾æ¥</p><p><a href="https://colah.github.io/posts/2015-08-Understanding-LSTMs/">https://colah.github.io/posts/2015-08-Understanding-LSTMs/</a></p><p><a href="https://zhuanlan.zhihu.com/p/451985132">https://zhuanlan.zhihu.com/p/451985132</a></p><p><a href="https://github.com/L1aoXingyu/code-of-learn-deep-learning-with-pytorch/blob/master/chapter5_RNN/time-series/lstm-time-series.ipynb">https://github.com/L1aoXingyu/code-of-learn-deep-learning-with-pytorch/blob/master/chapter5_RNN/time-series/lstm-time-series.ipynb</a></p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Neural Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Neural Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyTorchå­¦ä¹ ç¬”è®°ï¼ˆäºŒï¼‰ CNN</title>
      <link href="/posts/10011.html"/>
      <url>/posts/10011.html</url>
      
        <content type="html"><![CDATA[<p>è¿™æ¬¡æ¥ç”¨PyTorchå®ç°ä¸€ä¸‹CNNå·ç§¯ç¥ç»ç½‘ç»œ, æ•°æ®æˆ‘ä»¬é‡‡ç”¨ MNIST è¿™ä¸ªæ‰‹å†™æ•°å­—è¯†åˆ«çš„æ•°æ®åº“, å®Œæˆä¸€ä¸ªå¤šåˆ†ç±»ä»»åŠ¡ï¼ˆåˆ¤æ–­æ˜¯å“ªä¸ªæ•°å­—ï¼‰</p><p>ä¸æ¸…æ¥šPyTorchåŸºæœ¬ç”¨æ³•è¯·ç§»æ­¥ <a href="https://anti-entrophic.github.io/posts/10010.html">https://anti-entrophic.github.io/posts/10010.html</a></p><p class='p left logo large'>æ¦‚è¿°</p><p>æœ€ç®€å•çš„CNNçš„ç»“æ„æ˜¯ â€œ-&gt;å·ç§¯å±‚-&gt;æ¿€æ´»å‡½æ•°-&gt;æ± åŒ–å±‚-&gt;çº¿æ€§å±‚â€ï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œåé¢ä¼šé…åˆä»£ç è¯¦ç»†æè¿°ã€‚</p><p>å·ç§¯å±‚ç›®æ ‡å°±æ˜¯è®­ç»ƒè‹¥å¹²ä¸ªå·ç§¯æ ¸ï¼ŒæœŸæœ›è¿™äº›å·ç§¯æ ¸èƒ½å¤Ÿå­¦åˆ°å›¾åƒçš„æŸäº›ç‰¹å¾ã€‚å›¾åƒçš„å„ä¸ªé€šé“ä¼šé€šè¿‡å„ä¸ªå·ç§¯æ ¸ï¼Œå¾—åˆ°å·ç§¯æ“ä½œåçš„ç»“æœï¼Œç„¶åç»è¿‡ReLUæ¿€æ´»å‡½æ•°ã€‚</p><p>æ± åŒ–å±‚å°±å¦‚ä¸‹å›¾ï¼Œç›®çš„æ˜¯ä¸ºäº†ç»™å›¾åƒé™ç»´ï¼Œå‡å°‘å‚æ•°ï¼Œå¹¶ä¸”æœŸæœ›èƒ½å¤Ÿæ•æ‰ä¸€äº›å…³é”®ç‰¹å¾ï¼Œå¿½ç•¥ä¸é‡è¦çš„ç»†èŠ‚</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://pic1.zhimg.com/80/v2-6091b01b4e85b1c23f3b7cf9f1496c90_1440w.webp" style="width:400px;"/></div></div><p>æœ€åå‹ç¼©ç»´åº¦åç»è¿‡ä¸€ä¸ªçº¿æ€§å±‚ï¼Œå¾—åˆ°æœ€ç»ˆç»“æœçš„æ¦‚ç‡åˆ†å¸ƒï¼Œç„¶ååˆ©ç”¨äº¤å‰ç†µæŸå¤±å‡½æ•°æ¥è¿›è¡Œä¼˜åŒ–ã€‚</p><p>æ›´è¯¦ç»†çš„ï¼š<a href="https://zhuanlan.zhihu.com/p/630695553">https://zhuanlan.zhihu.com/p/630695553</a></p><p class='p left logo large'>æ•°æ®</p><p>æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡ <code>torchvision</code> è¿™ä¸ªåŒ…ä¸‹è½½åˆ° MNIST è¿™ä¸ªæ•°æ®åº“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.utils.data <span class="keyword">as</span> Data</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">import</span> torchvision</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ•°æ®é›†</span></span><br><span class="line">train_data = torchvision.datasets.MNIST(</span><br><span class="line">    root = <span class="string">&#x27;./MNIST/&#x27;</span>,</span><br><span class="line">    train = <span class="literal">True</span>,</span><br><span class="line">    transform = torchvision.transforms.ToTensor(),</span><br><span class="line">    download = <span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">test_data = torchvision.datasets.MNIST(root=<span class="string">&#x27;./MNIST/&#x27;</span>, train=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¸‹è½½ä¸‹æ¥ä¸€ä¸ªæ˜¯è®­ç»ƒé›†ï¼Œä¸€ä¸ªæ˜¯éªŒè¯é›†ã€‚å¹¶ä¸”ä¸‹è½½ä¸‹æ¥å°±æ˜¯ <code>torch.utils.data.Dataset</code> ç±»ï¼Œå¯ä»¥å¾ˆå¥½åœ°é€‚é… PyTorch ä¸­å¸¸ç”¨çš„ Dataloader</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train_loader = Data.DataLoader(</span><br><span class="line">    dataset = train_data,</span><br><span class="line">    batch_size = <span class="number">50</span>,</span><br><span class="line">    shuffle = <span class="literal">True</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>Dataloader</code> å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®Œæˆå°†æ•°æ®ç»„æˆbatchï¼Œéšæœºå–æ ·ç­‰æ“ä½œã€‚</p><p>å¯ä»¥ç®€å•çœ‹ä¸€ä¸‹ MNIST è¿™ä¸ªæ•°æ®é›†ï¼Œæ¯å¼ å›¾ç‰‡çš„å¤§å°éƒ½æ˜¯ 28*28ï¼Œè®­ç»ƒæ ·æœ¬æœ‰60000ä¸ªï¼Œæµ‹è¯•æ ·æœ¬æœ‰10000ä¸ª</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(train_data.data.shape)</span><br><span class="line"><span class="built_in">print</span>(test_data.data.shape)</span><br><span class="line"><span class="comment"># -----output-----</span></span><br><span class="line"><span class="comment"># torch.Size([60000, 28, 28])</span></span><br><span class="line"><span class="comment"># torch.Size([10000, 28, 28])</span></span><br></pre></td></tr></table></figure><p class='p left logo large'>ç½‘ç»œç»“æ„</p><p>å·ç§¯å±‚çš„è¾“å…¥æ˜¯ä¸‰ç»´çš„ï¼Œç¬¬ä¸€ç»´æ˜¯å›¾åƒçš„é€šé“æ•°ã€‚</p><p>è¿™ä¸ª <code>nn.Conv2d</code> ï¼Œ<code>in_channels</code>å°±æ˜¯è¾“å…¥å›¾åƒçš„é€šé“æ•°ï¼Œç°åº¦å›¾åƒå°±æ˜¯1ï¼ŒRGBå›¾åƒå°±æ˜¯3ã€‚<code>output_channels</code>å°±æ˜¯å·ç§¯æ ¸æ•°ï¼Œä¹Ÿæ˜¯è¾“å‡ºå›¾åƒçš„é€šé“æ•°ã€‚</p><p>å¦‚æœ<code>in_channels</code>æ˜¯3çš„è¯ï¼Œé‚£å¯¹æ¯ä¸ªå·ç§¯æ ¸ï¼Œéƒ½æ˜¯å¯¹3ä¸ªé€šé“å„è‡ªå·ç§¯ï¼Œç„¶ååŠ èµ·æ¥ï¼Œä¼šå¾—åˆ°16ä¸ªå·ç§¯åçš„é€šé“ï¼Œæœ€ååˆåœ¨ä¸€èµ·ã€‚</p><p><code>kernel_size</code> å°±æ˜¯å·ç§¯æ ¸çš„å¤§å°ï¼Œ<code>stride</code> æ˜¯å·ç§¯æ ¸ç§»åŠ¨çš„æ­¥é•¿ï¼Œ<code>padding</code> æ˜¯å‘¨å›´è¡¥0ï¼Œæ§åˆ¶å·ç§¯åå›¾åƒçš„å¤§å°ã€‚</p><p><code>ReLU()</code> å°±æ¿€æ´»ä¸€ä¸‹ï¼Œä¸è¿‡æˆ‘æœ‰ç‚¹ç–‘æƒ‘çš„æ˜¯ï¼Œå·ç§¯æ“ä½œå®Œä¹‹åï¼Œä¼šä¸ä¼šæŸäº›ç‚¹çš„intensityè¶…è¿‡255ï¼Ÿå› ä¸ºè¿™åœ¨å›¾åƒä¸­åº”è¯¥æ˜¯ä¸å¯èƒ½çš„æƒ…å†µï¼Œä½†æ˜¯å¥½åƒç›´æ¥å°±æ²¡æœ‰å¤„ç†ï¼›å°äº0çš„è¯ç»è¿‡ReLU()å¯ä»¥è°ƒå›æ¥ã€‚</p><p><code>nn.MaxPool2d</code> å°±æ˜¯ä¸€ä¸ªæ± åŒ–å±‚ï¼Œå¦‚æ–‡ç« å¼€å¤´å›¾ç‰‡æ‰€ç¤ºï¼Œå–2x2æ ¼ä¸­çš„æœ€å¤§å€¼ã€‚</p><p>æœ€ç»ˆç¬¬ä¸€å±‚çš„ç»´åº¦å˜åŒ–ä¸º (batch_size, 1, 28, 28) -&gt; (batch_size, 16, 14, 14)</p><p>ç¬¬äºŒå±‚çš„ç»´åº¦å˜åŒ–ä¸º (batch_size, 16, 14, 14) -&gt; (batch_size, 32, 7, 7)</p><p>çº¿æ€§å±‚çš„ç»´åº¦å˜åŒ–ä¸º -&gt; (batch, 32<em>7</em>7) -&gt; (batch, 10)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(CNN, self).__init__() <span class="comment"># åœ¨Python3ä¸­ï¼Œä¸å†éœ€è¦æ˜¾å¼åœ°ä¼ é€’å‚æ•°ï¼Œä¼šè‡ªåŠ¨åœ°è¯†åˆ«å½“å‰ç±»åŠå…¶ç»§æ‰¿çš„çˆ¶ç±»ï¼Œæ‰€ä»¥å†™super().__init__()æ›´å¥½</span></span><br><span class="line"></span><br><span class="line">        self.convl = nn.Sequential(</span><br><span class="line">            nn.Conv2d(</span><br><span class="line">                in_channels=<span class="number">1</span>,</span><br><span class="line">                out_channels=<span class="number">16</span>,</span><br><span class="line">                kernel_size=<span class="number">5</span>,</span><br><span class="line">                stride=<span class="number">1</span>,</span><br><span class="line">                padding=<span class="number">2</span></span><br><span class="line">            ),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(</span><br><span class="line">                kernel_size=<span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.conv2 = nn.Sequential(</span><br><span class="line">            nn.Conv2d(</span><br><span class="line">                in_channels=<span class="number">16</span>,</span><br><span class="line">                out_channels=<span class="number">32</span>,</span><br><span class="line">                kernel_size=<span class="number">5</span>,</span><br><span class="line">                stride=<span class="number">1</span>,</span><br><span class="line">                padding=<span class="number">2</span></span><br><span class="line">            ),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.MaxPool2d(</span><br><span class="line">                kernel_size=<span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.out = nn.Linear(<span class="number">32</span>*<span class="number">7</span>*<span class="number">7</span>, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        x = self.convl(x) <span class="comment"># (batch_size, 1, 28, 28) -&gt; (batch_size, 16, 14, 14)</span></span><br><span class="line">        x = self.conv2(x) <span class="comment"># (batch_size, 16, 14, 14) -&gt; (batch_size, 32, 7, 7)</span></span><br><span class="line">        x = x.view(x.shape[<span class="number">0</span>], -<span class="number">1</span>) <span class="comment"># (batch, 32*7*7)</span></span><br><span class="line">        x = self.out(x) <span class="comment"># (batch, 10)</span></span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure><p class='p left logo large'>ç½‘ç»œè®­ç»ƒ</p><p>å¯¹äºåˆ†ç±»çš„æ¦‚ç‡åˆ†å¸ƒï¼ŒæŸå¤±å‡½æ•°ç”¨äº¤å‰ç†µæŸå¤±ï¼ŒåŸå› æˆ‘åœ¨å…¶å®ƒæ–‡ç« ä¸­ä¹Ÿæåˆ°è¿‡ï¼Œè¯¦ç»†é“¾æ¥ï¼š<a href="https://zhuanlan.zhihu.com/p/115277553">https://zhuanlan.zhihu.com/p/115277553</a></p><p>ä¼˜åŒ–å™¨æ²¡æœ‰ç”¨SGDè€Œæ˜¯Adamï¼Œä¸çŸ¥é“å…·ä½“ä¼šæœ‰ä»€ä¹ˆå·®å¼‚</p><p>åªè®­ç»ƒä¸€ä¸ªepoch</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">model = CNN()</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.Adam(model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> step,(batch_x,batch_y) <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_loader):</span><br><span class="line">        pred_y = model(batch_x)</span><br><span class="line">        loss = criterion(pred_y, batch_y)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (step + <span class="number">1</span>) % <span class="number">200</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Step:&#x27;</span>, <span class="string">&#x27;%04d&#x27;</span> % (step + <span class="number">1</span>), <span class="string">&#x27;cost =&#x27;</span>, <span class="string">&#x27;&#123;:.6f&#125;&#x27;</span>.<span class="built_in">format</span>(loss))</span><br><span class="line">        </span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br></pre></td></tr></table></figure><p class='p left logo large'>ç»“æœ</p><p>çœ‹ä¸€ä¸‹ç»“æœï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™æ­¥unsqueezeè®©test_dataä»(10000,28,28)-&gt;(10000,1,28,28)ï¼Œé€‚é…CNNçš„è¾“å…¥</span></span><br><span class="line">test_x = torch.unsqueeze(test_data.data,dim=<span class="number">1</span>).<span class="built_in">float</span>()[:<span class="number">2000</span>] </span><br><span class="line"><span class="comment"># å–å‡ºå‰2000ä¸ªéªŒè¯æ ·æœ¬çš„æ ‡ç­¾</span></span><br><span class="line">test_y = test_data.targets[:<span class="number">2000</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®€å•è¯•ä¸€ä¸‹å‰20ä¸ªçš„è¾“å‡ºç»“æœ</span></span><br><span class="line">test_output = model(test_x[:<span class="number">20</span>])</span><br><span class="line"><span class="comment"># è¿™é‡Œï¼Œtest_outputçš„ç»´åº¦æ˜¯(20,10)ï¼Œtorch.maxä¼šè¿”å›ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯valueï¼Œä¸€ä¸ªæ˜¯indexï¼Œindexå°±ä»£è¡¨ç€åˆ†ç±»ä¸ºå“ªä¸ªæ•°å­—</span></span><br><span class="line"><span class="comment"># torch.max(_, 1) è¡¨ç¤ºæ²¿ç€test_outputçš„ç¬¬1ç»´ä¹Ÿå°±æ˜¯10è¿™ä¸€ç»´å»æ‰¾æœ€å¤§å€¼ï¼Œæ‰¾çš„å°±æ˜¯æ¯ä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒä¸­çš„æœ€å¤§å€¼</span></span><br><span class="line">pred_y = torch.<span class="built_in">max</span>(test_output, <span class="number">1</span>)[<span class="number">1</span>].numpy()</span><br><span class="line"><span class="built_in">print</span>(pred_y, <span class="string">&#x27;prediction number&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(test_y[:<span class="number">20</span>].numpy(),<span class="string">&#x27;real number&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># -----output-----</span></span><br><span class="line"><span class="comment"># [7 2 1 0 4 1 4 9 5 9 0 6 9 0 1 5 9 7 3 4] prediction number</span></span><br><span class="line"><span class="comment"># [7 2 1 0 4 1 4 9 5 9 0 6 9 0 1 5 9 7 3 4] real number</span></span><br></pre></td></tr></table></figure><p class='p left logo large'>æ€»ç»“</p><p>åªæ˜¯æœ€ç®€å•çš„CNNå§ï¼Œä¸è¿‡ç»“æœç¡®å®æŒºå¥½ï¼Œç½‘ç»œå°±çœŸçš„å­¦åˆ°ç‰¹å¾äº†ã€‚ä¹Ÿæ²¡å»è¯•è¿‡æ¢ä¸€ä¸‹ä¼˜åŒ–å™¨å•Šæ¿€æ´»å‡½æ•°ä¼šæœ‰ä»€ä¹ˆæ•ˆæœï¼Œåªæ˜¯å­¦ä¸€ä¸‹åŸºç¡€çŸ¥è¯†é¡ºä¾¿å­¦ä¹ PyTorchç”¨æ³•å§</p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Neural Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Neural Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PyTorchå­¦ä¹ ç¬”è®°ï¼ˆä¸€ï¼‰ åŸºç¡€</title>
      <link href="/posts/10010.html"/>
      <url>/posts/10010.html</url>
      
        <content type="html"><![CDATA[<p>å…ˆå°è¯•å†™ä¸€ä¸ªç®€å•çš„çº¿æ€§è®¡ç®—ï¼Œç”¨ç¥ç»ç½‘ç»œæ‹Ÿåˆå­¦ä¹ ã€‚</p><p class='p left logo large'>æ•°æ®ç”Ÿæˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆæ•°æ®</span></span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="comment"># ç»™å®šæƒé‡çŸ©é˜µ</span></span><br><span class="line">W = torch.tensor([[<span class="number">0.3</span>, <span class="number">0.4</span>],[<span class="number">0.5</span>,<span class="number">0.6</span>],[<span class="number">0.6</span>,<span class="number">0.2</span>]])</span><br><span class="line"></span><br><span class="line">num_samples = <span class="number">100</span></span><br><span class="line">input_dim = <span class="number">3</span></span><br><span class="line">x = torch.rand((num_samples, input_dim))</span><br><span class="line"></span><br><span class="line">y = torch.matmul(W.t(), x.t()).t()</span><br></pre></td></tr></table></figure><p>ä¸€ä¼šå„¿æˆ‘ä»¬ç”¨è¿™äº›æ•°æ®å–æ‹Ÿåˆæƒé‡çŸ©é˜µ $W$</p><p class='p left logo large'>å®šä¹‰ç½‘ç»œ</p><p>pytorchä¸­çš„è‡ªå®šä¹‰ç¥ç»ç½‘ç»œç±»éœ€è¦ç»§æ‰¿ <code>nn.Module</code> ï¼Œå¹¶ä¸”è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•° <code>__init__()</code> æ¥å®Œæˆä¸€äº›å‚æ•°å’Œæ–¹æ³•çš„åˆå§‹åŒ–ã€‚</p><p>æœ€ç®€å•çš„ç½‘ç»œæˆ‘ä»¬åªéœ€å®šä¹‰ç½‘ç»œä¸­çš„å±‚ç»“æ„ï¼Œå¦‚è¿™é‡Œæˆ‘åŠ äº†ä¸€å±‚çº¿æ€§å±‚ã€‚ä»¥åŠå‰å‘ä¼ æ’­çš„ <code>forward</code> å‡½æ•°å³å¯ã€‚</p><p>å¦‚æœéœ€è¦è‡ªå®šä¹‰æŸå¤±å‡½æ•°ç­‰ï¼Œä¼šåœ¨ä¹‹åçš„æ–‡ç« ä¸­ä»‹ç»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simple_nn</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Simple_nn, self).__init__()</span><br><span class="line">        self.W = nn.Linear(input_dim, output_dim, bias=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, X</span>):</span><br><span class="line">        <span class="comment"># X : [batch_size, input_dim]</span></span><br><span class="line">        <span class="comment"># åœ¨forwardä¸­çš„Xè¿˜æ˜¯å¸¦æœ‰batch_sizeè¿™ä¸€ç»´åº¦çš„ï¼Œä¸è¿‡åœ¨ç»è¿‡é“¾æ¥å±‚çš„æ—¶å€™ï¼Œpytorchä¼šè‡ªåŠ¨å¤„ç†æ‰¹æ¬¡ï¼Œä¸ç”¨æ˜¾å¼è€ƒè™‘ã€‚</span></span><br><span class="line">        output = self.W(X)</span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure><p class='p left logo large'>è¿›è¡Œè®­ç»ƒ</p><p>è®­ç»ƒéœ€è¦æ•°æ®ï¼Œæˆ‘ä»¬æŠŠæ•°æ®ä»¥batchçš„å½¢å¼é€è¿›ç½‘ç»œè¿›è¡Œè®­ç»ƒã€‚ç›®å‰æˆ‘ä»¬ä¸æ¶‰åŠdatasetï¼Œdataloaderçš„ä½¿ç”¨ã€‚</p><p>å…ˆå†™ä¸€ä¸ªéšæœºå–batchçš„å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">batch_size = <span class="number">4</span> <span class="comment"># mini-batch size</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_batch</span>():</span><br><span class="line">    random_x = torch.zeros((batch_size, input_dim))</span><br><span class="line">    random_y = torch.zeros((batch_size, output_dim))</span><br><span class="line">    <span class="comment"># å®šä¹‰ä¸€ä¸ªéšæœºæŠ½å–batch</span></span><br><span class="line">    random_index = np.random.choice(<span class="built_in">range</span>(<span class="built_in">len</span>(x)), batch_size, replace=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, index <span class="keyword">in</span> <span class="built_in">enumerate</span>(random_index):</span><br><span class="line">        random_x[i] = x[index]</span><br><span class="line">        random_y[i] = y[index]</span><br><span class="line">                </span><br><span class="line">    <span class="keyword">return</span> random_x, random_y</span><br></pre></td></tr></table></figure><p>ç„¶åå†™ä¸€ä¸ªè®­ç»ƒå‡½æ•°</p><p>pytorchå°è£…äº†å¾ˆå¤šæ“ä½œï¼Œæ¯”å¦‚è¯´åå‘ä¼ æ’­ <code>backward</code> æ˜¯ä¸éœ€è¦è‡ªå·±å†™çš„ï¼Œåªéœ€è¦è°ƒç”¨ <code>loss.backward()</code> å³å¯</p><p>éšåï¼Œè°ƒç”¨ <code>torch.optim</code> ä¸­è¢«ç§°ä¸ºä¼˜åŒ–å™¨çš„å·¥å…·å°±å¯ä»¥æ›´æ–°å‚æ•°</p><p>åƒè¿™é‡Œçš„ <code>optim.SGD</code> å°±æ˜¯éšæœºæ¢¯åº¦ä¸‹é™çš„å‚æ•°æ›´æ–°æ–¹æ³•ã€‚</p><p>æ³¨æ„ï¼Œæ¨¡å‹ç›´åˆ° <code>optimizer.step()</code> è¿™æ­¥æ‰æ­£å¼æ›´æ–°æ¨¡å‹å‚æ•°ã€‚è¿™ä¸¤æ­¥çš„åˆ†ç¦»æ˜¯ä¸ºäº†æä¾›æ›´å¤§çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å¤šæ¬¡è°ƒç”¨ <code>loss.backward()</code>ç´¯ç§¯æ¢¯åº¦ï¼Œç„¶ååœ¨ç‰¹å®šæ—¶åˆ»æ‰§è¡Œä¸€æ¬¡ <code>optimizer.step()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ¨¡å‹å®ä¾‹</span></span><br><span class="line">model = Simple_nn()</span><br><span class="line"><span class="comment"># å®šä¹‰æŸå¤±å‡½æ•° </span></span><br><span class="line">criterion = nn.MSELoss()</span><br><span class="line"><span class="comment"># å®šä¹‰ä¼˜åŒ–å™¨</span></span><br><span class="line">optimizer = optim.SGD(model.parameters(), lr=<span class="number">0.01</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Training</span></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5000</span>):</span><br><span class="line">    input_batch, output_batch = random_batch()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ¸…é™¤æ¢¯åº¦ç¼“å­˜</span></span><br><span class="line">    optimizer.zero_grad()</span><br><span class="line">    <span class="comment"># å‰å‘ä¼ æ’­</span></span><br><span class="line">    output_pred = model(input_batch)</span><br><span class="line">    <span class="comment"># è®¡ç®—æŸå¤±å‡½æ•°</span></span><br><span class="line">    loss = criterion(output_pred, output_batch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epoch + <span class="number">1</span>) % <span class="number">1000</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Epoch:&#x27;</span>, <span class="string">&#x27;%04d&#x27;</span> % (epoch + <span class="number">1</span>), <span class="string">&#x27;cost =&#x27;</span>, <span class="string">&#x27;&#123;:.6f&#125;&#x27;</span>.<span class="built_in">format</span>(loss))</span><br><span class="line"></span><br><span class="line">    loss.backward()</span><br><span class="line">    optimizer.step()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(model.W.weight.t())</span><br></pre></td></tr></table></figure><p>æœ€åå¾—åˆ°è¾“å‡ºï¼Œå’Œæˆ‘ä»¬ä¸€å¼€å§‹å®šä¹‰çš„ $W$ æ˜¯å¾ˆæ¥è¿‘çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tensor([[0.2985, 0.4066],</span><br><span class="line">        [0.5058, 0.5921],</span><br><span class="line">        [0.5955, 0.2015]], grad_fn=&lt;TBackward0&gt;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Neural Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Neural Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nunjucks Error expected variable endè§£å†³åŠæ³•</title>
      <link href="/posts/10009.html"/>
      <url>/posts/10009.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨æ–‡ç« ä¸­å†™latexä»£ç çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé‡åˆ°æŠ¥é”™ï¼šNunjucks Error expected variable end</p><p>æ¯”å¦‚ä¸‹é¢è¿™æ®µ</p><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br><span class="line"><span class="keyword">\begin</span>&#123;equation&#125;</span><br><span class="line">    <span class="keyword">\begin</span>&#123;array&#125;&#123;ll&#125;</span><br><span class="line">        p(w<span class="built_in">_</span>j|w<span class="built_in">_</span>i) <span class="built_in">&amp;</span>= y<span class="built_in">_</span>j <span class="keyword">\\</span></span><br><span class="line">                   <span class="built_in">&amp;</span>= <span class="keyword">\frac</span>&#123;e<span class="built_in">^</span>&#123;u<span class="built_in">_</span>j&#125;&#125;&#123;<span class="keyword">\sum</span><span class="built_in">_</span>&#123;k <span class="keyword">\in</span> V&#125; e<span class="built_in">^</span>&#123;u<span class="built_in">_</span>k&#125;&#125;   <span class="keyword">\\</span></span><br><span class="line">                   <span class="built_in">&amp;</span>= <span class="keyword">\frac</span>&#123; e<span class="built_in">^</span>&#123;&#123;W&#x27;<span class="built_in">_</span>j&#125;<span class="built_in">^</span>T <span class="keyword">\cdot</span> W<span class="built_in">_</span>I&#125; &#125; &#123;<span class="keyword">\sum</span><span class="built_in">_</span>&#123;k <span class="keyword">\in</span> V&#125; e<span class="built_in">^</span>&#123; &#123;W&#x27;<span class="built_in">_</span>k&#125;<span class="built_in">^</span>T <span class="keyword">\cdot</span> W<span class="built_in">_</span>I&#125; &#125; <span class="keyword">\\</span></span><br><span class="line">    <span class="keyword">\end</span>&#123;array&#125; <span class="keyword">\notag</span></span><br><span class="line"><span class="keyword">\end</span>&#123;equation&#125;</span><br><span class="line"><span class="built_in">$</span><span class="built_in">$</span></span><br></pre></td></tr></table></figure><p>æŸ¥é˜…èµ„æ–™åæ˜¯å› ä¸ºï¼ŒHexoä½¿ç”¨Nunjucksæ¸²æŸ“å¸–å­ï¼Œç”¨ <code>&#123; &#123; &#125; &#125;</code> æˆ– <code>&#123;% %&#125;</code> åŒ…è£…çš„å†…å®¹å°†è¢«è§£æï¼Œå¹¶å¯èƒ½å¯¼è‡´é—®é¢˜ã€‚</p><p>å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æ ‡ç­¾åŒ…è£¹æ•æ„Ÿå­—æ®µï¼Œé¿å…è¢«Nunjucksé”™è¯¯è§£æã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endraw%&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo &amp; Butterfly tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo &amp; Butterfly tutorial </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Word2Vec</title>
      <link href="/posts/10008.html"/>
      <url>/posts/10008.html</url>
      
        <content type="html"><![CDATA[<div class="note success simple"><p>æœ€å¥½çš„å­¦ä¹ æ–¹æ³•å°±æ˜¯æŠŠçŸ¥è¯†è®²ç»™åˆ«äººå¬</p></div><p>å¼€ä¸ªæ–°å‘ï¼ŒåŠªåŠ›ï¼å°é¢å›¾ä¹Ÿæ¢ä¸Šå¯¹æˆ‘æ„ä¹‰éå‡¡çš„ Chtholly</p><p class='p left logo large'>åŸºæœ¬æ¦‚å¿µ</p><p>åŸºæœ¬æ¦‚å¿µæ‡’å¾—å†™äº†ã€‚</p><p>Word2Vecæ˜¯Googleçš„Mikolovåœ¨2013å¹´æå‡ºçš„ä¸€ç§è¯å‘é‡çš„è¡¨å¾å½¢å¼ã€‚ä¸åŒäºç¨€ç–çš„one-hotç¼–ç ï¼Œå¯¹æ ·æœ¬ç©ºé—´çš„åˆ©ç”¨ç‡åªæœ‰åæ ‡è½´ä¸Šå¯æ€œçš„å‡ ä¸ªç‚¹; word embedding å°±å¯ä»¥ä»¥æ›´å°‘çš„ç»´åº¦è¡¨ç¤ºè¯è¯­ï¼Œæ›´é«˜æ•ˆåœ°åˆ©ç”¨æ ·æœ¬ç©ºé—´ï¼Œå¹¶å¯ä½¿å•è¯çš„å‘é‡è¡¨å¾å…·æœ‰ä¸€å®šå‡ ä½•æ„ä¹‰ã€‚</p><p class='p left logo large'>ç½‘ç»œç»“æ„</p><p>Word2Vecä¸€å…±ç»™å‡ºäº†ä¸¤ç§ç½‘ç»œç»“æ„ï¼ŒCBOWå’ŒSkip-gram</p><h1 id="CBOW"><a href="#CBOW" class="headerlink" title="CBOW"></a>CBOW</h1><p>CBOWçš„ä»»åŠ¡ç®€å•æ¥è¯´å°±æ˜¯ï¼Œç»™å®šæŸä¸ªå•è¯ $w_t$ çš„ä¸Šä¸‹æ–‡ $w_{t-2}, w_{t-1}, w_{t+1}, w_{t+2}$ï¼Œå»ä¼°è®¡ä¸­é—´è¿™ä¸ªå•è¯åº”è¯¥æ˜¯ä»€ä¹ˆï¼Œä¹Ÿå°±æ˜¯è¦è®¡ç®— $p(w_t | w_{t-2}, w_{t-2}, w_{t-2}, w_{t-2})$ï¼Œè¯å‘é‡æ˜¯è¿™ä¸€ä»»åŠ¡çš„ä¸€é¡¹äº§ç‰©ã€‚</p><h2 id="æ­£å‘ä¼ æ’­"><a href="#æ­£å‘ä¼ æ’­" class="headerlink" title="æ­£å‘ä¼ æ’­"></a>æ­£å‘ä¼ æ’­</h2><p>æˆ‘ä»¬å…ˆè€ƒè™‘è¾ƒä¸ºç®€å•çš„ä¸€ä¸ªå•è¯çš„æƒ…å†µï¼Œå³è®¡ç®— $p(w_t|w_{I})$</p><p>CBOWæ¨¡å‹çš„è¾“å…¥æ˜¯ä¸€ä¸ªone-hotå‘é‡ï¼Œè€ƒè™‘å½“å‰æœ‰ä¸€ä¸ªé•¿åº¦ä¸º|V|çš„è¯è¡¨ï¼Œä¸å¦¨è®¾ $w_{oI}$ æ˜¯è¯è¡¨ä¸­çš„ç¬¬ $I$ ä¸ªè¯çš„one-hotè¡¨ç¤ºï¼ˆå’Œ $w_{t+1}$ è¿™ç§åŸæ¥å¥å­ä¸­çš„ç©ºé—´ä½ç½®å…³ç³»ä½œåŒºåˆ«ï¼‰ï¼Œä¹Ÿå³åªæœ‰ç¬¬ $I$ ä¸ªå…ƒç´ æ˜¯1</p><div class="img-wrap"><div class="img-bg"><img class="img" src="https://pic2.zhimg.com/80/v2-ca4c641f4f3c9a44e43260c04c0161d1_1440w.webp" alt="CBOWæ¨¡å‹ç¤ºä¾‹ï¼Œå›¾æºçŸ¥ä¹" style="width:400px;"/></div><span class="image-caption">CBOWæ¨¡å‹ç¤ºä¾‹ï¼Œå›¾æºçŸ¥ä¹</span></div><p>CBOWä»…æœ‰ä¸€ä¸ªéšå±‚ï¼Œè®¾è¾“å…¥å±‚åˆ°éšå±‚çš„æƒé‡ä¸º $W$ï¼Œè¾“å…¥å±‚åˆ°è¾“å‡ºå±‚çš„æƒé‡ä¸º $Wâ€™$ï¼Œéšå±‚ç¥ç»å…ƒä¸ªæ•°ä¸º $N$, $W_i$ è¡¨ç¤º $W$ çš„ç¬¬ $i$ è¡Œï¼Œ${Wâ€™_j}$ è¡¨ç¤º $Wâ€™$ çš„ç¬¬ $j$ åˆ—ã€‚</p><p>å› ä¸ºinputæ˜¯one-hotå‘é‡ï¼Œå¯ä»¥çŸ¥é“éšå±‚çš„è¾“å…¥ $h$ åº”è¯¥ç­‰äº $W$ çš„ç¬¬ $I$ è¡Œ $W_I$ ï¼Œ$h$ çš„ç»´åº¦æ˜¯ $N \times 1$ã€‚</p><p>CBOWçš„è®¾è®¡ä¸­çœç•¥äº†éšè—å±‚çš„éçº¿æ€§æ¿€æ´»å‡½æ•°ï¼Œä»…ä»…æ˜¯åšäº†ä¸€ä¸ªåŠ æƒç»„åˆã€‚</p><p>éšåç»è¿‡æƒé‡ $Wâ€™$ ï¼Œå¾—åˆ°ä¸€ä¸ªå‘é‡$u$ï¼Œå…¶ä¸­ $u_i = {Wâ€™_i}^T \cdot W_I$ ï¼Œå¹¶è¿›è¡Œä¸€æ¬¡softmaxå½’ä¸€åŒ–å¾—åˆ°ç»“æœ $y$</p><p>è¾“å‡ºç»“æœæ˜¯ä¸€ä¸ª $V \times 1$ çš„å‘é‡ï¼Œæ¯ä¸€ä¸ªå…ƒç´  $y_i$ è¡¨ç¤ºäº†é¢„æµ‹è¯ä¸ºè¯è¡¨ä¸­ç¬¬ $i$ ä¸ªè¯çš„æ¦‚ç‡ã€‚</p><h2 id="æŸå¤±å‡½æ•°"><a href="#æŸå¤±å‡½æ•°" class="headerlink" title="æŸå¤±å‡½æ•°"></a>æŸå¤±å‡½æ•°</h2><p>å¯¹äºä¸€ä¸ªè¾“å…¥ $w_{oi}$ï¼Œæˆ‘ä»¬å·²çŸ¥å®ƒçš„è¾“å‡ºåº”è¯¥æ˜¯ $w_{oj}$ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åº”è¯¥æœ€å¤§åŒ–ç›®æ ‡å‡½æ•°$p(w_{oj}|w_{oi})$, å³ $y_j$</p>$$\begin{equation}    \begin{array}{ll}        p(w_{oj}|w_{oi}) &= y_j \\                   &= \frac{e^{u_j}}{\sum_{k \in V} e^{u_k}}   \\                   &= \frac{ e^{{W'_j}^T \cdot W_I} } {\sum_{k \in V} e^{ {W'_k}^T \cdot W_I} } \\    \end{array} \notag\end{equation}$$<p>æˆ‘ä»¬å¯¹å…¶å–å¯¹æ•°,åˆ™</p><script type="math/tex; mode=display">log \; p(w_{oj}|w_{oi}) = {W'_j}^T \cdot W_I - log{\sum_{k \in V} {W'_k}^T \cdot W_I}</script><p>æŸå¤±å‡½æ•°å°±æ˜¯ç›®æ ‡å‡½æ•°å–è´Ÿå°±å¯ä»¥äº†ã€‚</p><p>å¦‚æœæœ‰å¤šä¸ªè¾“å…¥ï¼Œä»…éœ€åœ¨ç¬¬ä¸€æ­¥çš„æ—¶å€™ï¼Œå¯¹å„ä¸ªè¾“å…¥å‡ç»è¿‡ç›¸åŒçš„æƒé‡çŸ©é˜µ $W$ ï¼Œæœ€åéšè—å±‚è¾“å…¥ $h$ å¹³å‡å³å¯ã€‚</p><p>ï¼ˆå…³äºå¯¹è¿™æ­¥å¤šä¸ªè¾“å…¥æ±‚å’Œå¹³å‡ï¼Œæˆ‘ä¸€å¼€å§‹ä¹Ÿæœ‰äº›å›°æƒ‘ï¼Œæ„Ÿè§‰ä¼šä¸ä¼šå¯¹æ•ˆæœäº§ç”Ÿä»€ä¹ˆå½±å“ã€‚ä¸è¿‡å¦‚æœæ˜¯å•ä¸ªè¾“å…¥çš„è¯ï¼Œå¯èƒ½ä¸åŒè¾“å…¥ä¹‹é—´çš„å½±å“æŠµæ¶ˆçš„å½±å“ä¼šæ¯”è¾ƒå¤§ã€‚ä½œè€…åº”è¯¥ä¹Ÿæ˜¯å®éªŒè¿‡äº†ç°åœ¨çš„ç»“æœå¥½ï¼Ÿä¸æ‡‚ã€‚ç„¶åæ¨¡å‹ä¹ŸæŠ›å¼ƒäº†å’Œä¸­å¿ƒè¯ç›¸éš”è·ç¦»çš„å‚æ•°ã€‚ï¼‰</p><p>è€ƒè™‘ä¸Šä¸‹æ–‡çª—å£é•¿åº¦ä¸º $c$ï¼ˆå‰åå„ $c$ ä¸ªæ€»å…± $2c$ ä¸ªï¼‰ï¼Œæˆ‘ä»¬è¦æ±‚çš„æŸå¤±å‡½æ•°å°±æ˜¯ï¼š</p><script type="math/tex; mode=display">\sum_{-c \leq j \leq c, j \neq 0}log \; p(w_t|w_{t+j});</script><p>è¿™ä¸ªå…¶å®å¯ä»¥ç›´æ¥ç”¨äº¤å‰ç†µæŸå¤±å‡½æ•°ç®—ï¼ŒåŸå› åœ¨ï¼š<a href="https://zhuanlan.zhihu.com/p/115277553">https://zhuanlan.zhihu.com/p/115277553</a> ï¼Œå†™å¾—ç‰¹åˆ«å¥½ï¼å€¼å¾—æˆ‘é‡æ–°å¼€ä¸€ç¯‡åšæ–‡è®°å½•ä¸€ä¸‹ã€‚ </p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>ä½œè€…å¾ˆå‰å®³ï¼Œé‚£ä¸ªæ—¶å€™æ²¡æœ‰Tensorflowã€PyTorchè¿™ç§æ·±åº¦å­¦ä¹ æ¡†æ¶ï¼Œæ•´ä¸ªä»£ç æ˜¯Cè¯­è¨€å®Œæˆçš„å¹¶ä¸”æ‰€æœ‰æ¢¯åº¦éƒ½æ˜¯æ‰‹ç®—çš„ã€‚</p><p>å…¶å®ç”¨ä¸Šæ·±åº¦å­¦ä¹ æ¡†æ¶åç½‘ç»œéå¸¸ç®€å•ï¼ŒæŸå¤±å‡½æ•°ç”¨ <code>criterion = nn.CrossEntropyLoss()</code> å°±å¯ä»¥äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Model</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Word2Vec</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Word2Vec, self).__init__()</span><br><span class="line">        <span class="comment"># è¾“å…¥å±‚åˆ°éšå±‚æƒé‡çŸ©é˜µ</span></span><br><span class="line">        self.W = nn.Linear(voc_size, embedding_size, bias=<span class="literal">False</span>) <span class="comment"># voc_size &gt; embedding_size Weight</span></span><br><span class="line">        <span class="comment"># éšå±‚åˆ°è¾“å‡ºå±‚æƒé‡çŸ©é˜µ</span></span><br><span class="line">        self.WT = nn.Linear(embedding_size, voc_size, bias=<span class="literal">False</span>) <span class="comment"># embedding_size &gt; voc_size Weight</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, X</span>):</span><br><span class="line">        <span class="comment"># X : [batch_size, voc_size]</span></span><br><span class="line">        hidden_layer = self.W(X) <span class="comment"># hidden_layer : [batch_size, embedding_size]</span></span><br><span class="line">        output_layer = self.WT(hidden_layer) <span class="comment"># output_layer : [batch_size, voc_size]</span></span><br><span class="line">        <span class="keyword">return</span> output_layer</span><br></pre></td></tr></table></figure><h1 id="skip-gram"><a href="#skip-gram" class="headerlink" title="skip-gram"></a>skip-gram</h1><p>è¯´å®è¯æˆ‘è§‰å¾—å°±æ˜¯CBOWå€’è¿‡æ¥ï¼Œï¼Œï¼Œå½¢å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><p class='p left logo large'>æ•ˆç‡ä¼˜åŒ–</p><h1 id="hierarchical-softmax"><a href="#hierarchical-softmax" class="headerlink" title="hierarchical softmax"></a>hierarchical softmax</h1><p>TODO</p><p class='p left logo large'>å‚è€ƒé“¾æ¥</p><p><a href="http://mccormickml.com/2016/04/19/word2vec-tutorial-the-skip-gram-model/">http://mccormickml.com/2016/04/19/word2vec-tutorial-the-skip-gram-model/</a> è¶…çº§ä¿å§†çº§æ•™ç¨‹<br><a href="https://adoni.github.io/2017/11/08/word2vec-pytorch/">https://adoni.github.io/2017/11/08/word2vec-pytorch/</a> </p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> NLP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NLP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œ Wiresharkçš„ä½¿ç”¨</title>
      <link href="/posts/10007.html"/>
      <url>/posts/10007.html</url>
      
        <content type="html"><![CDATA[<p>éšä¾¿å†™å†™</p><p>Wiresharkæ˜¯ç½‘ç»œåŒ…åˆ†æå·¥å…·ï¼Œä¸»è¦ä½œç”¨æ˜¯åœ¨æ¥å›—å®æ—¶æ•æ‰ç½‘ç»œåŒ…ï¼Œå¹¶è¯¦ç»†æ˜¾ç¤ºåŒ…çš„åè®®ä¿¡æ¯ã€‚</p><ul><li><p>å¯ä»¥æ•æ‰å¤šç§ç½‘ç»œæ¥å›—ç±»å‹çš„åŒ…ï¼ŒåŒ…æ‹¬æ— çº¿å±€åŸŸç½‘æ¥å›—ã€‚</p></li><li><p>å¯ä»¥æ”¯æŒå¤šç§åè®®çš„è§£ç ï¼Œå¦‚TCPï¼ŒDNSç­‰ã€‚</p></li></ul><h1 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h1><p>Wiresharkçš„è¿‡æ»¤å™¨åˆ†ä¸ºæ•è·è¿‡æ»¤å™¨å’Œæ˜¾ç¤ºè¿‡æ»¤å™¨</p><ul><li><p>å‰è€…éœ€è¦åœ¨æ•æ‰å‰è®¾ç½®å¥½ï¼Œå†³å®šæ•æ‰ä»€ä¹ˆåŒ…</p></li><li><p>åè€…åœ¨æ•è·è¿‡ç¨‹ä¸­åŠç»“æŸåå¯ä»¥éšæ—¶ä¿®æ”¹ï¼Œåªæ˜¯æ˜¾ç¤ºæ•è·ç»“æœç¬¦åˆè¦æ±‚çš„åŒ…</p></li></ul><h1 id="æ•è·è¿‡æ»¤å™¨è¯­æ³•"><a href="#æ•è·è¿‡æ»¤å™¨è¯­æ³•" class="headerlink" title="æ•è·è¿‡æ»¤å™¨è¯­æ³•"></a>æ•è·è¿‡æ»¤å™¨è¯­æ³•</h1><p>è¿™é‡Œå¾ˆå…¨ï¼š<a href="https://blog.csdn.net/qq_39720249/article/details/128157288">https://blog.csdn.net/qq_39720249/article/details/128157288</a></p><h2 id="åŸºäºåè®®è¿‡æ»¤"><a href="#åŸºäºåè®®è¿‡æ»¤" class="headerlink" title="åŸºäºåè®®è¿‡æ»¤"></a>åŸºäºåè®®è¿‡æ»¤</h2><ul><li>ä¾‹ï¼šåªæ•è·ç«¯å£ä¸º80çš„tcpæ•°æ®åŒ…</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp port 80</span><br></pre></td></tr></table></figure><h2 id="åŸºäºæ–¹å‘è¿‡æ»¤"><a href="#åŸºäºæ–¹å‘è¿‡æ»¤" class="headerlink" title="åŸºäºæ–¹å‘è¿‡æ»¤"></a>åŸºäºæ–¹å‘è¿‡æ»¤</h2><p>å¯ä»¥æŒ‡å®šè·å– æºsrc æˆ–æ˜¯ ç›®çš„dst æ–¹å‘çš„æ•°æ®åŒ…ï¼Œä¹Ÿå¯ä»¥ç”¨ src and dst æˆ–æ˜¯ src or dst</p><ul><li>ä¾‹ï¼šåªæ•è·ç›®çš„ipä¸ºæœ¬æœºipçš„ipv4æ•°æ®åŒ…</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dst host &lt;æœ¬æœºip&gt;</span><br></pre></td></tr></table></figure><h2 id="åŸºäºç±»å‹è¿‡æ»¤"><a href="#åŸºäºç±»å‹è¿‡æ»¤" class="headerlink" title="åŸºäºç±»å‹è¿‡æ»¤"></a>åŸºäºç±»å‹è¿‡æ»¤</h2><p>å¯é€‰é¡¹æœ‰ ä¸»æœºhostï¼Œç½‘æ®µnetï¼Œç«¯å£portï¼Œç«¯å£èŒƒå›´portrange ç­‰</p><ul><li>ä¾‹ï¼šåªæ•è·ç«¯å£ä¸ä¸º80çš„æ•°æ®åŒ…</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">not port 80</span><br></pre></td></tr></table></figure><h1 id="æ˜¾ç¤ºè¿‡æ»¤å™¨è¯­æ³•"><a href="#æ˜¾ç¤ºè¿‡æ»¤å™¨è¯­æ³•" class="headerlink" title="æ˜¾ç¤ºè¿‡æ»¤å™¨è¯­æ³•"></a>æ˜¾ç¤ºè¿‡æ»¤å™¨è¯­æ³•</h1><p>ä¾‹ï¼šæ˜¾ç¤ºipä¸ºæœ¬æœºipçš„dnsæ•°æ®åŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip.addr == &lt;æœ¬æœºip&gt; &amp;&amp; dns</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¼šå‘ç°è¿™æ ·ä»€ä¹ˆåŒ…éƒ½æ²¡æœ‰ã€‚</p><p>å°†æ˜¾ç¤ºè¿‡æ»¤å™¨æ¡ä»¶ç®€åŒ–ä¸ºdnsåå‘ç°èƒ½æ­£ç¡®æ‰¾åˆ°ç›¸å…³dnsæ•°æ®åŒ…ï¼Œä½†æ˜¯å…¶srcå’Œdstéƒ½æ˜¯æˆ‘æœ¬æœºçš„ä¸´æ—¶Ipv6åœ°å€ã€‚</p><p>å°†è¡¨è¾¾å¼æ›´æ”¹ä¸ºä»¥ä¸‹å¼å­å³å¯æ­£ç¡®è·å–dnsæ•°æ®åŒ…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipv6.addr == &lt;æœ¬æœºip&gt; &amp;&amp; dns</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Computer Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Study </tag>
            
            <tag> Notes </tag>
            
            <tag> Computer Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FDU Operating System Lab2</title>
      <link href="/posts/10006.html"/>
      <url>/posts/10006.html</url>
      
        <content type="html"><![CDATA[<div class="note success simple"><p>è–ªç«ç›¸ä¼ </p></div><p>å› ä¸ºä¸­é€”æ‰å¼€å§‹å†™åšå®¢ï¼Œä¸€äº›é…ç½®ä¸Šçš„é—®é¢˜å¯èƒ½æ²¡è®²æ¸…æ¥šã€‚ç›®å‰åªæ˜¯è‡ªå·±åšä¸€ä¸ªè®°å½•å§ã€‚</p><p>å¦‚æœèƒ½å¸®åˆ°ä½ ç†è§£è¿™ä¸ªlabå°±å¥½å•¦</p><p>ç¯å¢ƒï¼šWSL + xv6</p><p>LAB2ï¼š<a href="https://docs.qq.com/slide/DR2VtU3Fvb2hGWEN0">https://docs.qq.com/slide/DR2VtU3Fvb2hGWEN0</a></p><h1 id="å®éªŒå‡†å¤‡"><a href="#å®éªŒå‡†å¤‡" class="headerlink" title="å®éªŒå‡†å¤‡"></a>å®éªŒå‡†å¤‡</h1><p>åˆ‡æ¢åˆ°æœ¬æ¬¡å®éªŒçš„ç¯å¢ƒåˆ†æ”¯ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git commit -am lab0</span><br><span class="line">git fetch</span><br><span class="line">git checkout syscall</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure><p>éšåæŒ‰è¦æ±‚ä¿®æ”¹ç›¸åº” <code>kernel</code> ä¸ <code>user</code> æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ï¼Œä»¥ä»»åŠ¡1çš„ <code>procnum</code> ä¸ºä¾‹ï¼Œå…¶ä½™åŒç†ã€‚</p><p>åœ¨ <code>kernel/syscall.h</code> ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªå®å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_procnum 22</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ <code>kernel/syscall.c</code> æŒ‡å®šç³»ç»Ÿè°ƒç”¨çš„ä¸»ä½“å‡½æ•°ï¼Œå³ç¬¬22å·System callä¼šè°ƒç”¨ <code>sys_procnum</code> è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_procnum</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">[SYS_procnum]  sys_procnum,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>kernel/sysproc.c</code> ä¸­æ·»åŠ å…·ä½“å®ç°çš„ä¸»ä½“å‡½æ•°ï¼ˆåœ¨åé¢ä¼šä»‹ç»ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_procnum</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//implementation of sys_procnum</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>user/usys.pl</code> ä¸­æ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„å­˜æ ¹</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">entry(<span class="string">&quot;procnum&quot;</span>);</span><br></pre></td></tr></table></figure><p>å…·ä½“è€Œè¨€ï¼Œå°±æ˜¯ <code>Makefile</code> ä¼šè°ƒç”¨è¿™ä¸ª <code>Perl</code> è„šæœ¬ï¼Œç”Ÿæˆä¸€æ®µæ±‡ç¼–ç åœ¨ <code>usys.S</code> ä¸­ï¼Œè¿™æ˜¯ <code>user.h</code> ä¸­å®šä¹‰çš„å‡½æ•°å®é™…çš„å®ç°ï¼Œå³è°ƒç”¨çš„åœ°æ–¹ã€‚</p><p>ç‚¹è¿› <code>usys.S</code> å¯ä»¥çœ‹åˆ°è¯¸å¦‚ <code>li a7, SYS_fork</code> è¿™ç§ï¼Œè¿˜è®°å¾—ä¹‹å‰æŠŠ <code>SYS_fork</code> å®å®šä¹‰ä¸ºäº†æ•°å­—å§ï¼Œå°±æ˜¯åœ¨è¿™é‡Œæ´¾ç”¨åœºã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿè®©ç”¨æˆ·ç¨‹åºè®¿é—®åˆ° <code>procnum</code> ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>user/user.h</code> ä¸­å£°æ˜è¯¥è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// system calls</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">procnum</span><span class="params">(<span class="type">int</span>*)</span>;</span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªå‚æ•°åˆ—è¡¨ä¸Šçš„ä¸åŒ¹é…ï¼Œä¼šå‘ç°æ‰€æœ‰ <code>kernel/sysproc.c</code> ä¸­çš„ç³»ç»Ÿè°ƒç”¨å®ç°å½¢å‚åˆ—è¡¨éƒ½æ˜¯voidã€‚</p><p>è¿™æ˜¯å› ä¸º <code>procnum()</code> è¿™æ ·çš„å‡½æ•°æ˜¯ç”¨æˆ·çº§åˆ«çš„å‡½æ•°ï¼Œè€Œ <code>sys_procnum()</code> æ˜¯å†…æ ¸çº§åˆ«çš„å‡½æ•°ï¼Œç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æœ‰ä¸åŒçš„æ•°æ®è®¿é—®è§„åˆ™å’Œéš”ç¦»ã€‚</p><p>å‰è€…éœ€è¦å°†å‚æ•°åœ¨ç”¨æˆ·ç©ºé—´æ‰“åŒ…æˆé€‚å½“çš„æ•°æ®ç»“æ„ï¼Œåè€…ä¼šé€šè¿‡è¾…åŠ©å‡½æ•° <code>argaddr()</code> æˆ– <code>argint()</code> ç­‰è·å–ç”¨æˆ·ç©ºé—´çš„å‚æ•°åˆ°å†…æ ¸ç©ºé—´ï¼Œå¹¶åœ¨å…¶ä¸­è¿›è¡Œåˆæ³•ä¸å®‰å…¨æ€§æ£€æŸ¥ï¼Œç¡®ä¿ä¸ä¼šå¼•å‘å†…æ ¸çš„é”™è¯¯ã€‚</p><p>å¯ä»¥çœ‹çœ‹å…¶å®ƒsystem callçš„å®ç°æ–¹æ³•ï¼Œæ¯”å¦‚wait()ï¼Œæ˜¯æ€ä¹ˆè·å–å‚æ•°åˆ—è¡¨çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">argaddr</span><span class="params">(<span class="type">int</span> n, uint64 *addr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">argint</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> *ip)</span>;</span><br></pre></td></tr></table></figure><h1 id="ä»»åŠ¡1ï¼šprocess-counting"><a href="#ä»»åŠ¡1ï¼šprocess-counting" class="headerlink" title="ä»»åŠ¡1ï¼šprocess counting"></a>ä»»åŠ¡1ï¼šprocess counting</h1><ul><li>ç³»ç»Ÿè°ƒç”¨åŠŸèƒ½ procnumï¼šç»Ÿè®¡ç³»ç»Ÿæ€»è¿›ç¨‹æ•°</li></ul><p>åœ¨useræ–‡ä»¶å¤¹ä¸‹æ·»åŠ æ£€éªŒç¨‹åº procnum.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/riscv.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/sysinfo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>(argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;procnum: Too many arguments\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> num = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (procnum(&amp;num) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;procnum failed!\n&quot;</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Number of process: %d\n&quot;</span>, num);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨makefileä¸­æ·»åŠ ç¼–è¯‘é¡¹</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPROGS=\</span><br><span class="line">    ...</span><br><span class="line">$U/_procnum\</span><br></pre></td></tr></table></figure><p>å®Œæˆ <code>kernel/sysproc.c</code> ä¸­å‡½æ•°çš„å…·ä½“å®ç°ã€‚æˆ‘æ•´ä½“æ˜¯å¯¹ç€ <code>sys_wait()</code> å‡½æ•°å­¦çš„ã€‚</p><p>å…ˆç”¨ <code>argaddr()</code> è·å–ä¼ è¿‡æ¥çš„å‚æ•°ï¼Œæ˜¯å˜é‡numçš„åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_procnum</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  uint64 p;</span><br><span class="line">  argaddr(<span class="number">0</span>, &amp;p);</span><br><span class="line">  <span class="keyword">return</span> procnum(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œ <code>sys_wait()</code> å‡½æ•°ä¸€æ ·ï¼Œæˆ‘ä»¬æŠŠå®ç°æ”¾åœ¨äº† <code>kernel/proc.c</code> ä¸­ï¼Œè®°å¾—åœ¨ <code>defs.h</code> ä¸­å…ˆå®šä¹‰å‡½æ•°</p><p>å› ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´å­˜åœ¨éš”ç¦»ï¼Œæ‰€ä»¥åªèƒ½ä½¿ç”¨ <code>copyout()</code> è¿™ç§è¾…åŠ©å‡½æ•°å®ç°ä¿®æ”¹ç”¨æˆ·ç©ºé—´çš„å˜é‡ï¼Œè€Œä¸èƒ½ç›´æ¥æ‹¿æŒ‡é’ˆå»æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Count the total number of processes in the system.</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">procnum</span><span class="params">(uint64 addr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">pp</span>;</span> <span class="comment">// å£°æ˜ä¸€ä¸ªæŒ‡å‘struct procçš„æŒ‡é’ˆppï¼Œç”¨äºéå†è¿›ç¨‹è¡¨ä¸­çš„è¿›ç¨‹ã€‚</span></span><br><span class="line">  <span class="type">int</span> proc_num = <span class="number">0</span>; <span class="comment">// ç»Ÿè®¡è¿›ç¨‹æ•°</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc(); <span class="comment">//è·å–å½“å‰è¿›ç¨‹çš„æŒ‡é’ˆå¹¶å­˜å‚¨åœ¨pä¸­ã€‚</span></span><br><span class="line">  <span class="keyword">for</span>(pp = proc; pp &lt; &amp;proc[NPROC]; pp++)&#123; <span class="comment">//éå†æ•´ä¸ªè¿›ç¨‹è¡¨ï¼ŒæŸ¥æ‰¾å­è¿›ç¨‹ã€‚</span></span><br><span class="line"><span class="keyword">if</span>(pp-&gt;state != <span class="number">0</span>) &#123; <span class="comment">// åªè¦è¿›ç¨‹çŠ¶æ€ä¸æ˜¯unused</span></span><br><span class="line">proc_num++;</span><br><span class="line">&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(addr != <span class="number">0</span> &amp;&amp; copyout(p-&gt;pagetable, addr, (<span class="type">char</span> *)&amp;proc_num, <span class="keyword">sizeof</span>(proc_num)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">// è¿™ä¸ªæ¯”è¾ƒå¤æ‚ï¼Œï¼Œé¦–å…ˆæ£€æŸ¥ addr æ˜¯å¦ä¸ºéé›¶å€¼ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœ addr ä¸ä¸ºé›¶å°±è°ƒç”¨ copyout å‡½æ•°ï¼Œå°†æ•°æ®ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚</span></span><br><span class="line"><span class="comment">// p æ˜¯å½“å‰è¿›ç¨‹çš„æŒ‡é’ˆï¼Œp-&gt;pagetable å­˜å‚¨äº†å½“å‰è¿›ç¨‹çš„é¡µè¡¨ã€‚é¡µè¡¨æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨äºå°†è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼Œä»¥ä¾¿è®¿é—®å†…å­˜ä¸­çš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// addr æ˜¯ç”¨æˆ·ç¨‹åºæä¾›çš„ç›®æ ‡åœ°å€ï¼Œæ•°æ®å°†è¢«å¤åˆ¶åˆ°è¿™é‡Œ</span></span><br><span class="line"><span class="comment">// (char *)&amp;proc_num æ˜¯è¦å¤åˆ¶çš„æºæ•°æ®çš„åœ°å€ã€‚éœ€è¦ä»¥char*çš„å½¢å¼ä¼ é€’æºæ•°æ®çš„åœ°å€</span></span><br><span class="line"><span class="comment">// sizeof(pp-&gt;xstate) æ˜¯è¦å¤åˆ¶çš„æ•°æ®çš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> proc_num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä½™å‡ é¡¹ä»»åŠ¡ä¹Ÿå·®ä¸å¤šï¼Œç…§çŒ«ç”»è™ã€‚</p><blockquote><p>ä¸‹é¢çš„éƒ¨åˆ†æ˜¯æˆ‘å¾ˆä¹…ä¹‹åå‚ç…§ç€å®éªŒæŠ¥å‘Šè¡¥çš„ï¼Œå¯èƒ½å¹¶ä¸å…¨é¢ï¼Œä»…ä¾›å‚è€ƒ</p></blockquote><h1 id="ä»»åŠ¡2ï¼šFree-Memory-Counting"><a href="#ä»»åŠ¡2ï¼šFree-Memory-Counting" class="headerlink" title="ä»»åŠ¡2ï¼šFree Memory Counting"></a>ä»»åŠ¡2ï¼šFree Memory Counting</h1><p>è¦ç»Ÿè®¡ç©ºé—²å†…å­˜å—çš„æ€»å­—èŠ‚æ•°æ•°ï¼Œå¯ä»¥ç›´æ¥çœ‹åœ¨ kalloc.c ä¸­çš„ kmem.freelistï¼Œéå†å¯ä»¥è·å¾—ç©ºé—²â€œé¡µæ•°â€ï¼Œæœ€åè®°å¾—ç­”æ¡ˆä¹˜ä»¥ PGSIZE</p><p>ä¸ºäº†æ“ä½œå®šä¹‰åœ¨ kalloc.c ä¸­çš„ kmemï¼Œå¯ä»¥åœ¨ kalloc.c ä¸­æ·»åŠ ä¸€ä¸ªå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">get_freemem</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> freemem_num = <span class="number">0</span>; <span class="comment">// ç»Ÿè®¡ç©ºé—²å†…å­˜æ•°</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">mem</span> =</span> kmem.freelist;</span><br><span class="line">  <span class="keyword">while</span> (mem) &#123;</span><br><span class="line">    freemem_num++;</span><br><span class="line">    mem = mem-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> freemem_num * PGSIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ååœ¨ç³»ç»Ÿè°ƒç”¨æ—¶è°ƒç”¨ <code>get_freemem()</code> è¿™ä¸ªå‡½æ•°ï¼Œå’Œå®éªŒ 1 ä¸€æ ·æˆ‘è¿˜æ˜¯æŠŠå®ç°æ”¾åœ¨äº†proc.c ä¸­ã€‚è®°å¾—æŠŠè¿™äº›å‡½æ•°éƒ½åœ¨å¤´æ–‡ä»¶ defs.h ä¸­å®šä¹‰ä¸€ä¸‹ã€‚</p><h3 id="sysproc-c"><a href="#sysproc-c" class="headerlink" title="sysproc.c :"></a>sysproc.c :</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uint64 </span><br><span class="line"><span class="title function_">sys_freemem</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  uint64 p;</span><br><span class="line">  argaddr(<span class="number">0</span>, &amp;p);</span><br><span class="line">  <span class="keyword">return</span> freemem(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="proc-c"><a href="#proc-c" class="headerlink" title="proc.c :"></a>proc.c :</h3><p>æŠŠç­”æ¡ˆå†™å› num</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">freemem</span><span class="params">(uint64 addr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="type">int</span> freemem_num = get_freemem();</span><br><span class="line">  <span class="keyword">if</span>(addr != <span class="number">0</span> &amp;&amp; copyout(p-&gt;pagetable, addr, (<span class="type">char</span> *)&amp;freemem_num, <span class="keyword">sizeof</span>(freemem_num)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> freemem_num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ä»»åŠ¡3ï¼šSystem-call-tracing"><a href="#ä»»åŠ¡3ï¼šSystem-call-tracing" class="headerlink" title="ä»»åŠ¡3ï¼šSystem call tracing"></a>ä»»åŠ¡3ï¼šSystem call tracing</h1><p>è¿™æ¬¡ trace.c å·²ç»ç»™å¥½äº†åœ¨ user æ–‡ä»¶å¤¹é‡Œ</p><p>Trace çš„ç”¨æ³•ä¸å¤ªä¸€æ ·ï¼Œå®ƒä¼ å…¥ä¸€ä¸ªå‚æ•° maskï¼Œæ¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½è¡¨ç¤ºè·Ÿè¸ªæŸä¸€ä¸ªsystem callã€‚è‹¥æŸä¸€ system call å¤„äºè¢«è·Ÿè¸ªçŠ¶æ€ï¼Œåˆ™æ‰§è¡Œå®ƒæ—¶ä¼šè¾“å‡ºç›¸å…³ä¿¡æ¯</p><p>è·Ÿç€ <a href="https://pdos.csail.mit.edu/6.S081/2022/labs/syscall.html">https://pdos.csail.mit.edu/6.S081/2022/labs/syscall.html</a> ä¸­çš„æç¤ºï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆåŒæ ·åœ¨ sysproc.c ä¸­æ·»<br>åŠ ç³»ç»Ÿè°ƒç”¨ sys_trace()ï¼Œå®ƒè´Ÿè´£æ¥æ”¶å‚æ•° mask åˆ°å½“å‰è¿›ç¨‹ã€‚è¿™è¦æ±‚æˆ‘ä»¬åœ¨ proc.h ä¸­ï¼Œå¯¹<br>æ¯ä¸€ä¸ªè¿›ç¨‹æ·»åŠ ä¸€ä¸ªå‚æ•° maskã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Per-process state </span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="type">char</span> name[<span class="number">16</span>]; <span class="comment">// Process name (debugging)</span></span><br><span class="line">  <span class="type">int</span> mask; <span class="comment">// denote which syscall is being traced </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>éšåï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ forkï¼Œè®©æ¯ä¸€ä¸ªå­è¿›ç¨‹ä¹Ÿç»§æ‰¿åˆ° maskã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> </span><br><span class="line"><span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ... </span></span><br><span class="line">  <span class="comment">// copy the trace_mask state</span></span><br><span class="line">  np-&gt;mask = p-&gt;trace_mask; </span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œåœ¨ syscall.c ä¸­ä¿®æ”¹ void syscall(void)ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶æ£€æŸ¥æ‰€æœ‰çš„ system callï¼Œè‹¥å¯¹åº” mask ä½=1ï¼Œåˆ™æ‰“å°ç›¸å…³ä¿¡æ¯ï¼Œæ ¼å¼å’Œè¦æ±‚ä¸­ç›¸åŒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> </span><br><span class="line"><span class="title function_">syscall</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> num; </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc(); </span><br><span class="line">  <span class="type">char</span>* syscall_name; </span><br><span class="line">  num = p-&gt;trapframe-&gt;a7; </span><br><span class="line">  <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">    <span class="comment">// Use num to lookup the system call function for num, call it, </span></span><br><span class="line"><span class="comment">// and store its return value in p-&gt;trapframe-&gt;a0 </span></span><br><span class="line">p-&gt;trapframe-&gt;a0 = syscalls[num](); </span><br><span class="line"><span class="comment">// éå†æ‰€æœ‰ syscall </span></span><br><span class="line"><span class="keyword">if</span> ((p-&gt;mask &amp; (<span class="number">1</span> &lt;&lt; num)) != <span class="number">0</span>) &#123; <span class="comment">// è‹¥å¤„äºè·Ÿè¸ªçŠ¶æ€ï¼› </span></span><br><span class="line">  <span class="comment">// æ‰“å°ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">      syscall_name = syscall_names[num]; </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscall_name, p-&gt;trapframe-&gt;a0); </span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>, p-&gt;pid, p-&gt;name, num); </span><br><span class="line">p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
          <category> Operating System </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Study </tag>
            
            <tag> Notes </tag>
            
            <tag> Operating System </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªå®šä¹‰é¡µé¢</title>
      <link href="/posts/10004.html"/>
      <url>/posts/10004.html</url>
      
        <content type="html"><![CDATA[<p>Hexo &amp; butterfly ä¼šè‡ªåŠ¨æŒ‰ç…§å…¶è®¾ç½®æŒ‡å®šçš„æ–¹å¼å¯¹markdownæ–‡ä»¶è¿›è¡Œæ¸²æŸ“ï¼Œç”Ÿæˆå¯¹åº”çš„åšå®¢é¡µé¢ã€‚</p><p>ä¸è¿‡å¯èƒ½é™¤äº†å†™åšå®¢ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›èƒ½åœ¨åšå®¢ä¸Šéƒ¨ç½²ä¸€äº›å°é¡µé¢å°åŠŸèƒ½ï¼Œbutterflyä¹Ÿæ˜¯æ”¯æŒçš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>/source</code> æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªhtmlæ–‡ä»¶å¤¹ï¼Œå°†æˆ‘ä»¬å†™å¥½çš„é¡µé¢ï¼ˆhtmlã€cssã€javascriptï¼‰ä¸€èµ·æ”¾è¿›å»ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">source</span><br><span class="line">    |-- html</span><br><span class="line">          |-- index.html  # ä¸»è¦çš„å°å·¥å…·æ€»è§ˆé¡µé¢</span><br><span class="line">          |-- Tool1  # å„ç§ä¸åŒçš„å°å·¥å…·</span><br><span class="line">          |-- Tool2</span><br><span class="line">          |-- ...</span><br></pre></td></tr></table></figure><p>åœ¨ <code>_config.yml</code> ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šhexoè®©å…¶è·³è¿‡å¯¹htmlæ–‡ä»¶å¤¹ä¸‹å†…å®¹çš„é»˜è®¤æ¸²æŸ“ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">skip_render:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;html/**&quot;</span>  </span><br></pre></td></tr></table></figure><p>æœ€åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨menuæ æ·»åŠ ä¸€ä¸ªToolå›¾æ ‡ï¼Œä¼šé¦–å…ˆè·³è½¬åˆ°ä¸€ä¸ªæ€»è§ˆé¡µé¢ï¼Œä¸“é—¨ç”¨äºå­˜æ”¾è‡ªå·±çš„å°å·¥å…·ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">Tools:</span> <span class="string">/html/index.html</span> <span class="string">||</span> <span class="string">fas</span> <span class="string">fa-archive</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo &amp; Butterfly tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo &amp; Butterfly tutorial </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åšå®¢ä¹¦å†™æŒ‡å—</title>
      <link href="/posts/10003.html"/>
      <url>/posts/10003.html</url>
      
        <content type="html"><![CDATA[<p>æ¯ç¯‡åšå®¢éƒ½æ˜¯ä¸€ä¸ªmarkdownæ–‡ä»¶ï¼Œç”±Butterflyæ¸²æŸ“ç”Ÿæˆé¡µé¢ï¼Œä¸‹é¢ä»‹ç»ä¸€äº›æ–‡ç« çš„è®¾ç½®ä»¥åŠå†™æ³•ï¼š</p><p class='p left logo large'>æ–‡ç« å±æ€§</p><p>æ¯ç¯‡æ–‡ç« çš„å¼€å¤´éƒ½æœ‰ä¸€ä¸ª<code>Front-matter</code>ï¼Œç”¨äºæä¾›è¿™ç¯‡æ–‡ç« çš„ç›¸å…³ä¿¡æ¯ï¼Œè¯¦æƒ…è¯·çœ‹ <a href="https://butterfly.js.org/posts/dc584b87/">https://butterfly.js.org/posts/dc584b87/</a></p><p>ä»¥æœ¬ç¯‡æ–‡ç« çš„è®¾ç½®ä¸ºä¾‹ï¼Œè®²ä¸€ä¸‹å„ä¸ªå±æ€§çš„æ„ä¹‰ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: åšå®¢ä¹¦å†™æŒ‡å—</span><br><span class="line">cover: &#x27;https://picst.sunbangyan.cn/2023/10/13/oynsmu.jpg&#x27;</span><br><span class="line">abbrlink: 10003</span><br><span class="line">date: 2023-10-13 22:59:32</span><br><span class="line">tags: [Hexo &amp; Butterfly tutorial]</span><br><span class="line">categories: </span><br><span class="line"><span class="bullet">  -</span> [Hexo &amp; Butterfly tutorial]</span><br><span class="line">updated:</span><br><span class="line">type:</span><br><span class="line">comments:</span><br><span class="line">description: ä»‹ç»åšå®¢æ–‡ç« çš„ä¹¦å†™æ–¹æ³•</span><br><span class="line">keywords:</span><br><span class="line">top<span class="emphasis">_img:</span></span><br><span class="line"><span class="emphasis">mathjax:</span></span><br><span class="line"><span class="emphasis">katex:</span></span><br><span class="line"><span class="emphasis">aside:</span></span><br><span class="line"><span class="emphasis">aplayer:</span></span><br><span class="line"><span class="emphasis">highlight_</span>shrink:</span><br><span class="line"><span class="section">random:</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure><ul><li><p>title</p><p>åšå®¢çš„æ ‡é¢˜</p></li><li><p>cover </p><p>åšå®¢çš„å°é¢ï¼ˆæ˜¾ç¤ºåœ¨é¦–é¡µï¼‰</p></li><li><p>abbrlink</p><p>ç”±æ’ä»¶ <code>hexo-abbrlink</code> ç”Ÿæˆï¼Œæ›¿æ¢hexoåŸç”Ÿçš„é¡µé¢urlç”Ÿæˆæ–¹æ¡ˆã€‚è¯¥å€¼å¯è‡ªå®šä¹‰ï¼Œå”¯ä¸€æŒ‡å®šä¸€ç¯‡æ–‡ç« ï¼ˆä¸å¯é‡å¤ï¼‰ï¼ŒåŒæ—¶ä¹Ÿæ˜¯è¯¥é¡µé¢çš„urlåœ°å€ã€‚</p></li><li><p>date</p><p>æ–‡ç« çš„å‘è¡¨æ—¶é—´</p></li><li><p>tags</p><p>è¯¥ç¯‡æ–‡ç« çš„æ ‡ç­¾ï¼Œè¯­æ³•ä¸º tags:[tag1, tag2, â€¦]</p></li><li><p>categories</p><p>è¯¥ç¯‡æ–‡ç« çš„åˆ†ç±»ï¼Œæ¨èè¯­æ³•ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">categories: </span><br><span class="line">  - [A, B]</span><br></pre></td></tr></table></figure><p>è¡¨ç¤ºè¯¥æ–‡ç« å±äºåˆ†ç±»Aä¸‹çš„å­ç±»B</p></li><li><p>description</p><p>åœ¨é¦–é¡µçœ‹åˆ°çš„æ–‡ç« å†…å®¹ç®€ä»‹ã€‚å¦‚æœè®¾ç½®äº† <code>description</code> ï¼Œåˆ™ä¼šæ˜¾ç¤ºè¿™ä¸ªï¼Œå¦åˆ™ä¼šæ˜¾ç¤ºæ–‡ç« å†…å®¹èŠ‚é€‰</p><p>è¿™ä¸€é¡¹å¯ä»¥åœ¨ <code>_config.butterfly.yml</code> ä¸­çš„ <code>index_post_content</code> ä¸€æ ä¿®æ”¹ï¼ˆè¯¦è§ï¼š<a href="https://anti-entrophic.github.io/posts/10002.htmlï¼‰">https://anti-entrophic.github.io/posts/10002.htmlï¼‰</a></p></li><li><p>å¾…è¡¥å……</p></li></ul><p class='p left logo large'>è‡ªå®šä¹‰é¡µé¢å­—ä½“</p><h1 id="åˆ›å»ºcssæ–‡ä»¶"><a href="#åˆ›å»ºcssæ–‡ä»¶" class="headerlink" title="åˆ›å»ºcssæ–‡ä»¶"></a>åˆ›å»ºcssæ–‡ä»¶</h1><p>ä»¥æˆ‘ç›®å‰ä½¿ç”¨çš„å­—ä½“ä¸ºä¾‹ï¼Œé¦–å…ˆéœ€è¦åœ¨ <code>/&#123;root&#125;/source/css</code> ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œæš‚ä¸”å‘½åä¸º <code>custom.css</code> ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*æ„Ÿè°¢å®‰çŸ¥é±¼å¤§ä½¬çš„æ•™ç¨‹ï¼*/</span></span><br><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: ZhuZiAYuanJWD;</span><br><span class="line">    <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">https://npm.elemecdn.com/anzhiyu-blog@1.1.6/fonts/ZhuZiAWan.woff2</span>);</span><br><span class="line">    <span class="attribute">font-display</span>: swap;</span><br><span class="line">    <span class="attribute">font-weight</span>: lighter;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">&quot;ZhuZiAYuanJWD&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä¸æŒ‡å®šå…¨å±€ä½¿ç”¨è¿™ä¸€ä¸ªå­—ä½“ï¼Œå¯ä»¥æ¢ï¼Œæ¯”å¦‚è¯´ä»…æŒ‡å®šå¯¼èˆªæ å½“ç„¶ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå¯ä»¥è‡ªå·±é­”æ”¹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span><span class="selector-id">#menus</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&quot;ZhuZiAYuanJWD&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å¼•å…¥cssæ–‡ä»¶"><a href="#å¼•å…¥cssæ–‡ä»¶" class="headerlink" title="å¼•å…¥cssæ–‡ä»¶"></a>å¼•å…¥cssæ–‡ä»¶</h1><p>åœ¨ <code>_config.butterfly.yml</code> ä¸­æ‰¾åˆ° <code>inject</code> è¿™ä¸€æ ï¼Œå°±åƒhtmlé“¾æ¥cssä¸€æ ·å¼•å…¥ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="comment"># è‡ªå®šä¹‰CSS</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel=&quot;stylesheet&quot;</span> <span class="string">href=&quot;/css/custom.css&quot;</span> <span class="string">media=&quot;defer&quot;</span> <span class="string">onload=&quot;this.media=&#x27;all&#x27;&quot;&gt;</span></span><br><span class="line">    <span class="comment"># æš‚æ—¶ä¸æ¸…æ¥šmediaå’Œonloadæœ‰ä»€ä¹ˆç”¨</span></span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œåœ¨ <code>_config.butterfly.yml</code> ä¸­æŒ‡å®šæ¸²æŸ“æ—¶ä½¿ç”¨æˆ‘ä»¬æ–°å¼•å…¥çš„å­—ä½“ï¼šï¼ˆè¿™æ­¥ä¸æ¸…æ¥šéœ€ä¸éœ€è¦ï¼‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">font:</span></span><br><span class="line">  <span class="attr">global-font-size:</span></span><br><span class="line">  <span class="attr">code-font-size:</span></span><br><span class="line">  <span class="attr">font-family:</span> <span class="string">ZhuZiAYuanJWD</span></span><br><span class="line">  <span class="attr">code-font-family:</span> <span class="string">ZhuZiAYuanJWD</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>font-family</code> æ˜¯å…¨å±€çš„å­—ä½“ï¼Œ <code>code-font-family</code> æ˜¯ä»£ç å—ä¸­çš„å­—ä½“</p>]]></content>
      
      
      <categories>
          
          <category> Hexo &amp; Butterfly tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo &amp; Butterfly tutorial </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo&amp;butterflyé…ç½®æ•™ç¨‹</title>
      <link href="/posts/10002.html"/>
      <url>/posts/10002.html</url>
      
        <content type="html"><![CDATA[<div class="note success simple"><p>ä»‹ç»ä¸€äº›åšå®¢çš„ Hexo &amp; butterfly é…ç½®ä¿®æ”¹æ–¹æ³•</p></div><p class='p left logo large'>ä¸»é¡µæ–‡ç« ç®€ä»‹</p><p>åœ¨ä¸»é¡µä¸­çœ‹åˆ°çš„æ–‡ç« å†…å®¹çš„ç®€ä»‹ï¼Œ<code>butterfly</code> å…±æä¾›äº†å››ç§é€‰æ‹©ï¼š</p><ol><li>descriptionï¼š åªæ˜¾ç¤ºdescription</li><li>bothï¼š ä¼˜å…ˆé€‰æ‹©descriptionï¼›å¦‚æœæ²¡æœ‰é…ç½®descriptionï¼Œåˆ™æ˜¾ç¤ºæ–‡ç« èŠ‚é€‰å†…å®¹</li><li>auto_excerptï¼š åªæ˜¾ç¤ºæ–‡ç« èŠ‚é€‰å†…å®¹</li><li>falseï¼š ä¸æ˜¾ç¤ºæ–‡ç« å†…å®¹</li></ol><p>åœ¨ <code>_config.butterfly.yml</code> ä¿®æ”¹æ¡ç›®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index_post_content:</span></span><br><span class="line">  <span class="attr">method:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">length:</span> <span class="number">500</span>  <span class="comment"># if you set method to 2 or 3, the length need to config</span></span><br></pre></td></tr></table></figure><p class='p left logo large'>è·³è¿‡æ¸²æŸ“</p><p>hexoä¼šè‡ªåŠ¨æŠŠsourceä¸‹çš„æ–‡ä»¶è¯†åˆ«æ¸²æŸ“ä¸ºåšå®¢é¡µé¢ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å¹¶ä¸å¸Œæœ›è‡ªåŠ¨æ¸²æŸ“ï¼Œè€Œæ˜¯æƒ³è¦å…¶ç»´æŒæˆ‘ä»¬è®¾è®¡çš„ç•Œé¢ã€‚</p><p>åœ¨ <code>_config.yml</code> ä¿®æ”¹æ¡ç›®å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">skip_render:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;html/**&quot;</span>  <span class="comment"># &quot;**&quot;ï¼šé€šé…ç¬¦ï¼Œhtmlæ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼›&quot;*&quot;ï¼Œhtmlæ–‡ä»¶å¤¹ä¸‹ä¸€å±‚çš„æ‰€æœ‰æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p class='p left logo large'>ä¾§è¾¹æ </p><p>åœ¨ <code>_config.butterfly.yml</code> ç›¸å…³æ¡ç›®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">aside:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hide:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">button:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">mobile:</span> <span class="literal">true</span> <span class="comment"># display on mobile</span></span><br><span class="line">  <span class="attr">position:</span> <span class="string">right</span> <span class="comment"># left or right</span></span><br><span class="line">  <span class="attr">display:</span></span><br><span class="line">    <span class="attr">archive:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">category:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">card_author:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">description:</span></span><br><span class="line">    <span class="attr">button:</span></span><br><span class="line">      <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">icon:</span> <span class="string">fab</span> <span class="string">fa-github</span></span><br><span class="line">      <span class="attr">text:</span> <span class="string">Follow</span> <span class="string">Me</span></span><br><span class="line">      <span class="attr">link:</span> <span class="string">https://github.com/Anti-Entrophic</span></span><br><span class="line">  <span class="attr">card_announcement:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">This</span> <span class="string">is</span> <span class="string">my</span> <span class="string">Blog</span></span><br><span class="line">  <span class="attr">card_recent_post:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">5</span> <span class="comment"># if set 0 will show all</span></span><br><span class="line">    <span class="attr">sort:</span> <span class="string">date</span> <span class="comment"># date or updated</span></span><br><span class="line">    <span class="attr">sort_order:</span> <span class="comment"># Don&#x27;t modify the setting unless you know how it works</span></span><br><span class="line">  <span class="attr">card_categories:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">8</span> <span class="comment"># if set 0 will show all</span></span><br><span class="line">    <span class="attr">expand:</span> <span class="string">none</span> <span class="comment"># none/true/false</span></span><br><span class="line">    <span class="attr">sort_order:</span> <span class="comment"># Don&#x27;t modify the setting unless you know how it works</span></span><br><span class="line">  <span class="attr">card_tags:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">40</span> <span class="comment"># if set 0 will show all</span></span><br><span class="line">    <span class="attr">color:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">orderby:</span> <span class="string">random</span> <span class="comment"># Order of tags, random/name/length</span></span><br><span class="line">    <span class="attr">order:</span> <span class="number">1</span> <span class="comment"># Sort of order. 1, asc for ascending; -1, desc for descending</span></span><br><span class="line">    <span class="attr">sort_order:</span> <span class="comment"># Don&#x27;t modify the setting unless you know how it works</span></span><br><span class="line">  <span class="attr">card_archives:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">monthly</span> <span class="comment"># yearly or monthly</span></span><br><span class="line">    <span class="attr">format:</span> <span class="string">MMMM</span> <span class="string">YYYY</span> <span class="comment"># eg: YYYYå¹´MMæœˆ</span></span><br><span class="line">    <span class="attr">order:</span> <span class="number">-1</span> <span class="comment"># Sort of order. 1, asc for ascending; -1, desc for descending</span></span><br><span class="line">    <span class="attr">limit:</span> <span class="number">8</span> <span class="comment"># if set 0 will show all</span></span><br><span class="line">    <span class="attr">sort_order:</span> <span class="comment"># Don&#x27;t modify the setting unless you know how it works</span></span><br><span class="line">  <span class="attr">card_webinfo:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">post_count:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">last_push_date:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">sort_order:</span> <span class="comment"># Don&#x27;t modify the setting unless you know how it works</span></span><br><span class="line">  <span class="attr">card_post_series:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">orderBy:</span> <span class="string">&#x27;date&#x27;</span> <span class="comment"># Order by title or date</span></span><br><span class="line">    <span class="attr">order:</span> <span class="number">-1</span> <span class="comment"># Sort of order. 1, asc for ascending; -1, desc for descending</span></span><br><span class="line"></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line">  <span class="comment"># fab fa-github: https://github.com/Anti-Entrophic || Github || &#x27;#24292e&#x27;</span></span><br></pre></td></tr></table></figure><p><code>aside</code> çš„æ³¨é‡Šå¾ˆè¯¦ç»†ï¼Œå¯¹ç…§ç€çœ‹å°±çŸ¥é“åŠŸèƒ½äº†ã€‚<code>social</code> æŒ‡çš„æ˜¯åœ¨ Follow me ä¸‹é¢å‡ºç°çš„å›¾æ ‡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hexo &amp; Butterfly tutorial </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo &amp; Butterfly tutorial </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åšå®¢æ—¶é—´çº¿</title>
      <link href="/posts/d87f7e0c.html"/>
      <url>/posts/d87f7e0c.html</url>
      
        <content type="html"><![CDATA[<div class="timeline undefined"><div class='timeline-item headline'><div class='timeline-item-title'><div class='item-circle'><p>2023</p></div></div></div><div class='timeline-item'><div class='timeline-item-title'><div class='item-circle'><p>10-13</p></div></div><div class='timeline-item-content'><p>å®Œæˆåšå®¢åŸºç¡€å»ºè®¾ä¸éƒ¨ç½²</p></div></div></div>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/posts/4a17b156.html"/>
      <url>/posts/4a17b156.html</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>categories</title>
      <link href="/categories/index.html"/>
      <url>/categories/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>tags</title>
      <link href="/tags/index.html"/>
      <url>/tags/index.html</url>
      
        <content type="html"><![CDATA[]]></content>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/css/custom.css"/>
      <url>/css/custom.css</url>
      
        <content type="html"><![CDATA[/* @font-face {  font-family: Candyhome;  src: url(https://npm.elemecdn.com/anzhiyu-blog@1.1.6/fonts/Candyhome.ttf);  font-display: swap;  font-weight: lighter;} */@font-face {    font-family: ZhuZiAYuanJWD;    src: url(https://npm.elemecdn.com/anzhiyu-blog@1.1.6/fonts/ZhuZiAWan.woff2);    font-display: swap;    font-weight: lighter;  }    body {    font-family: "ZhuZiAYuanJWD";  }  div#menus {    font-family: "ZhuZiAYuanJWD";  }  h1#site-title {    font-family: ZhuZiAYuanJWD;    font-size: 3em !important;  }  a.article-title,  a.blog-slider__title,  a.categoryBar-list-link,  h1.post-title {    font-family: ZhuZiAYuanJWD;  }    .iconfont {    font-family: "iconfont" !important;    font-size: 3em;    /* å¯ä»¥å®šä¹‰å›¾æ ‡å¤§å° */    font-style: normal;    -webkit-font-smoothing: antialiased;    -moz-osx-font-smoothing: grayscale;  }    /* æ—¶é—´è½´ç”Ÿè‚–icon */  svg.icon {    /* è¿™é‡Œå®šä¹‰svg.iconï¼Œé¿å…å’ŒButterflyè‡ªå¸¦çš„noteæ ‡ç­¾å†²çª */    width: 1em;    height: 1em;    /* widthå’Œheightå®šä¹‰å›¾æ ‡çš„é»˜è®¤å®½åº¦å’Œé«˜åº¦*/    vertical-align: -0.15em;    fill: currentColor;    overflow: hidden;  }    .icon-zhongbiao::before {    color: #f7c768;  }    /* bilibliç•ªå‰§æ’ä»¶ */  #article-container .bangumi-tab.bangumi-active {    background: var(--anzhiyu-theme);    color: var(--anzhiyu-ahoverbg);    border-radius: 10px;  }  a.bangumi-tab:hover {    text-decoration: none !important;  }  .bangumi-button:hover {    background: var(--anzhiyu-theme) !important;    border-radius: 10px !important;    color: var(--anzhiyu-ahoverbg) !important;  }  a.bangumi-button.bangumi-nextpage:hover {    text-decoration: none !important;  }  .bangumi-button {    padding: 5px 10px !important;  }    a.bangumi-tab {    padding: 5px 10px !important;  }  svg.icon.faa-tada {    font-size: 1.1em;  }  .bangumi-info-item {    border-right: 1px solid #f2b94b;  }  .bangumi-info-item span {    color: #f2b94b;  }  .bangumi-info-item em {    color: #f2b94b;  }    /* è§£å†³artitalkçš„å›¾æ ‡é—®é¢˜ */  #uploadSource > svg {    width: 1.19em;    height: 1.5em;  }    /*top-imgé»‘è‰²é€æ˜ç»ç’ƒæ•ˆæœç§»é™¤ï¼Œä¸å»ºè®®åŠ ï¼Œé™¤éä½ æ‰§ç€äºå®Œå…¨ä¸€å›¾æµæˆ–è€…èƒŒæ™¯å›¾å¯¹æ¯”è‰²æ˜æ˜¾ */  #page-header:not(.not-top-img):before {    background-color: transparent !important;  }    /* é¦–é¡µæ–‡ç« å¡ç‰‡ */  #recent-posts > .recent-post-item {    background: rgba(255, 255, 255, 0.9);  }    /* é¦–é¡µä¾§æ å¡ç‰‡ */  #aside-content .card-widget {    background: rgba(255, 255, 255, 0.9);  }    /* æ–‡ç« é¡µé¢æ­£æ–‡èƒŒæ™¯ */  div#post {    background: rgba(255, 255, 255, 0.9);  }    /* åˆ†é¡µé¡µé¢ */  div#page {    background: rgba(255, 255, 255, 0.9);  }    /* å½’æ¡£é¡µé¢ */  div#archive {    background: rgba(255, 255, 255, 0.9);  }    /* æ ‡ç­¾é¡µé¢ */  div#tag {    background: rgba(255, 255, 255, 0.9);  }    /* åˆ†ç±»é¡µé¢ */  div#category {    background: rgba(255, 255, 255, 0.9);  }    /*å¤œé—´æ¨¡å¼ä¼ªç±»é®ç½©å±‚é€æ˜*/  [data-theme="dark"] #recent-posts > .recent-post-item {    background: #121212;  }    [data-theme="dark"] .card-widget {    background: #121212 !important;  }    [data-theme="dark"] div#post {    background: #121212 !important;  }    [data-theme="dark"] div#tag {    background: #121212 !important;  }    [data-theme="dark"] div#archive {    background: #121212 !important;  }    [data-theme="dark"] div#page {    background: #121212 !important;  }    [data-theme="dark"] div#category {    background: #121212 !important;  }    [data-theme="dark"] div#category {    background: transparent !important;  }  /* é¡µè„šé€æ˜ */  #footer {    background: transparent !important;  }    /* å¤´å›¾é€æ˜ */  #page-header {    background: transparent !important;  }    #rightside > div > button {    border-radius: 5px;  }    /* æ»šåŠ¨æ¡ */    ::-webkit-scrollbar {    width: 10px;    height: 10px;  }    ::-webkit-scrollbar-thumb {    background-color: #3b70fc;    border-radius: 2em;  }    ::-webkit-scrollbar-corner {    background-color: transparent;  }    ::-moz-selection {    color: #fff;    background-color: #3b70fc;  }    /* éŸ³ä¹æ’­æ”¾å™¨ */    /* .aplayer .aplayer-lrc {    display: none !important;  } */    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {    left: -66px !important;    transition: all 0.3s;    /* é»˜è®¤æƒ…å†µä¸‹ç¼©è¿›å·¦ä¾§66pxï¼Œåªç•™ä¸€ç‚¹ç®­å¤´éƒ¨åˆ† */  }    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {    left: 0 !important;    transition: all 0.3s;    /* é¼ æ ‡æ‚¬åœæ˜¯å·¦ä¾§ç¼©è¿›å½’é›¶ï¼Œå®Œå…¨æ˜¾ç¤ºæŒ‰é’® */  }    .aplayer.aplayer-fixed {    z-index: 999999 !important;  }    /* è¯„è®ºæ¡†  */  .vwrap {    box-shadow: 2px 2px 5px #bbb;    background: rgba(255, 255, 255, 0.3);    border-radius: 8px;    padding: 30px;    margin: 30px 0px 30px 0px;  }    /* è®¾ç½®è¯„è®ºæ¡† */    .vcard {    box-shadow: 2px 2px 5px #bbb;    background: rgba(255, 255, 255, 0.3);    border-radius: 8px;    padding: 30px;    margin: 30px 0px 0px 0px;  }    /* mdç½‘ç«™ä¸‹åˆ’çº¿ */  #article-container a:hover {    text-decoration: none !important;  }    #article-container #hpp_talk p img {    display: inline;  }    /* 404é¡µé¢ */  #error-wrap {    position: absolute;    top: 40%;    right: 0;    left: 0;    margin: 0 auto;    padding: 0 1rem;    max-width: 1000px;    transform: translate(0, -50%);  }    #error-wrap .error-content {    display: flex;    flex-direction: row;    justify-content: center;    align-items: center;    margin: 0 1rem;    height: 18rem;    border-radius: 8px;    background: var(--card-bg);    box-shadow: var(--card-box-shadow);    transition: all 0.3s;  }    #error-wrap .error-content .error-img {    box-flex: 1;    flex: 1;    height: 100%;    border-top-left-radius: 8px;    border-bottom-left-radius: 8px;    background-color: #3b70fc;    background-position: center;    background-size: cover;  }    #error-wrap .error-content .error-info {    box-flex: 1;    flex: 1;    padding: 0.5rem;    text-align: center;    font-size: 14px;    font-family: Titillium Web, "PingFang SC", "Hiragino Sans GB", "Microsoft JhengHei", "Microsoft YaHei", sans-serif;  }  #error-wrap .error-content .error-info .error_title {    margin-top: -4rem;    font-size: 9em;  }  #error-wrap .error-content .error-info .error_subtitle {    margin-top: -3.5rem;    word-break: break-word;    font-size: 1.6em;  }  #error-wrap .error-content .error-info a {    display: inline-block;    margin-top: 0.5rem;    padding: 0.3rem 1.5rem;    background: var(--btn-bg);    color: var(--btn-color);  }    #body-wrap.error .aside-list {    display: flex;    flex-direction: row;    flex-wrap: nowrap;    bottom: 0px;    position: absolute;    padding: 1rem;    width: 100%;    overflow: scroll;  }    #body-wrap.error .aside-list .aside-list-group {    display: flex;    flex-direction: row;    flex-wrap: nowrap;    max-width: 1200px;    margin: 0 auto;  }    #body-wrap.error .aside-list .aside-list-item {    padding: 0.5rem;  }    #body-wrap.error .aside-list .aside-list-item img {    width: 100%;    object-fit: cover;    border-radius: 12px;  }    #body-wrap.error .aside-list .aside-list-item .thumbnail {    overflow: hidden;    width: 230px;    height: 143px;    background: var(--anzhiyu-card-bg);    display: flex;  }    #body-wrap.error .aside-list .aside-list-item .content .title {    -webkit-line-clamp: 2;    overflow: hidden;    display: -webkit-box;    -webkit-box-orient: vertical;    line-height: 1.5;    justify-content: center;    align-items: flex-end;    align-content: center;    padding-top: 0.5rem;    color: white;  }    #body-wrap.error .aside-list .aside-list-item .content time {    display: none;  }    /* ä»£ç æ¡†ä¸»é¢˜ */  #article-container figure.highlight {    border-radius: 10px;  }]]></content>
      
    </entry>
    
    
  
</search>
